<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Gulp</title>
  
  <!-- Meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="gulp,build,vinyl,stream,buffer">
  
  
    <meta name="description" content="Gulp Introduce">
  

  <!-- Feed -->
  
    <link rel="alternative" href="/atom.xml" title="SixDegree" type="application/atom+xml">
  

  <!-- CSS -->
  <link rel="stylesheet" href="/bootstrap/dist/css/bootstrap.css">
  
	
		<link rel="stylesheet" href="/highlight/demo/styles/tomorrow-night-bright.css">
	
    
  
  <link rel="stylesheet" href="/css/fontello.css">
  <link rel="stylesheet" href="/css/style.css">

  <!-- Site Analyse -->
  
	<script>
	var userID='2bbb83cc0f781dd7502e9d5e19661866';
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?"+userID;
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>


</head>

<body data-spy="scroll" data-target="#nav-catalog">
  <div id="top-push"></div>
<a href="#top-push" id="go-top">
	<span class="glyphicon glyphicon-chevron-up"></span>
</a>
  <aside id="sidebar">
    <section class="sidebar-header">Catalog</section>
     <nav id="nav-catalog">
        <ol class="sidebar-nav nav"><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#header-1"><span class="sidebar-nav nav-text">Starter</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-2"><span class="sidebar-nav nav-text">安装</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-3"><span class="sidebar-nav nav-text">API</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-4"><span class="sidebar-nav nav-text">SyncTask</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-5"><span class="sidebar-nav nav-text">Vinyl</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-6"><span class="sidebar-nav nav-text">Doc</span></a></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#header-7"><span class="sidebar-nav nav-text">常用插件</span></a></li></ol>
    </nav>
  </aside>
  <span id="sidebar-ctrl" class="glyphicon glyphicon-list-alt circle"></span>
  <div id="wrapper">
    <header>
  <nav class="navbar navbar-default">
    <div class="container-fluid">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#nav-menu" aria-expanded="false">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="/">SixDegree</a>
      </div>
      <div class="collapse navbar-collapse" id="nav-menu">
        <ul class="nav navbar-nav navbar-right">
          
              <li  >
                <a href="/">Blogs</a>
              </li>
          
              <li  >
                <a href="/tags.html">Tags</a>
              </li>
          
              <li  >
                <a href="/about.html">About</a>
              </li>
          
          
              <li>
                <a href="/atom.xml" target="_blank">
                  <span class="icon-rss"></span>
                </a>
              </li>
          
              <li>
                <a href="http://github.com/sixdegree" target="_blank">
                  <span class="icon-github"></span>
                </a>
              </li>
          
        </ul>
      </div>
    </div>
  </nav>
</header>



    <div class="container">
      <article class="detail" role="main">
  <section class="post-header">
    <h1 class="post-title">Gulp</h1>
    <ul class="post-meta">
      <li>
        <span class="glyphicon glyphicon-calendar"></span>
        <time datetime="2015-03-31T16:00:00.000Z">2015-04-01</time>
      </li>
      
        <li>
         <span class="glyphicon glyphicon-tags"></span>
          
            <a href="/tags.html#tag-Node">Node</a>
          
        </li>
      
    </ul>
  </section>
  <section class="post-content">
    <h2 id="header-1">Starter</h2>
<p>Gulp 基于流的自动化构建工具 （功能同Grunt）</p>
<h3 id="header-2">安装</h3>
<p>安装全局gulp</p>
<pre><code>&gt; npm install gulp -g
&gt; gulp help
</code></pre><p>在项目中使用gulp</p>
<pre><code># 安装gulp
&gt; npm install gulp --save-dev

# 编写gulpfile.js文件
&gt; vim gulpfile.js
...

# 执行task
&gt; gulp xxx
</code></pre><h3 id="header-3">API</h3>
<ul>
<li><p><code>gulp.src(globs[, options])</code></p>
<ul>
<li><code>options.buffer</code>：true（默认），false表示stream方式读取文件内容</li>
<li><code>options.read</code>：true（默认）, false表示不读取文件内容</li>
<li><p><code>options.base</code>：everything before a glob starts（默认）</p>
<ul>
<li><p>eg: <code>&#39;client/js/**/*.js&#39;</code>，则base默认为<code>client/js</code>；<code>client/js/test.js</code>, base默认为<code>client/js</code></p>
<pre><code class="lang-js">gulp.src(&#39;client/js/**/*.js&#39;) // Matches &#39;client/js/somedir/somefile.js&#39; and resolves `base` to `client/js/`
.pipe(minify())
.pipe(gulp.dest(&#39;build&#39;));  // Writes &#39;build/somedir/somefile.js&#39;

gulp.src(&#39;client/js/**/*.js&#39;, { base: &#39;client&#39; })
.pipe(minify())
.pipe(gulp.dest(&#39;build&#39;));  // Writes &#39;build/js/somedir/somefile.js&#39;
</code></pre>
</li>
</ul>
</li>
</ul>
</li>
<li><p><code>gulp.dest(path[, options])</code></p>
<ul>
<li>options.cwd：process.cwd() 前脚本的工作目录的路径，当文件输出路径为相对路径将会用到</li>
<li>options.mode：0777 （默认），指定被创建文件夹的权限</li>
</ul>
</li>
<li><p><code>gulp.task(name[, deps], fn)</code></p>
<ul>
<li>name：任务名</li>
<li>deps ：为一个数组，是当前定义的任务需要依赖的其他任务（可不设置），默认依赖任务会并行执行</li>
<li>fn：任务函数（deps中的任务先执行）<pre><code class="lang-js">gulp.task(&#39;mytask&#39;, [&#39;array&#39;, &#39;of&#39;, &#39;task&#39;, &#39;names&#39;], function() {
// Do stuff
});
</code></pre>
</li>
</ul>
</li>
<li><code>gulp.watch(glob [, opts], tasks)</code><pre><code class="lang-js">  gulp.watch(&#39;js/**/*.js&#39;, [&#39;uglify&#39;,&#39;reload&#39;]);
</code></pre>
</li>
<li><code>gulp.watch(glob [, opts, cb])</code><pre><code class="lang-js">  gulp.watch(&#39;js/**/*.js&#39;, function(event){
      console.log(event.type); //变化类型 added为新增,deleted为删除，changed为改变 
      console.log(event.path); //变化的文件的路径
  });
</code></pre>
</li>
</ul>
<p>说明：</p>
<ul>
<li><code>globs</code> : String  or  Array<ul>
<li>文件匹配模式(类似正则表达式)，Gulp内部使用了<code>node-glob</code>模块来实现其文件匹配功能</li>
<li><code>**</code>，<code>*</code>,<code>?</code>,<code>!</code>,<code>[...]</code>,<code>[^...]</code>,<code>{...}</code></li>
</ul>
</li>
</ul>
<h3 id="header-4">SyncTask</h3>
<p>想等待异步任务中的异步操作完成后再执行后续的任务，有三种方法可以实现：</p>
<ol>
<li>Passing in a callback<pre><code class="lang-js"> gulp.task(&#39;sync&#39;, function (cb) {
     // setTimeout could be any async task
     setTimeout(function () {
         cb();
     }, 1000);
 });
</code></pre>
</li>
<li>Returning a stream （适用于任务就是操作gulp.src获取到的流的情况）<pre><code class="lang-js"> gulp.task(&#39;sync&#39;, function () {
     return gulp.src(&#39;js/*.js&#39;)
         .pipe(concat(&#39;script.min.js&#39;)
         .pipe(uglify())
         .pipe(gulp.dest(&#39;../dist/js&#39;);
 });
</code></pre>
</li>
<li>Returning a Promise<pre><code class="lang-js"> var Q = require(&#39;q&#39;);
 gulp.task(&#39;one&#39;,function(){
   var deferred = Q.defer();
   setTimeout(function() {
      deferred.resolve();
   }, 5000);
   return deferred.promise;
 });
</code></pre>
</li>
</ol>
<p>测试：</p>
<pre><code class="lang-js">gulp.task(&#39;secondTask&#39;, [&#39;sync&#39;], function () {
    // this task will not start until the sync task is all done!
    console.log(&#39;secondTask is done&#39;);
});
</code></pre>
<p>注意： 默认情况下，依赖任务们会并行执行<br>例如：</p>
<pre><code class="lang-js">gulp.task(&#39;otherTask&#39;,function(){
    //no dependent tasks
    ...
});

//sync,otherTask会同时执行，然后执行default的fn
gulp.task(&#39;default&#39;, [&#39;sync&#39;,&#39;otherTask&#39;], function () {
   // do stuff
});
</code></pre>
<p>解决方案：</p>
<pre><code class="lang-js">gulp.task(&#39;otherTask&#39;,[&quot;sync&quot;],function(){
    //depends on sync
    ...
});
//先执行sync，然后执行otherTask，最后执行default的fn
gulp.task(&#39;default&#39;, [&#39;sync&#39;,&#39;otherTask&#39;], function () {
   // do stuff
});
</code></pre>
<p>书写太麻烦，推荐插件<code>run-sequence</code></p>
<pre><code class="lang-js">var runSequence = require(&#39;run-sequence&#39;);
gulp.task(&#39;some-task&#39;, function() {
    runSequence(
            [&#39;task-1&#39;, &#39;task-2&#39;, &#39;task-3&#39;], // These 3 can be done in parallel
            &#39;task-4&#39;, // ...then just do this
            [&#39;task-5&#39;, &#39;task-5&#39;], // ...then do these things in parallel
            &#39;task-6&#39;, // ...then do this
            // ....
    );
});
</code></pre>
<h3 id="header-5">Vinyl</h3>
<p>vinyl 文件对象 （一种虚拟文件格式）</p>
<ul>
<li>有一个 <code>contents</code> 属性来存放文件内容</li>
<li>内容可以是以下三种形式：<ul>
<li><code>Stream</code></li>
<li><code>Buffer</code></li>
<li><code>null</code></li>
</ul>
</li>
<li>判断 contents 属性存放内容的类型：<ul>
<li><code>isBuffer()</code>: Returns true if file.contents is a Buffer.</li>
<li><code>isStream()</code>: Returns true if file.contents is a Stream.</li>
<li><code>isNull()</code>: Returns true if file.contents is null.</li>
</ul>
</li>
</ul>
<p>Gulp：</p>
<ul>
<li>gulp 中的流，预期操作的是 vinyl 文件对象</li>
<li>不兼容：<ul>
<li>常规流与vinyl文件对象流是不同的</li>
<li>gulp api ,plugin 中操作vinyl对象内容类型（stream，buffer）可能会不同</li>
</ul>
</li>
<li><p>示例</p>
<ul>
<li><code>fs.createReadStream(...)</code> 常规读取流，得到的是数据块（chunk）</li>
<li><p><code>gulp.src(...)</code> 默认得到的是把内容转换成 buffer 的 vinyl 文件对象，而不是数据块（chunk），可以通过设置 <code>buffer: false</code> 选项，可以让 gulp 禁用 buffer</p>
<pre><code class="lang-js">fs.createReadStream(&#39;/usr/share/dict/words&#39;).on(&#39;data&#39;, function(chunk) {  
console.log(&#39;Read %d bytes of data&#39;, chunk.length);
});

输出结果：
&gt; Read 65536 bytes of data
&gt; Read 65536 bytes of data
&gt; Read 65536 bytes of data
&gt; Read 65536 bytes of data
...
</code></pre>
<pre><code class="lang-js">gulp.src(&#39;/usr/share/dict/words&#39;).on(&#39;data&#39;, function(file) {  
console.log(&#39;Read %d bytes of data&#39;, file.contents.length);
});

输出结果：
&gt; Read 2493109 bytes of data
</code></pre>
<pre><code class="lang-js">gulp.src(&#39;/usr/share/dict/words&#39;, {buffer: false}).on(&#39;data&#39;, function(file) {  
var stream = file.contents;
stream.on(&#39;data&#39;, function(chunk) {
  console.log(&#39;Read %d bytes of data&#39;, chunk.length);
});
});

输出结果：
&gt; Read 65536 bytes of data
&gt; Read 65536 bytes of data
&gt; Read 65536 bytes of data
&gt; Read 65536 bytes of data
&gt; ...
</code></pre>
</li>
</ul>
</li>
</ul>
<p>解决流不兼容问题：</p>
<ul>
<li><p>使用第三方插件：</p>
<ul>
<li>vinyl-source-stream：常规流 =&gt; vinyl文件对象(Stream)</li>
<li><p>vinyl-buffer：vinyl文件对象(Stream)  =&gt; vinyl文件对象(Buffer)</p>
<pre><code class="lang-js">var fs=require(&quot;fs&quot;);
var source = require(&#39;vinyl-source-stream&#39;);
var buffer = require(&#39;vinyl-buffer&#39;);
var uglify = require(&#39;gulp-uglify&#39;);

fs.createReadStream(&#39;./src/app.js&#39;)
    .pipe(source(&#39;app.min.js&#39;)) // 常规流 =&gt; vinyl 对象(stream)
    .pipe(buffer())             // vinyl 对象(stream) =&gt; vinyl文件对象(Buffer)
    .pipe(uglify())             // gulp-uglify 只支持处理vinyl文件对象(Buffer)
    .pipe(gulp.dest(&#39;dist/&#39;));

gulp.src(&#39;app.js&#39;, {buffer: false})
    .pipe(buffer())         // vinyl 对象(Stream) =&gt; vinyl文件对象(Buffer)
    .pipe(uglify())
    .pipe(gulp.dest(&#39;dist/&#39;));

gulp.src(&#39;app.js&#39;)
    .pipe(uglify())
    .pipe(gulp.dest(&#39;dist/&#39;));
</code></pre>
</li>
</ul>
</li>
<li><p>使用gulp插件：</p>
<ul>
<li>gulp-buffer：vinyl文件对象(Stream)  =&gt; vinyl文件对象(Buffer)</li>
<li>gulp-streamify：vinyl文件对象(Stream)  =&gt; vinyl文件对象(Buffer) =&gt; 其他处理 =&gt; vinyl文件对象(Stream) </li>
</ul>
</li>
<li><p>使用<code>through2</code>自定义处理</p>
<pre><code class="lang-js">  var modify=modify(opts){
      return through2.obj(function(file,encoding,next){
          //file为上游读流产生的文件数据
          //next用于向下游传递处理后的数据

          console.log(file.path);
          console.log(file.isNull());
          console.log(file.isStream());

          var contents=String(file.contents);
          file.contents=new Buffer(contents);
          next(null,file);     // this.push(file); next();
      });
  }

  fs.createReadStream(&#39;/tmp/important.dat&#39;)
      .pipe(modify())
      .pipe(fs.createWriteStream(&#39;/tmp/out.txt&#39;));

  gulp.src(&#39;/tmp/important.dat&#39;)
          .pipe(modify())
          .pipe(gulp.dest(&#39;dist/&#39;));
</code></pre>
</li>
</ul>
<p>综合测试：</p>
<pre><code class="lang-js">fs.createReadStream(&quot;./posts/articles/&quot;+filename)
    .pipe(source(&quot;2013-11-13-a1.md&quot;))
    .pipe(gulp.dest(&quot;./dist/articles&quot;))
    .pipe(through2.obj(function(file,enc,next){
        console.log(&quot;Now is &quot;+(file.isStream()?&quot;Stream&quot;:&quot;Buffer&quot;));
        next(null,file);
    }))
    .pipe(buffer())
    .pipe(through2.obj(function(file,enc,next){
        console.log(&quot;Now is &quot;+(file.isStream()?&quot;Stream&quot;:&quot;Buffer&quot;));
        next(null,file);
    }))
    ;
</code></pre>
<pre><code class="lang-js">gulp.src(&quot;./posts/articles/????-??-??-*.md&quot;)
    .pipe(through2.obj(function(file,enc,next){
        console.log(file.path);
        console.log(path.basename(file.path,&quot;.md&quot;));
        //console.log(path.basename(file.path));
        if(file.isNull()) {
            console.log(&quot;This file is Empty!&quot;);
        }
        else if(file.isStream()){
            console.log(&quot;This function is not support Stream!&quot;);
        }
        else if (file.isBuffer()){
            console.log(&quot;Do Marked!&quot;);
            var result=marked(String(file.contents));
            console.log(result.props);
            file.contents = Buffer(result.content);
        }
        next(null, file);
    }))
    .pipe(gulp.dest(&quot;./dist/articles&quot;));
</code></pre>
<p><strong>PS:</strong> <code>though2</code>还可以用于自定义gulp插件中</p>
<h3 id="header-6">Doc</h3>
<p><img src="/2015/04/01/gulp-1.png" alt="Gulp"></p>
<p><img src="/2015/04/01/gulp-2.png" alt="Gulp"></p>
<h2 id="header-7">常用插件</h2>
<ul>
<li>css编译器： gulp-sass，gulp-less</li>
<li>file合并：gulp-concat</li>
<li>file最小化：gulp-uglify 压缩js，gulp-minifycss 压缩css，gulp-imagemin 压缩图像</li>
<li>file重命名：gulp-rename</li>
<li>file删除：gulp-clean</li>
<li>静态服务器：gulp-server-livereload</li>
</ul>
<p>使用举例：</p>
<p>重命名，压缩文件：</p>
<pre><code class="lang-js">var rename=require(&quot;gulp-rename&quot;);
var uglify=require(&quot;gulp-uglify&quot;);
gulp.task(&#39;mini&#39;,function(){
    gulp.src(Config.react.dest+&quot;/app.js&quot;)
        .pipe(rename(&quot;app.min.js&quot;))
        .pipe(uglify())
        .pipe(gulp.dest(Config.react.prodDest));
});
</code></pre>
<p>实时编译sass文件：</p>
<pre><code class="lang-js">var sass = require(&#39;gulp-sass&#39;);
function sassBuild(opts,filename){
    if(!filename)
        filename=opts.default;
    var sassOptions = {
      errLogToConsole: true,
      outputStyle: &#39;expanded&#39;,
      loadPath:opts.loadPath
    };
    function build(event){
        if(event)
            console.log(&#39;File &#39; + event.path + &#39; was &#39; + event.type);
        gulp.src(opts.src+filename+&quot;.scss&quot;)
            .pipe(sass(sassOptions).on(&#39;error&#39;, sass.logError))
            //.pipe(concat(&#39;style.css&#39;))
            .pipe(gulp.dest(opts.dest));
    }
    build();
    gulp.watch(Config.sass.src+&quot;**/*.scss&quot;,build)
        /*.on(&quot;change&quot;,function(event){
            console.log(&#39;File &#39; + event.path + &#39; was &#39; + event.type);
        })*/
        ;
}
gulp.task(&#39;sass&#39;, function () {
 sassBuild(Config.sass,argv.n);
});
</code></pre>
<p>架起静态服务器，实时预览：</p>
<pre><code class="lang-js">var server = require(&#39;gulp-server-livereload&#39;);
function server(){
    var filterFun=function(filePath,cb){
       Config.server.filterReg.map(function(reg){
            if((new RegExp(reg)).test(filePath))
                cb(true);
        })
      /*if(/app.js/.test(filePath) || /style.css/.test(filePath)) {
        cb(true)
      } */
    }
    var serverOpts={
        livereload: {
            enable: true,
            filter:filterFun
          },
          open: true
    };
    gulp.src(Config.dist)
        .pipe(server(serverOpts));
}
gulp.task(&#39;server&#39;,function(){
    server();
});
</code></pre>
  </section>
</article>

      <hr/>
      
<section class="post-comment">
	
		<div id="gitment_container"></div>

<link rel="stylesheet" href="/gitment/default.css">
<script src="/gitment/gitment.browser.js"></script>


<script type="text/javascript">
	var gitment = new Gitment({
	  id: document.location.pathname,
	  owner: 'chenjin-zero',
	  repo: 'blogComment',
	  oauth: {
	    client_id: '36a09bb7399efe69c6ce',
	    client_secret: 'ad9ad546b23b708c71d92e513dc36e0486179dea',
	  }
	})
      
	gitment.render('gitment_container')
</script>
	
</section>

    </div>
  </div>
</body>

<script src="/jquery/dist/jquery.min.js"></script>
<script src="/bootstrap/dist/js/bootstrap.min.js"></script>


	<script src="/highlight/highlight.pack.js"></script>
	<script type="text/javascript">
		hljs.initHighlightingOnLoad();
	</script>






<script type="text/javascript">

  $(document).ready(function(){
    var sidebarCtrl=$("#sidebar-ctrl");
    var sidebar=$("#sidebar");
    var wrapper=$("#wrapper");
    sidebarCtrl.on("click",function(event){
        //alert("click");
        sidebar.toggleClass("sidebar-toggle");
        wrapper.toggleClass("sidebar-toggle");
        sidebarCtrl.toggleClass("sidebar-toggle");
        sidebarCtrl.toggleClass("active");
    })
  });
</script>


</html>
