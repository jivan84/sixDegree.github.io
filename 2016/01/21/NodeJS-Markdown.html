<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>基于NodeJS解析Markdown</title>
  
  <!-- Meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="nodejs,markdown,marked,highlight,mathJax,blog">
  
  
    <meta name="description" content="extended functional nodejs marked module to parsing markdown file">
  

  <!-- Feed -->
  
    <link rel="alternative" href="/atom.xml" title="SixDegree" type="application/atom+xml">
  

  <!-- CSS -->
  <link rel="stylesheet" href="/bootstrap/dist/css/bootstrap.css">
  
    <link rel="stylesheet" href="/highlight/demo/styles/tomorrow-night-bright.css">
  
  <link rel="stylesheet" href="/css/fontello.css">
  <link rel="stylesheet" href="/css/style.css">

  <!-- Site Analyse -->
  

</head>

<body data-spy="scroll" data-target="#nav-catalog">
  <div id="top-push"></div>
<a href="#top-push" id="go-top">
	<span class="glyphicon glyphicon-chevron-up"></span>
</a>
  <aside id="sidebar">
    <section class="sidebar-header">Catalog</section>
     <nav id="nav-catalog">
        <ol class="sidebar-nav nav"><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-1"><span class="sidebar-nav nav-text">前言</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-2"><span class="sidebar-nav nav-text">1. 搭建测试环境</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-3"><span class="sidebar-nav nav-text">2. 使用 Marked Cmd</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-4"><span class="sidebar-nav nav-text">3. 使用 Marked API</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-5"><span class="sidebar-nav nav-text">3.1 Minimal usage</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-6"><span class="sidebar-nav nav-text">3.2 Setting options example</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-7"><span class="sidebar-nav nav-text">3.3 Browser</span></a></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-8"><span class="sidebar-nav nav-text">4. Marked 解析说明</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-9"><span class="sidebar-nav nav-text">4.1 解析过程</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-10"><span class="sidebar-nav nav-text">4.2 核心类介绍</span></a></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-11"><span class="sidebar-nav nav-text">5. Marked 扩展</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-12"><span class="sidebar-nav nav-text">5.1 拓展：增加 TOC 功能 ( HeaderAnchor )</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-13"><span class="sidebar-nav nav-text">5.2 拓展：增加解析 MetaHeader</span></a></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-14"><span class="sidebar-nav nav-text">6. HTML 结果页面扩展</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-15"><span class="sidebar-nav nav-text">6.1 使用 Highlight.js 进行语法高亮</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-16"><span class="sidebar-nav nav-text">6.2 增加 LaTex 公式支持</span></a></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-17"><span class="sidebar-nav nav-text">7. Issues</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-18"><span class="sidebar-nav nav-text">7.1 Marked TOC heading id 乱码</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-19"><span class="sidebar-nav nav-text">7.2 Highlight & Markdown Conflict with MathJax</span></a></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-20"><span class="sidebar-nav nav-text">8. 最终版</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-21"><span class="sidebar-nav nav-text">9. 各种Markdown编辑器</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-22"><span class="sidebar-nav nav-text">10. 参考</span></a></li></ol>
    </nav>
  </aside>
  <span id="sidebar-ctrl" class="glyphicon glyphicon-list-alt circle"></span>
  <div id="wrapper">
    <header>
  <nav class="navbar navbar-default">
    <div class="container-fluid">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#nav-menu" aria-expanded="false">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="/">SixDegree</a>
      </div>
      <div class="collapse navbar-collapse" id="nav-menu">
        <ul class="nav navbar-nav navbar-right">
          
              <li  >
                <a href="/">Blogs</a>
              </li>
          
              <li  >
                <a href="/tags.html">Tags</a>
              </li>
          
              <li  >
                <a href="/about.html">About</a>
              </li>
          
          
              <li>
                <a href="/atom.xml" target="_blank">
                  <span class="icon-rss"></span>
                </a>
              </li>
          
              <li>
                <a href="http://github.com/sixdegree" target="_blank">
                  <span class="icon-github"></span>
                </a>
              </li>
          
        </ul>
      </div>
    </div>
  </nav>
</header>



    <div class="container">
      <article class="detail" role="main">
  <section class="post-header">
    <h1 class="post-title">基于NodeJS解析Markdown</h1>
    <ul class="post-meta">
      <li>
        <span class="glyphicon glyphicon-calendar"></span>
        <time datetime="2016-01-20T16:00:00.000Z">2016-01-21</time>
      </li>
      
        <li>
         <span class="glyphicon glyphicon-tags"></span>
          
            <a href="/tags.html#tag-NodeJs">NodeJs</a>
          
        </li>
      
    </ul>
  </section>
  <section class="post-content">
    <h3 id="header-1">前言</h3>
<p>使用nodejs模块marked解析Markdown文章</p>
<ul>
<li><p><strong>优点：</strong> </p>
<ol>
<li>前后端，不同OS 都可使用</li>
<li>开源，易扩展</li>
<li>速度比较快 (通过RegEx匹配解析)</li>
</ol>
</li>
<li><p><strong>应用举例：</strong></p>
<ol>
<li>作为markdown编辑器<ul>
<li>网上各个markdown编辑器的规则、功能、风格、依赖平台等都有不统一，导出不理想，自定制有局限，无法做扩展</li>
</ul>
</li>
<li>自由加入各个开发项目中<ul>
<li>static site generator</li>
<li>online editor</li>
<li>…</li>
</ul>
</li>
</ol>
</li>
</ul>
<h3 id="header-2">1. 搭建测试环境</h3>
<pre><code class="nullvim">&gt; <span class="built_in">mkdir</span> node-marked
&gt; <span class="keyword">cd</span> node-marked
&gt; npm init
&gt; npm install marked --save-dev
&gt; npm install <span class="keyword">highlight</span>.js --save-dev
</code></pre>
<h3 id="header-3">2. 使用 Marked Cmd</h3>
<pre><code class="nullvim">&gt; npm install marked -g
&gt; marked -i articles/01.md
&gt; marked -i articles/01.md -t
&gt; marked -i articles/01.md -o pages/01.html
</code></pre>
<p><strong>参数说明</strong></p>
<ul>
<li><strong>-o, –output</strong>: 指定输出文件，默认为当前控制台</li>
<li><strong>-i, –input</strong>: 指定输入文件或最后一个参数，默认为当前控制台输入</li>
<li><strong>-t, –tokens</strong>: 输出token流代替HTML</li>
<li><strong>–pedantic</strong>: 只解析符合markdown.pl定义的，不修正markdown的错误</li>
<li><strong>–gfm</strong>: 启动Github样式的Markdown，参考 <a href="http://help.github.com/articles/github-flavored-markdown/">github-flavored-markdown</a></li>
<li><strong>–breaks</strong>: 支持Github换行符，必须打开gfm选项</li>
<li><strong>–tables</strong>: 支持Github表格，必须打开gfm选项</li>
<li><strong>–sanitize</strong>: 原始输出，忽略HTML标签</li>
<li><strong>–smart-lists</strong>: 优化列表输出</li>
<li><strong>–lang-prefix [prefix]</strong>: 设置前置样式</li>
<li><strong>–no-etc</strong>: 选择的反正标识</li>
<li><strong>–silent</strong>: 不输出错误信息</li>
<li><strong>-h, –help</strong>: 帮助信息</li>
</ul>
<h3 id="header-4">3. 使用 Marked API</h3>
<p><strong>API</strong>  具体可参考 <a href="https://github.com/chjj/marked">GitHub Marked</a></p>
<pre><code class="nulljavascript">marked(markdownString [,options] [,callback])
</code></pre>
<h4 id="header-5">3.1 Minimal usage</h4>
<pre><code class="nulljavascript"><span class="keyword">var</span> marked=<span class="built_in">require</span>(<span class="string">"marked"</span>);
<span class="built_in">console</span>.log(marked(<span class="string">"I am using marked api!"</span>));
</code></pre>
<pre><code class="nullvim">&gt; node <span class="number">01</span>
<span class="symbol">&lt;p&gt;</span>I <span class="keyword">am</span> using marked api!&lt;/<span class="keyword">p</span>&gt;
</code></pre>
<h4 id="header-6">3.2 Setting options example</h4>
<pre><code class="nulljavascript"><span class="keyword">var</span> marked=<span class="built_in">require</span>(<span class="string">"marked"</span>);
<span class="keyword">var</span> highlight=<span class="built_in">require</span>(<span class="string">"highlight.js"</span>);
marked.setOptions({
    gfm: <span class="literal">true</span>,
    tables: <span class="literal">true</span>,
    breaks: <span class="literal">true</span>,
    pedantic: <span class="literal">false</span>,
    sanitize: <span class="literal">false</span>,
    smartLists: <span class="literal">true</span>,
    smartypants: <span class="literal">false</span>,
    codePrefix:<span class="string">"hljs"</span>,
    tableClass:<span class="string">"table"</span>,
    highlight:<span class="function"><span class="keyword">function</span> (<span class="params">code,lang</span>) </span>{
        <span class="keyword">return</span> highlight.highlightAuto(code,[lang]).value;
    }
});
<span class="built_in">console</span>.log(marked(markdownString));
</code></pre>
<pre><code class="nullvim">&gt; node 01
&lt;h3 id="i-am-using-marked-api-"&gt;I am using marked api!&lt;/h3&gt;
&lt;pre&gt;&lt;code class="lang-js"&gt; &lt;span class="hljs-built_in"&gt;console&lt;/span&gt;.log(&lt;span class="hljs-string"&gt;'Hello world!'&lt;/span&gt;);
&lt;/code&gt;&lt;/pre&gt;
</code></pre>
<h4 id="header-7">3.3 Browser</h4>
<pre><code class="nullhtml"><span class="meta">&lt;!doctype html&gt;</span>
<span class="tag">&lt;<span class="name">html</span>&gt;</span>
<span class="tag">&lt;<span class="name">head</span>&gt;</span>
  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>/&gt;</span>
  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Marked in the browser<span class="tag">&lt;/<span class="name">title</span>&gt;</span>
  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"lib/marked.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>
<span class="tag">&lt;/<span class="name">head</span>&gt;</span>
<span class="tag">&lt;<span class="name">body</span>&gt;</span>
  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"content"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span>
  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">
    <span class="built_in">document</span>.getElementById(<span class="string">'content'</span>).innerHTML =
      marked(<span class="string">'# Marked in browser\n\nRendered by **marked**.'</span>);
  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>
<span class="tag">&lt;/<span class="name">body</span>&gt;</span>
<span class="tag">&lt;/<span class="name">html</span>&gt;</span>
</code></pre>
<hr>
<h3 id="header-8">4. Marked 解析说明</h3>
<pre><code class="nulljavascript"><span class="function"><span class="keyword">function</span> <span class="title">marked</span>(<span class="params">src,opt,callback</span>)</span>{
    ...
    opt = merge({}, marked.defaults, opt);
    ...
    tokens = Lexer.lex(src, opt);
    ...
    out=Parser.parse(tokens,opt);
    ...
}
</code></pre>
<h4 id="header-9">4.1 解析过程</h4>
<ol>
<li><strong>Lexer</strong>: Block Level Render =&gt; tokens</li>
<li><strong>Parser</strong>: Parse tokens =&gt; html<br> each token =&gt; <strong>Render</strong> &amp;&amp; <strong>InlineLexer</strong>(Inline Level Render ) =&gt; html</li>
</ol>
<h4 id="header-10">4.2 核心类介绍</h4>
<p><strong>1. Lexer ( Block Level Render )</strong></p>
<pre><code class="nulljavascript"><span class="keyword">var</span> block={...}        <span class="comment">//定义块级解析规则（正则表达式）</span>
<span class="comment">//newline,code,fences,hr,heading,nptable,lheading,blockquote,list,html,def,table,paragraph,text</span>

Lexer.rules=block;
Lexer.lex = <span class="function"><span class="keyword">function</span>(<span class="params">src, options</span>) </span>{
  <span class="keyword">var</span> lexer = <span class="keyword">new</span> Lexer(options);
  <span class="keyword">return</span> lexer.lex(src);
};

Lexer.prototype.lex         <span class="comment">//调用 Lexer.prototype.token</span>
Lexer.prototype.token       <span class="comment">//根据rules解析返回tokens数组</span>
</code></pre>
<p><strong>2. Parser ( Parse Tokens to HTML )</strong></p>
<pre><code class="nulljavascript">Parser.parse = <span class="function"><span class="keyword">function</span>(<span class="params">tokens, options, renderer</span>) </span>{
  <span class="keyword">var</span> parser = <span class="keyword">new</span> Parser(options, renderer);
  <span class="keyword">return</span> parser.parse(tokens);
};

Parser.prototype.parse    <span class="comment">//调用 Parser.prototype.tok 逐个解析token</span>
Parser.prototype.tok      <span class="comment">//根据token.type调用Render的相应方法进行渲染 </span>
ps: 有些token在调用Render渲染前会预先调用InlineLex进行预处理
</code></pre>
<p><strong>3. Render ( Render Each Token to HTML )</strong></p>
<pre><code class="nulljavascript">Renderer.prototype.code
Renderer.prototype.blockquote
Renderer.prototype.html
Renderer.prototype.heading
Renderer.prototype.hr
Renderer.prototype.list
Renderer.prototype.listitem
Renderer.prototype.paragraph
Renderer.prototype.table 
Renderer.prototype.tablerow
Renderer.prototype.tablecell
Renderer.prototype.strong
Renderer.prototype.em
Renderer.prototype.codespan
Renderer.prototype.br
Renderer.prototype.del
Renderer.prototype.link
Renderer.prototype.image
Renderer.prototype.text
</code></pre>
<p><strong>4. InlineLexer ( Inline Level Renderer )</strong></p>
<pre><code class="nulljavascript"><span class="keyword">var</span> inline={...}     <span class="comment">//定义行级解析规则（正则表达式）</span>
<span class="comment">//escape,autolink,url,tag,link,reflink,nolink,strong,em,code,br,del,text</span>

InlineLexer.rules = inline;
InlineLexer.output = <span class="function"><span class="keyword">function</span>(<span class="params">src, links, options</span>) </span>{
  <span class="keyword">var</span> inline = <span class="keyword">new</span> InlineLexer(links, options);
  <span class="keyword">return</span> inline.output(src);
};

InlineLexer.prototype.output     <span class="comment">//根据rules解析，返回字符串</span>
ps: 有些匹配项会调用Render的相应方法进行渲染
</code></pre>
<hr>
<h3 id="header-11">5. Marked 扩展</h3>
<blockquote>
<p>在了解了marked的解析过程后，<br>对于一些无法通过marked本身提供的配置选项完成的特殊功能，<br>可以自己在上面拓展一些功能（这也是会选择marked的原因之一）</p>
<p><strong>这里列举两个比较常用的拓展:</strong></p>
<ul>
<li>增加<code>TOC(HeaderAnchor)</code>功能；</li>
<li>增加解析<code>meta</code>功能；</li>
</ul>
</blockquote>
<h4 id="header-12">5.1 拓展：增加 TOC 功能 ( HeaderAnchor )</h4>
<pre><code class="nullmarkdown">[TOC]
</code></pre>
<p><strong>1. Lexer</strong></p>
<pre><code class="nulljavascript"><span class="keyword">var</span> block = {
    ...
     toc: <span class="regexp">/^\[TOC\]\n/</span>,
};

Lexer.prototype.token = <span class="function"><span class="keyword">function</span>(<span class="params">src, top, bq</span>) </span>{
    ...
    var tocIndex=<span class="number">-1</span>;
    <span class="keyword">while</span>(src){
        ...
        if(cap=<span class="keyword">this</span>.rules.toc.exec(src)){
            <span class="comment">//console.log("token toc");</span>
            src = src.substring(cap[<span class="number">0</span>].length);
            <span class="keyword">this</span>.tokens.push({type:<span class="string">'toc'</span>});
            tocIndex=<span class="keyword">this</span>.tokens.length<span class="number">-1</span>;
            <span class="keyword">continue</span>;
        }
        ...
    }
    <span class="keyword">if</span>(tocIndex&gt;=<span class="number">0</span>){
        <span class="keyword">var</span> toc=[];
        <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;<span class="keyword">this</span>.tokens.length;i++){
          <span class="keyword">if</span>(<span class="keyword">this</span>.tokens[i].type===<span class="string">'heading'</span>)
            toc.push(<span class="keyword">this</span>.tokens[i]);
        }
        <span class="keyword">this</span>.tokens[tocIndex]={type:<span class="string">"toc"</span>,datas:toc};
    }
    <span class="keyword">return</span> <span class="keyword">this</span>.tokens;
};
</code></pre>
<p><strong>2. Parser</strong></p>
<pre><code class="nulljavascript">Parser.prototype.tok = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{
  <span class="keyword">switch</span> (<span class="keyword">this</span>.token.type){
    <span class="keyword">case</span> <span class="string">'toc'</span>:{
      <span class="comment">//console.log("parse toc");</span>
      <span class="keyword">var</span> datas=<span class="keyword">this</span>.token.datas;
      <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;datas.length;i++){
        datas[i].raw=datas[i].text;
        datas[i].text=<span class="keyword">this</span>.inline.output(datas[i].text);
      }
      <span class="keyword">return</span> <span class="keyword">this</span>.renderer.toc(datas);
    }
    ...
  }
};
</code></pre>
<p><strong>3. Render</strong></p>
<pre><code class="nulljavascript">Renderer.prototype.toc = <span class="function"><span class="keyword">function</span>(<span class="params">datas</span>) </span>{
  <span class="comment">//console.log("render toc");</span>
  <span class="keyword">var</span> tocStr=<span class="string">''</span>,indentStr=<span class="string">''</span>,item=<span class="literal">undefined</span>;
  <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;datas.length;i++){
    item=datas[i];
    indentStr=<span class="string">''</span>;
    <span class="keyword">for</span>(<span class="keyword">var</span> j=<span class="number">0</span>;j&lt;item.depth<span class="number">-1</span>;j++)
        indentStr+=<span class="string">'&amp;nbsp;&amp;nbsp;'</span>;
    <span class="keyword">var</span> id=<span class="keyword">this</span>.options.headerPrefix+item.raw.toLowerCase().replace(<span class="regexp">/[^\w]+/g</span>, <span class="string">'-'</span>);
    tocStr+=<span class="string">"&lt;li&gt;"</span>+indentStr+<span class="string">"&lt;a href='#"</span>+id+<span class="string">"'&gt;"</span>+item.text+<span class="string">"&lt;/a&gt;&lt;/li&gt;"</span>;
  }
  <span class="keyword">return</span> <span class="keyword">this</span>.list(tocStr,<span class="literal">false</span>);
};
</code></pre>
<p><strong>4. 使用示例</strong></p>
<pre><code class="nulljavascript"><span class="keyword">var</span> marked=<span class="built_in">require</span>(<span class="string">"./marked-extend"</span>);
<span class="keyword">var</span> fs=<span class="built_in">require</span>(<span class="string">"fs"</span>);
fs.readFile(<span class="string">"articles/01.md"</span>,<span class="string">'utf8'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">err,data</span>)</span>{
    <span class="keyword">var</span> result=marked(data);
    fs.writeFile(<span class="string">"pages/01-1.html"</span>,result);
});
</code></pre>
<h4 id="header-13">5.2 拓展：增加解析 MetaHeader</h4>
<pre><code class="nullmarkdown">--- 
title: 用Middleman搭建静态博客
tags: web, static
<span class="section">description: Build Static Blog by Middleman
---</span>
</code></pre>
<p><strong>1. Lexer</strong></p>
<pre><code class="nulljavascript"><span class="keyword">var</span> block = {
    ...
    meta:<span class="regexp">/^-{3,}\s*?\n([\s\S]*?)\n-{3,}/</span>, 
    metaItem:<span class="regexp">/(\S+)\s*?:\s*([\s\S]*?)(?=$|\n)/g</span>,
};

Lexer.prototype.token = <span class="function"><span class="keyword">function</span>(<span class="params">src, top, bq</span>) </span>{
    ...
    var tocIndex=<span class="number">-1</span>;
    <span class="keyword">while</span>(src){
        ...
        if(cap=<span class="keyword">this</span>.rules.meta.exec(src)){
            src=src.substring(cap[<span class="number">0</span>].length);
            <span class="keyword">var</span> meta={};
            <span class="keyword">while</span>((item=<span class="keyword">this</span>.rules.metaItem.exec(cap[<span class="number">1</span>]))!=<span class="literal">null</span>){
                <span class="comment">//console.log(item[1]+":"+item[2]);</span>
                meta[item[<span class="number">1</span>]]=item[<span class="number">2</span>];
            }
            <span class="keyword">this</span>.tokens.push({type:<span class="string">"meta"</span>,datas:meta});
            <span class="keyword">continue</span>;
        }
        ...
    }
    <span class="keyword">return</span> <span class="keyword">this</span>.tokens;
};

Lexer.prototype.getToken=<span class="function"><span class="keyword">function</span>(<span class="params">tokens,type</span>)</span>{
    <span class="keyword">var</span> token=<span class="literal">undefined</span>;
    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;tokens.length;i++){
        <span class="keyword">if</span>(tokens[i].type===type){
          token=tokens[i];
          <span class="keyword">break</span>;
        }
    }
    <span class="keyword">return</span> token;
};
<span class="comment">// Static Method</span>
Lexer.getToken=Lexer.prototype.getToken;
</code></pre>
<p><strong>2. Parser</strong></p>
<pre><code class="nulljavascript">Parser.prototype.tok = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{
  <span class="keyword">switch</span> (<span class="keyword">this</span>.token.type){
    <span class="keyword">case</span> <span class="string">'meta'</span>:{
        <span class="keyword">return</span> <span class="string">""</span>;
    }
    ...
  }
};
</code></pre>
<p><strong>3. 使用示例</strong></p>
<pre><code class="nulljavascript"><span class="keyword">var</span> marked=<span class="built_in">require</span>(<span class="string">"./marked-extend"</span>);
<span class="keyword">var</span> fs=<span class="built_in">require</span>(<span class="string">"fs"</span>);
fs.readFile(<span class="string">"articles/01.md"</span>,<span class="string">'utf8'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">err,data</span>)</span>{
    <span class="keyword">var</span> Lexer=marked.Lexer;
    <span class="keyword">var</span> lexer=<span class="keyword">new</span> Lexer();
    <span class="keyword">var</span> tokens=lexer.lex(data);

    <span class="keyword">var</span> tocToken=lexer.getToken(tokens,<span class="string">"toc"</span>);
    <span class="built_in">console</span>.log(<span class="string">"toc:"</span>);
    <span class="built_in">console</span>.log(tocToken);

    <span class="keyword">var</span> metaToken=lexer.getToken(tokens,<span class="string">"meta"</span>);
    <span class="built_in">console</span>.log(<span class="string">"meta:"</span>);
    <span class="built_in">console</span>.log(metaToken);

    <span class="keyword">var</span> result=marked.parser(tokens);
    fs.writeFile(<span class="string">"pages/01-2.html"</span>,result);
});
</code></pre>
<hr>
<h3 id="header-14">6. HTML 结果页面扩展</h3>
<h4 id="header-15">6.1 使用 Highlight.js 进行语法高亮</h4>
<p><strong>1.Highlight介绍</strong> ( 参考 <a href="https://highlightjs.org/static/demo/">LiveDemo</a> | <a href="https://highlightjs.org/usage/">Usage</a> | <a href="http://highlightjs.readthedocs.org/en/latest/">Doc&amp;API</a> )</p>
<p><strong>使用在线Highligh</strong> ( 可在线定制，参考 <a href="https://highlightjs.org/download/">Getting highlight.js</a>,<a href="https://cdnjs.com/libraries/highlight.js/">CDN highlight.js</a> )</p>
<pre><code class="nullhtml"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">href</span>=<span class="string">"http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/styles/default.min.css"</span> /&gt;</span>

<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/highlight.min.js"</span>/&gt;</span><span class="handlebars"><span class="xml">
<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/languages/markdown.min.js"</span>&gt;</span><span class="undefined"></span></span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>
<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined">
    hljs.initHighlightingOnLoad();
</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>
</code></pre>
<p><strong>使用本地构建的Highligh</strong></p>
<pre><code class="nullvim">&gt; bower install <span class="keyword">highlight</span> --save-dev
&gt; <span class="keyword">cd</span> bower_components/<span class="keyword">highlight</span>

//构建Highligh
&gt; npm install
&gt; node tools/build.js -t <span class="keyword">all</span>    // build <span class="keyword">all</span> [ node cdn  browser]
（或者只构建browser，使用 node tools/build.js -t browser）
</code></pre>
<p><strong>PS:</strong> 若执行报类似如下错误，请升级node，或下载highlight#8 ( bower install highlight#8 )</p>
<pre><code class="nullvim">build     = require(`./${commander.target}`);
                    ^
SyntaxError: Unexpected token ILLEGAL
    at Module._compile (module.js:439:25)
    at Object.Module._extensions..js (module.js:474:10)
    at Module.load (module.js:356:32)
    at Function.Module._load (module.js:312:12)
    at Function.Module.runMain (module.js:497:10)
    at startup (node.js:119:16)
    at node.js:902:3
</code></pre>
<pre><code class="nullhtml">使用构建的browser highlight
<span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">href</span>=<span class="string">"../bower_components/highlight/build/browser/demo/styles/default.css"</span> /&gt;</span>

<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"../bower_components/highlight/build/browser/highlight.pack.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>
<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined">
    hljs.initHighlightingOnLoad();
</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>
</code></pre>
<p><strong>PS:</strong> </p>
<ul>
<li>构建出的node highlight 和通过 npm install highlight.js 获取的highlight是一致的</li>
<li>要在前端网页中使用node highlight，还需通过browserify插件转换 （具体使用可参考gulp篇）</li>
</ul>
<p><strong>2. 在Marked中使用highlight.js</strong></p>
<p>前端只加载highlight css文件</p>
<pre><code class="nullhtml"><span class="meta">&lt;!DOCTYPE html&gt;</span>
<span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span>
<span class="tag">&lt;<span class="name">head</span>&gt;</span>
  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span>
  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Marked Highlight<span class="tag">&lt;/<span class="name">title</span>&gt;</span>
  <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">href</span>=<span class="string">"../bower_components/highlight/build/browser/demo/styles/tomorrow-night-bright.css"</span> /&gt;</span>
<span class="tag">&lt;/<span class="name">head</span>&gt;</span>
<span class="tag">&lt;<span class="name">body</span>&gt;</span>
    {content}
<span class="tag">&lt;/<span class="name">body</span>&gt;</span>
<span class="tag">&lt;/<span class="name">html</span>&gt;</span>
</code></pre>
<p>后端调用highlight解析markdown的code内容</p>
<pre><code class="nulljavascript"><span class="keyword">var</span> marked=<span class="built_in">require</span>(<span class="string">"./marked-extend"</span>);
<span class="keyword">var</span> fs=<span class="built_in">require</span>(<span class="string">"fs"</span>);
<span class="keyword">var</span> highlight=<span class="built_in">require</span>(<span class="string">"highlight.js"</span>);

marked.setOptions({
    langPrefix:<span class="string">"hljs "</span>,
    highlight:<span class="function"><span class="keyword">function</span> (<span class="params">code,lang</span>) </span>{
        <span class="keyword">return</span> highlight.highlightAuto(code,[lang]).value;
    }
});

fs.readFile(<span class="string">"articles/test.md"</span>,<span class="string">'utf8'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">err,data</span>)</span>{
    <span class="keyword">var</span> result=marked(data);
    <span class="keyword">var</span> tpl=fs.readFileSync(<span class="string">"template/highlight-03.html"</span>,<span class="string">'utf-8'</span>);
    fs.writeFile(<span class="string">"pages/highlight-03.html"</span>,tpl.replace(<span class="string">"{content}"</span>,result));
});
</code></pre>
<p><strong>3.调用区别</strong></p>
<ul>
<li>前端调用<code>hljs.initHighlightingOnLoad();</code>  识别解析<code>&lt;pre&gt;&lt;code&gt;...&lt;/code&gt;&lt;/pre&gt;</code>块<ul>
<li>若无language设置，则自动识别添加一种languange<br>  <code>&lt;pre&gt;&lt;code class=&quot;hljs html&quot;&gt;...&lt;/code&gt;&lt;/pre&gt;</code></li>
<li>若有languange设置<ul>
<li>是已注册的languange，则使用相应的languange js进行解析<br><code>&lt;pre&gt;&lt;code class=&quot;hljs javascript&quot;&gt;...&lt;/code&gt;&lt;/pre&gt;</code></li>
<li>是未注册的languange，则不解析<br><code>&lt;pre&gt;&lt;code class=&quot;nohighlight&quot;&gt;...&lt;/code&gt;&lt;/pre&gt;</code></li>
</ul>
</li>
</ul>
</li>
<li>后端marked解析code<ul>
<li>若无languange设置，则不会在<code>&lt;code&gt;</code>标签上增加class</li>
<li>若有languange设置，则会在<code>&lt;code&gt;</code>标签上增加class（langPrefix+languange）</li>
</ul>
</li>
</ul>
<pre><code class="nulljavascript">Renderer.prototype.code = <span class="function"><span class="keyword">function</span>(<span class="params">code, lang, escaped</span>) </span>{
  <span class="keyword">if</span> (<span class="keyword">this</span>.options.highlight) {
    <span class="keyword">var</span> out = <span class="keyword">this</span>.options.highlight(code, lang);
    <span class="keyword">if</span> (out != <span class="literal">null</span> &amp;&amp; out !== code) {
      escaped = <span class="literal">true</span>;
      code = out;
    }
  }

  <span class="keyword">if</span> (!lang) {
    <span class="keyword">return</span> <span class="string">'&lt;pre&gt;&lt;code&gt;'</span>+ (escaped ? code : <span class="built_in">escape</span>(code, <span class="literal">true</span>)) + <span class="string">'\n&lt;/code&gt;&lt;/pre&gt;'</span>;
  }

  <span class="keyword">return</span> <span class="string">'&lt;pre&gt;&lt;code class="'</span>
    + <span class="keyword">this</span>.options.langPrefix
    + <span class="built_in">escape</span>(lang, <span class="literal">true</span>)
    + <span class="string">'"&gt;'</span>
    + (escaped ? code : <span class="built_in">escape</span>(code, <span class="literal">true</span>))
    + <span class="string">'\n&lt;/code&gt;&lt;/pre&gt;\n'</span>;
};
</code></pre>
<p><strong>PS: </strong> 可以修改前后端以统一两种调用highlight的效果</p>
<h4 id="header-16">6.2 增加 LaTex 公式支持</h4>
<p>使用 MathJax （参考 <a href="http://mlworks.cn/posts/introduction-to-mathjax-and-latex-expression/">LaTex</a>,<a href="http://mathjax-chinese-doc.readthedocs.org/en/latest/configuration.html">MathJax Doc</a>）</p>
<pre><code class="nullhtml">//从CDN加载MathJax
<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>
<span class="attr">src</span>=<span class="string">"https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"</span>&gt;</span><span class="undefined">
</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>
//或加载通过bower install MathJax --save-dev 获取到本地的MathJax
 <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"../bower_components/MathJax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>

//可添加配置，eg：
<span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/x-mathjax-config"</span>&gt;</span><span class="undefined">
    MathJax.Hub.Config({
    ...
    });
</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>
</code></pre>
<hr>
<h3 id="header-17">7. Issues</h3>
<h4 id="header-18">7.1 Marked TOC heading id 乱码</h4>
<blockquote>
<p>marked中解析出的<code>&lt;hx&gt;</code>标签id生成规则为：<br><code>this.options.headerPrefix+ raw.toLowerCase().replace(/[^\w]+/g, &#39;-&#39;)</code><br>( 将文本中空格替换为<code>-</code> )</p>
<p>若是中文或其他特殊字符会导致难以Anchor</p>
</blockquote>
<p><strong>自定义<code>h</code>标签的id生成规则：</strong></p>
<p><strong>1.Lexer</strong></p>
<pre><code class="nulljavascript">Lexer.prototype.token = <span class="function"><span class="keyword">function</span>(<span class="params">src, top, bq</span>) </span>{
    ...
    while(src){
        ...
    }
     <span class="keyword">if</span>(tocIndex&gt;=<span class="number">0</span> || <span class="keyword">this</span>.options.reHeader){
        <span class="keyword">var</span> toc=[];
        <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;<span class="keyword">this</span>.tokens.length;i++){
          <span class="keyword">if</span>(<span class="keyword">this</span>.tokens[i].type===<span class="string">'heading'</span>){
            toc.push(<span class="keyword">this</span>.tokens[i]);
            <span class="keyword">this</span>.tokens[i].index=toc.length;   <span class="comment">// add heading index</span>
          }
        }
        <span class="keyword">this</span>.tokens[tocIndex]={type:<span class="string">"toc"</span>,datas:toc};
    }
    <span class="keyword">return</span> <span class="keyword">this</span>.tokens;
};
</code></pre>
<p><strong>2.Parser</strong></p>
<pre><code class="nulljavascript">Parser.prototype.tok = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{
     <span class="keyword">switch</span> (<span class="keyword">this</span>.token.type) {
        ...
        case <span class="string">'heading'</span>: {
          <span class="keyword">return</span> <span class="keyword">this</span>.renderer.heading(
            <span class="keyword">this</span>.inline.output(<span class="keyword">this</span>.token.text),
            <span class="keyword">this</span>.token.depth,
            <span class="keyword">this</span>.token.text,<span class="keyword">this</span>.token.index);  <span class="comment">// add heading index</span>
        }
        ...
    }
}
</code></pre>
<p><strong>3.Render</strong></p>
<pre><code class="nulljavascript">Renderer.prototype.heading = <span class="function"><span class="keyword">function</span>(<span class="params">text, level, raw, index</span>) </span>{
  <span class="keyword">return</span> <span class="string">'&lt;h'</span>+ level
    + <span class="string">' id="'</span>
    + <span class="keyword">this</span>.options.headerPrefix
    <span class="comment">//+ raw.toLowerCase().replace(/[^\w]+/g, '-')</span>
    + (index?index:raw.toLowerCase().replace(<span class="regexp">/[^\w]+/g</span>, <span class="string">'-'</span>))
    + <span class="string">'"&gt;'</span>
    + text+ <span class="string">'&lt;/h'</span>+ level+ <span class="string">'&gt;\n'</span>;
};
Renderer.prototype.toc = <span class="function"><span class="keyword">function</span>(<span class="params">datas</span>) </span>{
    ...
    <span class="comment">//var id=this.options.headerPrefix+item.raw.toLowerCase().replace(/[^\w]+/g, '-');</span>
    <span class="keyword">var</span> id=<span class="keyword">this</span>.options.headerPrefix+(item.index?item.index:item.raw.toLowerCase().replace(<span class="regexp">/[^\w]+/g</span>, <span class="string">'-'</span>));
    ...
};
</code></pre>
<h4 id="header-19">7.2 Highlight &amp; Markdown Conflict with MathJax</h4>
<p><strong>1.约定markdown中的LaxTex公式</strong><br>含有LaxTex公式的包含在<code>&lt;pre&gt;&lt;/pre&gt;</code> 标签中</p>
<p><strong>2. 添加MathJax配置</strong></p>
<pre><code class="nullhtml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/x-mathjax-config"</span>&gt;</span><span class="actionscript">
    MathJax.Hub.Config({
          tex2jax: {
              <span class="comment">//skipTags remove 'pre' entry</span>
              skipTags: [<span class="string">'script'</span>, <span class="string">'noscript'</span>, <span class="string">'style'</span>, <span class="string">'textarea'</span>,<span class="string">'code'</span>]
        }
    });
</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>
</code></pre>
<hr>
<h3 id="header-20">8. 最终版</h3>
<ul>
<li>项目源码 <a href="https://github.com/sixDegree/node-marked">github</a></li>
</ul>
<h3 id="header-21">9. 各种Markdown编辑器</h3>
<ul>
<li>Windos版，推荐 <a href="http://pad.haroopress.com/">Haroopad</a></li>
<li>OS X 版，推荐 <a href="http://pad.haroopress.com/">Haroopad</a>,<a href="http://macdown.uranusjr.com/">MacDown</a>,<a href="http://www.textnutwriter.com/">TextNut</a></li>
<li>Online版，推荐 <a href="http://www.jianshu.com/p/b3QtRo">简书</a>，<a href="https://maxiang.io/">马克飞象</a></li>
<li>如果不嫌麻烦，也可以使用sublime+plugin自定制</li>
</ul>
<h3 id="header-22">10. 参考</h3>
<ul>
<li>markdown<ul>
<li><a href="http://lutaf.com/markdown-simple-usage.htm">markdown 简明语法</a></li>
<li><a href="http://sspai.com/25137">认识与入门 Markdown</a></li>
</ul>
</li>
<li>marked<ul>
<li><a href="https://github.com/chjj/marked">chjj/marked</a></li>
<li><a href="http://blog.fens.me/nodejs-markdown-marked/">Marked高效的Markdown解析器</a></li>
<li><a href="http://sentsin.com/web/1151.html">动手开发更好用的markdown编辑器-07扩展语法</a></li>
</ul>
</li>
<li>markdown editor<ul>
<li><a href="http://www.williamlong.info/archives/4319.html">好用的Markdown编辑器一览</a></li>
<li><a href="http://www.jianshu.com/p/6c157af09e84">Mac 下两款 Markdown 编辑器 Mou/MacDown 大 PK</a></li>
<li><a href="http://blog.leanote.com/post/54bfa17b8404f03097000000">近乎完美的 Markdown 写作体验 - Sublime Text 3 + OmniMarkupPreviewer</a></li>
</ul>
</li>
<li>highlight<ul>
<li><a href="http://blog.csdn.net/spy19881201/article/details/38866033">代码高亮 highlightjs 使用文档</a></li>
<li><a href="https://highlightjs.org/">highlightjs org</a></li>
<li><a href="http://highlightjs.readthedocs.org">highlightjs doc</a></li>
</ul>
</li>
<li>mathJax<ul>
<li><a href="http://mlworks.cn/posts/introduction-to-mathjax-and-latex-expression/">Mathjax与LaTex公式简介</a></li>
<li><a href="https://www.mathjax.org/">Mathjax org</a></li>
<li><a href="http://docs.mathjax.org/en/latest/start.html">Mathjax doc</a></li>
<li><a href="http://mathjax-chinese-doc.readthedocs.org/en/latest/configuration.html">加载和配置MathJax</a></li>
</ul>
</li>
</ul>
  </section>
</article>

      <hr/>
      <section class="post-comment">
	<!-- disqus默认将数据加载到id为'disqus_thread'的容器中，可配置disqus_container_id改变-->
<div id="disqus_thread"> 
	<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

	<script type="text/javascript">
		var disqus_shortname = 'sixdegreespace'; 
		var disqus_identifier = '2016/01/21/NodeJS-Markdown.html';	
		var disqus_title = '基于NodeJS解析Markdown';
		var disqus_url = 'http://sixdegree.github.io/2016/01/21/NodeJS-Markdown.html' ;
		//var disqus_category_id = '4262241'; 

		(function() {
		    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
		})();
	</script>


 
</section>
    </div>
  </div>
</body>

<script src="/jquery/dist/jquery.min.js"></script>
<script src="/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/highlight/highlight.pack.js"></script>
<script type="text/javascript">
  hljs.initHighlightingOnLoad();
  
  $(document).ready(function(){
    var sidebarCtrl=$("#sidebar-ctrl");
    var sidebar=$("#sidebar");
    var wrapper=$("#wrapper");
    sidebarCtrl.on("click",function(event){
        //alert("click");
        sidebar.toggleClass("sidebar-toggle");
        wrapper.toggleClass("sidebar-toggle");
        sidebarCtrl.toggleClass("sidebar-toggle");
        sidebarCtrl.toggleClass("active");
    })
  });
</script>


</html>
