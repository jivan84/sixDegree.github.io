<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ReactJS高阶之Flux</title>
  
  <!-- Meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="reactJs,flux,reflux,redux">
  
  
    <meta name="description" content="introduce react flux">
  

  <!-- Feed -->
  
    <link rel="alternative" href="/atom.xml" title="SixDegree" type="application/atom+xml">
  

  <!-- CSS -->
  <link rel="stylesheet" href="/bootstrap/dist/css/bootstrap.css">
  
    <link rel="stylesheet" href="/highlight/demo/styles/tomorrow-night-bright.css">
  
  <link rel="stylesheet" href="/css/fontello.css">
  <link rel="stylesheet" href="/css/style.css">

  <!-- Site Analyse -->
  
	<script>
	var userID='2bbb83cc0f781dd7502e9d5e19661866';
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?"+userID;
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>


</head>

<body data-spy="scroll" data-target="#nav-catalog">
  <div id="top-push"></div>
<a href="#top-push" id="go-top">
	<span class="glyphicon glyphicon-chevron-up"></span>
</a>
  <aside id="sidebar">
    <section class="sidebar-header">Catalog</section>
     <nav id="nav-catalog">
        <ol class="sidebar-nav nav"><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#header-1"><span class="sidebar-nav nav-text">Flux</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#header-2"><span class="sidebar-nav nav-text">Reflux</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#header-3"><span class="sidebar-nav nav-text">Redux</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-4"><span class="sidebar-nav nav-text">基本使用示例</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-5"><span class="sidebar-nav nav-text">高阶使用示例</span></a></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#header-6"><span class="sidebar-nav nav-text">Reference</span></a></li></ol>
    </nav>
  </aside>
  <span id="sidebar-ctrl" class="glyphicon glyphicon-list-alt circle"></span>
  <div id="wrapper">
    <header>
  <nav class="navbar navbar-default">
    <div class="container-fluid">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#nav-menu" aria-expanded="false">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="/">SixDegree</a>
      </div>
      <div class="collapse navbar-collapse" id="nav-menu">
        <ul class="nav navbar-nav navbar-right">
          
              <li  >
                <a href="/">Blogs</a>
              </li>
          
              <li  >
                <a href="/tags.html">Tags</a>
              </li>
          
              <li  >
                <a href="/about.html">About</a>
              </li>
          
          
              <li>
                <a href="/atom.xml" target="_blank">
                  <span class="icon-rss"></span>
                </a>
              </li>
          
              <li>
                <a href="http://github.com/sixdegree" target="_blank">
                  <span class="icon-github"></span>
                </a>
              </li>
          
        </ul>
      </div>
    </div>
  </nav>
</header>



    <div class="container">
      <article class="detail" role="main">
  <section class="post-header">
    <h1 class="post-title">ReactJS高阶之Flux</h1>
    <ul class="post-meta">
      <li>
        <span class="glyphicon glyphicon-calendar"></span>
        <time datetime="2016-01-05T16:00:00.000Z">2016-01-06</time>
      </li>
      
        <li>
         <span class="glyphicon glyphicon-tags"></span>
          
            <a href="/tags.html#tag-ReactJs">ReactJs</a>
          
        </li>
      
    </ul>
  </section>
  <section class="post-content">
    <h2 id="header-1">Flux</h2>
<p>单向数据流的架构模式（在 MVC 中属于M层）</p>
<pre><code>╔═════════╗       ╔════════╗       ╔═════════════════╗
║ Actions ║──────&gt;║ Stores ║──────&gt;║ View Components ║
╚═════════╝       ╚════════╝       ╚═════════════════╝
     ^                                      │
     └──────────────────────────────────────┘
</code></pre><p>基于单向数据流如何更好的管理数据，在 Views 与数据之间进行解耦 ，Store 是关键</p>
<ul>
<li>View 层 Dispatch actions（分发操作）</li>
<li>Store 响应action，触发 change事件</li>
<li>View 层响应change事件</li>
</ul>
<p>在flux思想之上，有很多优秀的库，比如：reflux，redux</p>
<h2 id="header-2">Reflux</h2>
<p><a href="https://github.com/reflux/refluxjs" target="_blank" rel="noopener">Github</a> | <a href="http://segmentfault.com/a/1190000002793786?utm_source=tuicool" target="_blank" rel="noopener">Reflux 介绍</a> | <a href="http://abruzzi.github.com/2015/11/get-started-with-reflux" target="_blank" rel="noopener">Sample</a></p>
<p>下载包：</p>
<pre><code>&gt; npm install reflux --save
</code></pre><ol>
<li><p>Action：定义方法</p>
<pre><code class="nulljavascript"><span class="hljs-keyword">var</span> Reflux=<span class="hljs-built_in">require</span>(<span class="hljs-string">"reflux"</span>);
<span class="hljs-built_in">module</span>.exports=Reflux.createActions([
 <span class="hljs-string">"listXxx"</span>,
 <span class="hljs-string">"getXxx"</span>,
 <span class="hljs-string">"updateXxx"</span>,
 <span class="hljs-string">"createXxx"</span>,
 ...
])
</code></pre>
</li>
<li><p>Store：监听actions</p>
<pre><code class="nulljavascript"> <span class="hljs-comment">//xxx-store.jsx</span>
 <span class="hljs-keyword">var</span> Reflux=<span class="hljs-built_in">require</span>(<span class="hljs-string">"reflux"</span>);
 <span class="hljs-keyword">var</span> Api=<span class="hljs-built_in">require</span>(<span class="hljs-string">"../utils/api"</span>);
 <span class="hljs-keyword">var</span> xxxActions=<span class="hljs-built_in">require</span>(<span class="hljs-string">"../actions/xxx-action"</span>);

 <span class="hljs-built_in">module</span>.exports=Reflux.createStore({
     <span class="hljs-attr">listenables</span>:[XxxActions],        <span class="hljs-comment">// 监听actions</span>
     data:{},

     <span class="hljs-comment">//添加Action中定义的同名函数</span>
     listXxx:<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
         <span class="hljs-keyword">return</span> Api.get(<span class="hljs-string">"..."</span>)
                 .then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">json</span>)</span>{
                     <span class="hljs-keyword">if</span>(json &amp;&amp; json.success)
                         <span class="hljs-keyword">this</span>.data=json.data;
                     <span class="hljs-keyword">this</span>.trigger(<span class="hljs-keyword">this</span>.data,json);    <span class="hljs-comment">//触发（监听此Store的Components会接收到）</span>
                 }.bind(<span class="hljs-keyword">this</span>));
     },
     ...
     <span class="hljs-comment">//也可添加Store自己的函数</span>
 });
</code></pre>
</li>
<li><p>Component: 调用Action（会触发调用相应的Store方法）或Store方法，监听Store变化</p>
<pre><code class="nulljavascript"> <span class="hljs-keyword">var</span> Reflux=<span class="hljs-built_in">require</span>(<span class="hljs-string">"reflux"</span>);
 <span class="hljs-keyword">var</span> XxxActions=<span class="hljs-built_in">require</span>(<span class="hljs-string">"../action/xxx-action"</span>);
 <span class="hljs-keyword">var</span> XxxStore=<span class="hljs-built_in">require</span>(<span class="hljs-string">"../stores/xxx-store"</span>);

 <span class="hljs-built_in">module</span>.exports=React.createClass({
     <span class="hljs-comment">//监听Store，捕获到则调用onChange方法（相当于callback）</span>
     mixins:[Reflux.listenTo(XxxStore,<span class="hljs-string">"onChange"</span>)],
     <span class="hljs-attr">onChange</span>:<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data,result</span>)</span>{
         <span class="hljs-keyword">this</span>.setState({...});
     },
     <span class="hljs-attr">componentWillMount</span>:<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
         XxxActions.listXxx();
     },
     ...
 });
</code></pre>
</li>
</ol>
<h2 id="header-3">Redux</h2>
<p><a href="http://camsong.github.io/redux-in-chinese/" target="_blank" rel="noopener">中文文档</a> | <a href="https://segmentfault.com/a/1190000003503338#articleHeader5" target="_blank" rel="noopener">Redux 介绍</a> | <a href="http://zhenhua-lee.github.io/react/redux.html" target="_blank" rel="noopener">解读redux工作原理</a></p>
<p><img src="/2016/01/06/redux.png" alt="redux"><br>（图片来自：<a href="http://staltz.com/unidirectional-user-interface-architectures.html）" target="_blank" rel="noopener">http://staltz.com/unidirectional-user-interface-architectures.html）</a></p>
<p>store 是一个单一对象：</p>
<ul>
<li><code>store.getState()</code> ：获取reducer的root state</li>
<li><code>store.dispatch(action)</code> ： 向所有reducer分发action</li>
<li><code>store.subscribe(listener)</code> ：注册 state 变化监听器</li>
<li><code>createStore(reducer, [initialState])</code> 创建Store</li>
</ul>
<p>下载包：</p>
<pre><code>&gt; npm install redux --save
&gt; npm install react-redux --save
</code></pre><h3 id="header-4">基本使用示例</h3>
<ol>
<li><p>Component</p>
<pre><code class="nulljavascript"> <span class="hljs-keyword">var</span> React=<span class="hljs-built_in">require</span>(<span class="hljs-string">"react"</span>);
 <span class="hljs-keyword">var</span> ReactDOM=<span class="hljs-built_in">require</span>(<span class="hljs-string">"react-dom"</span>);

 <span class="hljs-keyword">var</span> Counter=React.createClass({
     <span class="hljs-attr">render</span>:<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
         <span class="hljs-keyword">return</span> (
           <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
             <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{this.props.value}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
             <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"btn btn-default"</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{this.props.onIncreaseClick}</span>&gt;</span>Increase<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
           <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
         )
     }
 });
</code></pre>
</li>
<li><p>Store</p>
<pre><code class="nulljavascript"> <span class="hljs-keyword">var</span> redux=<span class="hljs-built_in">require</span>(<span class="hljs-string">"redux"</span>);

 <span class="hljs-keyword">var</span> countRedux=<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">state,action</span>)</span>{
     <span class="hljs-keyword">switch</span>(action.type){
         <span class="hljs-keyword">case</span> <span class="hljs-string">'INCREASE'</span>:
             <span class="hljs-keyword">return</span> state+action.step;
     }
     <span class="hljs-keyword">return</span> state;
 }

 <span class="hljs-keyword">var</span> store=redux.createStore(countRedux,<span class="hljs-number">0</span>);
 store.subscribe(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
     <span class="hljs-built_in">console</span>.log(store.getState());
 });
</code></pre>
</li>
<li><p>Action</p>
<pre><code class="nulljavascript"> <span class="hljs-keyword">var</span> increaseAction={<span class="hljs-attr">type</span>:<span class="hljs-string">'INCREASE'</span>,<span class="hljs-attr">step</span>:<span class="hljs-number">1</span>};
 <span class="hljs-comment">//test</span>
 store.dispatch(increaseAction);
</code></pre>
</li>
<li><p>Container</p>
<pre><code class="nulljavascript"> <span class="hljs-keyword">var</span> Provider=<span class="hljs-built_in">require</span>(<span class="hljs-string">"react-redux"</span>).Provider;
 <span class="hljs-keyword">var</span> connect=<span class="hljs-built_in">require</span>(<span class="hljs-string">"react-redux"</span>).connect;

 <span class="hljs-comment">//Map Redux state to component props</span>
 <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">mapStateToProps</span>(<span class="hljs-params">state</span>)</span>{
     <span class="hljs-keyword">return</span> {<span class="hljs-attr">count</span>:state}
 }
 <span class="hljs-comment">//Map Redux dispatch to component props</span>
 <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">mapDispatchToProps</span>(<span class="hljs-params">dispatch</span>)</span>{
     <span class="hljs-keyword">return</span> {
         <span class="hljs-attr">onIncreaseClick</span>:<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{dispatch(increaseAction);}
     }
 }

 <span class="hljs-keyword">var</span> App=connect(mapStateToProps,mapDispatchToProps)(Counter)

 <span class="hljs-comment">// render</span>
 ReactDOM.render(
   <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span> <span class="hljs-attr">store</span>=<span class="hljs-string">{store}</span>&gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span>
   <span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>,
   <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'app'</span>)
 );
</code></pre>
</li>
</ol>
<h3 id="header-5">高阶使用示例</h3>
<p><img src="/2016/01/06/redux-book.png" alt="redux"><br>（图片来自：<a href="https://www.udemy.com/react-redux/" target="_blank" rel="noopener">https://www.udemy.com/react-redux/</a> 教程）</p>
<p><strong>要点：</strong></p>
<ol>
<li>Reducer:<pre><code class="nulljavascript"> <span class="hljs-keyword">var</span> bookReducer=<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">state,action</span>)</span>{...};
 <span class="hljs-keyword">var</span> activeBookReducer=<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">state,action</span>)</span>{...};
 <span class="hljs-built_in">module</span>.exports=combineReducers({
     <span class="hljs-attr">books</span>:booksReducer,
     <span class="hljs-attr">activeBook</span>:activeBookReducer
 })
</code></pre>
</li>
<li><p>Action Creator:</p>
<pre><code class="nulljavascript">     <span class="hljs-keyword">var</span> selectBook=<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">book</span>)</span>{
         <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Selectd:"</span>+book.title);
         <span class="hljs-keyword">return</span> {<span class="hljs-attr">type</span>:<span class="hljs-string">"BOOK_SELECTED"</span>,<span class="hljs-attr">payload</span>:book};
     }
     <span class="hljs-built_in">module</span>.exports={
         <span class="hljs-attr">selectBook</span>:selectBook
     }
</code></pre>
</li>
<li><p>Container:</p>
<pre><code class="nulljavascript"> <span class="hljs-keyword">var</span> bindActionCreators=<span class="hljs-built_in">require</span>(<span class="hljs-string">"redux"</span>).bindActionCreators;

 <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">mapDispatchToProps</span>(<span class="hljs-params">dispatch</span>)</span>{
     <span class="hljs-comment">/*return {
         selectBook:function(book){dispatch({type:'BOOK_SELECTED',payload:book})}
     }*/</span>
     <span class="hljs-keyword">return</span> bindActionCreators(BookActions,dispatch);
 }
</code></pre>
</li>
</ol>
<p><strong> 可使用middleware实现异步Action </strong> （例如使用<code>redux-promise</code> ）</p>
<p><img src="/2016/01/06/redux-book-middleware.png" alt="redux"><br>（图片来自：<a href="https://www.udemy.com/react-redux/" target="_blank" rel="noopener">https://www.udemy.com/react-redux/</a> 教程）</p>
<p><strong>要点：</strong> 触发action，传递promise对象，使用middleware拦截直到响应，继续传递action到reducers</p>
<ol>
<li><p>下载包<code>redux-promise</code> (Redux Middleware) &amp; <code>axios</code> (Promise Request)：</p>
<pre><code>&gt; npm install redux-promise --save
&gt; npm install axios --save
</code></pre></li>
<li><p>Action：</p>
<pre><code class="nulljavascript"> {<span class="hljs-attr">type</span>:<span class="hljs-string">'BOOK_LIST'</span>,<span class="hljs-attr">payload</span>:axios.get(url);}
</code></pre>
</li>
<li><p>Reducer:</p>
<pre><code class="nulljavascript"> <span class="hljs-keyword">var</span> booksReducer=<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">state,action</span>)</span>{
     <span class="hljs-keyword">switch</span>(action.type){
         <span class="hljs-keyword">case</span> <span class="hljs-string">'BOOK_LIST'</span>:
             <span class="hljs-keyword">if</span>(action.payload.status==<span class="hljs-number">200</span>){
                 <span class="hljs-keyword">return</span> [action.payload.data];
             }
     }
     <span class="hljs-keyword">return</span> state;
 }
</code></pre>
</li>
<li><p>Store</p>
<pre><code class="nulljavascript"> <span class="hljs-keyword">var</span> createStore=<span class="hljs-built_in">require</span>(<span class="hljs-string">"redux"</span>).createStore;

 <span class="hljs-keyword">var</span> applyMiddleware=<span class="hljs-built_in">require</span>(<span class="hljs-string">"redux"</span>).applyMiddleware;
 <span class="hljs-keyword">var</span> ReduxPromise=<span class="hljs-built_in">require</span>(<span class="hljs-string">"redux-promise"</span>);
 <span class="hljs-keyword">var</span> createStoreWithMiddleware=applyMiddleware(ReduxPromise)(createStore);

 <span class="hljs-keyword">var</span> store=createStoreWithMiddleware(booksReducers);
</code></pre>
</li>
</ol>
<h2 id="header-6">Reference</h2>
<ul>
<li>Reflux <a href="https://github.com/reflux/refluxjs" target="_blank" rel="noopener">Github</a> | <a href="http://segmentfault.com/a/1190000002793786?utm_source=tuicool" target="_blank" rel="noopener">Reflux 介绍</a> | <a href="http://abruzzi.github.com/2015/11/get-started-with-reflux" target="_blank" rel="noopener">Sample</a></li>
<li>Redux <a href="https://github.com/rackt/react-redux" target="_blank" rel="noopener">Github</a> | <a href="http://camsong.github.io/redux-in-chinese/index.html" target="_blank" rel="noopener">中文文档</a> | <a href="https://segmentfault.com/a/1190000003503338#articleHeader5" target="_blank" rel="noopener">Redux 介绍</a> | <a href="http://zhenhua-lee.github.io/react/redux.html" target="_blank" rel="noopener">解读redux工作原理</a></li>
<li><a href="https://github.com/sixDegree/react-advance" target="_blank" rel="noopener">My Demos</a></li>
</ul>
  </section>
</article>

      <hr/>
      
<section class="post-comment">
	
		<div id="gitment_container"></div>

<link rel="stylesheet" href="/gitment/default.css">
<script src="/gitment/gitment.browser.js"></script>


<script type="text/javascript">
	var gitment = new Gitment({
	  owner: 'sixDegree',
	  repo: 'blogComment',
	  oauth: {
	    client_id: '36a09bb7399efe69c6ce',
	    client_secret: 'f28f2c5fff964d8e5d1a6ebdee77e6a890a8ac94',
	  },
	})
	gitment.render('gitment_container')
</script>
	
</section>

    </div>
  </div>
</body>

<script src="/jquery/dist/jquery.min.js"></script>
<script src="/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/highlight/highlight.pack.js"></script>
<script type="text/javascript">
  hljs.initHighlightingOnLoad();
  
  $(document).ready(function(){
    var sidebarCtrl=$("#sidebar-ctrl");
    var sidebar=$("#sidebar");
    var wrapper=$("#wrapper");
    sidebarCtrl.on("click",function(event){
        //alert("click");
        sidebar.toggleClass("sidebar-toggle");
        wrapper.toggleClass("sidebar-toggle");
        sidebarCtrl.toggleClass("sidebar-toggle");
        sidebarCtrl.toggleClass("active");
    })
  });
</script>


</html>
