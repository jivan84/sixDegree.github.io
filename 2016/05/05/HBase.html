<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>HBase</title>
  
  <!-- Meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="hbase,nosql,bigdata,hadoop">
  
  
    <meta name="description" content="HBase introduction">
  

  <!-- Feed -->
  
    <link rel="alternative" href="/atom.xml" title="SixDegree" type="application/atom+xml">
  

  <!-- CSS -->
  <link rel="stylesheet" href="/bootstrap/dist/css/bootstrap.css">
  
    <link rel="stylesheet" href="/highlight/demo/styles/tomorrow-night-bright.css">
  
  <link rel="stylesheet" href="/css/fontello.css">
  <link rel="stylesheet" href="/css/style.css">

  <!-- Site Analyse -->
  
	<script>
	var userID='2bbb83cc0f781dd7502e9d5e19661866';
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?"+userID;
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>


</head>

<body data-spy="scroll" data-target="#nav-catalog">
  <div id="top-push"></div>
<a href="#top-push" id="go-top">
	<span class="glyphicon glyphicon-chevron-up"></span>
</a>
  <aside id="sidebar">
    <section class="sidebar-header">Catalog</section>
     <nav id="nav-catalog">
        <ol class="sidebar-nav nav"><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#header-1"><span class="sidebar-nav nav-text">概述</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-2"><span class="sidebar-nav nav-text">数据模型</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-3"><span class="sidebar-nav nav-text">架构体系</span></a></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#header-4"><span class="sidebar-nav nav-text">安装</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-5"><span class="sidebar-nav nav-text">伪分布式</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-6"><span class="sidebar-nav nav-text">集群式</span></a></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#header-7"><span class="sidebar-nav nav-text">操作</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-8"><span class="sidebar-nav nav-text">Shell Cmd</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-9"><span class="sidebar-nav nav-text">Java API</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-10"><span class="sidebar-nav nav-text">结合MapReduce操作</span></a></li></ol></li></ol>
    </nav>
  </aside>
  <span id="sidebar-ctrl" class="glyphicon glyphicon-list-alt circle"></span>
  <div id="wrapper">
    <header>
  <nav class="navbar navbar-default">
    <div class="container-fluid">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#nav-menu" aria-expanded="false">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="/">SixDegree</a>
      </div>
      <div class="collapse navbar-collapse" id="nav-menu">
        <ul class="nav navbar-nav navbar-right">
          
              <li  >
                <a href="/">Blogs</a>
              </li>
          
              <li  >
                <a href="/tags.html">Tags</a>
              </li>
          
              <li  >
                <a href="/about.html">About</a>
              </li>
          
          
              <li>
                <a href="/atom.xml" target="_blank">
                  <span class="icon-rss"></span>
                </a>
              </li>
          
              <li>
                <a href="http://github.com/sixdegree" target="_blank">
                  <span class="icon-github"></span>
                </a>
              </li>
          
        </ul>
      </div>
    </div>
  </nav>
</header>



    <div class="container">
      <article class="detail" role="main">
  <section class="post-header">
    <h1 class="post-title">HBase</h1>
    <ul class="post-meta">
      <li>
        <span class="glyphicon glyphicon-calendar"></span>
        <time datetime="2016-05-04T16:00:00.000Z">2016-05-05</time>
      </li>
      
        <li>
         <span class="glyphicon glyphicon-tags"></span>
          
            <a href="/tags.html#tag-BigData">BigData</a>
          
            <a href="/tags.html#tag-NoSql">NoSql</a>
          
        </li>
      
    </ul>
  </section>
  <section class="post-content">
    <h2 id="header-1">概述</h2>
<p>HBase：Hadoop Database</p>
<ul>
<li>一种在Hadoop之上的NoSQL 的Key/vale数据库,适合实时查询</li>
<li>利用Hadoop HDFS作为其文件存储系统</li>
<li>利用Hadoop MapReduce来处理其海量数据</li>
<li>利用Zookeeper作为协调工具</li>
<li>是一个高可靠性、高性能、面向列、可伸缩的分布式存储系统</li>
<li>适合海量数据(如20PB)的秒级简单查询的数据库<ul>
<li>适合key-value查询</li>
<li>适合按时间排序top n的场景</li>
<li>适合大量读写</li>
</ul>
</li>
</ul>
<h3 id="header-2">数据模型</h3>
<ul>
<li><p>数据模型<br>  <img src="/2016/05/05/datamodal.png" alt="Data Modal"><br>  <img src="/2016/05/05/keyvalue.png" alt="Key Value"></p>
<ul>
<li>Table:存储管理数据</li>
<li><code>RowKey</code>:行键（类似于关系型数据库中的主键）</li>
<li><code>ColumnFamily</code>：列族（定义表时指定），可包含任意多个列（插入记录时动态增加）</li>
<li><code>Cell</code>：单元格，由<code>{rowKey,columnFamily:columnName}</code>确定的存储单元<ul>
<li>可存储一份数据的多个版本，由<code>Timestamp（时间戳）</code>属性区分，即数据具有版本特性</li>
<li>由<code>{rowKey, columnFamily:columnName, version}</code>可确定某一版的Data</li>
<li>若不指定时间戳或者版本，默认取最新的数据</li>
</ul>
</li>
</ul>
</li>
<li><p>逻辑数据模型<br>  <img src="/2016/05/05/logicalmodal.png" alt="Logical Modal"></p>
</li>
<li><p>物理数据模型<br>  <img src="/2016/05/05/physicalmodal.png" alt="Physical Modal"></p>
</li>
<li><p>说明：</p>
<ul>
<li>存储划分：<ul>
<li><code>Table</code>按<code>RowKey</code>范围<code>[startKey,endKey)</code>划分成N个<code>Region</code><ul>
<li>各个<code>Region</code>分散存储在不同的<code>RegionServer</code>（单独的物理机器）中</li>
<li>这样对表的操作转化为对多台<code>RegionServer</code>的并行操作</li>
</ul>
</li>
<li><code>Region</code>按<code>ColumnFamily</code>一对一划分成<code>Store</code>,每个store包括:<ul>
<li><code>MemStore</code> 内存存储 （先，达到阀值后，写入StoreFile）<ul>
<li><code>StoreFile</code> 文件存储（对应一个<code>HFile</code>，存放在Hadoop HDFS）</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>存储结构：<ul>
<li><code>RowKey</code>,<code>ColumnName</code>按字典顺序物理存储</li>
<li><code>Timestamp</code>是一个64位整数</li>
<li>所有数据以<code>byte[]</code>存储</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="/2016/05/05/region.png" alt="Region"></p>
<h3 id="header-3">架构体系</h3>
<p>主从式结构</p>
<ul>
<li>Master（主）：可以启动多个，由Zookeeper的Master Election机制保证总有一个Master运行<ul>
<li>管理RegionServer</li>
<li>分配Region</li>
</ul>
</li>
<li>RegionServer（从）：一个物理节点一个<ul>
<li>存储Region</li>
<li>响应用户I/O请求，向HDFS文件系统中读写数据</li>
<li>合并切分Region（StoreFile）</li>
</ul>
</li>
<li>Zookeeper（协调）<ul>
<li>保证集群中只有一个Running Master<ul>
<li>监控RegionServer的状态，实时通知给Master</li>
<li>存储HBase的Schema（包括有哪些Table，每个Table有哪些ColumnFamily）</li>
<li>存储Region寻址入口（即<code>-ROOT-</code>表的location）</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="/2016/05/05/frame1.png" alt="Frame"></p>
<p><img src="/2016/05/05/frame2.png" alt="Frame"></p>
<p>HRegion 进程：</p>
<ul>
<li>HLog ：预写式日志（所有更新操作先记录进日志，再操作），用于做灾难恢复Failover</li>
<li>Store ：每个Store存放一个列族<ul>
<li>MemStore 内存存储 （先，达到阀值后，写入StoreFile）</li>
<li>StoreFile 文件存储（对应一个HFile，存放在Hadoop HDFS）<ul>
<li>每次写入就形成一份单独的<ul>
<li>数量增长到一定阀值：合并StoreFile（合并时会进行版本合并和删除工作）– HDFS适合存储大文件</li>
<li>大小超过一定阀值：分割当前Region（再由HMaster分配到其他RegionServer）– 实现负载均衡</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>注意：</p>
<ul>
<li>HBase中有两张特殊的Table（<code>-ROOT-</code>和<code>.META.</code>）<ul>
<li><code>.META.</code>：记录了<code>用户表</code>的Region信息，<code>.META.</code>表本身可划分成N个regoin</li>
<li><code>-ROOT-</code>：记录了<code>.META.</code>表划分成的N个Region的信息，<code>-ROOT-</code>本身只有一个，不划分<br><img src="/2016/05/05/meta.png" alt="META"></li>
</ul>
</li>
<li>Client访问HBase上数据数据（并不需要master参与）:<code>zookeeper</code>=&gt;<code>-ROOT-</code>表=&gt;<code>.META.</code>表=&gt;Region位置=&gt;访问</li>
<li>Client包含访问HBase的接口,可通过维护着一些cache来加快对HBase的访问（比如缓存region的位置信息）</li>
</ul>
<h2 id="header-4">安装</h2>
<h3 id="header-5">伪分布式</h3>
<ol>
<li>下载解压安装包</li>
<li>设置环境变量（<code>/etc/profile</code>文件）<ul>
<li><code>HBASE_HOME</code></li>
<li><code>PATH</code></li>
</ul>
</li>
<li>配置（<code>$HBASE_HOME/conf</code>目录下）<ul>
<li><code>hbase-env.sh</code><pre><code class="nullvim">  export JAVA_HOME=/usr/local/jdk
  # 使用HBase内置的Zookeeper
  export HBASE_MANAGES_ZK=true
</code></pre>
</li>
<li><code>hbase-site.xml</code><pre><code class="nullxml">  <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>hbase.rootdir<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>hdfs://hadoop0:9000/hbase<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>hbase.cluster.distributed<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>hbase.zookeeper.quorum<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>hadoop0<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>dfs.replication<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
</code></pre>
</li>
</ul>
</li>
<li>启动<ul>
<li>运行Hadoop</li>
<li>运行HBase: <code>start-hbase.sh</code></li>
</ul>
</li>
<li>验证<ul>
<li><code>jps</code> 三个进程：HMaster、HRegionServer、HQuorumPeer</li>
<li><code>http://hadoop0:60010</code></li>
</ul>
</li>
</ol>
<h3 id="header-6">集群式</h3>
<p>（在原来的hadoop0上的hbase伪分布基础上进行搭建）</p>
<p>例如：</p>
<ul>
<li>Master：hadoop0</li>
<li>RegionServer：hadoop1,hadoop2</li>
</ul>
<ol>
<li>配置（<code>$HBASE_HOME/conf</code>目录下）<ul>
<li><code>hbase-env.sh</code><pre><code class="nullvim">  export JAVA_HOME=/usr/local/jdk
  # 不使用HBase内置的Zookeeper
  export HBASE_MANAGES_ZK=false
</code></pre>
</li>
<li><code>hbase-site.xml</code><pre><code class="nullxml">  ...
  <span class="hljs-comment">&lt;!-- 配置Zookeeper监控管理的节点（hostname）--&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>hbase.zookeeper.quorum<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>hadoop0,hadoop1,hadoop2<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
</code></pre>
</li>
<li><code>regionservers</code> （配置RegionServer的hostname）<pre><code class="nullvim">  hadoop1
  hadoop2
</code></pre>
</li>
</ul>
</li>
<li>复制配置好的hbase到其他节点<pre><code class="nullvim"> scp -rp ./hbase `hadoop`@hadoop1:~
 scp -rp ./hbase `hadoop`@hadoop2:~
</code></pre>
</li>
<li>启动<ul>
<li>运行Hadoop</li>
<li>运行zookeeper</li>
<li>运行HBase: <code>start-hbase.sh</code></li>
</ul>
</li>
</ol>
<h2 id="header-7">操作</h2>
<p>注意：HBase不能支持where条件、Order by 查询，只支持按照Row key来查询，但是可以通过HBase提供的API进行条件过滤</p>
<h3 id="header-8">Shell Cmd</h3>
<ul>
<li>启用HBase Shell命令行<pre><code class="nullshell"><span class="hljs-meta">  &gt;</span><span class="bash"> hbase shell</span>
  ...
<span class="hljs-meta">  &gt;</span><span class="bash"> quite</span>
</code></pre>
</li>
<li>常用命令<table class="table">
<thead>
<tr>
<th>名称</th>
<th>命令表达式</th>
</tr>
</thead>
<tbody>
<tr>
<td>创建表</td>
<td>create ‘表名称’, ‘列族名称1’,’列族名称2’,’列族名称N’</td>
</tr>
<tr>
<td>添加记录</td>
<td>put ‘表名称’, ‘行键’, ‘列族名称:列名称’, ‘值’</td>
</tr>
<tr>
<td>查看记录</td>
<td>get ‘表名称’, ‘行键’</td>
</tr>
<tr>
<td>查看表中的记录总数</td>
<td>count ‘表名称’</td>
</tr>
<tr>
<td>删除记录</td>
<td>delete ‘表名’ ,’行键’ , ‘列名称’</td>
</tr>
<tr>
<td>删除一张表</td>
<td>先要屏蔽该表，才能对该表进行删除，第一步 disable ‘表名称’ 第二步 drop ‘表名称’</td>
</tr>
<tr>
<td>查看所有记录</td>
<td>scan “表名称”</td>
</tr>
<tr>
<td>查看某个表某个列中所有数据</td>
<td>scan “表名称” , {COLUMNS=&gt;’列族名称:列名称’}</td>
</tr>
<tr>
<td>更新记录</td>
<td>就是重写一遍进行覆盖</td>
</tr>
</tbody>
</table>
</li>
<li>注意：<ul>
<li>HBase其实没有delete操作，只有insert，以Timestamp区分新旧记录</li>
<li>为充分利用分布式，可使用reverse key，hash，复合行键等技巧改造行键</li>
<li>行键打乱后，可更均匀随机的分配到各节点，而不是集中在一个节点</li>
</ul>
</li>
</ul>
<p>操作示例：</p>
<ul>
<li><p>表操作：</p>
<ul>
<li>创建表<pre><code class="nullshell"><span class="hljs-meta">  &gt;</span><span class="bash"> create <span class="hljs-string">'users'</span>,<span class="hljs-string">'user_id'</span>,<span class="hljs-string">'address'</span>,<span class="hljs-string">'info'</span></span>
</code></pre>
</li>
<li>查看表<pre><code class="nullshell"><span class="hljs-meta">  &gt;</span><span class="bash"> list</span>
<span class="hljs-meta">  &gt;</span><span class="bash"> describe <span class="hljs-string">'users'</span></span>
</code></pre>
</li>
<li>验证表<pre><code class="nullshell"><span class="hljs-meta">  &gt;</span><span class="bash"> exists <span class="hljs-string">'users'</span></span>
<span class="hljs-meta">  &gt;</span><span class="bash"> is_enabled <span class="hljs-string">'users'</span></span>
<span class="hljs-meta">  &gt;</span><span class="bash"> is_disabled <span class="hljs-string">'users'</span></span>
</code></pre>
</li>
<li>删除表<pre><code class="nullshell"><span class="hljs-meta">  &gt;</span><span class="bash"> <span class="hljs-built_in">disable</span> <span class="hljs-string">'users'</span></span>
<span class="hljs-meta">  &gt;</span><span class="bash"> delete <span class="hljs-string">'users'</span></span>
</code></pre>
</li>
</ul>
</li>
<li><p>记录操作：</p>
<ul>
<li>插入<pre><code class="nullshell"><span class="hljs-meta">  &gt;</span><span class="bash"> put <span class="hljs-string">'users'</span>,<span class="hljs-string">'xiaoming'</span>,<span class="hljs-string">'info:age'</span>,<span class="hljs-string">'24'</span>;</span>
<span class="hljs-meta">  &gt;</span><span class="bash"> put <span class="hljs-string">'users'</span>,<span class="hljs-string">'xiaoming'</span>,<span class="hljs-string">'info:birthday'</span>,<span class="hljs-string">'1987-06-17'</span>;</span>
<span class="hljs-meta">  &gt;</span><span class="bash"> put <span class="hljs-string">'users'</span>,<span class="hljs-string">'xiaoming'</span>,<span class="hljs-string">'info:company'</span>,<span class="hljs-string">'alibaba'</span>;</span>
<span class="hljs-meta">  &gt;</span><span class="bash"> put <span class="hljs-string">'users'</span>,<span class="hljs-string">'xiaoming'</span>,<span class="hljs-string">'address:contry'</span>,<span class="hljs-string">'china'</span>;</span>
<span class="hljs-meta">  &gt;</span><span class="bash"> put <span class="hljs-string">'users'</span>,<span class="hljs-string">'xiaoming'</span>,<span class="hljs-string">'address:province'</span>,<span class="hljs-string">'zhejiang'</span>;</span>
<span class="hljs-meta">  &gt;</span><span class="bash"> put <span class="hljs-string">'users'</span>,<span class="hljs-string">'xiaoming'</span>,<span class="hljs-string">'address:city'</span>,<span class="hljs-string">'hangzhou'</span>;</span>
<span class="hljs-meta">  &gt;</span><span class="bash"> put <span class="hljs-string">'users'</span>,<span class="hljs-string">'zhangyifei'</span>,<span class="hljs-string">'info:birthday'</span>,<span class="hljs-string">'1987-4-17'</span>;</span>
<span class="hljs-meta">  &gt;</span><span class="bash"> put <span class="hljs-string">'users'</span>,<span class="hljs-string">'zhangyifei'</span>,<span class="hljs-string">'info:favorite'</span>,<span class="hljs-string">'movie'</span>;</span>
<span class="hljs-meta">  &gt;</span><span class="bash"> put <span class="hljs-string">'users'</span>,<span class="hljs-string">'zhangyifei'</span>,<span class="hljs-string">'info:company'</span>,<span class="hljs-string">'alibaba'</span>;</span>
<span class="hljs-meta">  &gt;</span><span class="bash"> put <span class="hljs-string">'users'</span>,<span class="hljs-string">'zhangyifei'</span>,<span class="hljs-string">'address:contry'</span>,<span class="hljs-string">'china'</span>;</span>
<span class="hljs-meta">  &gt;</span><span class="bash"> put <span class="hljs-string">'users'</span>,<span class="hljs-string">'zhangyifei'</span>,<span class="hljs-string">'address:province'</span>,<span class="hljs-string">'guangdong'</span>;</span>
<span class="hljs-meta">  &gt;</span><span class="bash"> put <span class="hljs-string">'users'</span>,<span class="hljs-string">'zhangyifei'</span>,<span class="hljs-string">'address:city'</span>,<span class="hljs-string">'jieyang'</span>;</span>
<span class="hljs-meta">  &gt;</span><span class="bash"> put <span class="hljs-string">'users'</span>,<span class="hljs-string">'zhangyifei'</span>,<span class="hljs-string">'address:town'</span>,<span class="hljs-string">'xianqiao'</span>;</span>
</code></pre>
</li>
<li><p>查询</p>
<pre><code class="nullshell"><span class="hljs-meta">  &gt;</span><span class="bash"> get <span class="hljs-string">'users'</span>,<span class="hljs-string">'xiaoming'</span></span>
<span class="hljs-meta">  &gt;</span><span class="bash"> get <span class="hljs-string">'users'</span>,<span class="hljs-string">'xiaoming'</span>,<span class="hljs-string">'info'</span></span>
<span class="hljs-meta">  &gt;</span><span class="bash"> get <span class="hljs-string">'users'</span>,<span class="hljs-string">'xiaoming'</span>,<span class="hljs-string">'info:age'</span></span>
<span class="hljs-meta">
  #</span><span class="bash"> 获取单元格数据的版本数据</span>
<span class="hljs-meta">  &gt;</span><span class="bash"> get <span class="hljs-string">'users'</span>,<span class="hljs-string">'xiaoming'</span>,{COLUMN=&gt;<span class="hljs-string">'info:age'</span>,VERSIONS=&gt;1}</span>
<span class="hljs-meta">  &gt;</span><span class="bash"> get <span class="hljs-string">'users'</span>,<span class="hljs-string">'xiaoming'</span>,{COLUMN=&gt;<span class="hljs-string">'info:age'</span>,VERSIONS=&gt;2}</span>
<span class="hljs-meta">  &gt;</span><span class="bash"> get <span class="hljs-string">'users'</span>,<span class="hljs-string">'xiaoming'</span>,{COLUMN=&gt;<span class="hljs-string">'info:age'</span>,VERSIONS=&gt;3}</span>
<span class="hljs-meta">
  #</span><span class="bash"> 获取单元格数据的某个版本数据</span>
<span class="hljs-meta">  &gt;</span><span class="bash"> get <span class="hljs-string">'users'</span>,<span class="hljs-string">'xiaoming'</span>,{COLUMN=&gt;<span class="hljs-string">'info:age'</span>,TIMESTAMP=&gt;1364874937056}</span>
<span class="hljs-meta">
  #</span><span class="bash"> 全表扫描</span>
<span class="hljs-meta">  &gt;</span><span class="bash"> scan <span class="hljs-string">'users'</span></span>
<span class="hljs-meta">
  #</span><span class="bash"> 统计表的行数</span>
<span class="hljs-meta">  &gt;</span><span class="bash"> count <span class="hljs-string">'users'</span></span>
</code></pre>
</li>
<li>更新<pre><code class="nullshell"><span class="hljs-meta">  &gt;</span><span class="bash"> put <span class="hljs-string">'users'</span>,<span class="hljs-string">'xiaoming'</span>,<span class="hljs-string">'info:age'</span> ,<span class="hljs-string">'29'</span></span>
<span class="hljs-meta">  &gt;</span><span class="bash"> get <span class="hljs-string">'users'</span>,<span class="hljs-string">'xiaoming'</span>,<span class="hljs-string">'info:age'</span></span>
</code></pre>
</li>
<li><p>删除</p>
<pre><code class="nullshell"><span class="hljs-meta">  #</span><span class="bash"> 删除某列值</span>
<span class="hljs-meta">  &gt;</span><span class="bash"> delete <span class="hljs-string">'users'</span>,<span class="hljs-string">'xiaoming'</span>,<span class="hljs-string">'info:age'</span></span>
<span class="hljs-meta">
  #</span><span class="bash"> 删除整行</span>
<span class="hljs-meta">  &gt;</span><span class="bash">deleteall <span class="hljs-string">'users'</span>,<span class="hljs-string">'xiaoming'</span></span>
<span class="hljs-meta">
  #</span><span class="bash"> 清空</span>
<span class="hljs-meta">  &gt;</span><span class="bash"> truncate <span class="hljs-string">'users'</span></span>
</code></pre>
</li>
</ul>
</li>
</ul>
<h3 id="header-9">Java API</h3>
<p>依赖包：</p>
<pre><code class="nullxml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.hbase<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hbase-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${hbase.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>使用示例：</p>
<pre><code class="nulljava">Configuration conf = HBaseConfiguration.create();
conf.set(<span class="hljs-string">"hbase.rootdir"</span>, <span class="hljs-string">"hdfs://hadoop0:9000/hbase"</span>);
<span class="hljs-comment">//使用eclipse时必须添加这个，否则无法定位</span>
conf.set(<span class="hljs-string">"hbase.zookeeper.quorum"</span>, <span class="hljs-string">"hadoop0"</span>);
HBaseAdmin admin = <span class="hljs-keyword">new</span> HBaseAdmin(conf);


String tableName=<span class="hljs-string">"users"</span>;
String columnFamily=<span class="hljs-string">"info"</span>;

<span class="hljs-comment">// 1. 创建一张表</span>
<span class="hljs-keyword">if</span> (admin.tableExists(tableName)) {
    System.out.println(<span class="hljs-string">"table exists!"</span>);
}<span class="hljs-keyword">else</span>{
    HTableDescriptor tableDesc = <span class="hljs-keyword">new</span> HTableDescriptor(tableName);
    tableDesc.addFamily(<span class="hljs-keyword">new</span> HColumnDescriptor(columnFamily));
    admin.createTable(tableDesc);
    System.out.println(<span class="hljs-string">"create table success!"</span>);
}

<span class="hljs-comment">// 2. 添加一条记录</span>
String rowKey=<span class="hljs-string">"xiaoming"</span>;
String column=<span class="hljs-string">"age"</span>;
String data=<span class="hljs-string">"24"</span>;

HTable table = <span class="hljs-keyword">new</span> HTable(conf, tableName);
Put p1 = <span class="hljs-keyword">new</span> Put(Bytes.toBytes(rowKey));
p1.add(Bytes.toBytes(columnFamily), Bytes.toBytes(column),     Bytes.toBytes(data));
table.put(p1);
System.out.println(<span class="hljs-string">"put'"</span>+rowKey+<span class="hljs-string">"',"</span>+columnFamily+<span class="hljs-string">":"</span>+column+<span class="hljs-string">"','"</span>+data+<span class="hljs-string">"'"</span>);

<span class="hljs-comment">// 3. 读取一条记录</span>
Get get = <span class="hljs-keyword">new</span> Get(Bytes.toBytes(rowKey));
Result result = table.get(get);
System.out.println(<span class="hljs-string">"Get: "</span>+result);

<span class="hljs-comment">// 4. 显示所有数据</span>
Scan scan = <span class="hljs-keyword">new</span> Scan();
ResultScanner scanner = table.getScanner(scan);
<span class="hljs-comment">/*scan.setStartRow(Bytes.toBytes("134/"));
scan.setStopRow( Bytes.toBytes("134:"));
scan.setMaxVersions(1);*/</span>
<span class="hljs-keyword">for</span> (Result res : scanner) {
    System.out.println(<span class="hljs-string">"Scan: "</span>+res    );
}
table.close();

<span class="hljs-comment">// 5. 删除表</span>
<span class="hljs-keyword">if</span>(admin.tableExists(tableName)){
    <span class="hljs-keyword">try</span> {
      admin.disableTable(tableName);
      admin.deleteTable(tableName);
    } <span class="hljs-keyword">catch</span> (IOException e) {
      e.printStackTrace();
      System.out.println(<span class="hljs-string">"Delete "</span>+tableName+<span class="hljs-string">" 失败"</span>);
    }
}
admin.close();
System.out.println(<span class="hljs-string">"Delete "</span>+tableName+<span class="hljs-string">" 成功"</span>);
</code></pre>
<h3 id="header-10">结合MapReduce操作</h3>
<p>Hbase对Mapreduce API进行了扩展，方便Mapreduce任务读写HTable数据</p>
<table class="table">
<thead>
<tr>
<th>HBase MapReduce</th>
<th>Hadoop MapReduce</th>
</tr>
</thead>
<tbody>
<tr>
<td>org.apache.hadoop.hbase.mapreduce.TableMapper</td>
<td>org.apache.hadoop.mapreduce.Mapper</td>
</tr>
<tr>
<td>org.apache.hadoop.hbase.mapreduce.TableReducer</td>
<td>org.apache.hadoop.mapreduce.Reducer</td>
</tr>
<tr>
<td>org.apache.hadoop.hbase.mapreduce.TableInputFormat</td>
<td>org.apache.hadoop.mapreduce.InputFormat</td>
</tr>
<tr>
<td>org.apache.hadoop.hbase.mapreduce.TableOutputFormat</td>
<td>org.apache.hadoop.mapreduce.OutputFormat</td>
</tr>
</tbody>
</table>
<p>依赖包：</p>
<pre><code class="nullxml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.hbase<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hbase-server<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${hbase.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>使用示例1：统计</p>
<pre><code class="nulljava"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>{   
    Configuration config = HBaseConfiguration.create(); 
    configuration.set(<span class="hljs-string">"hbase.zookeeper.quorum"</span>, <span class="hljs-string">"hadoop0"</span>);

    Job job = <span class="hljs-keyword">new</span> Job(config,<span class="hljs-string">"HBaseTotal"</span>);  
    job.setJarByClass(TotalOnHBase.class); 

    Scan scan = <span class="hljs-keyword">new</span> Scan();  
    scan.setCaching(<span class="hljs-number">500</span>);
    scan.setCacheBlocks(<span class="hljs-keyword">false</span>);
    TableMapReduceUtil.initTableMapperJob(<span class="hljs-string">"access-log"</span>,scan,MyTableMapper.class,Text.class,IntWritable.class,job);  
    TableMapReduceUtil.initTableReducerJob(<span class="hljs-string">"total-access"</span>,MyTableReducer.class,job);  
    job.waitForCompletion(<span class="hljs-keyword">true</span>);
}
</code></pre>
<pre><code class="nulljava"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyTableMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TableMapper</span>&lt;<span class="hljs-title">Text</span>, <span class="hljs-title">IntWritable</span>&gt;  </span>{  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> IntWritable ONE = <span class="hljs-keyword">new</span> IntWritable(<span class="hljs-number">1</span>);  
    <span class="hljs-keyword">private</span> Text text = <span class="hljs-keyword">new</span> Text();  
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">map</span><span class="hljs-params">(ImmutableBytesWritable row, Result value, Context context)</span> <span class="hljs-keyword">throws</span> IOException, InterruptedException </span>{  
        String ip = Bytes.toString(row.get()).split(<span class="hljs-string">"-"</span>)[<span class="hljs-number">0</span>];  
        String url = <span class="hljs-keyword">new</span> String(value.getValue(Bytes.toBytes(<span class="hljs-string">"info"</span>), Bytes.toBytes(<span class="hljs-string">"url"</span>)));  
        text.set(ip+<span class="hljs-string">"&amp;"</span>+url);  
        context.write(text, ONE);  
    }  
}
</code></pre>
<pre><code class="nulljava"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyTableReducer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TableReducer</span>&lt;<span class="hljs-title">Text</span>, <span class="hljs-title">IntWritable</span>, <span class="hljs-title">ImmutableBytesWritable</span>&gt;  </span>{  
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">reduce</span><span class="hljs-params">(Text key, Iterable&lt;IntWritable&gt; values, Context context)</span> <span class="hljs-keyword">throws</span> IOException, InterruptedException </span>{  
        <span class="hljs-keyword">int</span> sum = <span class="hljs-number">0</span>;  
        <span class="hljs-keyword">for</span> (IntWritable val : values) {  
            sum += val.get();  
        }  

        Put put = <span class="hljs-keyword">new</span> Put(key.getBytes());  
        put.add(Bytes.toBytes(<span class="hljs-string">"info"</span>), Bytes.toBytes(<span class="hljs-string">"count"</span>), Bytes.toBytes(String.valueOf(sum)));  

        context.write(<span class="hljs-keyword">null</span>, put);  
    }  
}
</code></pre>
<p>使用示例2：批量导入（<code>TableOutputFormat</code>,<code>TableReducer</code>）</p>
<pre><code class="nulljava"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>{
    <span class="hljs-keyword">final</span> Configuration configuration = <span class="hljs-keyword">new</span> Configuration();
    <span class="hljs-comment">//设置zookeeper</span>
    configuration.set(<span class="hljs-string">"hbase.zookeeper.quorum"</span>, <span class="hljs-string">"hadoop0"</span>);
    <span class="hljs-comment">//设置hbase表名称</span>
    configuration.set(TableOutputFormat.OUTPUT_TABLE, <span class="hljs-string">"wlan_log"</span>);
    <span class="hljs-comment">//将该值改大，防止hbase超时退出</span>
    configuration.set(<span class="hljs-string">"dfs.socket.timeout"</span>, <span class="hljs-string">"180000"</span>);

    <span class="hljs-keyword">final</span> Job job = <span class="hljs-keyword">new</span> Job(configuration, <span class="hljs-string">"HBaseBatchImport"</span>);
    FileInputFormat.setInputPaths(job, <span class="hljs-string">"hdfs://hadoop0:9000/input"</span>);
    job.setInputFormatClass(TextInputFormat.class);
    job.setMapperClass(BatchImportMapper.class);
    job.setMapOutputKeyClass(LongWritable.class);
    job.setMapOutputValueClass(Text.class);
    <span class="hljs-comment">//BatchImportReducer extends TableReducer</span>
    job.setReducerClass(BatchImportReducer.class);
    <span class="hljs-comment">//不再设置输出路径，而是设置输出格式类型</span>
    job.setOutputFormatClass(TableOutputFormat.class);
    job.waitForCompletion(<span class="hljs-keyword">true</span>);
}
</code></pre>
<pre><code class="nulljava"><span class="hljs-comment">// BatchImportMapper 数据清理，省略...</span>
<span class="hljs-comment">// BatchImportReducer 将数据写入HBase</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BatchImportReducer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TableReducer</span>&lt;<span class="hljs-title">LongWritable</span>, <span class="hljs-title">Text</span>, <span class="hljs-title">NullWritable</span>&gt;</span>{
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">reduce</span><span class="hljs-params">(LongWritable key, Iterable&lt;Text&gt; values,Context context)</span> <span class="hljs-keyword">throws</span> IOException ,InterruptedException </span>{
        <span class="hljs-keyword">for</span> (Text text : values) {
            <span class="hljs-keyword">final</span> String[] splited = text.toString().split(<span class="hljs-string">"\t"</span>);
            <span class="hljs-keyword">final</span> Put put = <span class="hljs-keyword">new</span> Put(Bytes.toBytes(splited[<span class="hljs-number">0</span>]));
            put.add(Bytes.toBytes(<span class="hljs-string">"info"</span>), Bytes.toBytes(<span class="hljs-string">"age"</span>), Bytes.toBytes(splited[<span class="hljs-number">1</span>]));
            <span class="hljs-comment">//省略其他字段，调用put.add(....)即可</span>
            context.write(NullWritable.get(), put);
        }
    };
}
</code></pre>
  </section>
</article>

      <hr/>
      
<section class="post-comment">
	
		<!-- disqus默认将数据加载到id为'disqus_thread'的容器中，可配置disqus_container_id改变-->
<div id="disqus_thread"> 
	<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

	<script type="text/javascript">
		var disqus_shortname = 'sixdegreespace'; 
		var disqus_identifier = '2016/05/05/HBase.html';	
		var disqus_title = 'HBase';
		var disqus_url = 'http://sixdegree.github.io/2016/05/05/HBase.html' ;
		//var disqus_category_id = '4262241'; 

		(function() {
		    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
		})();
	</script>


 
	
</section>

    </div>
  </div>
</body>

<script src="/jquery/dist/jquery.min.js"></script>
<script src="/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/highlight/highlight.pack.js"></script>
<script type="text/javascript">
  hljs.initHighlightingOnLoad();
  
  $(document).ready(function(){
    var sidebarCtrl=$("#sidebar-ctrl");
    var sidebar=$("#sidebar");
    var wrapper=$("#wrapper");
    sidebarCtrl.on("click",function(event){
        //alert("click");
        sidebar.toggleClass("sidebar-toggle");
        wrapper.toggleClass("sidebar-toggle");
        sidebarCtrl.toggleClass("sidebar-toggle");
        sidebarCtrl.toggleClass("active");
    })
  });
</script>


</html>
