<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Webservice</title>
  
  <!-- Meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="webservice,wsdl,soap,wsimport,jaxws,cxf,spring">
  
  
    <meta name="description" content="Set up webservice (jaxws,cxf)">
  

  <!-- Feed -->
  
    <link rel="alternative" href="/atom.xml" title="SixDegree" type="application/atom+xml">
  

  <!-- CSS -->
  <link rel="stylesheet" href="/bootstrap/dist/css/bootstrap.css">
  
    <link rel="stylesheet" href="/highlight/demo/styles/tomorrow-night-bright.css">
  
  <link rel="stylesheet" href="/css/fontello.css">
  <link rel="stylesheet" href="/css/style.css">
</head>

<body data-spy="scroll" data-target="#nav-catalog">
  <div id="top-push"></div>
<a href="#top-push" id="go-top">
	<span class="glyphicon glyphicon-chevron-up"></span>
</a>
  <aside id="sidebar">
    <section class="sidebar-header">Catalog</section>
     <nav id="nav-catalog">
        <ol class="sidebar-nav nav"><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#header-1"><span class="sidebar-nav nav-text">简介</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-2"><span class="sidebar-nav nav-text">WSDL</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-3"><span class="sidebar-nav nav-text">type</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-4"><span class="sidebar-nav nav-text">message</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-5"><span class="sidebar-nav nav-text">portType</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-6"><span class="sidebar-nav nav-text">binding</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-7"><span class="sidebar-nav nav-text">service</span></a></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-8"><span class="sidebar-nav nav-text">SOAP</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-9"><span class="sidebar-nav nav-text">Eclipse工具</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-10"><span class="sidebar-nav nav-text">Apache TCPMon工具</span></a></li></ol></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#header-11"><span class="sidebar-nav nav-text">Jax-ws (wsimport命令)</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#header-12"><span class="sidebar-nav nav-text">Jax-ws (Server端)</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-13"><span class="sidebar-nav nav-text">代码优先</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-14"><span class="sidebar-nav nav-text">契约优先（推荐）</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-15"><span class="sidebar-nav nav-text">发布服务（Application中）</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-16"><span class="sidebar-nav nav-text">发布服务（Web中）</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-17"><span class="sidebar-nav nav-text">发布独立的JAX-WS端点</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-18"><span class="sidebar-nav nav-text">发布兼容JAX-WS端点的Web</span></a></li></ol></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#header-19"><span class="sidebar-nav nav-text">Jax-ws (Client端)</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-20"><span class="sidebar-nav nav-text">基于SOAP的通讯方式（直接传递SOAP消息）</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-21"><span class="sidebar-nav nav-text">Message方式（xml）</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-22"><span class="sidebar-nav nav-text">Payload方式（String）</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-23"><span class="sidebar-nav nav-text">扩展：增加消息头</span></a></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-24"><span class="sidebar-nav nav-text">基于Jax-ws的通讯方式（封装了SOAP消息）</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-25"><span class="sidebar-nav nav-text">据wsdl中的service创建Service</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-26"><span class="sidebar-nav nav-text">据wsdl中的definitions创建Service</span></a></li></ol></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#header-27"><span class="sidebar-nav nav-text">Jax-ws (Handler)</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-28"><span class="sidebar-nav nav-text">自定义SOAPHandler</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-29"><span class="sidebar-nav nav-text">配置使用</span></a></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#header-30"><span class="sidebar-nav nav-text">CXF</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-31"><span class="sidebar-nav nav-text">依赖包</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-32"><span class="sidebar-nav nav-text">生成代码</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-33"><span class="sidebar-nav nav-text">使用</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-34"><span class="sidebar-nav nav-text">Server端</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-35"><span class="sidebar-nav nav-text">Client端</span></a></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-36"><span class="sidebar-nav nav-text">结合Spring</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-37"><span class="sidebar-nav nav-text">Server端</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-38"><span class="sidebar-nav nav-text">Client端</span></a></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-39"><span class="sidebar-nav nav-text">拦截器</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-40"><span class="sidebar-nav nav-text">自定义拦截器</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-41"><span class="sidebar-nav nav-text">添加拦截器</span></a></li></ol></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#header-42"><span class="sidebar-nav nav-text">扩展应用</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-43"><span class="sidebar-nav nav-text">Upload附件</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-44"><span class="sidebar-nav nav-text">消息头处理</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-45"><span class="sidebar-nav nav-text">显示处理</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-46"><span class="sidebar-nav nav-text">通过SOAPHandler处理</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-47"><span class="sidebar-nav nav-text">通过SoapInterceptor处理</span></a></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-48"><span class="sidebar-nav nav-text">Exception异常处理</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-49"><span class="sidebar-nav nav-text">异步调用</span></a></li></ol></li></ol>
    </nav>
  </aside>
  <span id="sidebar-ctrl" class="glyphicon glyphicon-list-alt circle"></span>
  <div id="wrapper">
    <header>
  <nav class="navbar navbar-default">
    <div class="container-fluid">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#nav-menu" aria-expanded="false">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="/">SixDegree</a>
      </div>
      <div class="collapse navbar-collapse" id="nav-menu">
        <ul class="nav navbar-nav navbar-right">
          
              <li  >
                <a href="/">Blogs</a>
              </li>
          
              <li  >
                <a href="/tags.html">Tags</a>
              </li>
          
              <li  >
                <a href="/about.html">About</a>
              </li>
          
          
              <li>
                <a href="/atom.xml" target="_blank">
                  <span class="icon-rss"></span>
                </a>
              </li>
          
              <li>
                <a href="http://github.com/sixdegree" target="_blank">
                  <span class="icon-github"></span>
                </a>
              </li>
          
        </ul>
      </div>
    </div>
  </nav>
</header>



    <div class="container">
      <article class="detail" role="main">
  <section class="post-header">
    <h1 class="post-title">Webservice</h1>
    <ul class="post-meta">
      <li>
        <span class="glyphicon glyphicon-calendar"></span>
        <time datetime="2013-08-31T16:00:00.000Z">2013-09-01</time>
      </li>
      
        <li>
         <span class="glyphicon glyphicon-tags"></span>
          
            <a href="/tags.html#tag-Java">Java</a>
          
            <a href="/tags.html#tag-Webservice">Webservice</a>
          
        </li>
      
    </ul>
  </section>
  <section class="post-content">
    <h2 id="header-1">简介</h2>
<p>WebService 用于异构平台之间的交互</p>
<p>JAVA 中共有三种WebService 规范：</p>
<ul>
<li>JAXM&amp;SAAJ</li>
<li>JAX-WS（JAX-RPC）</li>
<li>JAX-RS</li>
</ul>
<p>有很多框架可以帮助实现：</p>
<ul>
<li><code>JAX-WS</code><ul>
<li>Java API Xml for WebService （JDK 1.6后)</li>
<li>JDK1.6以前，RMI方式，以SOAPMessage encode方式传递消息</li>
</ul>
</li>
<li><code>CXF</code> （60%）<ul>
<li><code>Apache CXF  =  Celtix + Xfire</code> （即Object Web Celtix和Codehaus XFire 合并而成）</li>
<li>是一种可插拨的架构<ul>
<li>既可以支持 XML ，也可以支持非 XML 的类型绑定</li>
<li>比如：JSON 和 CORBA</li>
</ul>
</li>
<li>基于SOAP通讯（REST也可），在<code>Jax-ws</code>基础上扩展<ul>
<li>JAX-WS 和JAX-RS 规范我们采用Apache CXF 作为实现</li>
</ul>
</li>
<li>本身就和Spring整合<ul>
<li>配置bean.xml,web.xml（CXFServlet）</li>
<li>核心是<code>org.apache.cxf.Bus</code>（总线，类似Spring 的ApplicationContext），由BusFactory 创建（默认的BUS ID 为cxf）</li>
</ul>
</li>
<li>可通过Interceptor代替Handler的处理</li>
</ul>
</li>
<li><code>Axis</code> （20%）</li>
<li><code>Metro</code></li>
</ul>
<p>专有名词介绍：</p>
<ul>
<li><code>SEI</code> (Service Endpoint Interface) 服务端提供的接口（公开为Web服务的接口）</li>
<li><code>SIB</code> （Service Implemention Bean） 服务实现类<ul>
<li>注意： 如果还实现了其他的接口，需在<code>@WebService</code> 注解的<code>endpointInterface</code>属性中指定哪个接口是SEI（全类名）</li>
</ul>
</li>
</ul>
<p>JaxB 编排与反编排：</p>
<ul>
<li><code>marshal</code> 编排： <code>object-&gt;stream(xml)</code></li>
<li><code>unmarshal</code> 反编排： <code>stream(xml)-&gt;object</code></li>
</ul>
<p>WebService 有个专门控制安全的协议：<code>WS-Security</code></p>
<p>WebService 通讯方式：</p>
<ul>
<li>基于SOAP的通讯方式</li>
<li>基于jax-ws的通讯方式（已经帮助封装了SOAP消息）</li>
<li>基于CXF的通讯方式</li>
<li>基于REST的通讯方式</li>
</ul>
<h3 id="header-2">WSDL</h3>
<p>以XML的形式描述方法签名：<code>返回值 方法名（传入参数）</code></p>
<pre><code class="nullxml"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span> standalone=<span class="string">"no"</span><span class="meta">?&gt;</span></span>
<span class="tag">&lt;<span class="name">wsdl:definitions</span> <span class="attr">xmlns:soap</span>=<span class="string">"http://schemas.xmlsoap.org/wsdl/soap/"</span> 
    <span class="attr">xmlns:tns</span>=<span class="string">"http://ws.cj.com/student"</span> 
    <span class="attr">xmlns:wsdl</span>=<span class="string">"http://schemas.xmlsoap.org/wsdl/"</span> 
    <span class="attr">xmlns:xsd</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span> 
    <span class="attr">name</span>=<span class="string">"OperationWsService"</span> 
    <span class="attr">targetNamespace</span>=<span class="string">"http://ws.cj.com/student"</span>&gt;</span>

    <span class="comment">&lt;!-- type：定义访问类型 --&gt;</span>
    <span class="comment">&lt;!-- message：定义消息，用来传递信息 --&gt;</span>
    <span class="comment">&lt;!-- portType：指明接口名称和接口中的服务 --&gt;</span>
    <span class="comment">&lt;!-- binding：绑定接口，指定消息传递和呈现所使用的格式 --&gt;</span>
    <span class="comment">&lt;!-- service ：指定服务发布的一些信息 --&gt;</span>

<span class="tag">&lt;/<span class="name">wsdl:definitions</span>&gt;</span>
</code></pre>
<h4 id="header-3">type</h4>
<p>定义访问类型 (complexType：复杂type定义，即对“tns”的对象进行定义)</p>
<pre><code class="nullxml"><span class="tag">&lt;<span class="name">wsdl:types</span>&gt;</span>
    <span class="tag">&lt;<span class="name">xsd:schema</span> <span class="attr">targetNamespace</span>=<span class="string">"http://www.example.org/student/"</span>&gt;</span>
        <span class="tag">&lt;<span class="name">xsd:element</span> <span class="attr">name</span>=<span class="string">"addUser"</span> <span class="attr">type</span>=<span class="string">"tns:addUser"</span>/&gt;</span>
        <span class="tag">&lt;<span class="name">xsd:element</span> <span class="attr">name</span>=<span class="string">"addUserResponse"</span> <span class="attr">type</span>=<span class="string">"tns:addUserResponse"</span>/&gt;</span>
        <span class="tag">&lt;<span class="name">xsd:element</span> <span class="attr">name</span>=<span class="string">"listUser"</span> <span class="attr">type</span>=<span class="string">"tns:listUser"</span>/&gt;</span>
        <span class="tag">&lt;<span class="name">xsd:element</span> <span class="attr">name</span>=<span class="string">"listUserResponse"</span> <span class="attr">type</span>=<span class="string">"tns:listUserResponse"</span>/&gt;</span>
        <span class="tag">&lt;<span class="name">xsd:element</span> <span class="attr">name</span>=<span class="string">"UserException"</span> <span class="attr">type</span>=<span class="string">"tns:UserException"</span>/&gt;</span>
        <span class="tag">&lt;<span class="name">xsd:element</span> <span class="attr">name</span>=<span class="string">"licenseInfo"</span> <span class="attr">type</span>=<span class="string">"tns:licenseInfo"</span>/&gt;</span>

        <span class="comment">&lt;!-- 复杂类型定义 --&gt;</span>
        <span class="tag">&lt;<span class="name">xsd:complexType</span> <span class="attr">name</span>=<span class="string">"user"</span>&gt;</span>
            <span class="tag">&lt;<span class="name">xsd:sequence</span>&gt;</span>
                <span class="tag">&lt;<span class="name">xsd:element</span> <span class="attr">name</span>=<span class="string">"id"</span> <span class="attr">type</span>=<span class="string">"xsd:int"</span>/&gt;</span>
                <span class="tag">&lt;<span class="name">xsd:element</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">type</span>=<span class="string">"xsd:string"</span>/&gt;</span>
                <span class="tag">&lt;<span class="name">xsd:element</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">type</span>=<span class="string">"xsd:string"</span> /&gt;</span>
            <span class="tag">&lt;/<span class="name">xsd:sequence</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">xsd:complexType</span>&gt;</span>

        <span class="tag">&lt;<span class="name">xsd:complexType</span> <span class="attr">name</span>=<span class="string">"addUser"</span>&gt;</span>
            <span class="tag">&lt;<span class="name">xsd:sequence</span>&gt;</span>
                <span class="tag">&lt;<span class="name">xsd:element</span> <span class="attr">name</span>=<span class="string">"user"</span> <span class="attr">type</span>=<span class="string">"tns:user"</span>/&gt;</span>
            <span class="tag">&lt;/<span class="name">xsd:sequence</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">xsd:complexType</span>&gt;</span>
        <span class="tag">&lt;<span class="name">xsd:complexType</span> <span class="attr">name</span>=<span class="string">"addUserResponse"</span>&gt;</span>
            <span class="tag">&lt;<span class="name">xsd:sequence</span>&gt;</span>
                <span class="tag">&lt;<span class="name">xsd:element</span> <span class="attr">name</span>=<span class="string">"id"</span> <span class="attr">type</span>=<span class="string">"xsd:int"</span>/&gt;</span>
            <span class="tag">&lt;/<span class="name">xsd:sequence</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">xsd:complexType</span>&gt;</span>

        <span class="tag">&lt;<span class="name">xsd:complexType</span> <span class="attr">name</span>=<span class="string">"listUser"</span>&gt;</span>
            <span class="tag">&lt;<span class="name">xsd:sequence</span>/&gt;</span>
        <span class="tag">&lt;/<span class="name">xsd:complexType</span>&gt;</span>
        <span class="tag">&lt;<span class="name">xsd:complexType</span> <span class="attr">name</span>=<span class="string">"listUserResponse"</span>&gt;</span>
            <span class="tag">&lt;<span class="name">xsd:sequence</span> <span class="attr">minOccurs</span>=<span class="string">"0"</span> <span class="attr">maxOccurs</span>=<span class="string">"unbounded"</span>&gt;</span>
                <span class="tag">&lt;<span class="name">xsd:element</span> <span class="attr">name</span>=<span class="string">"user"</span> <span class="attr">type</span>=<span class="string">"tns:user"</span>/&gt;</span>
            <span class="tag">&lt;/<span class="name">xsd:sequence</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">xsd:complexType</span>&gt;</span>

        <span class="tag">&lt;<span class="name">xsd:complexType</span> <span class="attr">name</span>=<span class="string">"UserException"</span>&gt;</span>
            <span class="tag">&lt;<span class="name">xsd:sequence</span>&gt;</span>
                <span class="tag">&lt;<span class="name">xsd:element</span> <span class="attr">name</span>=<span class="string">"message"</span> <span class="attr">type</span>=<span class="string">"xsd:string"</span>/&gt;</span>
            <span class="tag">&lt;/<span class="name">xsd:sequence</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">xsd:complexType</span>&gt;</span>

        <span class="tag">&lt;<span class="name">xsd:complexType</span> <span class="attr">name</span>=<span class="string">"licenseInfo"</span>&gt;</span>
            <span class="tag">&lt;<span class="name">xsd:sequence</span>&gt;</span>
                <span class="tag">&lt;<span class="name">xsd:element</span> <span class="attr">name</span>=<span class="string">"registerUser"</span> <span class="attr">type</span>=<span class="string">"tns:user"</span>/&gt;</span>
            <span class="tag">&lt;/<span class="name">xsd:sequence</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">xsd:complexType</span>&gt;</span>

    <span class="tag">&lt;/<span class="name">xsd:schema</span>&gt;</span>
<span class="tag">&lt;/<span class="name">wsdl:types</span>&gt;</span>
</code></pre>
<p>可定义在外部文件xsd中然后再wsdl中引用</p>
<pre><code class="nullxml"><span class="tag">&lt;<span class="name">wsdl:types</span>&gt;</span>
    <span class="comment">&lt;!-- 引入xsd,没有搭建web服务器时使用wsimport会找不到xsd文件 --&gt;</span>
    <span class="comment">&lt;!--方法一
    &lt;xsd:schema&gt;
        &lt;xsd:import namespace="http://ws.cj.com/student/" schemaLocation="student.xsd"/&gt;
    &lt;/xsd:schema&gt;--&gt;</span>

    <span class="comment">&lt;!-- 方法二 --&gt;</span>
    <span class="tag">&lt;<span class="name">xsd:schema</span> <span class="attr">targetNamespace</span>=<span class="string">"http://ws.cj.com/student/"</span>&gt;</span>
        <span class="tag">&lt;<span class="name">xsd:include</span> <span class="attr">schemaLocation</span>=<span class="string">"operation.xsd"</span>/&gt;</span>
    <span class="tag">&lt;/<span class="name">xsd:schema</span>&gt;</span>
<span class="tag">&lt;/<span class="name">wsdl:types</span>&gt;</span>
</code></pre>
<p>xsd文件:</p>
<pre><code class="nullxml"><span class="tag">&lt;<span class="name">xsd:schema</span> <span class="attr">xmlns:xsd</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span>
    <span class="attr">targetNamespace</span>=<span class="string">"http://ws.cj.com/student"</span>
    <span class="attr">xmlns:tns</span>=<span class="string">"http://ws.cj.com/student"</span>
    <span class="attr">elementFormDefault</span>=<span class="string">"unqualified"</span>&gt;</span> <span class="comment">&lt;!-- 默认为 qualified --&gt;</span>
    ...
<span class="tag">&lt;/<span class="name">xsd:schema</span>&gt;</span>
</code></pre>
<h4 id="header-4">message</h4>
<p>定义消息，用来传递信息 （SOPA协议通过Soap Message来传递）</p>
<p>公布了多少服务就有2倍于服务的消息 ：</p>
<ul>
<li>request(in)</li>
<li>response(out)</li>
</ul>
<pre><code class="nullxml"><span class="tag">&lt;<span class="name">wsdl:message</span> <span class="attr">name</span>=<span class="string">"addUser"</span>&gt;</span>
    <span class="tag">&lt;<span class="name">wsdl:part</span> <span class="attr">element</span>=<span class="string">"tns:addUser"</span> <span class="attr">name</span>=<span class="string">"addUser"</span>/&gt;</span>
<span class="tag">&lt;/<span class="name">wsdl:message</span>&gt;</span>
<span class="tag">&lt;<span class="name">wsdl:message</span> <span class="attr">name</span>=<span class="string">"addUserResponse"</span>&gt;</span>
    <span class="tag">&lt;<span class="name">wsdl:part</span> <span class="attr">element</span>=<span class="string">"tns:addUserResponse"</span> <span class="attr">name</span>=<span class="string">"addUserResponse"</span>/&gt;</span>
<span class="tag">&lt;/<span class="name">wsdl:message</span>&gt;</span>
<span class="tag">&lt;<span class="name">wsdl:message</span> <span class="attr">name</span>=<span class="string">"listUser"</span>&gt;</span>
    <span class="tag">&lt;<span class="name">wsdl:part</span> <span class="attr">element</span>=<span class="string">"tns:listUser"</span> <span class="attr">name</span>=<span class="string">"listUser"</span>/&gt;</span>
<span class="tag">&lt;/<span class="name">wsdl:message</span>&gt;</span>
<span class="tag">&lt;<span class="name">wsdl:message</span> <span class="attr">name</span>=<span class="string">"listUserResponse"</span>&gt;</span>
    <span class="tag">&lt;<span class="name">wsdl:part</span> <span class="attr">element</span>=<span class="string">"tns:listUserResponse"</span> <span class="attr">name</span>=<span class="string">"listUserResponse"</span>/&gt;</span>
<span class="tag">&lt;/<span class="name">wsdl:message</span>&gt;</span>
<span class="comment">&lt;!-- Exception message --&gt;</span>
<span class="tag">&lt;<span class="name">wsdl:message</span> <span class="attr">name</span>=<span class="string">"UserException"</span>&gt;</span>
    <span class="tag">&lt;<span class="name">wsdl:part</span> <span class="attr">element</span>=<span class="string">"tns:UserException"</span> <span class="attr">name</span>=<span class="string">"UserException"</span>/&gt;</span>
<span class="tag">&lt;/<span class="name">wsdl:message</span>&gt;</span>
<span class="comment">&lt;!-- Header message --&gt;</span>
<span class="tag">&lt;<span class="name">wsdl:message</span> <span class="attr">name</span>=<span class="string">"licenseInfo"</span>&gt;</span>
    <span class="tag">&lt;<span class="name">wsdl:part</span> <span class="attr">element</span>=<span class="string">"tns:licenseInfo"</span> <span class="attr">name</span>=<span class="string">"licenseInfo"</span>/&gt;</span>
<span class="tag">&lt;/<span class="name">wsdl:message</span>&gt;</span>
</code></pre>
<h4 id="header-5">portType</h4>
<p>portType：指明接口名称和接口中的服务</p>
<p>通过operation指定接口中的方法（服务），绑定相应的in和out的消息<br>（其中input表示参数，output表示返回值）</p>
<pre><code class="nullxml"><span class="tag">&lt;<span class="name">wsdl:portType</span> <span class="attr">name</span>=<span class="string">"IUserWsService"</span>&gt;</span>
    <span class="tag">&lt;<span class="name">wsdl:operation</span> <span class="attr">name</span>=<span class="string">"addUser"</span>&gt;</span>
          <span class="tag">&lt;<span class="name">wsdl:input</span> <span class="attr">message</span>=<span class="string">"tns:addUser"</span>/&gt;</span>
          <span class="tag">&lt;<span class="name">wsdl:output</span> <span class="attr">message</span>=<span class="string">"tns:addUserResponse"</span>/&gt;</span>
          <span class="comment">&lt;!-- Exception fault--&gt;</span>
          <span class="tag">&lt;<span class="name">wsdl:fault</span> <span class="attr">name</span>=<span class="string">"UserException"</span> <span class="attr">message</span>=<span class="string">"tns:UserException"</span>/&gt;</span>
    <span class="tag">&lt;/<span class="name">wsdl:operation</span>&gt;</span>
    <span class="tag">&lt;<span class="name">wsdl:operation</span> <span class="attr">name</span>=<span class="string">"listUser"</span>&gt;</span>
          <span class="tag">&lt;<span class="name">wsdl:input</span> <span class="attr">message</span>=<span class="string">"tns:listUser"</span>/&gt;</span>
          <span class="tag">&lt;<span class="name">wsdl:output</span> <span class="attr">message</span>=<span class="string">"tns:listUserResponse"</span>/&gt;</span>
    <span class="tag">&lt;/<span class="name">wsdl:operation</span>&gt;</span>
<span class="tag">&lt;/<span class="name">wsdl:portType</span>&gt;</span>
</code></pre>
<h4 id="header-6">binding</h4>
<p>绑定接口，指定消息传递和呈现所使用的格式</p>
<p>两种风格：</p>
<ul>
<li>document</li>
<li>rpc</li>
</ul>
<p>两种传递方式：</p>
<ul>
<li>encode(早期，jdk6以前)</li>
<li>literal(jdk1.6以后)</li>
</ul>
<pre><code class="nullxml"><span class="tag">&lt;<span class="name">wsdl:binding</span> <span class="attr">name</span>=<span class="string">"UserWsServiceSOAP"</span> <span class="attr">type</span>=<span class="string">"tns:IUserWsService"</span>&gt;</span>
    <span class="tag">&lt;<span class="name">soap:binding</span> <span class="attr">style</span>=<span class="string">"document"</span> <span class="attr">transport</span>=<span class="string">"http://schemas.xmlsoap.org/soap/http"</span>/&gt;</span>
    <span class="tag">&lt;<span class="name">wsdl:operation</span> <span class="attr">name</span>=<span class="string">"addUser"</span>&gt;</span>
        <span class="tag">&lt;<span class="name">wsdl:input</span>&gt;</span>
            <span class="tag">&lt;<span class="name">soap:body</span> <span class="attr">use</span>=<span class="string">"literal"</span>/&gt;</span>
            <span class="comment">&lt;!-- Header --&gt;</span>
            <span class="tag">&lt;<span class="name">soap:header</span> <span class="attr">use</span>=<span class="string">"literal"</span> <span class="attr">part</span>=<span class="string">"licenseInfo"</span> <span class="attr">message</span>=<span class="string">"tns:licenseInfo"</span>/&gt;</span>
        <span class="tag">&lt;/<span class="name">wsdl:input</span>&gt;</span>
        <span class="tag">&lt;<span class="name">wsdl:output</span>&gt;</span>
            <span class="tag">&lt;<span class="name">soap:body</span> <span class="attr">use</span>=<span class="string">"literal"</span>/&gt;</span>
        <span class="tag">&lt;/<span class="name">wsdl:output</span>&gt;</span>
        <span class="tag">&lt;<span class="name">wsdl:fault</span> <span class="attr">name</span>=<span class="string">"UserException"</span>&gt;</span>
            <span class="tag">&lt;<span class="name">soap:fault</span> <span class="attr">name</span>=<span class="string">"UserException"</span> <span class="attr">use</span>=<span class="string">"literal"</span>/&gt;</span>
        <span class="tag">&lt;/<span class="name">wsdl:fault</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">wsdl:operation</span>&gt;</span>

    <span class="tag">&lt;<span class="name">wsdl:operation</span> <span class="attr">name</span>=<span class="string">"listUser"</span>&gt;</span>
        <span class="tag">&lt;<span class="name">wsdl:input</span>&gt;</span>
            <span class="tag">&lt;<span class="name">soap:body</span> <span class="attr">use</span>=<span class="string">"literal"</span>/&gt;</span>
        <span class="tag">&lt;/<span class="name">wsdl:input</span>&gt;</span>
        <span class="tag">&lt;<span class="name">wsdl:output</span>&gt;</span>
            <span class="tag">&lt;<span class="name">soap:body</span> <span class="attr">use</span>=<span class="string">"literal"</span>/&gt;</span>
        <span class="tag">&lt;/<span class="name">wsdl:output</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">wsdl:operation</span>&gt;</span>
<span class="tag">&lt;/<span class="name">wsdl:binding</span>&gt;</span>
</code></pre>
<h4 id="header-7">service</h4>
<p>指定服务发布的一些信息</p>
<pre><code class="nullxml"><span class="tag">&lt;<span class="name">wsdl:service</span> <span class="attr">name</span>=<span class="string">"UserWsService"</span>&gt;</span>
    <span class="tag">&lt;<span class="name">wsdl:port</span> <span class="attr">binding</span>=<span class="string">"tns:UserWsServiceSOAP"</span> <span class="attr">name</span>=<span class="string">"UserWsServicePort"</span>&gt;</span>
      <span class="tag">&lt;<span class="name">soap:address</span> <span class="attr">location</span>=<span class="string">"http://localhost:9090/us"</span>/&gt;</span>
    <span class="tag">&lt;/<span class="name">wsdl:port</span>&gt;</span>
<span class="tag">&lt;/<span class="name">wsdl:service</span>&gt;</span>
</code></pre>
<h3 id="header-8">SOAP</h3>
<p>SOAP （Simple Object Access Protocal）简单对象访问协议<br>通过xml存储对象，通过element元素组装信息，通过Soap Message传递信息</p>
<p>通过SOAP协议进行消息传递</p>
<p><img src="/2013/09/01/soap.png" alt="SOAP"></p>
<h4 id="header-9">Eclipse工具</h4>
<p>通过Eclipse中J2EE视图下的“Launch the Web Services Explore“功能调用webservice</p>
<p>例如：</p>
<p>输入wsdl地址：<code>http://localhost:8888/ns?wsdl</code>，查看Status下的Source，得到如下：</p>
<ol>
<li><p>SOAP Request Envelope: </p>
<pre><code class="nullxml"><span class="tag">&lt;<span class="name">soapenv:Envelope</span> <span class="attr">xmlns:soapenv</span>=<span class="string">"http://schemas.xmlsoap.org/soap/envelope/"</span>     <span class="attr">xmlns:q0</span>=<span class="string">"http://first.ws.my.cj.com/"</span> <span class="attr">xmlns:xsd</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span>     <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span>&gt;</span>
 <span class="tag">&lt;<span class="name">soapenv:Body</span>&gt;</span>
     <span class="tag">&lt;<span class="name">q0:minus</span>&gt;</span>
           <span class="tag">&lt;<span class="name">a</span>&gt;</span>50<span class="tag">&lt;/<span class="name">a</span>&gt;</span>
           <span class="tag">&lt;<span class="name">b</span>&gt;</span>30<span class="tag">&lt;/<span class="name">b</span>&gt;</span>
       <span class="tag">&lt;/<span class="name">q0:minus</span>&gt;</span>
 <span class="tag">&lt;/<span class="name">soapenv:Body</span>&gt;</span>
<span class="tag">&lt;/<span class="name">soapenv:Envelope</span>&gt;</span>
</code></pre>
</li>
<li><p>SOAP Response Envelope:</p>
<pre><code class="nullxml"><span class="tag">&lt;<span class="name">S:Envelope</span> <span class="attr">xmlns:S</span>=<span class="string">"http://schemas.xmlsoap.org/soap/envelope/"</span> <span class="attr">xmlns:SOAP-</span>    <span class="attr">ENV</span>=<span class="string">"http://schemas.xmlsoap.org/soap/envelope/"</span>&gt;</span>
 <span class="tag">&lt;<span class="name">S:Body</span>&gt;</span>
     <span class="tag">&lt;<span class="name">ns2:minusResponse</span> <span class="attr">xmlns:ns2</span>=<span class="string">"http://first.ws.my.cj.com/"</span>&gt;</span>
           <span class="tag">&lt;<span class="name">minusResult</span>&gt;</span>20<span class="tag">&lt;/<span class="name">minusResult</span>&gt;</span>
       <span class="tag">&lt;/<span class="name">ns2:minusResponse</span>&gt;</span>
   <span class="tag">&lt;/<span class="name">S:Body</span>&gt;</span>
<span class="tag">&lt;/<span class="name">S:Envelope</span>&gt;</span>
</code></pre>
</li>
</ol>
<h4 id="header-10">Apache TCPMon工具</h4>
<ul>
<li><a href="http://ws.apache.org/commons/tcpmon/download.cgi">下载地址</a></li>
<li>运行：解压后进去<code>build</code>目录，双击<code>tcpmon.bat</code>就可以执行</li>
<li>实际上是个代理，起一个消息转发的作用，监视的是转发出去的消息</li>
<li>这样就可以截获转发在WebService服务器和客户机之间会传递的SOAP消息，帮助查看调试</li>
<li>最终消息还是要送到具体的地址和端口，它的前后都应该配置正确才行，否则响应就不正确了</li>
</ul>
<p><img src="/2013/09/01/tcpmon-proc.png" alt="TCPMon Process"></p>
<p>使用举例：</p>
<ol>
<li><p>配置（监听发布在<a href="http://localhost:9876上的webservice）">http://localhost:9876上的webservice）</a><br><img src="/2013/09/01/tcpmon-config.png" alt="TCPMon Config"></p>
</li>
<li><p>运行结果：<br><img src="/2013/09/01/tcpmon-result.png" alt="TCPMon Result"></p>
</li>
</ol>
<h2 id="header-11">Jax-ws (wsimport命令)</h2>
<p>根据wsdl文件生成Java平台的webservice接口（JDK1.6及以后，都包含此命令）</p>
<ul>
<li><code>wsimport -d d:/webservice/01/ -keep -verbose http://localhost:8888/ns?wsdl</code></li>
<li><code>wsimport -d d:/webservice/01/ -p test –verbose http://localhost:8888/ns?wsdl</code></li>
<li>参数说明：<ul>
<li>-d 指定生成目录</li>
<li>-p 指定生成的包 eg: -p com.cj.sms.first.client</li>
<li>-keep 指定是否生成.java的源文件</li>
<li>-verbose 显示生成的详细信息</li>
<li>最后指定wsdl文件位置：可以是网络中的，也可以是本地文件</li>
</ul>
</li>
</ul>
<p><img src="/2013/09/01/wsimport.png" alt="wsimport"></p>
<h2 id="header-12">Jax-ws (Server端)</h2>
<ul>
<li>代码优先：先编写接口，由接口生成wsdl</li>
<li>契约优先：先编写wsdl，由wsdl生成接口</li>
</ul>
<p>（wsdl即契约）</p>
<p><strong>PS: </strong><br>使用代码优先会破坏方法原有的结构，而使用契约优先可以定制wsdl，将一些验证信息置于SOAPHeader中，然后通过Handler预处理或者修改接口类显示声明来获取处理</p>
<h3 id="header-13">代码优先</h3>
<ol>
<li><p>编写WebService接口（加Annotation）</p>
<ul>
<li>@WebService</li>
<li>@WebMethod</li>
<li>@WebResult</li>
<li>@WebParam</li>
</ul>
</li>
<li><p>编写WebService实现类（加Annotation ）</p>
<pre><code> @WebService(endpointInterface=&quot;指定webservice接口-包名加类名&quot;,targetNamespace=&quot;&quot;)
</code></pre></li>
<li><p>发布服务（会自动生成wsdl）</p>
</li>
</ol>
<h3 id="header-14">契约优先（推荐）</h3>
<p>发布的服务是根据编写的wsdl文件生成的，wsdl文件变化，服务即变化</p>
<ol>
<li>编写wsdl文件<ul>
<li>在类路径下创建 META-INF/wsdl下</li>
<li>在tomcat中发布服务需置于WEB-INF/wsdl/下</li>
</ul>
</li>
<li>根据wsdl生成WebService接口类<ul>
<li>使用<code>wsimport</code>命令根据wsdl文件生成</li>
<li>生成的Interface接口类将作为Server端的WebService接口，如<pre><code class="nulljava"><span class="meta">@WebService</span>(name = <span class="string">"IUserWsService"</span>, targetNamespace = <span class="string">"http://www.my.org/user"</span>)
<span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IUserWsService</span> </span>{...}
</code></pre>
</li>
</ul>
</li>
<li>实现WebService接口（指定 wsdlLocation）<pre><code class="nulljava"> <span class="meta">@WebService</span>(endpointInterface=<span class="string">"com.cj.my.ws.thrid.IUserWsService"</span>
     ,targetNamespace=<span class="string">"http://www.my.org/user"</span>
     <span class="comment">//,wsdlLocation="/WEB-INF/wsdl/user.wsdl"  //在tomcat中发布服务</span>
     ,wsdlLocation=<span class="string">"META-INF/wsdl/user.wsdl"</span>
     ,serviceName=<span class="string">"UserWsService"</span>
     ,portName=<span class="string">"UserWsServicePort"</span>)
 <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserWsService</span> <span class="keyword">implements</span> <span class="title">IUserWsService</span></span>
</code></pre>
</li>
<li>发布服务</li>
</ol>
<h3 id="header-15">发布服务（Application中）</h3>
<ul>
<li>默认命名空间targetNamespace为倒置包名（eg: <a href="http://first.sms.cj.com）">http://first.sms.cj.com）</a></li>
<li>可以重新制定命名空间</li>
<li>注意：需要在实现类中也重新指定命名空间（<code>@WebService(targetNamespace=&quot;http://www.cj.test/&quot;)</code>）</li>
</ul>
<pre><code class="nulljava"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerApp</span></span>{
    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>{
        <span class="comment">//wsdl文件发布地址</span>
        String address=<span class="string">"http://localhost:8888/ns"</span>;
        Endpoint.publish(address, <span class="keyword">new</span> OperationWsServiceImpl()); <span class="comment">//IOperationWsService实现类</span>
    }
}
</code></pre>
<h3 id="header-16">发布服务（Web中）</h3>
<ol>
<li>将wsdl文件置于WEB-INF下</li>
<li>修改服务实现类注解中的wsdlLocation属性（eg：<code>wsdlLocation=&quot;/WEB-INF/wsdl/user.wsdl&quot;</code>）</li>
<li>编写<code>sun-jaxws.xml</code>置于WEB-INF下<pre><code class="nullxml"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span>
<span class="tag">&lt;<span class="name">endpoints</span> <span class="attr">xmlns</span>=<span class="string">"http://java.sun.com/xml/ns/jax-ws/ri/runtime"</span> <span class="attr">version</span>=<span class="string">"2.0"</span>&gt;</span>
<span class="tag">&lt;<span class="name">endpoint</span> <span class="attr">name</span>=<span class="string">"UserWsService"</span> 
    <span class="attr">implementation</span>=<span class="string">"com.cj.my.ws.thrid.UserWsService"</span> <span class="attr">url-pattern</span>=<span class="string">"/us"</span>/&gt;</span>
<span class="tag">&lt;/<span class="name">endpoints</span>&gt;</span>
</code></pre>
</li>
<li>发布服务</li>
</ol>
<h4 id="header-17">发布独立的JAX-WS端点</h4>
<p>通过Spring独立发布</p>
<p>加入依赖包：</p>
<pre><code class="nullxml"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.sun.xml.ws<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jaxws-rt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.9-b14002<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
</code></pre>
<ol>
<li><p>web.xml中添加（在配置Spring基础上）：</p>
<pre><code class="nullxml"> <span class="comment">&lt;!--发布WebService到Web容器中（需配置在SpringListener之前） --&gt;</span>
 <span class="tag">&lt;<span class="name">listener</span>&gt;</span>
     <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>
         com.sun.xml.ws.transport.http.servlet.WSServletContextListener
     <span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span>
 <span class="tag">&lt;/<span class="name">listener</span>&gt;</span>

 <span class="tag">&lt;<span class="name">servlet</span>&gt;</span>
     <span class="comment">&lt;!--和sun-jaxws.xml中的name一致 --&gt;</span>
     <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>UserWsService<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span>
     <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.sun.xml.ws.transport.http.servlet.WSServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span>
 <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span>
 <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span>
     <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>UserWsService<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span> 
     <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/us<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span>
 <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span>
</code></pre>
</li>
<li><p>beans.xml</p>
<pre><code class="nullxml"> <span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span>
         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span>
         <span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span>
         <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span>
         <span class="attr">xsi:schemaLocation</span>=<span class="string">"..."</span>&gt;</span>
     <span class="tag">&lt;<span class="name">context:annotation-config</span>/&gt;</span>
     <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.cj.my.ws"</span> /&gt;</span>
     <span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span> <span class="attr">proxy-target-class</span>=<span class="string">"true"</span>/&gt;</span>

     <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.remoting.jaxws.SimpleJaxWsServiceExporter"</span>&gt;</span>
         <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"baseAddress"</span> <span class="attr">value</span>=<span class="string">"http://localhost:8080/ss/"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span>
     <span class="tag">&lt;/<span class="name">bean</span>&gt;</span>
 <span class="tag">&lt;/<span class="name">beans</span>&gt;</span>
</code></pre>
</li>
</ol>
<h4 id="header-18">发布兼容JAX-WS端点的Web</h4>
<p>通过jax-spring整合</p>
<p>加入依赖包：</p>
<pre><code class="nullxml"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jvnet.jax-ws-commons.spring<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jaxws-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
</code></pre>
<ol>
<li><p>web.xml中添加（在配置Spring基础上）：</p>
<pre><code class="nullxml"> <span class="comment">&lt;!-- 使用WSSpringServlet来管理--&gt;</span>
 <span class="tag">&lt;<span class="name">servlet</span>&gt;</span>
     <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>UserWsService<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span>
     <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.sun.xml.ws.transport.http.servlet.WSSpringServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span>
 <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span>
 <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span>
     <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>UserWsService<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span>
     <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/us<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span>
 <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span>
</code></pre>
</li>
<li><p>beans.xml</p>
<pre><code class="nullxml"> <span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span>
         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span>
         <span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span>
         <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span>
         <span class="attr">xmlns:ws</span>=<span class="string">"http://jax-ws.dev.java.net/spring/core"</span>
         <span class="attr">xmlns:wss</span>=<span class="string">"http://jax-ws.dev.java.net/spring/servlet"</span>
         <span class="attr">xsi:schemaLocation</span>=<span class="string">"...
     http://jax-ws.dev.java.net/spring/core http://jax-ws.dev.java.net/spring/core.xsd
     http://jax-ws.dev.java.net/spring/servlet http://jax-ws.dev.java.net/spring/servlet.xsd"</span>&gt;</span>

     <span class="tag">&lt;<span class="name">context:annotation-config</span>/&gt;</span>
     <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.cj.my.ws"</span> /&gt;</span>    
     <span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span> <span class="attr">proxy-target-class</span>=<span class="string">"true"</span>/&gt;</span>

     <span class="comment">&lt;!-- 让userWsService被Spring管理 --&gt;</span>
     <span class="tag">&lt;<span class="name">wss:binding</span> <span class="attr">url</span>=<span class="string">"/us"</span>&gt;</span>
         <span class="tag">&lt;<span class="name">wss:service</span>&gt;</span>
             <span class="tag">&lt;<span class="name">ws:service</span> <span class="attr">bean</span>=<span class="string">"#userWsService"</span>&gt;</span> <span class="comment">&lt;!-- 指明webservice的注入对象，注意需加个# --&gt;</span>
                 <span class="comment">&lt;!-- 将wsdl的外部xsd文件加入 --&gt;</span>
                 <span class="tag">&lt;<span class="name">ws:metadata</span>&gt;</span>
                     <span class="tag">&lt;<span class="name">value</span>&gt;</span>/WEB-INF/wsdl/user.xsd<span class="tag">&lt;/<span class="name">value</span>&gt;</span>
                 <span class="tag">&lt;/<span class="name">ws:metadata</span>&gt;</span>
             <span class="tag">&lt;/<span class="name">ws:service</span>&gt;</span>
         <span class="tag">&lt;/<span class="name">wss:service</span>&gt;</span>
     <span class="tag">&lt;/<span class="name">wss:binding</span>&gt;</span>

     <span class="comment">&lt;!-- 建议在配置文件中手动注入，若使用Annotation：@Service("userWsService")可能会找不到--&gt;</span>
     <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"userWsService"</span> <span class="attr">class</span>=<span class="string">"com.cj.my.ws.thrid.UserWsService"</span> /&gt;</span> 
 <span class="tag">&lt;/<span class="name">beans</span>&gt;</span>
</code></pre>
</li>
</ol>
<h2 id="header-19">Jax-ws (Client端)</h2>
<h3 id="header-20">基于SOAP的通讯方式（直接传递SOAP消息）</h3>
<ul>
<li>Message方式：格式化为xml进行消息传递<pre><code class="nulljava">  Dispatch&lt;SOAPMessage&gt; dispatch=service.createDispatch(
      <span class="keyword">new</span> QName(<span class="keyword">this</span>.ns,<span class="string">"MyServiceImplPort"</span>),
      SOAPMessage.class,
      Service.Mode.MESSAGE);
  SOAPMessage message=MessageFactory.newInstance().createMessage();
  ...
  SOAPMessage response=dispatch.invoke(message);
  ...
</code></pre>
</li>
<li>Payload方式：格式化为String(将对象编排与反编排)进行消息传递<pre><code class="nulljava">  Dispatch&lt;Source&gt; dispatch=service.createDispatch(
      <span class="keyword">new</span> QName(<span class="keyword">this</span>.ns,<span class="string">"MyServiceImplPort"</span>),
      Source.class,
      Service.Mode.PAYLOAD);
  ...
  StreamSource rs=<span class="keyword">new</span> StreamSource(<span class="keyword">new</span> StringReader(payload));
  Source response=dispatch.invoke(rs);
  ...
</code></pre>
</li>
</ul>
<p><strong>PS：</strong>通过Dispatch发送</p>
<h4 id="header-21">Message方式（xml）</h4>
<p>格式化为xml进行处理</p>
<pre><code class="nulljava"><span class="comment">// ClientTest:</span>
<span class="meta">@Test</span>
<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test02</span><span class="params">()</span></span>{
    <span class="keyword">try</span>{
        <span class="comment">//1.创建服务Service</span>
        URL url = <span class="keyword">new</span> URL(<span class="keyword">this</span>.wsdl);
        QName qname = <span class="keyword">new</span> QName(<span class="keyword">this</span>.ns,<span class="string">"MyServiceImplService"</span>);
        Service service=Service.create(url, qname);

        <span class="comment">//2.创建Dispatch(基于Message方式：格式化为xml进行处理)</span>
        QName pname=<span class="keyword">new</span> QName(<span class="keyword">this</span>.ns,<span class="string">"MyServiceImplPort"</span>);
        <span class="comment">//createDispatch(portName,classType,mode)</span>
        Dispatch&lt;SOAPMessage&gt; dispatch=service.createDispatch(pname,
            SOAPMessage.class,Service.Mode.MESSAGE);

        <span class="comment">//3.创建SOAPMessage</span>
        SOAPMessage message=MessageFactory.newInstance().createMessage();
        SOAPEnvelope envelope=message.getSOAPPart().getEnvelope();
        SOAPBody body=envelope.getBody();

        <span class="comment">//4.创建QName即节点以指定消息中传递的数据</span>
        QName ename=<span class="keyword">new</span> QName(<span class="keyword">this</span>.ns,<span class="string">"minus"</span>,<span class="string">"ns"</span>);
        SOAPBodyElement bodyElement=body.addBodyElement(ename);
        bodyElement.addChildElement(<span class="string">"a"</span>).setValue(<span class="string">"50"</span>);
        bodyElement.addChildElement(<span class="string">"b"</span>).setValue(<span class="string">"30"</span>);
        message.writeTo(System.out);
        System.out.println();

        <span class="comment">//5.通过Dispatch传递消息，会返回响应消息</span>
        SOAPMessage response=dispatch.invoke(message);
        response.writeTo(System.out);
        System.out.println();

        <span class="comment">//将响应的消息转换为dom对象（可通过Xpath等多种方式完成对响应数据的处理）</span>
        SOAPBody responseBody=response.getSOAPPart().getEnvelope().getBody();
        Document doc=responseBody.extractContentAsDocument();
        String str=doc.getElementsByTagName(<span class="string">"minusResult"</span>).item(<span class="number">0</span>).getTextContent();
        System.out.println(str);

    }<span class="keyword">catch</span> (Exception e){
        System.out.println(e.getMessage());
    }
}
</code></pre>
<p>发送的消息如下：</p>
<pre><code class="nullxml"><span class="tag">&lt;<span class="name">SOAP-ENV:Envelope</span> <span class="attr">xmlns:SOAP-ENV</span>=<span class="string">"http://schemas.xmlsoap.org/soap/envelope/"</span>&gt;</span>
    <span class="tag">&lt;<span class="name">SOAP-ENV:Header</span>/&gt;</span>
    <span class="tag">&lt;<span class="name">SOAP-ENV:Body</span>&gt;</span>
        <span class="tag">&lt;<span class="name">ns:minus</span> <span class="attr">xmlns:ns</span>=<span class="string">"http://first.ws.my.cj.com/"</span>&gt;</span>
            <span class="tag">&lt;<span class="name">a</span>&gt;</span>50<span class="tag">&lt;/<span class="name">a</span>&gt;</span>
            <span class="tag">&lt;<span class="name">b</span>&gt;</span>30<span class="tag">&lt;/<span class="name">b</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">ns:minus</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">SOAP-ENV:Body</span>&gt;</span>
<span class="tag">&lt;/<span class="name">SOAP-ENV:Envelope</span>&gt;</span>
</code></pre>
<p>得到响应消息如下：</p>
<pre><code class="nullxml"><span class="tag">&lt;<span class="name">S:Envelope</span> <span class="attr">xmlns:S</span>=<span class="string">"http://schemas.xmlsoap.org/soap/envelope/"</span>&gt;</span>
    <span class="tag">&lt;<span class="name">S:Header</span>/&gt;</span>
    <span class="tag">&lt;<span class="name">S:Body</span>&gt;</span>
        <span class="tag">&lt;<span class="name">ns2:minusResponse</span> <span class="attr">xmlns:ns2</span>=<span class="string">"http://first.ws.my.cj.com/"</span>&gt;</span>
            <span class="tag">&lt;<span class="name">minusResult</span>&gt;</span>20<span class="tag">&lt;/<span class="name">minusResult</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">ns2:minusResponse</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">S:Body</span>&gt;</span>
<span class="tag">&lt;/<span class="name">S:Envelope</span>&gt;</span>
</code></pre>
<h4 id="header-22">Payload方式（String）</h4>
<p>通过字符串(将对象编排与反编排)进行消息的传递，会自动对字符串进行编码</p>
<p>发送（payload）：</p>
<pre><code class="nullxml"><span class="tag">&lt;<span class="name">ns:addStudent</span> <span class="attr">xmlns:ns</span>=<span class="string">"http://first.ws.my.cj.com/"</span>&gt;</span>
    <span class="tag">&lt;<span class="name">ns2:student</span> <span class="attr">xmlns:ns2</span>=<span class="string">"http://first.ws.my.cj.com/"</span>&gt;</span>
        <span class="tag">&lt;<span class="name">age</span>&gt;</span>18<span class="tag">&lt;/<span class="name">age</span>&gt;</span>
        <span class="tag">&lt;<span class="name">id</span>&gt;</span>0<span class="tag">&lt;/<span class="name">id</span>&gt;</span>
        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Lucy<span class="tag">&lt;/<span class="name">name</span>&gt;</span>
        <span class="tag">&lt;<span class="name">sex</span>&gt;</span>Female<span class="tag">&lt;/<span class="name">sex</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">ns2:student</span>&gt;</span>
<span class="tag">&lt;/<span class="name">ns:addStudent</span>&gt;</span>
</code></pre>
<pre><code class="nulljava"><span class="comment">// ClientTest:</span>
<span class="meta">@Test</span>
<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test03</span><span class="params">()</span></span>{
    <span class="keyword">try</span>{
        <span class="comment">//1.创建服务Service</span>
        URL url = <span class="keyword">new</span> URL(<span class="keyword">this</span>.wsdl);
        QName qname = <span class="keyword">new</span> QName(<span class="keyword">this</span>.ns,<span class="string">"MyServiceImplService"</span>);
        Service service=Service.create(url, qname);

        <span class="comment">//2.创建Dispatch(基于Payload,通过源数据Source的方式传递)</span>
        QName dname=<span class="keyword">new</span> QName(<span class="keyword">this</span>.ns,<span class="string">"MyServiceImplPort"</span>);
        Dispatch&lt;Source&gt; dispatch=service.createDispatch(dname,
        Source.class,Service.Mode.PAYLOAD);

        <span class="comment">//3. 创建对象</span>
        Student student=<span class="keyword">new</span> Student();
        student.setId(<span class="number">5</span>);
        student.setName(<span class="string">"Lucy"</span>);
        student.setAge(<span class="number">18</span>);
        student.setSex(Gender.FEMALE);

        <span class="comment">//4. 使用Marshaller编排对象：根据对象组建xml字符串</span>
        JAXBContext ctx=JAXBContext.newInstance(AddStudent.class);
        AddStudent addStudent=<span class="keyword">new</span> AddStudent();
        addStudent.setStudent(student);
        QName sname=<span class="keyword">new</span> QName(<span class="keyword">this</span>.ns,<span class="string">"addStudent"</span>);
        JAXBElement&lt;AddStudent&gt; element=<span class="keyword">new</span> JAXBElement&lt;AddStudent&gt;(sname,AddStudent.class,addStudent);

        Marshaller mar=ctx.createMarshaller();
        <span class="comment">//fragement 默认为false，会创建头信息：&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;</span>
        mar.setProperty(Marshaller.JAXB_FRAGMENT,<span class="keyword">true</span>);
        StringWriter writer= <span class="keyword">new</span> StringWriter();
        mar.marshal(element, writer);

        String payload=writer.toString();
        System.out.println(<span class="string">"payload:"</span>+payload);

        <span class="comment">//6.通过Dispatch传递payload</span>
        StreamSource rs=<span class="keyword">new</span> StreamSource(<span class="keyword">new</span> StringReader(payload));
        Source response=dispatch.invoke(rs);

        <span class="comment">//7.处理响应信息</span>
        System.out.println(response <span class="keyword">instanceof</span> StAXSource);

        <span class="comment">//使用Transformer对象将Source转换为dom对象</span>
        Transformer trans=TransformerFactory.newInstance().newTransformer();
        DOMResult result=<span class="keyword">new</span> DOMResult();
        trans.transform(response, result);

        <span class="comment">//通过XPath处理相应信息</span>
        XPath xpath=XPathFactory.newInstance().newXPath();
        NodeList nodeList=(NodeList)xpath.evaluate(<span class="string">"//student"</span>,
            result.getNode(),XPathConstants.NODESET);

        <span class="comment">//使用Unmarshaller反编排：将xml节点转换回对象</span>
        <span class="comment">//Student stu=(Student)ctx.createUnmarshaller().unmarshal(nodeList.item(0));</span>
        JAXBElement&lt;Student&gt; resultElement=ctx.createUnmarshaller()
                            .unmarshal(nodeList.item(<span class="number">0</span>), Student.class);
        Student stu=resultElement.getValue();
        System.out.println(stu.getId()+<span class="string">"|"</span>+stu.getName()+<span class="string">"|"</span>+stu.getAge()+<span class="string">"|"</span>+stu.getSex());
    }<span class="keyword">catch</span> (Exception e){
        System.out.println(<span class="string">"Exception:"</span>+e.getMessage());
        e.printStackTrace();
    }
}
</code></pre>
<h4 id="header-23">扩展：增加消息头</h4>
<pre><code class="nulljava"><span class="comment">//创建SOAPHeader</span>
SOAPHeader header=envelope.getHeader();
<span class="keyword">if</span>(header==<span class="keyword">null</span>)
    header=envelope.addHeader();
QName hName=<span class="keyword">new</span> QName(<span class="keyword">this</span>.ns,<span class="string">"authInfo"</span>,<span class="string">"ns"</span>);
header.addHeaderElement(hName).setValue(<span class="string">"auth:tom"</span>);
</code></pre>
<p>创建的消息（Result）如下：</p>
<pre><code class="nullxml"><span class="tag">&lt;<span class="name">SOAP-ENV:Envelope</span> <span class="attr">xmlns:SOAP-ENV</span>=<span class="string">"http://schemas.xmlsoap.org/soap/envelope/"</span>&gt;</span>
    <span class="tag">&lt;<span class="name">SOAP-ENV:Header</span>&gt;</span>
        <span class="tag">&lt;<span class="name">ns:authInfo</span> <span class="attr">xmlns:ns</span>=<span class="string">"http://first.ws.my.cj.com/"</span>&gt;</span>auth:tom<span class="tag">&lt;/<span class="name">ns:authInfo</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">SOAP-ENV:Header</span>&gt;</span>
    <span class="tag">&lt;<span class="name">SOAP-ENV:Body</span>&gt;</span>
        <span class="tag">&lt;<span class="name">ns:list</span> <span class="attr">xmlns:ns</span>=<span class="string">"http://first.ws.my.cj.com/"</span>/&gt;</span>
    <span class="tag">&lt;/<span class="name">SOAP-ENV:Body</span>&gt;</span>
<span class="tag">&lt;/<span class="name">SOAP-ENV:Envelope</span>&gt;</span>
</code></pre>
<h3 id="header-24">基于Jax-ws的通讯方式（封装了SOAP消息）</h3>
<ol>
<li>使用wsimport命令根据wsdl（不依赖于平台）生成客户端代码</li>
<li>将生成的java类导入到client端项目中<ul>
<li>注意：这里生成的interface是Client根据wsdl生成的，与Server端的不是同一个</li>
</ul>
</li>
<li>创建Service，调用发布的方法</li>
</ol>
<h4 id="header-25">据wsdl中的service创建Service</h4>
<p>wsdl文件中：</p>
<pre><code class="nullxml"><span class="tag">&lt;<span class="name">wsdl:service</span> <span class="attr">name</span>=<span class="string">"OperationWsService"</span>&gt;</span>
    <span class="tag">&lt;<span class="name">wsdl:port</span> <span class="attr">name</span>=<span class="string">"OperationWsServicePort"</span> <span class="attr">binding</span>=<span class="string">"tns:OperationWsServiceSOAP"</span> &gt;</span>
        <span class="tag">&lt;<span class="name">soap:address</span> <span class="attr">location</span>=<span class="string">"http://localhost:8888/ns"</span>/&gt;</span>
    <span class="tag">&lt;/<span class="name">wsdl:port</span>&gt;</span>
<span class="tag">&lt;/<span class="name">wsdl:service</span>&gt;</span>
</code></pre>
<pre><code class="nulljava"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>{
    OperationWsService service=<span class="keyword">new</span> OperationWsService ();
    IOperationWsService operationWsService=service.getOperationWsServicePort();
    <span class="comment">//调用实现方法</span>
    System.out.println(operationWsService.plus(<span class="number">34</span>, <span class="number">56</span>));
}
</code></pre>
<h4 id="header-26">据wsdl中的definitions创建Service</h4>
<pre><code class="nullxml"><span class="tag">&lt;<span class="name">wsdl:definitions</span> <span class="attr">xmlns:soap</span>=<span class="string">"http://schemas.xmlsoap.org/wsdl/soap/"</span> 
        <span class="attr">xmlns:tns</span>=<span class="string">"http://ws.cj.com/student"</span> 
        <span class="attr">xmlns:wsdl</span>=<span class="string">"http://schemas.xmlsoap.org/wsdl/"</span> 
        <span class="attr">xmlns:xsd</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span> 
        <span class="attr">name</span>=<span class="string">"OperationWsService"</span> 
        <span class="attr">targetNamespace</span>=<span class="string">"http://ws.cj.com/student"</span>&gt;</span>
</code></pre>
<pre><code class="nulljava"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> MalformedURLException</span>{
    URL url=<span class="keyword">new</span> URL(<span class="string">"http://localhost:8888/ns?wsdl"</span>); 
    <span class="comment">//命名Qname(命名空间,服务名称)</span>
    QName qname=<span class="keyword">new</span> QName(<span class="string">"http://ws.cj.com/student"</span>,<span class="string">"OperationWsService"</span>);
    <span class="comment">//相当于创建了&lt;OperationWsService xmln=”http://ws.cj.com/student”&gt;节点</span>

    OperationWsService service=<span class="keyword">new</span> OperationWsService(url, qname);
    IOperationWsService operationWsService=service.getPort(IOperationWsService.class);

    <span class="comment">//调用实现方法</span>
    System.out.println(operationWsService.plus(<span class="number">34</span>, <span class="number">56</span>));
}
</code></pre>
<h2 id="header-27">Jax-ws (Handler)</h2>
<p>Handler处理SOAP消息 (类似过滤器)：</p>
<ul>
<li>逻辑处理器<code>LogicalHandler</code>：只能获取<code>SOAPBody</code>的信息</li>
<li>消息处理器<code>SOAPHandler</code>：可以获取<code>SOAPMessage</code>的信息</li>
<li>Out处理顺序：先逻辑处理器再消息处理器</li>
</ul>
<p><img src="/2013/09/01/handler1.png" alt="Handler"><br><img src="/2013/09/01/handler2.png" alt="Handler"></p>
<h3 id="header-28">自定义SOAPHandler</h3>
<p><code>implements SOAPHandler&lt;SOAPMessageContext&gt;</code></p>
<ul>
<li><p><code>@Override handleMessage</code>方法</p>
<ul>
<li>可处理 <code>in</code> 和 <code>out</code> 消息 （out消息必须 return true，否则Exception）</li>
<li><code>return true</code>：<ul>
<li>交由下一个Handler处理</li>
<li><code>in</code>消息最终到达Server端WebService实现类处理；</li>
<li><code>out</code>消息最终将响应消息发送到Client端。</li>
</ul>
</li>
<li><code>return false</code>:<ul>
<li><code>in</code>消息被阻断，交由handleFault方法处理；</li>
<li><code>out</code>消息引发Exception</li>
</ul>
</li>
</ul>
</li>
<li><p><code>@Override handleFault</code>方法：</p>
<ul>
<li>可捕获处理<code>SOAPException</code> (对WebService而言，相当于Exception)</li>
<li>无法捕获处理<code>SOAPFaultException</code>（对WebService而言，相当于RuntimeException，必须在Client端调用处捕获）</li>
<li><code>return true</code>:交由下一个Handler处理； </li>
<li><code>return false</code>:阻断</li>
</ul>
</li>
</ul>
<p>示例：</p>
<pre><code class="nulljava"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XxxHandler</span> <span class="keyword">implements</span> <span class="title">SOAPHandler</span>&lt;<span class="title">SOAPMessageContext</span>&gt;
    @<span class="title">Override</span>
    <span class="title">public</span> <span class="title">boolean</span> <span class="title">handleMessage</span>(<span class="title">SOAPMessageContext</span> <span class="title">context</span>)</span>{
        Boolean out=(Boolean)context.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY);
        <span class="keyword">if</span>(out)
            System.out.println(<span class="string">"XxxHandler out"</span>);
        <span class="keyword">else</span>
            System.out.println(<span class="string">"XxxHandler in"</span>);
        <span class="keyword">return</span> <span class="keyword">true</span>;
    }

    <span class="meta">@Override</span>
    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handleFault</span><span class="params">(SOAPMessageContext context)</span></span>{
        System.out.println(<span class="string">"XxxHandle Fault"</span>);
        <span class="keyword">try</span>{
            SOAPMessage message =context.getMessage();
            SOAPEnvelope envelope=message.getSOAPPart().getEnvelope();
            SOAPFault fault=envelope.getBody().getFault();
            <span class="keyword">if</span>(fault!=<span class="keyword">null</span>)
                System.out.println(<span class="string">"Handle1 Fault:"</span>+fault.getFaultString());
        } <span class="keyword">catch</span> (SOAPException e){
            e.printStackTrace();
        } <span class="keyword">catch</span> (IOException e){
            e.printStackTrace();
        }<span class="keyword">catch</span>(SOAPFaultException e)<span class="comment">//不会触发此异常！</span>
        {
            System.out.println(<span class="string">"Handler1 Fault catch SOAPFaultException"</span>);
        }
        <span class="keyword">return</span> <span class="keyword">true</span>;
    }

    <span class="meta">@Override</span>
    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(MessageContext context)</span>
    </span>{}

    <span class="meta">@Override</span>
    <span class="function"><span class="keyword">public</span> Set&lt;QName&gt; <span class="title">getHeaders</span><span class="params">()</span></span>{
        <span class="keyword">return</span> <span class="keyword">null</span>;
    }
}
</code></pre>
<h3 id="header-29">配置使用</h3>
<ul>
<li>配置Handler过滤链文件 (eg: <code>handler-chain.xml</code>， 置于classpath下)<pre><code class="nullxml"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span> standalone=<span class="string">"yes"</span><span class="meta">?&gt;</span></span>
<span class="tag">&lt;<span class="name">javaee:handler-chains</span> 
   <span class="attr">xmlns:javaee</span>=<span class="string">"http://java.sun.com/xml/ns/javaee"</span> 
   <span class="attr">xmlns:xsd</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span>&gt;</span>
<span class="tag">&lt;<span class="name">javaee:handler-chain</span>&gt;</span>
  <span class="tag">&lt;<span class="name">javaee:handler</span>&gt;</span>
    <span class="tag">&lt;<span class="name">javaee:handler-class</span>&gt;</span>com.cj.my.ws.handler.LicenseHandler<span class="tag">&lt;/<span class="name">javaee:handler-class</span>&gt;</span>
  <span class="tag">&lt;/<span class="name">javaee:handler</span>&gt;</span>
<span class="tag">&lt;/<span class="name">javaee:handler-chain</span>&gt;</span>
<span class="tag">&lt;/<span class="name">javaee:handler-chains</span>&gt;</span>
</code></pre>
</li>
<li>在WebService实现类上添加@HandlerChain注解（eg：<code>@HandlerChain(file=&quot;handler-chain.xml&quot;)</code></li>
</ul>
<p><strong>PS：</strong><br>在下面介绍的CXF中，可通过其他方式加载使用Handler，还可以使用Inteceptor代替Handler</p>
<h2 id="header-30">CXF</h2>
<p>基于CXF的通讯方式 （<a href="http://cxf.apache.org/">Apache CXF官网</a>）</p>
<ul>
<li>基于jax-ws，开发方式和jax-ws基本类似，仅仅是为jax-ws增加了一些功能</li>
<li>可以使用Interceptor替代SOAPHandler</li>
<li>生命周期（阶段）：<br><img src="2013-09-01-Webservice/cxfLifeCycle.png" alt="LifeCycle"></li>
<li>有多种Interceptor拦截器，用的比较多的是：<ul>
<li>extends AbstractPhaseInterceptor<Message></li>
<li>extends AbstractSoapInterceptor</li>
</ul>
</li>
</ul>
<h3 id="header-31">依赖包</h3>
<pre><code class="nullxml"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.cxf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cxf-rt-frontend-jaxws<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">version</span>&gt;</span>${cxf.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
<span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.cxf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cxf-rt-transports-http<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">version</span>&gt;</span>${cxf.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
<span class="comment">&lt;!-- 使用jetty容器时才需要此包--&gt;</span>
<span class="tag">&lt;<span class="name">dependency</span>&gt;</span>
    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.cxf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cxf-rt-transports-http-jetty<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>
    <span class="tag">&lt;<span class="name">version</span>&gt;</span>${cxf.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span>
<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>
</code></pre>
<h3 id="header-32">生成代码</h3>
<p>示例：使用契约优先的方式</p>
<ol>
<li>编写wsdl</li>
<li>使用wsimport命令生成sourcecode</li>
<li>Server端<ul>
<li>拷贝wsimport命令生成的interface（eg: IUserWsService）到Server端（去除@XmlSeeAlso注解）</li>
<li>wsdl放置到WEB-INF(web项目)或META-INF(local项目)下</li>
<li>编写服务实现类（eg:<code>public class UserWsService implements IUserWsService</code>）</li>
<li>发布服务</li>
</ul>
</li>
<li>Client端<ul>
<li>拷贝wsimport命令生成的所有代码到Client端</li>
<li>调用服务</li>
</ul>
</li>
</ol>
<h3 id="header-33">使用</h3>
<h4 id="header-34">Server端</h4>
<p>方式一：使用JaxWs API 发布服务</p>
<pre><code class="nulljava">Endpoint.publish(<span class="string">"http://localhost:9090/my/us"</span>, <span class="keyword">new</span> UserWsService());
</code></pre>
<p>方式二：使用服务发布工厂<code>JaxWsServerFactoryBean</code>发布服务（默认使用“代码优先”）</p>
<pre><code class="nulljava">JaxWsServerFactoryBean serverFactory=<span class="keyword">new</span> JaxWsServerFactoryBean();
serverFactory.setAddress(<span class="string">"http://localhost:9090/my/us"</span>);
serverFactory.setServiceBean(<span class="keyword">new</span> UserWsService());
serverFactory.setServiceClass(IUserWsService.class);

<span class="comment">//为访问增加相应的Interceptor来处理in/out消息</span>
serverFactory.getInInterceptors().add(<span class="keyword">new</span> LoggingInInterceptor());
serverFactory.getOutInterceptors().add(<span class="keyword">new</span> LoggingOutInterceptor());

<span class="comment">//需要设置以下参数才能基于“契约优先”发布(会自动对应外部xsd文件)</span>
serverFactory.setWsdlLocation(<span class="string">"META-INF/wsdl/user.wsdl"</span>);
serverFactory.setServiceName(<span class="keyword">new</span> QName(<span class="string">"http://www.my.org/user"</span>,<span class="string">"UserWsService"</span>));

<span class="comment">//增加自定义Handler</span>
<span class="comment">//serverFactory.getHandlers().add(new LicenseHandler());</span>
<span class="comment">//可使用Interceptor代替Handler</span>
serverFactory.getInInterceptors().add(<span class="keyword">new</span> LicenseInInterceptor());

serverFactory.create();
</code></pre>
<h4 id="header-35">Client端</h4>
<p>方式一：使用 JaxWs API 进行客户端调用</p>
<pre><code class="nulljava">UserWsService service=<span class="keyword">new</span> UserWsService();
IUserWsService userService=service.getUserWsServicePort();
System.out.println(userService.addTest(<span class="number">23</span>, <span class="number">45</span>));
</code></pre>
<p>方式二：使用代理工厂<code>JaxWsProxyFactoryBean</code>进行客户端调用</p>
<pre><code class="nulljava">JaxWsProxyFactoryBean factory = <span class="keyword">new</span> JaxWsProxyFactoryBean();
factory.setAddress(<span class="string">"http://localhost:9090/my/us"</span>);
factory.setServiceClass(IUserWsService.class);

<span class="comment">//为访问增加相应的Interceptor来处理in/out消息</span>
factory.getInInterceptors().add(<span class="keyword">new</span> LoggingInInterceptor());
factory.getOutInterceptors().add(<span class="keyword">new</span> LoggingOutInterceptor());

<span class="comment">//增加SOAPHandler</span>
<span class="comment">//factory.getHandlers().add(new LicenseHandler());</span>
<span class="comment">//可以使用Interceptor代替Handler</span>
factory.getOutInterceptors().add(<span class="keyword">new</span> LicenseOutInterceptor());

IUserWsService userService=(IUserWsService)factory.create();
System.out.println(userService.addTest(<span class="number">23</span>, <span class="number">45</span>));
</code></pre>
<h3 id="header-36">结合Spring</h3>
<p>使用Spring管理</p>
<h4 id="header-37">Server端</h4>
<p>发布WebService到Web容器中，并通过Spring管理WebService</p>
<ol>
<li><p>配置<code>web.xml</code></p>
<pre><code class="nullxml"> <span class="comment">&lt;!-- 添加CXF的servlet监听请求 --&gt;</span>
 <span class="tag">&lt;<span class="name">servlet</span>&gt;</span>
     <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>CXFServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span>
     <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.apache.cxf.transport.servlet.CXFServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span>
 <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span>
 <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span>
     <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>CXFServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span>
     <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/service/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span>
 <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span>
</code></pre>
</li>
<li><p>配置<code>beans.xml</code></p>
<pre><code class="nullxml"> <span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span>
         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span>
         <span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span>
         <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span>
         <span class="attr">xmlns:jaxws</span>=<span class="string">"http://cxf.apache.org/jaxws"</span>
         <span class="attr">xsi:schemaLocation</span>=<span class="string">" ...
             http://cxf.apache.org/jaxws http://cxf.apache.org/schemas/jaxws.xsd"</span>&gt;</span>

     <span class="tag">&lt;<span class="name">context:annotation-config</span>/&gt;</span>
     <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.cj.my.ws.service"</span> /&gt;</span>
     <span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span> <span class="attr">proxy-target-class</span>=<span class="string">"true"</span>/&gt;</span>

     <span class="comment">&lt;!-- 导入cxf--&gt;</span>
     <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">"classpath:META-INF/cxf/cxf.xml"</span>/&gt;</span>
     <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">"classpath:META-INF/cxf/cxf-extension-jaxws.xml"</span>/&gt;</span>
     <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">"classpath:META-INF/cxf/cxf-servlet.xml"</span>/&gt;</span>

     <span class="comment">&lt;!-- 发布服务--&gt;</span>
 <span class="tag">&lt;/<span class="name">beans</span>&gt;</span>
</code></pre>
<ul>
<li>发布方式一：使用<code>&lt;jaxws:endpoint&gt;</code><pre><code class="nullxml"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"userWsService"</span> <span class="attr">class</span>=<span class="string">"com.cj.my.ws.cxf.UserWsService"</span> /&gt;</span>
<span class="tag">&lt;<span class="name">jaxws:endpoint</span> <span class="attr">id</span>=<span class="string">"userWS"</span> <span class="attr">implementor</span>=<span class="string">"#userWsService"</span> <span class="attr">address</span>=<span class="string">"/us"</span>&gt;</span>
  <span class="tag">&lt;<span class="name">jaxws:inInterceptors</span>&gt;</span>
      <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"ipInInterceptor"</span> <span class="attr">class</span>=<span class="string">"com.cj.my.ws.cxf.interceptor.IpInInterceptor"</span>/&gt;</span>
  <span class="tag">&lt;/<span class="name">jaxws:inInterceptors</span>&gt;</span>
  <span class="comment">&lt;!--  &lt;jaxws:outFaultInterceptors&gt;
      &lt;bean id="loggerOutInterceptor" class="org.apache.cxf.interceptor.LoggingOutInterceptor"/&gt;
      &lt;bean id="faultOutInterceptor" class="org.apache.cxf.interceptor.FaultOutInterceptor"/&gt;
  &lt;/jaxws:outFaultInterceptors&gt; --&gt;</span>
  <span class="tag">&lt;<span class="name">jaxws:handlers</span>&gt;</span>
      <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"backWsLogHandler"</span> <span class="attr">class</span>=<span class="string">"com.cj.my.ws.cxf.handler.BackWsLogHandler"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span>
      <span class="comment">&lt;!-- &lt;bean id="licenseHandler" class="com.cj.my.ws.cxf.handler.LicenseHandler"&gt;&lt;/bean&gt; --&gt;</span>
  <span class="tag">&lt;/<span class="name">jaxws:handlers</span>&gt;</span>
<span class="tag">&lt;/<span class="name">jaxws:endpoint</span>&gt;</span>
</code></pre>
</li>
<li>发布方式二：使用<code>&lt;jaxws:server&gt;</code><pre><code class="nullxml"><span class="tag">&lt;<span class="name">jaxws:server</span> <span class="attr">id</span>=<span class="string">"userWS"</span> <span class="attr">serviceClass</span>=<span class="string">"com.cj.my.ws.cxf.IUserWsService"</span> <span class="attr">address</span>=<span class="string">"/us"</span>&gt;</span>
  <span class="tag">&lt;<span class="name">jaxws:serviceBean</span>&gt;</span>
      <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"com.cj.my.ws.cxf.UserWsService"</span>/&gt;</span>
  <span class="tag">&lt;/<span class="name">jaxws:serviceBean</span>&gt;</span>
<span class="tag">&lt;/<span class="name">jaxws:server</span>&gt;</span>
</code></pre>
</li>
<li>其实<code>&lt;jaxws:server&gt;</code> 和<code>&lt;jaxws:endpoint&gt;</code> 是等效的，都用于发布Web 服务<ul>
<li>JAX-WS 规范中使用EndPoint 发布Web 服务，CXF 为了和JAX-WS 对应，提供了这个与<code>&lt;jaxws:server&gt;</code> 功能一样的配置元素<code>&lt;jaxws:endpoint&gt;</code></li>
</ul>
</li>
</ul>
</li>
</ol>
<h4 id="header-38">Client端</h4>
<p>通过Spring注入WebService Client</p>
<p>使用<code>&lt;jaxws:client&gt;</code>:</p>
<pre><code class="nullxml"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span>
        <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span>
        <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span>
        <span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span>
        <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span>
        <span class="attr">xmlns:jaxws</span>=<span class="string">"http://cxf.apache.org/jaxws"</span>
        <span class="attr">xmlns:cxf</span>=<span class="string">"http://cxf.apache.org/core"</span>
        <span class="attr">xsi:schemaLocation</span>=<span class="string">"
            http://cxf.apache.org/jaxws http://cxf.apache.org/schemas/jaxws.xsd
            http://cxf.apache.org/core http://cxf.apache.org/schemas/core.xsd"</span>&gt;</span>

<span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.cj.my.ws"</span>/&gt;</span>

<span class="tag">&lt;<span class="name">jaxws:client</span> <span class="attr">id</span>=<span class="string">"userWsService"</span> 
        <span class="attr">serviceClass</span>=<span class="string">"com.cj.my.ws.cxf.client.IUserWsService"</span> 
        <span class="attr">address</span>=<span class="string">"http://localhost:9090/my/service/us"</span> &gt;</span>
    <span class="comment">&lt;!-- &lt;jaxws:handlers&gt;
        &lt;ref bean="licenseHandler"/&gt;
    &lt;/jaxws:handlers&gt; --&gt;</span>
<span class="tag">&lt;/<span class="name">jaxws:client</span>&gt;</span>
</code></pre>
<p>测试：</p>
<pre><code class="nulljava"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)
<span class="meta">@ContextConfiguration</span>(<span class="string">"classpath:beans.xml"</span>)
<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientSpringTest</span>
</span>{
    <span class="meta">@Inject</span>
    <span class="keyword">private</span> IUserWsService userWsService=<span class="keyword">null</span>;

    <span class="meta">@Test</span>
    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAddTest</span><span class="params">()</span></span>{
        System.out.println(userWsService.addTest(<span class="number">23</span>, <span class="number">45</span>));
    }
}
</code></pre>
<h3 id="header-39">拦截器</h3>
<h4 id="header-40">自定义拦截器</h4>
<p>CXF中有一些常用的拦截器（例如：LoggingOutInterceptor，LoggingInInterceptor）</p>
<p>也可自定义拦截器，例如：</p>
<pre><code class="nulljava"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestOutInterceptor</span> <span class="keyword">extends</span> <span class="title">AbstractSoapInterceptor</span></span>{
    <span class="keyword">private</span> String ns=<span class="string">"http://www.my.org/user"</span>;
    <span class="function"><span class="keyword">public</span> <span class="title">TestOutInterceptor</span><span class="params">()</span></span>{
        <span class="keyword">super</span>(Phase.WRITE);
    }

    <span class="meta">@Override</span>
    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(SoapMessage message)</span> <span class="keyword">throws</span> Fault</span>{
        System.out.println(<span class="string">"TestOutInterceptor------------"</span>);
        <span class="keyword">try</span>{
            DataBinding dataBinding=<span class="keyword">new</span> JAXBDataBinding(String.class);
            QName qname=<span class="keyword">new</span> QName(<span class="keyword">this</span>.ns,<span class="string">"testInfo"</span>);
            Header header=<span class="keyword">new</span> Header(qname, <span class="string">"test 88"</span>, dataBinding);
            message.getHeaders().add(header);
        } <span class="keyword">catch</span> (JAXBException e){
            e.printStackTrace();
        }
    }
}
</code></pre>
<h4 id="header-41">添加拦截器</h4>
<p>方法一：<code>JaxWsServerFactoryBean</code></p>
<p>Server端：</p>
<pre><code class="nulljava">JaxWsServerFactoryBean serverFactory=<span class="keyword">new</span> JaxWsServerFactoryBean();
...
serverFactory.getInInterceptors().add(<span class="keyword">new</span> LicenseInInterceptor());
</code></pre>
<p>Client端：</p>
<pre><code class="nulljava">JaxWsProxyFactoryBean factory = <span class="keyword">new</span> JaxWsProxyFactoryBean();
...
factory.getOutInterceptors().add(<span class="keyword">new</span> LicenseOutInterceptor());
</code></pre>
<p>方法二：Annotation</p>
<p>Server端：</p>
<pre><code class="nulljava"><span class="meta">@InInterceptors</span>(interceptors={<span class="string">"com.cj.my.ws.cxf.interceptor.LicenseInInterceptor"</span>})
<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserWsService</span> <span class="keyword">implements</span> <span class="title">IUserWsService</span></span>
</code></pre>
<p>Client端：</p>
<pre><code class="nulljava"><span class="meta">@OutInterceptors</span>(interceptors={
        <span class="string">"com.cj.my.ws.cxf.interceptor.TestOutInterceptor"</span>,
        <span class="string">"com.cj.my.ws.cxf.interceptor.LicenseOutInterceptor"</span>,
        <span class="string">"org.apache.cxf.interceptor.LoggingOutInterceptor"</span>})
<span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IUserWsService</span></span>
</code></pre>
<p>方法三：基于Spring，在Spring配置文件(eg: <code>beans.xml</code>)中添加</p>
<ul>
<li>全局配置（使用<code>&lt;cxf:bus&gt;</code>）<ul>
<li>即作为Client端和Server端都有效（即：对你访问第三方的WebService接口和别人访问你发布出去的WebService接口,都起到拦截作用 ）<pre><code class="nullxml"><span class="tag">&lt;<span class="name">cxf:bus</span>&gt;</span>
  <span class="tag">&lt;<span class="name">cxf:outInterceptors</span>&gt;</span>
      <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"loggingOutInterceptor"</span>/&gt;</span>
  <span class="tag">&lt;/<span class="name">cxf:outInterceptors</span>&gt;</span>
  <span class="tag">&lt;<span class="name">cxf:inInterceptors</span>&gt;</span>
      <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"loggingInInterceptor"</span>/&gt;</span>
  <span class="tag">&lt;/<span class="name">cxf:inInterceptors</span>&gt;</span>
<span class="tag">&lt;/<span class="name">cxf:bus</span>&gt;</span>
<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"loggingOutInterceptor"</span> <span class="attr">class</span>=<span class="string">"org.apache.cxf.interceptor.LoggingOutInterceptor"</span>/&gt;</span>
<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"loggingInInterceptor"</span> <span class="attr">class</span>=<span class="string">"org.apache.cxf.interceptor.LoggingInInterceptor"</span>/&gt;</span>
</code></pre>
</li>
</ul>
</li>
<li>局部（针对某个WebService）：<ul>
<li>Server端：配置在<code>&lt;jaxws:server&gt;</code>或<code>&lt;jaxws:endpoint&gt;</code>中</li>
<li>Client端：配置在<code>&lt;jaxws:client&gt;</code>中，例如：<pre><code class="nullxml"><span class="tag">&lt;<span class="name">jaxws:client</span> <span class="attr">id</span>=<span class="string">"userWsService"</span>
      <span class="attr">serviceClass</span>=<span class="string">"com.cj.my.ws.cxf.client.IUserWsService"</span> 
      <span class="attr">address</span>=<span class="string">"http://localhost:9090/my/service/us"</span> &gt;</span>
  <span class="tag">&lt;<span class="name">jaxws:handlers</span>&gt;</span>
      <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"licenseHandler"</span>/&gt;</span>
  <span class="tag">&lt;/<span class="name">jaxws:handlers</span>&gt;</span>
<span class="tag">&lt;/<span class="name">jaxws:client</span>&gt;</span>
<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"licenseHandler"</span> <span class="attr">class</span>=<span class="string">"com.cj.my.ws.cxf.handler.LicenseHandler"</span>/&gt;</span>
</code></pre>
</li>
</ul>
</li>
</ul>
<h2 id="header-42">扩展应用</h2>
<h3 id="header-43">Upload附件</h3>
<p>二进制MTOM</p>
<ul>
<li>字节数组<code>byte[]</code> 放于SOAPBody不好，若太大，会有内存溢出异常</li>
<li>使用MTOM二进制处理（优化过）</li>
<li><code>@MTOM</code>：以附件AttachmentPart传送，即以流的方式传送</li>
</ul>
<ol>
<li><p>wsdl文件中：</p>
<pre><code class="nullxml"> <span class="tag">&lt;<span class="name">xsd:complexType</span> <span class="attr">name</span>=<span class="string">"uploadFile"</span>&gt;</span>
     <span class="tag">&lt;<span class="name">xsd:sequence</span>&gt;</span>
         <span class="tag">&lt;<span class="name">xsd:element</span> <span class="attr">name</span>=<span class="string">"file"</span> <span class="attr">type</span>=<span class="string">"xsd:base64Binary"</span> <span class="attr">nillable</span>=<span class="string">"true"</span> <span class="attr">minOccurs</span>=<span class="string">"0"</span>/&gt;</span>
     <span class="tag">&lt;/<span class="name">xsd:sequence</span>&gt;</span>
 <span class="tag">&lt;/<span class="name">xsd:complexType</span>&gt;</span>
</code></pre>
</li>
<li><p>Server端WebService实现类</p>
<pre><code class="nulljava"> <span class="meta">@MTOM</span>
 <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserWsService</span> <span class="keyword">implements</span> <span class="title">IUserWsService</span></span>{
     ...
     <span class="meta">@Override</span>
     <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">uploadFile</span><span class="params">(<span class="keyword">byte</span>[] file)</span></span>{
         SimpleDateFormat sdf=<span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyymmddhhMMss"</span>);
         String fileName=sdf.format(<span class="keyword">new</span> Date());    
         FileOutputStream fos = <span class="keyword">null</span>;
         System.out.println(file);
         <span class="keyword">try</span> {
             fos = <span class="keyword">new</span> FileOutputStream(<span class="string">"d:/webservice/"</span>+fileName+<span class="string">".jpg"</span>);
             fos.write(file);
             fos.flush();
             <span class="keyword">return</span> <span class="keyword">true</span>;
         } <span class="keyword">catch</span> (Exception e) {
             <span class="keyword">return</span> <span class="keyword">false</span>;
         } <span class="keyword">finally</span> {
             <span class="keyword">try</span> {
                 fos.close();
             } <span class="keyword">catch</span> (IOException e) {
                 <span class="keyword">return</span> <span class="keyword">false</span>;
             }
         }
     }
 }
</code></pre>
</li>
<li><p>Client端调用测试</p>
<pre><code class="nulljava"> <span class="meta">@Before</span>
 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> MalformedURLException</span>{
     URL url=<span class="keyword">new</span> URL(<span class="keyword">this</span>.wsdl);
     QName qname = <span class="keyword">new</span> QName(<span class="keyword">this</span>.ns, <span class="string">"UserWsService"</span>);
     <span class="keyword">this</span>.service=<span class="keyword">new</span> UserWsService(url,qname);
     <span class="comment">//this.userService=service.getUserWsServicePort();</span>
     <span class="keyword">this</span>.userService=service.getUserWsServicePort(<span class="keyword">new</span> MTOMFeature());
 }

 <span class="meta">@Test</span>
 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testUploadFile</span><span class="params">()</span></span>{
     <span class="keyword">try</span> {
         <span class="keyword">byte</span>[] file = FileUtils.readFileToByteArray(<span class="keyword">new</span> File(<span class="string">"E:\\picture\\123.jpg"</span>));
         <span class="keyword">boolean</span> result=userService.uploadFile(file);
         System.out.println(result);
     } <span class="keyword">catch</span> (IOException e) {
         e.printStackTrace();
     }
 }
</code></pre>
</li>
</ol>
<h3 id="header-44">消息头处理</h3>
<p>wsdl文件中：</p>
<pre><code class="nullxml"><span class="comment">&lt;!-- 创建消息头元素 --&gt;</span>
<span class="tag">&lt;<span class="name">xsd:element</span> <span class="attr">name</span>=<span class="string">"licenseInfo"</span> <span class="attr">type</span>=<span class="string">"xsd:string"</span> /&gt;</span>

<span class="comment">&lt;!-- 创建消息头信息 --&gt;</span>
<span class="tag">&lt;<span class="name">wsdl:message</span> <span class="attr">name</span>=<span class="string">"licenseInfo"</span>&gt;</span>
      <span class="tag">&lt;<span class="name">wsdl:part</span> <span class="attr">name</span>=<span class="string">"licenseInfo"</span> <span class="attr">element</span>=<span class="string">"tns:licenseInfo"</span> /&gt;</span>
<span class="tag">&lt;/<span class="name">wsdl:message</span>&gt;</span>

<span class="comment">&lt;!-- 为某个特定的方法绑定消息头（也可不加，作为全局，通过Handler统一判断处理）--&gt;</span>
<span class="tag">&lt;<span class="name">wsdl:binding</span> <span class="attr">name</span>=<span class="string">"OperationWsServiceSOAP"</span> <span class="attr">type</span>=<span class="string">"tns:IOperationWsService"</span>&gt;</span>
    <span class="tag">&lt;<span class="name">soap:binding</span> <span class="attr">style</span>=<span class="string">"document"</span> <span class="attr">transport</span>=<span class="string">"http://schemas.xmlsoap.org/soap/http"</span>/&gt;</span>
    <span class="tag">&lt;<span class="name">wsdl:operation</span> <span class="attr">name</span>=<span class="string">"divide"</span>&gt;</span>
        <span class="tag">&lt;<span class="name">wsdl:input</span>&gt;</span>
            <span class="tag">&lt;<span class="name">soap:body</span> <span class="attr">use</span>=<span class="string">"literal"</span>/&gt;</span>
            <span class="tag">&lt;<span class="name">soap:header</span> <span class="attr">use</span>=<span class="string">"literal"</span> <span class="attr">part</span>=<span class="string">"licenseInfo"</span> <span class="attr">message</span>=<span class="string">"tns:licenseInfo"</span> /&gt;</span>
        <span class="tag">&lt;/<span class="name">wsdl:input</span>&gt;</span>
        <span class="tag">&lt;<span class="name">wsdl:output</span>&gt;</span>
            <span class="tag">&lt;<span class="name">soap:body</span> <span class="attr">use</span>=<span class="string">"literal"</span>/&gt;</span>
            <span class="tag">&lt;/<span class="name">wsdl:output</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">wsdl:operation</span>&gt;</span>
<span class="tag">&lt;/<span class="name">wsdl:binding</span>&gt;</span>
</code></pre>
<h4 id="header-45">显示处理</h4>
<p>Server端声明（显示的声明一个参数获取头部信息 ）：</p>
<pre><code class="nulljava"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IOperationWsService</span></span>{
    ...

    <span class="comment">//添加接口，用于显示获取licenseInfo</span>
    <span class="meta">@WebMethod</span>
    <span class="meta">@WebResult</span>(name = <span class="string">"divideResult"</span>, targetNamespace = <span class="string">""</span>)
    <span class="meta">@RequestWrapper</span>(localName = <span class="string">"divide"</span>, targetNamespace = <span class="string">"http://www.example.org/student/"</span>,     className = <span class="string">"com.cj.my.ws.second.client.Divide"</span>)
    <span class="meta">@ResponseWrapper</span>(localName = <span class="string">"divideResponse"</span>, targetNamespace = <span class="string">"http://www.example.org/student/"</span>,     className = <span class="string">"com.cj.my.ws.second.client.DivideResponse"</span>)
    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">divide</span><span class="params">(
    @WebParam(name = <span class="string">"a"</span>, targetNamespace = <span class="string">""</span>)</span> <span class="keyword">int</span> a,
    @<span class="title">WebParam</span><span class="params">(name = <span class="string">"b"</span>, targetNamespace = <span class="string">""</span>)</span> <span class="keyword">int</span> b,
    @<span class="title">WebParam</span><span class="params">(name=<span class="string">"licenseInfo"</span>,header=<span class="keyword">true</span>)</span> String licenseInfo)</span>;
}
</code></pre>
<p>Client端调用：</p>
<pre><code class="nulljava"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientApp</span></span>{
    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>{
    OperationWsService service=<span class="keyword">new</span> OperationWsService ();
    IOperationWsService operationWsService=service.getOperationWsServicePort();
    System.out.println(operationWsService.divide(<span class="number">30</span>, <span class="number">0</span>,<span class="string">"123"</span>));
    }
}
</code></pre>
<h4 id="header-46">通过SOAPHandler处理</h4>
<p>Server端自定义SOAPHandler：<code>LicenseHandler</code> （in 时使用）</p>
<pre><code class="nulljava"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LicenseHandler</span> <span class="keyword">implements</span> <span class="title">SOAPHandler</span>&lt;<span class="title">SOAPMessageContext</span>&gt;</span>{
    <span class="meta">@Override</span>
    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handleMessage</span><span class="params">(SOAPMessageContext context)</span></span>{
        <span class="keyword">try</span>{
            Boolean out=(Boolean)context.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY);
            <span class="keyword">if</span>(!out){
                SOAPMessage message=context.getMessage();
                SOAPEnvelope envelope=message.getSOAPPart().getEnvelope();
                SOAPBody body=envelope.getBody();

                String partName=body.getChildNodes().item(<span class="number">0</span>).getLocalName();
                <span class="keyword">if</span>(<span class="string">"list"</span>.equals(partName) || <span class="string">"addUser"</span>.equals(partName)){
                SOAPHeader header=envelope.getHeader();
                <span class="keyword">if</span>(header==<span class="keyword">null</span> || header.getFirstChild()==<span class="keyword">null</span>){
                    <span class="comment">//将错误信息加入SOAPBody中</span>
                    SOAPFault fault=body.addFault();
                    fault.setFaultString(<span class="string">"头部信息不能为空"</span>);
                    <span class="comment">//return false;</span>
                    <span class="keyword">throw</span> <span class="keyword">new</span> SOAPFaultException(fault);
                }

                <span class="comment">/*
                //此方法会将头信息detach分离出来，接下来的程序就不能再取到了
                @SuppressWarnings("unchecked")
                Iterator&lt;SOAPHeaderElement&gt; it =header.extractAllHeaderElements();
                while(it.hasNext()){
                    System.out.println("header:"+it.next().getTextContent());
                }*/</span>

                NodeList nodeList=header.getChildNodes();
                <span class="comment">//NodeList nodeList=header.getElementsByTagName("ns:licenseInfo");</span>
                System.out.println(<span class="string">"header--"</span>+nodeList.item(<span class="number">0</span>).getTextContent());
                }
            }
        } <span class="keyword">catch</span> (SOAPException e){
            e.printStackTrace();
        } <span class="keyword">catch</span> (IOException e){
            e.printStackTrace();
        }
        <span class="keyword">return</span> <span class="keyword">true</span>;
    }

    <span class="meta">@Override</span>
    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handleFault</span><span class="params">(SOAPMessageContext context)</span></span>{
        <span class="keyword">return</span> <span class="keyword">false</span>;
    }
}
</code></pre>
<p>Client端自定义SOAPHandler：<code>LicenseHandler</code> （out 时使用）</p>
<pre><code class="nulljava"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LicenseHandler</span> <span class="keyword">implements</span> <span class="title">SOAPHandler</span>&lt;<span class="title">SOAPMessageContext</span>&gt;</span>{
    <span class="keyword">private</span> String wsdl=<span class="string">"http://localhost:9090/us?wsdl"</span>;
    <span class="keyword">private</span> String ns=<span class="string">"http://www.my.org/user"</span>;

    <span class="meta">@Override</span>
    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handleMessage</span><span class="params">(SOAPMessageContext context)</span></span>{    
        <span class="keyword">try</span>{
            Boolean out=(Boolean)context.get(MessageContext.MESSAGE_OUTBOUND_PROPERTY);
            <span class="keyword">if</span>(out){
                SOAPMessage message=context.getMessage();
                SOAPEnvelope envelope=message.getSOAPPart().getEnvelope();
                SOAPBody body=envelope.getBody();
                String partName=body.getFirstChild().getLocalName();
                System.out.println(<span class="string">"partName:"</span>+partName);
                <span class="keyword">if</span>(!<span class="string">"addUser"</span>.equals(partName))
                    <span class="keyword">return</span> <span class="keyword">true</span>;

                SOAPHeader header=envelope.getHeader();
                <span class="keyword">if</span>(header==<span class="keyword">null</span>)
                    header=envelope.addHeader();

                User regUser=<span class="keyword">new</span> User();
                regUser.setId(<span class="number">18</span>);
                regUser.setUsername(<span class="string">"RegisterUser"</span>);
                regUser.setPassword(<span class="string">"888"</span>);
                LicenseInfo licenseInfo=<span class="keyword">new</span> LicenseInfo();
                licenseInfo.setRegisterUser(regUser);

                JAXBContext ctx=JAXBContext.newInstance(LicenseInfo.class);
                QName sname=<span class="keyword">new</span> QName(<span class="keyword">this</span>.ns,<span class="string">"licenseInfo"</span>);
                JAXBElement&lt;LicenseInfo&gt; element=<span class="keyword">new</span> JAXBElement&lt;LicenseInfo&gt;(sname,LicenseInfo.class,licenseInfo);

                Marshaller mar=ctx.createMarshaller();
                mar.setProperty(Marshaller.JAXB_FRAGMENT,<span class="keyword">true</span>);
                mar.setProperty(Marshaller.JAXB_ENCODING, <span class="string">"UTF-8"</span>);
                mar.marshal(element, header);

                message.writeTo(System.out);
                System.out.println();
            }
        } <span class="keyword">catch</span> (SOAPException e){
            e.printStackTrace();
        } <span class="keyword">catch</span> (JAXBException e){
            e.printStackTrace();
        }<span class="keyword">catch</span> (IOException e){
            e.printStackTrace();
        }
        <span class="keyword">return</span> <span class="keyword">true</span>;
    }

    <span class="meta">@Override</span>
    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handleFault</span><span class="params">(SOAPMessageContext context)</span></span>{
        <span class="keyword">try</span>{
            SOAPMessage message=context.getMessage();
            message.writeTo(System.out);
            System.out.println();
        } <span class="keyword">catch</span> (SOAPException e){
            e.printStackTrace();
        } <span class="keyword">catch</span> (IOException e){
            e.printStackTrace();
        }
        <span class="keyword">return</span> <span class="keyword">false</span>;
    }

}
</code></pre>
<h4 id="header-47">通过SoapInterceptor处理</h4>
<p>Server端In Interceptor</p>
<pre><code class="nulljava"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LicenseInInterceptor</span> <span class="keyword">extends</span> <span class="title">AbstractSoapInterceptor</span></span>{
    <span class="function"><span class="keyword">public</span> <span class="title">LicenseInInterceptor</span><span class="params">()</span></span>{
        <span class="keyword">super</span>(Phase.POST_UNMARSHAL);
    }
    <span class="meta">@Override</span>
    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(SoapMessage message)</span> <span class="keyword">throws</span> Fault</span>{
        QName qname=<span class="keyword">new</span> QName(<span class="string">"http://www.my.org/user"</span>,<span class="string">"licenseInfo"</span>);
        Header header=message.getHeader(qname);
        <span class="keyword">if</span>(header!=<span class="keyword">null</span>){
            Object obj=header.getObject();
            <span class="keyword">if</span>(obj <span class="keyword">instanceof</span>  Node){
                Element e=(Element) obj;
                NodeList nodeList=e.getChildNodes();
                <span class="comment">//System.out.println(nodeList.item(0).getTextContent());</span>
                Node node=nodeList.item(<span class="number">0</span>);
                <span class="keyword">if</span>(node==<span class="keyword">null</span> || !node.getTextContent().equals(<span class="string">"RegisterUser888"</span>))
                    <span class="keyword">throw</span> <span class="keyword">new</span> Fault(<span class="keyword">new</span> Exception(<span class="string">"licenseInfo isn't correct!"</span>));
            }
        }
    }
}
</code></pre>
<p>Client端Out Interceptor</p>
<pre><code class="nulljava"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LicenseOutInterceptor</span> <span class="keyword">extends</span> <span class="title">AbstractSoapInterceptor</span></span>{
    <span class="keyword">private</span> String ns=<span class="string">"http://www.my.org/user"</span>;
    <span class="function"><span class="keyword">public</span> <span class="title">LicenseOutInterceptor</span><span class="params">()</span></span>{
        <span class="keyword">super</span>(Phase.WRITE);
    }

    <span class="meta">@Override</span>
    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(SoapMessage message)</span> <span class="keyword">throws</span> Fault</span>{
        <span class="keyword">try</span>{
            User regUser=<span class="keyword">new</span> User();
            regUser.setId(<span class="number">18</span>);
            regUser.setUsername(<span class="string">"RegisterUser"</span>);
            regUser.setPassword(<span class="string">"888"</span>);
            LicenseInfo licenseInfo=<span class="keyword">new</span> LicenseInfo();
            licenseInfo.setRegisterUser(regUser);

            DataBinding dataBinding=<span class="keyword">new</span> JAXBDataBinding(LicenseInfo.class);
            QName qname=<span class="keyword">new</span> QName(<span class="keyword">this</span>.ns,<span class="string">"licenseInfo"</span>);

            Header header=<span class="keyword">new</span> Header(qname, licenseInfo, dataBinding);
            message.getHeaders().add(header);

        } 
        <span class="keyword">catch</span> (JAXBException e){
            e.printStackTrace();
        }
    }
}
</code></pre>
<h3 id="header-48">Exception异常处理</h3>
<p>使用非运行期异常</p>
<p>wsdl文件中（将异常对象封装成一个Message）：</p>
<pre><code class="nullxml"><span class="comment">&lt;!-- 创建异常对象 --&gt;</span>
<span class="tag">&lt;<span class="name">xsd:element</span> <span class="attr">name</span>=<span class="string">"StudentException"</span> <span class="attr">type</span>=<span class="string">"tns:StudentException"</span>/&gt;</span>
<span class="tag">&lt;<span class="name">xsd:complexType</span> <span class="attr">name</span>=<span class="string">"StudentException"</span>&gt;</span>
<span class="tag">&lt;<span class="name">xsd:sequence</span>&gt;</span>
<span class="tag">&lt;<span class="name">xsd:element</span> <span class="attr">name</span>=<span class="string">"message"</span> <span class="attr">type</span>=<span class="string">"xsd:string"</span> /&gt;</span>
<span class="tag">&lt;/<span class="name">xsd:sequence</span>&gt;</span>
<span class="tag">&lt;/<span class="name">xsd:complexType</span>&gt;</span>

<span class="comment">&lt;!-- 创建异常消息 --&gt;</span>
<span class="tag">&lt;<span class="name">wsdl:message</span> <span class="attr">name</span>=<span class="string">"StudentException"</span>&gt;</span>
      <span class="tag">&lt;<span class="name">wsdl:part</span> <span class="attr">name</span>=<span class="string">"StudentException"</span> <span class="attr">element</span>=<span class="string">"tns:StudentException"</span> /&gt;</span>
<span class="tag">&lt;/<span class="name">wsdl:message</span>&gt;</span>

<span class="comment">&lt;!-- 声明某接口（服务）的异常消息 --&gt;</span>
<span class="tag">&lt;<span class="name">wsdl:portType</span> <span class="attr">name</span>=<span class="string">"IOperationWsService"</span>&gt;</span>
    <span class="tag">&lt;<span class="name">wsdl:operation</span> <span class="attr">name</span>=<span class="string">"plus"</span>&gt;</span>
      <span class="tag">&lt;<span class="name">wsdl:input</span> <span class="attr">message</span>=<span class="string">"tns:plus"</span>/&gt;</span>
      <span class="tag">&lt;<span class="name">wsdl:output</span> <span class="attr">message</span>=<span class="string">"tns:plusResponse"</span>/&gt;</span>
      <span class="tag">&lt;<span class="name">wsdl:fault</span> <span class="attr">name</span>=<span class="string">"StudentException"</span> <span class="attr">message</span>=<span class="string">"tns:StudentException"</span>/&gt;</span>
    <span class="tag">&lt;/<span class="name">wsdl:operation</span>&gt;</span>
<span class="tag">&lt;/<span class="name">wsdl:portType</span>&gt;</span>

<span class="comment">&lt;!-- 为特定方法绑定异常形式 --&gt;</span>
<span class="tag">&lt;<span class="name">wsdl:binding</span> <span class="attr">name</span>=<span class="string">"OperationWsServiceSOAP"</span> <span class="attr">type</span>=<span class="string">"tns:IOperationWsService"</span>&gt;</span>
   <span class="tag">&lt;<span class="name">soap:binding</span> <span class="attr">style</span>=<span class="string">"document"</span> <span class="attr">transport</span>=<span class="string">"http://schemas.xmlsoap.org/soap/http"</span>/&gt;</span>
    <span class="tag">&lt;<span class="name">wsdl:operation</span> <span class="attr">name</span>=<span class="string">"plus"</span>&gt;</span>
      <span class="tag">&lt;<span class="name">wsdl:input</span>&gt;</span>
        <span class="tag">&lt;<span class="name">soap:body</span> <span class="attr">use</span>=<span class="string">"literal"</span>/&gt;</span>
      <span class="tag">&lt;/<span class="name">wsdl:input</span>&gt;</span>
      <span class="tag">&lt;<span class="name">wsdl:output</span>&gt;</span>
        <span class="tag">&lt;<span class="name">soap:body</span> <span class="attr">use</span>=<span class="string">"literal"</span>/&gt;</span>
      <span class="tag">&lt;/<span class="name">wsdl:output</span>&gt;</span>
      <span class="tag">&lt;<span class="name">wsdl:fault</span> <span class="attr">name</span>=<span class="string">"StudentException"</span>&gt;</span>
        <span class="tag">&lt;<span class="name">soap:fault</span> <span class="attr">name</span>=<span class="string">"StudentException"</span> <span class="attr">use</span>=<span class="string">"literal"</span>/&gt;</span>
      <span class="tag">&lt;/<span class="name">wsdl:fault</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">wsdl:operation</span>&gt;</span>
<span class="tag">&lt;/<span class="name">wsdl:binding</span>&gt;</span>
</code></pre>
<p>Server端处理</p>
<ul>
<li>Server端发生Exception,被JAX截获：判断wsdl中是否有定义此异常</li>
<li>无则向上抛出Exception；</li>
<li>有则表明此Exception需抛到Client端，将此异常信息封装为SOAPFault放于SOAPBody中反馈给Client端，由Client端捕获此异常。</li>
<li>注意：此时Server端不会报异常（因为已经被封装成Soap消息了）。</li>
</ul>
<p>模拟：</p>
<p>Server端 （WebService实现类）：</p>
<pre><code class="nulljava"><span class="meta">@Override</span>
<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isExist</span><span class="params">(Integer id)</span> <span class="keyword">throws</span> StudentException</span>{
    <span class="keyword">if</span>(id&lt;<span class="number">0</span>)
        <span class="keyword">throw</span> <span class="keyword">new</span> StudentException(<span class="string">"illegal input param:"</span>+id);
    <span class="keyword">for</span>(Student student:studentList){
        <span class="keyword">if</span>(student.getId()==id)
            <span class="keyword">return</span> <span class="keyword">true</span>;
    }
    <span class="keyword">return</span> <span class="keyword">false</span>;
}
</code></pre>
<p>Client端调用：</p>
<pre><code class="nulljava"><span class="comment">//调用实现方法isExist,获取StudentException(wsimport命令自动生成的是：StudentException_Exception)</span>
<span class="keyword">try</span>{
<span class="keyword">boolean</span> result = myService.isExist(-<span class="number">1</span>);
System.out.println(result);
System.out.println(<span class="string">"--------------------------"</span>);
}
<span class="keyword">catch</span> (StudentException_Exception e){
    System.out.println(e.getMessage());
}
</code></pre>
<h3 id="header-49">异步调用</h3>
<p>CXF支持如下两种形式的异步调用模式：</p>
<ul>
<li><p>轮询方法（Polling approach）</p>
<ul>
<li>调用一个特殊的无参方法，返回一个 <code>javax.xml.ws.Response</code> 实例</li>
<li>通过轮询该 Response 对象来检查是否有应答消息到达</li>
<li><code>Response implements java.util.concurrency.Future&lt;T&gt;</code></li>
<li><code>Non-blocking polling</code>（非阻塞轮询）<ul>
<li>尝试获得结果之前，调用非阻塞方法<code>Response&lt;T&gt;.isDone()</code>来检查响应消息是否到达<pre><code class="nulljava">Response&lt;StartResponse&gt; rs=backService.startAsync();
<span class="keyword">while</span>(!rs.isDone()){
Thread.sleep(<span class="number">100</span>);
System.out.println(<span class="string">"Non-blocking polling(无阻塞轮询)-------"</span>);
}
StartResponse startResponse = rs.get();
System.out.println(startResponse.getResult());
</code></pre>
</li>
</ul>
</li>
<li><code>Blocking polling</code> (阻塞轮询）<ul>
<li>立即调用<code>Response&lt;T&gt;.get()</code>，阻塞至响应到达（可以指定一个超时时长作为可选项）<pre><code class="nulljava">Response&lt;StartResponse&gt; rs=backService.startAsync();
StartResponse startResponse=rs.get(5L, java.util.concurrent.TimeUnit.SECONDS);
System.out.println(startResponse.getResult());
</code></pre>
</li>
</ul>
</li>
</ul>
</li>
<li><p>回调方法（Callback approach）</p>
<ul>
<li>调用另外一个特殊的方法：使用一个回调对象的引用作为一个参数（<code>javax.xml.ws.AsyncHandler</code>类型）</li>
<li>只要有应答消息到达客户端，CXF运行时就会回调该 <code>AsyncHandler 对象</code>，并将应答消息的内容传给它</li>
</ul>
</li>
</ul>
<p>使用示例：</p>
<ol>
<li><p>新建<code>binding.xml</code>文件（打开异步调用特性，进行绑定声明）</p>
<pre><code class="nullxml"> <span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span>
 <span class="tag">&lt;<span class="name">bindings</span> <span class="attr">xmlns:xsd</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span>
     <span class="attr">xmlns:wsdl</span>=<span class="string">"http://schemas.xmlsoap.org/wsdl/"</span> 
     <span class="attr">wsdlLocation</span>=<span class="string">"http://localhost:9090/sms/comm/service/bs?wsdl"</span>  
     <span class="attr">xmlns</span>=<span class="string">"http://java.sun.com/xml/ns/jaxws"</span>&gt;</span>

     <span class="comment">&lt;!-- 只想对一个端口“iHelloWorld”生成异步方法，可以在绑定声明中指定
     &lt;bindings node="wsdl:definitions/wsdl:portType[@name='iHelloWorld']"&gt;
      --&gt;</span>
     <span class="comment">&lt;!-- 把node设为“wsdl:definitions”，表示对整个WSDL契约起作用 --&gt;</span>
     <span class="tag">&lt;<span class="name">bindings</span> <span class="attr">node</span>=<span class="string">"wsdl:definitions"</span>&gt;</span>
         <span class="tag">&lt;<span class="name">enableAsyncMapping</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enableAsyncMapping</span>&gt;</span>
     <span class="tag">&lt;/<span class="name">bindings</span>&gt;</span>
 <span class="tag">&lt;/<span class="name">bindings</span>&gt;</span>
</code></pre>
</li>
<li><p>生成相应的带异步支持的stub代码</p>
<ul>
<li>方式一：使用wsdl2java命令<pre><code>wsdl2java -b binding.xml hello.wsdl
</code></pre></li>
<li>方式二：使用wsimport命令<pre><code>wsimport -d d:/webservice/sms -keep http://localhost:9090/sms/comm/service/bs?wsdl -p com.cj.sms.client.back -b d:/webservice/binding.xml
</code></pre></li>
<li>服务接口类的方法多出两个方法声明</li>
<li><p>例如<code>destroy()</code>方法，会多出：</p>
<pre><code class="nulljava">  <span class="comment">/**
  * 异步调用的轮询方式
  * <span class="doctag">@return</span> returns javax.xml.ws.Response&lt;com.cj.sms.client.back.DestroyResponse&gt;
  */</span>
  <span class="meta">@WebMethod</span>(operationName = <span class="string">"destroy"</span>)
  <span class="meta">@RequestWrapper</span>(localName = <span class="string">"destroy"</span>, targetNamespace = <span class="string">"http://ws.sms.cj.com/back"</span>, className = <span class="string">"com.cj.sms.client.back.Destroy"</span>)
  <span class="meta">@ResponseWrapper</span>(localName = <span class="string">"destroyResponse"</span>, targetNamespace = <span class="string">"http://ws.sms.cj.com/back"</span>, className = <span class="string">"com.cj.sms.client.back.DestroyResponse"</span>)
  <span class="function"><span class="keyword">public</span> Response&lt;DestroyResponse&gt; <span class="title">destroyAsync</span><span class="params">()</span></span>;

  <span class="comment">/**
  * 异步调用的回调方式
  * <span class="doctag">@param</span> asyncHandler
  * <span class="doctag">@return</span> returns java.util.concurrent.Future&lt;? extends java.lang.Object&gt;
  */</span>
  <span class="meta">@WebMethod</span>(operationName = <span class="string">"destroy"</span>)
  <span class="meta">@RequestWrapper</span>(localName = <span class="string">"destroy"</span>, targetNamespace = <span class="string">"http://ws.sms.cj.com/back"</span>, className = <span class="string">"com.cj.sms.client.back.Destroy"</span>)
  <span class="meta">@ResponseWrapper</span>(localName = <span class="string">"destroyResponse"</span>, targetNamespace = <span class="string">"http://ws.sms.cj.com/back"</span>, className = <span class="string">"com.cj.sms.client.back.DestroyResponse"</span>)
  <span class="keyword">public</span> Future&lt;?&gt; destroyAsync(
  <span class="meta">@WebParam</span>(name = <span class="string">"asyncHandler"</span>, targetNamespace = <span class="string">""</span>)AsyncHandler&lt;DestroyResponse&gt; asyncHandler);
</code></pre>
</li>
</ul>
</li>
<li><p>测试</p>
<ul>
<li>测试轮询方式<pre><code class="nulljava"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testStart</span><span class="params">()</span></span>{
  <span class="keyword">try</span>{
      Response&lt;StartResponse&gt; rs=backService.startAsync();
      <span class="keyword">while</span>(!rs.isDone()){  
              Thread.sleep(<span class="number">100</span>);
              System.out.println(<span class="string">"Non-blocking polling(无阻塞轮询)-------"</span>);  
         }
      <span class="comment">//如果没有前面isDone的检测，此处就退化为阻塞式轮询</span>
      StartResponse startResponse = rs.get();
      <span class="comment">//也可设置一个超时时长做为选项</span>
      <span class="comment">//StartResponse startResponse=rs.get(5L, java.util.concurrent.TimeUnit.SECONDS);</span>
      System.out.println(startResponse.getResult());
  }<span class="keyword">catch</span>(SOAPFaultException e){
      System.out.println(e.getMessage());
  }<span class="keyword">catch</span> (InterruptedException e){
      e.printStackTrace();
  } <span class="keyword">catch</span> (ExecutionException e){
      e.printStackTrace();
  }
}
</code></pre>
</li>
<li><p>测试回调方式</p>
<pre><code class="nulljava"><span class="meta">@Test</span>
<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDestroy</span><span class="params">()</span></span>{
  <span class="keyword">try</span>{
      <span class="comment">//destroyHandler=new WsDestroyAsyncHandler();</span>

      <span class="comment">//返回的 Future&lt;?&gt; 对象只是用来检测一个响应是否已经到达</span>
      <span class="comment">//响应消息的值只在回调对象WsDestroyAsyncHandler中可得</span>
      Future&lt;?&gt; future=backService.destroyAsync(destroyHandler);
      <span class="keyword">while</span>(!future.isDone()){  
              Thread.sleep(<span class="number">10000</span>);  
              System.out.println(<span class="string">"异步方法(回调)--------------"</span>);  
          }  
      System.out.println(destroyHandler.getResponseText());    
  }<span class="keyword">catch</span>(SOAPFaultException e){
      System.out.println(e.getMessage());
  }<span class="keyword">catch</span> (InterruptedException e){
      e.printStackTrace();
  }
}
</code></pre>
<pre><code class="nulljava"><span class="comment">//自定义回调类</span>
<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WsDestroyAsyncHandler</span> <span class="keyword">implements</span> <span class="title">AsyncHandler</span>&lt;<span class="title">DestroyResponse</span>&gt;</span>{
  <span class="keyword">private</span> DestroyResponse destroyResponse;
  <span class="meta">@Override</span>
  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleResponse</span><span class="params">(Response&lt;DestroyResponse&gt; res)</span></span>{
      <span class="keyword">try</span>{
          <span class="comment">//获取响应数据，并把它存放到成员变量destroyResponse中</span>
          destroyResponse=res.get();
          System.out.println(<span class="string">"result:"</span>+destroyResponse.getResult());
      } <span class="keyword">catch</span> (InterruptedException e){
          e.printStackTrace();
      } <span class="keyword">catch</span> (ExecutionException e){
          e.printStackTrace();
      }
  }
  <span class="comment">//方便从响应中提炼出主要的输出参数</span>
  <span class="function"><span class="keyword">public</span> String <span class="title">getResponseText</span><span class="params">()</span></span>{
      <span class="keyword">return</span> destroyResponse.getResult();
  }
}
</code></pre>
</li>
</ul>
</li>
</ol>
  </section>
</article>

      <hr/>
      <section class="post-comment">
	<!-- disqus默认将数据加载到id为'disqus_thread'的容器中，可配置disqus_container_id改变-->
<div id="disqus_thread"> 
	<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

	<script type="text/javascript">
		var disqus_shortname = 'sixdegreespace'; 
		var disqus_identifier = '2013/09/01/Webservice.html';	
		var disqus_title = 'Webservice';
		var disqus_url = 'http://sixdegree.github.io/2013/09/01/Webservice.html' ;
		//var disqus_category_id = '4262241'; 

		(function() {
		    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
		})();
	</script>


 
</section>
    </div>
  </div>
</body>

<script src="/jquery/dist/jquery.min.js"></script>
<script src="/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/highlight/highlight.pack.js"></script>
<script type="text/javascript">
  hljs.initHighlightingOnLoad();
  
  $(document).ready(function(){
    var sidebarCtrl=$("#sidebar-ctrl");
    var sidebar=$("#sidebar");
    var wrapper=$("#wrapper");
    sidebarCtrl.on("click",function(event){
        //alert("click");
        sidebar.toggleClass("sidebar-toggle");
        wrapper.toggleClass("sidebar-toggle");
        sidebarCtrl.toggleClass("sidebar-toggle");
        sidebarCtrl.toggleClass("active");
    })
  });
</script>


</html>
