<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Hibernate进阶</title>
  
  <!-- Meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="hibernate,query,native sql,QBC,TableGenerator">
  
  
    <meta name="description" content="Hibernate Query and TableGenerator Introduce">
  

  <!-- Feed -->
  
    <link rel="alternative" href="/atom.xml" title="SixDegree" type="application/atom+xml">
  

  <!-- CSS -->
  <link rel="stylesheet" href="/bootstrap/dist/css/bootstrap.css">
  
    <link rel="stylesheet" href="/highlight/demo/styles/tomorrow-night-bright.css">
  
  <link rel="stylesheet" href="/css/fontello.css">
  <link rel="stylesheet" href="/css/style.css">

  <!-- Site Analyse -->
  
	<script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?2bbb83cc0f781dd7502e9d5e19661866";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>


</head>

<body data-spy="scroll" data-target="#nav-catalog">
  <div id="top-push"></div>
<a href="#top-push" id="go-top">
	<span class="glyphicon glyphicon-chevron-up"></span>
</a>
  <aside id="sidebar">
    <section class="sidebar-header">Catalog</section>
     <nav id="nav-catalog">
        <ol class="sidebar-nav nav"><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#header-1"><span class="sidebar-nav nav-text">Native SQL</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-2"><span class="sidebar-nav nav-text">简单查询</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-3"><span class="sidebar-nav nav-text">多表复杂查询，返回未关联对象</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-4"><span class="sidebar-nav nav-text">多表查询，返回关联对象</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-5"><span class="sidebar-nav nav-text">使用addScalar 查询托管对象</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-6"><span class="sidebar-nav nav-text">使用ResultTransformer 返回托管对象</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-7"><span class="sidebar-nav nav-text">addEntity VS ResultTransformer</span></a></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#header-8"><span class="sidebar-nav nav-text">QBC</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-9"><span class="sidebar-nav nav-text">setFetchMode</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-10"><span class="sidebar-nav nav-text">createCriteria</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-11"><span class="sidebar-nav nav-text">createAlias</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-12"><span class="sidebar-nav nav-text">Join Restriction</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-13"><span class="sidebar-nav nav-text">exist - subquery</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-14"><span class="sidebar-nav nav-text">通用查询封装示例</span></a></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#header-15"><span class="sidebar-nav nav-text">TableGenerator</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-16"><span class="sidebar-nav nav-text">TableGenerator 注解和类</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-17"><span class="sidebar-nav nav-text">使用JPA注解：@TableGenerator</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-18"><span class="sidebar-nav nav-text">使用Hibernate注解：@GenericGenerator</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-19"><span class="sidebar-nav nav-text">Hibernate的Optimizer优化器</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-20"><span class="sidebar-nav nav-text">自定义TableGenerator</span></a></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#header-21"><span class="sidebar-nav nav-text">Spring中配置Hibernate</span></a></li></ol>
    </nav>
  </aside>
  <span id="sidebar-ctrl" class="glyphicon glyphicon-list-alt circle"></span>
  <div id="wrapper">
    <header>
  <nav class="navbar navbar-default">
    <div class="container-fluid">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#nav-menu" aria-expanded="false">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="/">SixDegree</a>
      </div>
      <div class="collapse navbar-collapse" id="nav-menu">
        <ul class="nav navbar-nav navbar-right">
          
              <li  >
                <a href="/">Blogs</a>
              </li>
          
              <li  >
                <a href="/tags.html">Tags</a>
              </li>
          
              <li  >
                <a href="/about.html">About</a>
              </li>
          
          
              <li>
                <a href="/atom.xml" target="_blank">
                  <span class="icon-rss"></span>
                </a>
              </li>
          
              <li>
                <a href="http://github.com/sixdegree" target="_blank">
                  <span class="icon-github"></span>
                </a>
              </li>
          
        </ul>
      </div>
    </div>
  </nav>
</header>



    <div class="container">
      <article class="detail" role="main">
  <section class="post-header">
    <h1 class="post-title">Hibernate进阶</h1>
    <ul class="post-meta">
      <li>
        <span class="glyphicon glyphicon-calendar"></span>
        <time datetime="2013-06-01T16:00:00.000Z">2013-06-02</time>
      </li>
      
        <li>
         <span class="glyphicon glyphicon-tags"></span>
          
            <a href="/tags.html#tag-Java">Java</a>
          
            <a href="/tags.html#tag-Hibernate">Hibernate</a>
          
        </li>
      
    </ul>
  </section>
  <section class="post-content">
    <h2 id="header-1">Native SQL</h2>
<h3 id="header-2">简单查询</h3>
<ol>
<li>返回<code>List&lt;Object[]&gt;</code><pre><code class="nulljava"> String sql = <span class="string">"select s.rollNo, s.name, s.address from Student s"</span>;
 SQLQuery query = session.createSQLQuery(sql);
 List list = query.list();
 Iterator iterator = list.iterator();
 <span class="keyword">for</span> (Iterator it = query.iterate(); it.hasNext();) {
         Object[] object = (Object[]) it.next();
         System.out.println(object[<span class="number">0</span>]);
         System.out.println(object[<span class="number">1</span>]);
         System.out.println(object[<span class="number">2</span>]);
 }
</code></pre>
</li>
<li><p>返回<code>List&lt;Map&gt;</code>,使用<code>setResultTransformer</code></p>
<pre><code class="nulljava"> String sql = <span class="string">"select s.roll_no, s.name, s.address from student s"</span>;
 SQLQuery query = session.createSQLQuery(sql)
     .setResultTransformer(Criteria.ALIAS_TO_ENTITY_MAP);

 List list = query.list();
 Iterator iterator = list.iterator();
 <span class="keyword">while</span> (iterator.hasNext()) {
     Map map = (Map) iterator.next();
     System.out.println(map.get(<span class="string">"roll_no"</span>));
     System.out.println(map.get(<span class="string">"name"</span>));
     System.out.println(map.get(<span class="string">"address"</span>));
 }
</code></pre>
</li>
<li><p>返回持久化对象<code>List&lt;Clazz&gt;</code>，使用<code>addEntity</code></p>
<pre><code class="nulljava"> String sql = <span class="string">"select s.roll_no, s.name, s.address from student s"</span>;
 SQLQuery query = session.createSQLQuery(sql)
     .addEntity(Student.class);
 List&lt;Student&gt; query=(List&lt;Student&gt;)query.list();
</code></pre>
</li>
</ol>
<h3 id="header-3">多表复杂查询，返回未关联对象</h3>
<ol>
<li><p>返回多个持久化对象<code>List&lt;Object[]&gt;</code>，使用<code>addEntity</code></p>
<pre><code class="nulljava"> String sql=<span class="string">"select {p.*}, {b.*} from person p, book b where &lt;complicated join&gt;"</span>;
 SQLQuery q= session.createSQLQuery(sql)
         .addEntity(<span class="string">"p"</span>, Person.class)
         .addEntity(<span class="string">"b"</span>, Book.class);
 List&lt;Object[]&gt; peopleWithBooks=(List&lt;Object[]&gt;)q.list();
</code></pre>
<p> =&gt;Oject[0]:<code>Person</code><br> =&gt;Oject[1]:<code>Book</code><br> <strong>PS</strong>: <code>{p.*}</code>向别名为p的这个对象注入所有属性值，<code>{}</code>占位符里是对象的属性,而非列名</p>
</li>
<li><p>返回托管对象<code>List&lt;XxxVo&gt;</code>，使用<code>addEntity</code> &amp; <code>setResultTransformer</code></p>
<pre><code class="nulljava"> String sql=<span class="string">"select {p.*}, {b.*} from person p, book b where &lt;complicated join&gt;"</span>;
 SQLQuery q= session.createSQLQuery(sql)
         .addEntity(<span class="string">"p"</span>, Person.class)
         .addEntity(<span class="string">"b"</span>, Book.class);
 q.setResultTransformer(Transformers.aliasToBean(PeopleWithBooksVo.class));
 List&lt;PeopleWithBooksVo&gt; peopleWithBooks=(List&lt;PeopleWithBooksVo&gt;)q.list();
</code></pre>
<p> =&gt;<code>PeopleWithBooksVo</code>(Person，Book)</p>
</li>
</ol>
<h3 id="header-4">多表查询，返回关联对象</h3>
<ul>
<li>对象Person：PersonId,Name,Books</li>
<li>对象Book：Code,Description</li>
<li>关联记录：<table class="table">
<thead>
<tr>
<th>PERSONID</th>
<th>NAME</th>
<th>CODE</th>
<th>DESCRIPTION</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>BEN</td>
<td>1234</td>
<td>BOOK 1</td>
</tr>
<tr>
<td>1</td>
<td>BEN</td>
<td>5678</td>
<td>BOOK 2</td>
</tr>
<tr>
<td>2</td>
<td>JOHN</td>
<td>9012</td>
<td>BOOK 3</td>
</tr>
</tbody>
</table>
</li>
</ul>
<ol>
<li><p>返回<code>List&lt;Object[]&gt;</code>，使用<code>addEntity</code> &amp; <code>addJoin</code></p>
<pre><code class="nulljava"> String sql=<span class="string">"select {p.*}, {b.*} from person p, book b where &lt;complicated join&gt;"</span>;
 SQLQuery q=session.createSQLQuery(sql)
     .addEntity(<span class="string">"p"</span>, Person.class)
     .addJoin(<span class="string">"b"</span>, <span class="string">"person.books"</span>);
 List&lt;Oject[]&gt; list = (List&lt;Oject[]&gt;) q.list();
</code></pre>
<p> =&gt;<code>List&lt;Object[]&gt;</code> (Object：Person，Book)，结果如下：</p>
<pre><code> List
  |- Object[]
  |   |- Person(Ben)
  |   |   |- Book(1)
  |   |   &#39;- Book(2)
  |   &#39;- Book(1)
  |- Object[]
  |   |- Person(Ben)
  |   |   |- Book(1)
  |   |   &#39;- Book(2)
  |   &#39;- Book(2)
  &#39;- Object[]
      |- Person(John)
      |   &#39;- Book(3)
      &#39;- Book(3)
</code></pre></li>
<li><p>返回<code>List&lt;Clazz&gt;</code>，使用<code>addEntity</code>&amp;<code>addJoin</code> &amp; <code>setResultTransformer</code></p>
<pre><code class="nulljava"> String sql=<span class="string">"select {p.*}, {b.*} from person p, book b where &lt;complicated join&gt;"</span>;
 SQLQuery q=session.createSQLQuery(sql)
     .addEntity(<span class="string">"p"</span>, Person.class)
     .addJoin(<span class="string">"b"</span>, <span class="string">"person.books"</span>);
 q.addEntity(<span class="string">"p"</span>, Person.class);
 q.setResultTransformer(Criteria.DISTINCT_ROOT_ENTITY);
 List&lt; Person&gt;list = (List&lt;Person&gt;) q.list();
</code></pre>
<p> =&gt; <code>List&lt;Person&gt;</code></p>
<p> <strong>PS</strong>：The duplicate<code>.addEntity(&quot;p&quot;, Person.class)</code> is necessary because <code>.setResultTransformer(Criteria.DISTINCT_ROOT_ENTITY)</code> operates on the last entity added.</p>
<pre><code> List
  |- Person(Ben)
  |   |- Book(1)
  |   &#39;- Book(2)
  &#39;- Person(John)
      &#39;- Book(3)
</code></pre></li>
</ol>
<h3 id="header-5">使用<code>addScalar</code> 查询托管对象</h3>
<p>如果不设置addScalar方法可能会报转型错误的异常</p>
<ol>
<li>Hibernate 3:<pre><code class="nulljava"> SQLQuery q = session.createSQLQuery(queryString)
         .addScalar(<span class="string">"UNAME"</span>,Hibernate.STRING)
         .addScalar(<span class="string">"COM"</span>,Hibernate.STRING)
         .addScalar(<span class="string">"COM_DATE"</span>,Hibernate.DATE) 
         .setString(<span class="string">"id"</span>, Id).list();
</code></pre>
</li>
<li>Hibernate4:<pre><code class="nulljava">    q.addScalar(<span class="string">"UNAME"</span>, StringType.INSTANCE)
     .addScalar(<span class="string">"COM"</span>, StringType.INSTANCE)
     .addScalar(<span class="string">"COM_DATE"</span>, DateType.INSTANCE)
</code></pre>
</li>
</ol>
<h3 id="header-6">使用<code>ResultTransformer</code> 返回托管对象</h3>
<ol>
<li><p>使用已有的<code>ResultTransformer</code><br> DTO：</p>
<pre><code class="nulljava"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdvancedClauseSearchResultDTO</span></span>{ 
     <span class="keyword">private</span> Date effectiveDate;
     <span class="keyword">private</span> String status;
     …
     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getEffectiveDate</span><span class="params">()</span> </span>{
         <span class="keyword">return</span> effectiveDate;
     }
     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEffectiveDate</span><span class="params">(Date aDate)</span> </span>{
         Date now = <span class="keyword">new</span> Date(System.currentTimeMillis());
         <span class="keyword">if</span> (now.before(effectiveDate)) {
             <span class="keyword">this</span>.status = <span class="string">"Pending"</span>;
         } <span class="keyword">else</span> <span class="keyword">if</span> (now.after(terminationDate)) {
             <span class="keyword">this</span>.status = <span class="string">"Terminated"</span>;
         } <span class="keyword">else</span> {
             <span class="keyword">this</span>.status = <span class="string">"Active"</span>;
         }
         <span class="keyword">this</span>.effectiveDate = aDate;
     }
 }
</code></pre>
<p> 使用：</p>
<pre><code class="nulljava"> SQLQuery q  = session.createSQLQuery(sb.toString());    query.setResultTransformer(Transformers.aliasToBean(AdvancedClauseSearchResultDTO.class));
 <span class="keyword">return</span> (List&lt;AdvancedClauseSearchResultDTO&gt;)query.list();
</code></pre>
</li>
<li><p>自定义`ResultTransformer</p>
<pre><code class="nulljava"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdvancedClauseSearchResultTransformer</span> <span class="keyword">implements</span> <span class="title">ResultTransformer</span> </span>{
     <span class="comment">//Use the aliasTransformer to do most of the work</span>
     ResultTransformer aliasTransformer = Transformers.aliasToBean(AdvancedClauseSearchResultDTO.class);

     <span class="meta">@Override</span>
     <span class="function"><span class="keyword">public</span> List <span class="title">transformList</span><span class="params">(List list)</span> </span>{
     List&lt;AdvancedClauseSearchResultDTO&gt; result = aliasTransformer.transformList(list);
         <span class="comment">//for each row, set the status field</span>
        <span class="keyword">for</span> (AdvancedClauseSearchResultDTO dto : result) {
             String status = <span class="keyword">null</span>;
             Date effectiveDate = dto.getEffectiveDate();
             Date terminationDate = dto.getTerminationDate();
             Date now = <span class="keyword">new</span> Date(System.currentTimeMillis());
             <span class="keyword">if</span> (now.before(effectiveDate)) {
                 status = <span class="string">"Pending"</span>;
             } <span class="keyword">else</span> <span class="keyword">if</span> (now.after(terminationDate)) {
                 status = <span class="string">"Terminated"</span>;
             } <span class="keyword">else</span> {
                 status = <span class="string">"Active"</span>;
             }
             dto.setStatus(status);

             <span class="keyword">if</span> (StringUtils.isNotEmpty(dto.getReasonForAmendment())){
                 dto.setAmended(Boolean.TRUE);
             }<span class="keyword">else</span>{
                 dto.setAmended(Boolean.FALSE);
             }
         }
         <span class="keyword">return</span> result;
     }

     <span class="meta">@Override</span>
     <span class="function"><span class="keyword">public</span> Object <span class="title">transformTuple</span><span class="params">(Object[] os, String[] strings)</span> </span>{
         Object result = aliasTransformer.transformTuple(os, strings);
         <span class="keyword">return</span> result;
     }
 }
</code></pre>
<p> 使用：</p>
<pre><code class="nulljava"> SQLQuery q  = session.createSQLQuery(sb.toString());
 q.setResultTransformer(<span class="keyword">new</span> AdvancedClauseSearchResultTransformer());
 <span class="keyword">return</span> (List&lt;AdvancedClauseSearchResultDTO&gt;)query.list();
</code></pre>
</li>
</ol>
<h3 id="header-7"><code>addEntity</code> VS <code>ResultTransformer</code></h3>
<ol>
<li><p><code>addEntity(Class clazz)</code> 的参数必须是被Hibernate管理的持久化bean,否则会报<code>MappingException:Unknown entity</code></p>
</li>
<li><p><code>ResultTransformer</code>可以接受一个任意的bean,只要这个bean的属性（严格说是<code>setXxx()</code>中的xxx）与select结果集列名存在对应关系</p>
</li>
</ol>
<h2 id="header-8">QBC</h2>
<p>参考文章：</p>
<ul>
<li><a href="http://what-when-how.com/hibernate/advanced-query-options-hibernate/">Advanced query options (Hibernate)</a></li>
<li><a href="https://docs.jboss.org/hibernate/orm/3.3/reference/en/html/querycriteria.html">Chapter 15. Criteria Queries</a></li>
</ul>
<h3 id="header-9">setFetchMode</h3>
<pre><code class="nulljava">List cats = sess.createCriteria(Cat.class)
    .add( Restrictions.like(<span class="string">"name"</span>, <span class="string">"Fritz%"</span>) )
    .setFetchMode(<span class="string">"mate"</span>, FetchMode.JOIN)
    .setFetchMode(<span class="string">"kittens"</span>, FetchMode.JOIN)
    .list();
</code></pre>
<p>=&gt; <code>List&lt;Cat&gt;</code> (each Cat: mate,kittens)<br>=&gt; This query will fetch both mate and kittens by outer join.</p>
<p><code>FetchType</code>与<code>FetchMode</code>：</p>
<pre><code class="nulljava"><span class="meta">@OneToMany</span>(mappedBy=<span class="string">"item"</span>,cascade=CascadeType.ALL,fetch=FetchType.EAGER) 
<span class="meta">@Fetch</span>(value=FetchMode.SUBSELECT)
</code></pre>
<p>两者比较：</p>
<ul>
<li>两者都是设定关联对象的加载策略</li>
<li>FetchType与FetchMode是JPA标准的通用加载策略注解属性</li>
<li>Fetch是Hibernate自有加载策略属性</li>
</ul>
<p>FetchType：</p>
<ul>
<li>FetchType.LAZY: 懒加载，在访问关联对象的时候加载(即从数据库读入内存)</li>
<li>FetchType.EAGER:立刻加载，在查询主对象的时候同时加载关联对象。</li>
</ul>
<p>FetchMode：</p>
<ul>
<li>FetchMode.JOIN： 始终立刻加载，使用外连(outer join)查询的同时加载关联对象，忽略FetchType.LAZY设定。</li>
<li>FetchMode.SELECT：默认懒加载(除非设定关联属性lazy=false)，当访问每一个关联对象时加载该对象，会累计产生N+1条sql语句</li>
<li>FetchMode.SUBSELECT  默认懒加载(除非设定关联属性lazy=false),在访问第一个关联对象时加载所有的关联对象。会累计产生两条sql语句。且FetchType设定有效。</li>
</ul>
<h3 id="header-10">createCriteria</h3>
<p>createCriteria定义：return sub Criteria ,so all the operation is on sub Criteria </p>
<pre><code>public Criteria createCriteria(String associationPath, int joinType) {
    return new Subcriteria( this, associationPath, joinType );
}
</code></pre><p>使用示例：</p>
<pre><code class="nulljava">List cats = sess.createCriteria(Cat.class)
    .add( Restrictions.like(<span class="string">"name"</span>, <span class="string">"F%"</span>) )
    .createCriteria(<span class="string">"kittens"</span>)
    .add(Restrictions.like(<span class="string">"name"</span>, <span class="string">"F%"</span>) )
    .list();
</code></pre>
<p>=&gt; <code>List&lt;Cat&gt;</code> (<strong>Cat:  no kittens</strong>)<br>=&gt; The second createCriteria() returns a new instance of Criteria that refers to the elements of the kittens collection.</p>
<pre><code class="nulljava">List cats = sess.createCriteria(Cat.class)
    .add( Restrictions.like(<span class="string">"name"</span>, <span class="string">"F%"</span>) )
    .createCriteria(<span class="string">"kittens"</span>,JoinType.LEFT_OUTER_JOIN)
    .add(Restrictions.like(<span class="string">"name"</span>, <span class="string">"F%"</span>) )
    .list();
</code></pre>
<p>=&gt; <code>List&lt;Cat&gt;</code> (<strong>Cat:  kittens</strong>)</p>
<h3 id="header-11">createAlias</h3>
<p>createAlias定义：return the criteria who create sub Criteria (默认使用INNER_JOIN)</p>
<pre><code class="nulljava"><span class="function"><span class="keyword">public</span> Criteria <span class="title">createAlias</span><span class="params">(String associationPath, String alias, <span class="keyword">int</span> joinType)</span> </span>{
    <span class="keyword">new</span> Subcriteria( <span class="keyword">this</span>, associationPath, alias, joinType );
    <span class="keyword">return</span> <span class="keyword">this</span>;
}
</code></pre>
<pre><code class="nulljava">List cats = sess.createCriteria(Cat.class)
    .createAlias(<span class="string">"kittens"</span>, <span class="string">"kt"</span>)
    .createAlias(<span class="string">"mate"</span>, <span class="string">"mt"</span>)
    .add( Restrictions.eqProperty(<span class="string">"kt.name"</span>, <span class="string">"mt.name"</span>) )
    .list();
</code></pre>
<p>=&gt; <code>List&lt;Cat&gt;</code> (<strong>Cat: no kittens and mate</strong>)<br>=&gt; createAlias() does not create a new instance of Criteria</p>
<pre><code class="nulljava">List cats = sess.createCriteria(Cat.class)
    .createAlias(<span class="string">"kittens"</span>, <span class="string">"kt"</span>,JoinType.LEFT_OUTER_JOIN)
    .createAlias(<span class="string">"mate"</span>, <span class="string">"mt"</span>,JoinType.LEFT_OUTER_JOIN)
    .add( Restrictions.eqProperty(<span class="string">"kt.name"</span>, <span class="string">"mt.name"</span>) )
    .list();
</code></pre>
<p>=&gt; <code>List&lt;Cat&gt;</code> (<strong>Cat:  kittens and mate</strong>)</p>
<h3 id="header-12">Join Restriction</h3>
<p>类似查询：<code>select * from A left join B on A.xx=B.xx and B.yy=zz where ...</code></p>
<pre><code class="nulljava">DetachedCriteria detachedCriteria=DetachedCriteria.forClass(SysMenu.class)
                      .addOrder(Order.asc(<span class="string">"parent"</span> ))
                      .addOrder(Order.asc(<span class="string">"menuOrder"</span> ))
                      <span class="comment">//使用createCriteria或createAlias都可</span>
                      .createAlias(<span class="string">"sysRoleMenus"</span>, <span class="string">"rm"</span>, JoinType.LEFT_OUTER_JOIN,Restrictions.eq(<span class="string">"sysRole.id"</span>, roleId));
</code></pre>
<p>=&gt; <code>List&lt;SysMenu&gt;</code> (<strong>SysMenu : no sysRoleMenus</strong>)</p>
<p>（HQL可使用<code>with</code>关键字实现）</p>
<h3 id="header-13">exist - subquery</h3>
<p>Sample1:</p>
<pre><code class="nullsql"><span class="keyword">select</span> A.*
<span class="keyword">FROM</span> AETABLE A
<span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">exists</span>
(
    <span class="keyword">select</span> entryid
    <span class="keyword">FROM</span> AETABLE B
    <span class="keyword">where</span> B.classpk = A.classpk
    <span class="keyword">and</span> B.userid = A.userid
    <span class="keyword">and</span> B.modifiedDate &gt; A.modifiedDate
)<span class="keyword">and</span> userid = <span class="number">10146</span>
</code></pre>
<p>Assuming property / class names match column / table names above:</p>
<pre><code class="nulljava">DetachedCriteria subquery = DetachedCriteria.forClass(AETable.class, <span class="string">"b"</span>)
 .add(Property.forName(<span class="string">"b.classpk"</span>).eqProperty(<span class="string">"a.classpk"</span>))
 .add(Property.forName(<span class="string">"b.userid"</span>).eqProperty(<span class="string">"a.userid"</span>))
 .add(Property.forName(<span class="string">"b.modifiedDate"</span>).gtProperty(<span class="string">"a.modifiedDate"</span>));

Criteria criteria = session.createCriteria(AETable.class, <span class="string">"a"</span>)
 .add(Property.forName(<span class="string">"userid"</span>).eq(<span class="keyword">new</span> Integer(<span class="number">10146</span>)))
 .add(Subqueries.notExists(subquery);
</code></pre>
<p>If the entryid is not the primary key, need to add projection.</p>
<pre><code class="nulljava">DetachedCriteria subquery = DetachedCriteria.forClass(AETable.class, <span class="string">"b"</span>)
 .add(Property.forName(<span class="string">"b.classpk"</span>).eqProperty(<span class="string">"a.classpk"</span>))
 .add(Property.forName(<span class="string">"b.userid"</span>).eqProperty(<span class="string">"a.userid"</span>))
 .add(Property.forName(<span class="string">"b.modifiedDate"</span>).gtProperty(<span class="string">"a.modifiedDate"</span>))
 .setProjection(Projections.property(<span class="string">"entryId"</span>));  <span class="comment">// Additional projection property</span>

Criteria criteria = session.createCriteria(AETable.class, <span class="string">"a"</span>)
 .add(Property.forName(<span class="string">"userid"</span>).eq(<span class="keyword">new</span> Integer(<span class="number">10146</span>)))
 .add(Subqueries.notExists(subquery);
</code></pre>
<p>Sample2:</p>
<pre><code class="nullsql"><span class="keyword">SELECT</span> *
 <span class="keyword">FROM</span> PIZZA_ORDER
 <span class="keyword">WHERE</span> <span class="keyword">EXISTS</span> (<span class="keyword">SELECT</span> <span class="number">1</span>
                 <span class="keyword">FROM</span> PIZZA
                 <span class="keyword">WHERE</span> PIZZA.pizza_size_id = <span class="number">1</span> 
                 <span class="keyword">AND</span> PIZZA.pizza_order_id = PIZZA_ORDER.pizza_order_id)
</code></pre>
<pre><code class="nulljava">DetachedCriteria sizeCriteria = DetachedCriteria.forClass(Pizza.class,<span class="string">"pizza"</span>)
 .add(<span class="string">"pizza_size_id"</span>,<span class="number">1</span>)
 .add(Property.forName(<span class="string">"pizza.pizza_order_id"</span>).eqProperty(<span class="string">"pizzaOrder.pizza_order_id"</span>));

Criteria criteria = Criteria.forClass(PizzaOrder.class,<span class="string">"pizzaOrder"</span>)
 .add(Subqueries.exists(
    sizeCriteria.setProjection(Projections.property(<span class="string">"pizza.id"</span>))
));

List&lt;pizzaOrder&gt; ordersWithOneSmallPizza = criteria.list();
</code></pre>
<p>Sample3:</p>
<pre><code class="nullsql"><span class="keyword">select</span> *
 <span class="keyword">from</span> shuttle_station
 <span class="keyword">where</span> <span class="keyword">id</span> <span class="keyword">in</span> (
    <span class="keyword">select</span> station_id 
    <span class="keyword">from</span> shuttle_route_schedule rs <span class="keyword">left</span> <span class="keyword">join</span> shuttle_route 
    <span class="keyword">where</span> active=<span class="number">1</span> <span class="keyword">and</span> expireTime <span class="keyword">is</span> <span class="literal">null</span>
)
</code></pre>
<pre><code class="nulljava">DetachedCriteria subCriteria=DetachedCriteria.forClass(ShuttleRouteSchedule.class,<span class="string">"rs"</span>)
    .add(Restrictions.eq(<span class="string">"active"</span>, <span class="keyword">true</span>))
    .add(Restrictions.isNull(<span class="string">"expireTime"</span>))
    .setProjection(Projections.distinct(Projections.property(<span class="string">"station.id"</span>)));

DetachedCriteria detachedCriteria=DetachedCriteria.forClass(ShuttleStation.class)
    .createAlias(<span class="string">"stationShifts"</span>,<span class="string">"ea"</span>, JoinType.LEFT_OUTER_JOIN)
    .add(Subqueries.propertyIn(<span class="string">"id"</span>, subCriteria));
</code></pre>
<h3 id="header-14">通用查询封装示例</h3>
<p><strong>PS:</strong>  使用过setProjection后获取信息后，重置为null，返回的不再是RootEntity~！<br>参考文章: <a href="http://blog.xebia.com/2008/12/11/sorting-and-pagination-with-hibernate-criteria-how-it-can-go-wrong-with-joins/">Sorting And Pagination With Hibernate Criteria - How It Can Go Wrong With Joins</a></p>
<pre><code class="nulljava"><span class="meta">@Override</span>
<span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)
<span class="function"><span class="keyword">public</span> List&lt;T&gt; <span class="title">list</span><span class="params">(DetachedCriteria detachedCriteria,<span class="keyword">boolean</span> byPage)</span>
</span>{
    Criteria criteria=<span class="keyword">null</span>;
    <span class="keyword">if</span>(detachedCriteria!=<span class="keyword">null</span>)
        criteria=detachedCriteria.getExecutableCriteria(getSession());
    <span class="keyword">else</span>
        criteria=<span class="keyword">this</span>.getSession().createCriteria(<span class="keyword">this</span>.getEntityClass());

    <span class="keyword">if</span> (byPage &amp;&amp; PaginationUtils.exist()){
        ResultTransformer resultTransformer=((CriteriaImpl)criteria).getResultTransformer();

        Object total = criteria.setProjection(Projections.rowCount()).uniqueResult(); 
        <span class="comment">//System.out.println(total.toString());</span>
        Pagination p=PaginationUtils.getPagination();
        p.setTotal(Integer.valueOf(total.toString()));

        criteria.setProjection(<span class="keyword">null</span>); 
        criteria.setResultTransformer(resultTransformer);

        criteria.setFirstResult(p.getStart());  
        criteria.setMaxResults(p.getLimit()); 
        <span class="keyword">if</span> (p.getSorter() != <span class="keyword">null</span> &amp;&amp; p.getSorter().length()!=<span class="number">0</span>) {
            <span class="keyword">if</span>(<span class="string">"DESC"</span>.equalsIgnoreCase(PaginationUtils.getOrder()))
                criteria.addOrder(Order.desc(PaginationUtils.getSorter()));
            <span class="keyword">else</span>
                criteria.addOrder(Order.asc(PaginationUtils.getSorter()));
        }
    }
    <span class="keyword">return</span> criteria.list(); 
}
</code></pre>
<pre><code class="nulljava"><span class="meta">@Override</span>
<span class="keyword">public</span> List&lt;?&gt; listByHql(String hql, Object... params) {
    <span class="comment">//this.getEntityClass();</span>
    <span class="keyword">if</span> (PaginationUtils.exist() &amp;&amp; PaginationUtils.getSorter() != <span class="keyword">null</span> &amp;&amp; PaginationUtils.getSorter().length()!=<span class="number">0</span>) {
        hql += <span class="string">" order by "</span> + PaginationUtils.getSorter() + <span class="string">" "</span>
                + PaginationUtils.getOrder();
    }
    Query query = createHQLQuery(hql, params);

    <span class="keyword">if</span> (PaginationUtils.exist()) {
        Query countQuery = createHQLQuery(<span class="string">"select count(*) "</span>
                + removeSelect(hql), params);
        <span class="keyword">int</span> total = Integer.valueOf(countQuery.uniqueResult().toString());
        PaginationUtils.setTotal(total);

        query.setFirstResult(PaginationUtils.getStart()).setMaxResults(
                PaginationUtils.getLimit());
    }
    <span class="keyword">return</span> query.list();
}
</code></pre>
<h2 id="header-15">TableGenerator</h2>
<p>参考文章：<a href="http://www.ibm.com/developerworks/cn/java/j-lo-tablegenerator/">探索 Hibernate 新 TableGenerator 机制</a></p>
<h3 id="header-16">TableGenerator 注解和类</h3>
<p><code>@TableGenerator</code> 注解是 JPA 规范中的注解，用于确定 TABLE 主键生成器的各个参数，具体的功能要由 JPA 提供者来实现</p>
<p>Hibernate 中实现该注解的<code>TableGenerator 类</code>有两个：</p>
<ol>
<li>原有的 TableGenerator，类名为 org.hibernate.id.TableGenerator，这是默认的 TableGenerator</li>
<li>新 TableGenerator，指的是 org.hibernate.id.enhanced.TableGenerator</li>
</ol>
<h3 id="header-17">使用JPA注解：@TableGenerator</h3>
<pre><code class="nulljava"><span class="meta">@Id</span>
<span class="meta">@GeneratedValue</span>(strategy=GenerationType.TABLE,generator=<span class="string">"teacherID"</span>)
<span class="meta">@TableGenerator</span>(name=<span class="string">"teacherID"</span>,
        table=<span class="string">"teacherID_DB"</span>,
        pkColumnName=<span class="string">"key_value"</span>,
        pkColumnValue=<span class="string">"pk_value"</span>,
        valueColumnName=<span class="string">"teacher"</span>,
        allocationSize=<span class="number">1</span>)     <span class="comment">//注意 initialValue 参数无效</span>
<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>{
    <span class="keyword">return</span> id;
}
</code></pre>
<p><strong>PS</strong>： 默认使用旧的TableGenerator类，若要使用新的，需配置：</p>
<pre><code class="nullxml"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"hibernate.id.new_generator_mappings"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span>
</code></pre>
<h3 id="header-18">使用Hibernate注解：@GenericGenerator</h3>
<p>新 TableGenerator 的一些功能不在 JPA 中，因此不能使用 JPA 的 <code>@TableGenerator</code> 注解，而是要使用 Hibernate 自身的 <code>@GenericGenerator</code> 注解</p>
<p>新 TableGenerator 配置参数表：</p>
<table class="table">
<thead>
<tr>
<th>序号</th>
<th>参数名</th>
<th>默认值</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>table_name</td>
<td>hibernate_sequence</td>
<td>辅助表的表名</td>
</tr>
<tr>
<td>2</td>
<td>value_column_name</td>
<td>next_val</td>
<td>存放序列值的列名</td>
</tr>
<tr>
<td>3</td>
<td>segment_column_name</td>
<td>sequence_name</td>
<td>存放序列名的列名</td>
</tr>
<tr>
<td>4</td>
<td>segment_value</td>
<td>default</td>
<td>序列名</td>
</tr>
<tr>
<td>5</td>
<td>segment_value_length</td>
<td>255</td>
<td>序列名所在列数据类型长度</td>
</tr>
<tr>
<td>6</td>
<td>initial_value</td>
<td>1</td>
<td>指定序列的初始值</td>
</tr>
<tr>
<td>7</td>
<td>increment_size</td>
<td>1</td>
<td>指定序列默认的递增量</td>
</tr>
<tr>
<td>8</td>
<td>optimizer</td>
<td>依 increment_size 的取值而定</td>
<td>指定序列的优化器</td>
</tr>
</tbody>
</table>
<p><img src="/2013/06/02/tableGenerator-params.png" alt="TableGenerator Parameters"></p>
<pre><code class="nulljava"><span class="meta">@GenericGenerator</span>( name=<span class="string">"id_gen"</span>, strategy=<span class="string">"enhanced-table"</span>,
parameters = {
       <span class="meta">@Parameter</span>( name = <span class="string">"table_name"</span>, value = <span class="string">"enhanced_gen"</span>),
       <span class="meta">@Parameter</span>( name =<span class="string">"value_column_name"</span>, value = <span class="string">"next"</span>),
       <span class="meta">@Parameter</span>( name = <span class="string">"segment_column_name"</span>,value = <span class="string">"segment_name"</span>),
       <span class="meta">@Parameter</span>( name = <span class="string">"segment_value"</span>, value = <span class="string">"emp_seq"</span>),
       <span class="meta">@Parameter</span>( name = <span class="string">"increment_size"</span>, value = <span class="string">"10"</span>),
       <span class="meta">@Parameter</span>( name = <span class="string">"optimizer"</span>,value = <span class="string">"pooled-lo"</span>)
})
<span class="meta">@Id</span>
<span class="meta">@GeneratedValue</span>(generator=<span class="string">"id_gen"</span>)
<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>{
    <span class="keyword">return</span> id;
}
</code></pre>
<p><strong>PS</strong>： 注意配置使用新的TableGenerator</p>
<pre><code class="nullxml"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"hibernate.id.new_generator_mappings"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span>
</code></pre>
<h3 id="header-19">Hibernate的Optimizer优化器</h3>
<p>Optimizer 名字及实现类：</p>
<table class="table">
<thead>
<tr>
<th>Optimizer 名字</th>
<th>类名</th>
<th>特点</th>
</tr>
</thead>
<tbody>
<tr>
<td>none</td>
<td>NoopOptimizer.class</td>
<td>没有任何优化，每次主键生成都需要访问数据库</td>
</tr>
<tr>
<td>hilo</td>
<td>HiLoOptimizer.class</td>
<td>hilo算法实现的主键生成机制，数据库中的值是 bucket 的序号</td>
</tr>
<tr>
<td>legacy-hilo</td>
<td>LegacyHiLoAlgorithmOptimizer.class</td>
<td>旧 hilo 算法</td>
</tr>
<tr>
<td>pooled</td>
<td>PooledOptimizer.class</td>
<td>也使用 hilo 算法，不同之处在于 bucket 内部数值保存在数据库中</td>
</tr>
<tr>
<td>pooled-lo</td>
<td>PooledLoOptimizer.class</td>
<td>算法与 pooled 完全相同，但保存在数据库中的值不同于 pooled</td>
</tr>
</tbody>
</table>
<p>选定优化器的过程：<br><img src="/2013/06/02/tableGenerator-optimizer.png" alt="Optimizer"></p>
<h3 id="header-20">自定义TableGenerator</h3>
<ol>
<li>自定义TableGenerator：<code>MyFormatTableGenerator</code> （implements org.hibernate.id.enhanced.TableGenerator）</li>
<li>自定义Optimizer：<code>MyPooledOptimizer</code> （extends OptimizerSupport implements InitialValueAwareOptimizer）</li>
<li>使用：<pre><code class="nulljava"> <span class="meta">@Id</span>
 <span class="meta">@Column</span>(name = <span class="string">"req_id"</span>, unique = <span class="keyword">true</span>, nullable = <span class="keyword">false</span>, length = <span class="number">10</span>)
 <span class="meta">@GeneratedValue</span>(strategy = GenerationType. TABLE, generator = <span class="string">"myFormatTableGenerator"</span> )
 <span class="meta">@GenericGenerator</span>(name = <span class="string">"myFormatTableGenerator"</span>, strategy = <span class="string">"com.cj.support.hibernate.MyFormatTableGenerator"</span> , parameters = {
  <span class="meta">@Parameter</span>(name = <span class="string">"format"</span>, value = <span class="string">"R%2$ty-%1$05d"</span>),
  <span class="meta">@Parameter</span>(name = TableGenerator. TABLE_PARAM, value = <span class="string">"tb_generator"</span>),
  <span class="meta">@Parameter</span>(name = TableGenerator. SEGMENT_COLUMN_PARAM, value = <span class="string">"gen_name"</span>),
  <span class="meta">@Parameter</span>(name = TableGenerator. SEGMENT_VALUE_PARAM, value = <span class="string">"Request_PK"</span>),
  <span class="meta">@Parameter</span>(name = TableGenerator. VALUE_COLUMN_PARAM, value = <span class="string">"gen_value"</span>),
  <span class="meta">@Parameter</span>(name = TableGenerator. INITIAL_PARAM, value = <span class="string">"1"</span>),
  <span class="meta">@Parameter</span>(name = TableGenerator. INCREMENT_PARAM, value = <span class="string">"20"</span>)
 })
 <span class="function"><span class="keyword">public</span> String <span class="title">getReqId</span><span class="params">()</span></span>{
     <span class="keyword">return</span> <span class="keyword">this</span>. reqId;
 }
</code></pre>
</li>
</ol>
<h2 id="header-21">Spring中配置Hibernate</h2>
<pre><code class="nullxml"><span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">"classpath:jdbc-prod.properties"</span>/&gt;</span>
<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">destroy-method</span>=<span class="string">"close"</span> <span class="attr">class</span>=<span class="string">"org.apache.commons.dbcp.BasicDataSource"</span>&gt;</span>
    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"${jdbc.driverClassName}"</span>/&gt;</span>
    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"${jdbc.url}"</span>/&gt;</span>
    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"${jdbc.username}"</span>/&gt;</span>
    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"${jdbc.password}"</span>/&gt;</span>

    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"initialSize"</span> <span class="attr">value</span>=<span class="string">"1"</span>/&gt;</span>
    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"minIdle"</span> <span class="attr">value</span>=<span class="string">"2"</span>/&gt;</span>
    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxActive"</span> <span class="attr">value</span>=<span class="string">"200"</span>/&gt;</span>
    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxIdle"</span> <span class="attr">value</span>=<span class="string">"30"</span>/&gt;</span>
    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxWait"</span> <span class="attr">value</span>=<span class="string">"1000"</span>/&gt;</span>
    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"removeAbandoned"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span>
    <span class="comment">&lt;!-- &lt;property name="logAbandoned" value="true"/&gt;   --&gt;</span>
    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"validationQuery"</span> <span class="attr">value</span>=<span class="string">"select 1 from dual"</span>/&gt;</span>
    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"testOnBorrow"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span>
<span class="tag">&lt;/<span class="name">bean</span>&gt;</span>

<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"sessionFactory"</span> <span class="attr">class</span>=<span class="string">"org.springframework.orm.hibernate4.LocalSessionFactoryBean"</span>&gt;</span>
    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span> /&gt;</span>
    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"hibernateProperties"</span>&gt;</span>
        <span class="tag">&lt;<span class="name">props</span>&gt;</span>
            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"hibernate.dialect"</span>&gt;</span>${hibernate.dialect}<span class="tag">&lt;/<span class="name">prop</span>&gt;</span>
            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"hibernate.id.new_generator_mappings"</span>&gt;</span>true<span class="tag">&lt;/<span class="name">prop</span>&gt;</span>
            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"hibernate.show_sql"</span>&gt;</span>${hibernate.show.sql}<span class="tag">&lt;/<span class="name">prop</span>&gt;</span>
            <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"hibernate.format_sql"</span>&gt;</span>${hibernate.format.sql}<span class="tag">&lt;/<span class="name">prop</span>&gt;</span>
            <span class="comment">&lt;!-- &lt;prop key="javax.persistence.validation.mode"&gt;none&lt;/prop&gt; --&gt;</span>
        <span class="tag">&lt;/<span class="name">props</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">property</span>&gt;</span>

    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"packagesToScan"</span>&gt;</span>
        <span class="tag">&lt;<span class="name">list</span>&gt;</span>
            <span class="tag">&lt;<span class="name">value</span>&gt;</span>com.golf.entity<span class="tag">&lt;/<span class="name">value</span>&gt;</span>
        <span class="tag">&lt;/<span class="name">list</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">property</span>&gt;</span>
<span class="tag">&lt;/<span class="name">bean</span>&gt;</span>

<span class="comment">&lt;!-- 声明式事务 --&gt;</span>
<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"txManager"</span> <span class="attr">class</span>=<span class="string">"org.springframework.orm.hibernate4.HibernateTransactionManager"</span>&gt;</span>
    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"sessionFactory"</span> <span class="attr">ref</span>=<span class="string">"sessionFactory"</span>/&gt;</span>
<span class="tag">&lt;/<span class="name">bean</span>&gt;</span>
<span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">"txAdvice"</span> <span class="attr">transaction-manager</span>=<span class="string">"txManager"</span> &gt;</span>
    <span class="tag">&lt;<span class="name">tx:attributes</span>&gt;</span>
        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"list*"</span> <span class="attr">propagation</span>=<span class="string">"REQUIRED"</span> <span class="attr">read-only</span>=<span class="string">"true"</span>/&gt;</span>
        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"get*"</span> <span class="attr">propagation</span>=<span class="string">"REQUIRED"</span> <span class="attr">read-only</span>=<span class="string">"true"</span>/&gt;</span>
        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"test*"</span> <span class="attr">propagation</span>=<span class="string">"REQUIRED"</span> <span class="attr">read-only</span>=<span class="string">"true"</span>  /&gt;</span>
        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"sendMail"</span> <span class="attr">propagation</span>=<span class="string">"REQUIRED"</span> <span class="attr">read-only</span>=<span class="string">"true"</span> <span class="attr">no-rollback-for</span>=<span class="string">"Exception"</span>/&gt;</span>
        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"*"</span>/&gt;</span>
    <span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span>
<span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span>
 <span class="tag">&lt;<span class="name">aop:config</span>&gt;</span>
    <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">expression</span>=<span class="string">"execution(* com.cj.service.*.*(..))"</span> <span class="attr">id</span>=<span class="string">"mySearchService"</span>/&gt;</span>
    <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">"txAdvice"</span> <span class="attr">pointcut-ref</span>=<span class="string">"mySearchService"</span>/&gt;</span>
<span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span>
</code></pre>
  </section>
</article>

      <hr/>
      <section class="post-comment">
	<!-- disqus默认将数据加载到id为'disqus_thread'的容器中，可配置disqus_container_id改变-->
<div id="disqus_thread"> 
	<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

	<script type="text/javascript">
		var disqus_shortname = 'sixdegreespace'; 
		var disqus_identifier = '2013/06/02/Hibernate-Advance.html';	
		var disqus_title = 'Hibernate进阶';
		var disqus_url = 'http://sixdegree.github.io/2013/06/02/Hibernate-Advance.html' ;
		//var disqus_category_id = '4262241'; 

		(function() {
		    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
		})();
	</script>


 
</section>
    </div>
  </div>
</body>

<script src="/jquery/dist/jquery.min.js"></script>
<script src="/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/highlight/highlight.pack.js"></script>
<script type="text/javascript">
  hljs.initHighlightingOnLoad();
  
  $(document).ready(function(){
    var sidebarCtrl=$("#sidebar-ctrl");
    var sidebar=$("#sidebar");
    var wrapper=$("#wrapper");
    sidebarCtrl.on("click",function(event){
        //alert("click");
        sidebar.toggleClass("sidebar-toggle");
        wrapper.toggleClass("sidebar-toggle");
        sidebarCtrl.toggleClass("sidebar-toggle");
        sidebarCtrl.toggleClass("active");
    })
  });
</script>


</html>
