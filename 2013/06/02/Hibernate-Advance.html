<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Hibernate进阶</title>
  
  <!-- Meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="hibernate,query,native sql,QBC,TableGenerator">
  
  
    <meta name="description" content="Hibernate Query and TableGenerator Introduce">
  

  <!-- Feed -->
  
    <link rel="alternative" href="/atom.xml" title="SixDegree" type="application/atom+xml">
  

  <!-- CSS -->
  <link rel="stylesheet" href="/bootstrap/dist/css/bootstrap.css">
  
	
		<link rel="stylesheet" href="/highlight/demo/styles/tomorrow-night-bright.css">
	
    
  
  <link rel="stylesheet" href="/css/fontello.css">
  <link rel="stylesheet" href="/css/style.css">

  <!-- Site Analyse -->
  
	<script>
	var userID='2bbb83cc0f781dd7502e9d5e19661866';
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?"+userID;
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>


</head>

<body data-spy="scroll" data-target="#nav-catalog">
  <div id="top-push"></div>
<a href="#top-push" id="go-top">
	<span class="glyphicon glyphicon-chevron-up"></span>
</a>
  <aside id="sidebar">
    <section class="sidebar-header">Catalog</section>
     <nav id="nav-catalog">
        <ol class="sidebar-nav nav"><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#header-1"><span class="sidebar-nav nav-text">Native SQL</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-2"><span class="sidebar-nav nav-text">简单查询</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-3"><span class="sidebar-nav nav-text">多表复杂查询，返回未关联对象</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-4"><span class="sidebar-nav nav-text">多表查询，返回关联对象</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-5"><span class="sidebar-nav nav-text">使用addScalar 查询托管对象</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-6"><span class="sidebar-nav nav-text">使用ResultTransformer 返回托管对象</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-7"><span class="sidebar-nav nav-text">addEntity VS ResultTransformer</span></a></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#header-8"><span class="sidebar-nav nav-text">QBC</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-9"><span class="sidebar-nav nav-text">setFetchMode</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-10"><span class="sidebar-nav nav-text">createCriteria</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-11"><span class="sidebar-nav nav-text">createAlias</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-12"><span class="sidebar-nav nav-text">Join Restriction</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-13"><span class="sidebar-nav nav-text">exist - subquery</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-14"><span class="sidebar-nav nav-text">通用查询封装示例</span></a></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#header-15"><span class="sidebar-nav nav-text">TableGenerator</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-16"><span class="sidebar-nav nav-text">TableGenerator 注解和类</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-17"><span class="sidebar-nav nav-text">使用JPA注解：@TableGenerator</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-18"><span class="sidebar-nav nav-text">使用Hibernate注解：@GenericGenerator</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-19"><span class="sidebar-nav nav-text">Hibernate的Optimizer优化器</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-20"><span class="sidebar-nav nav-text">自定义TableGenerator</span></a></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#header-21"><span class="sidebar-nav nav-text">Spring中配置Hibernate</span></a></li></ol>
    </nav>
  </aside>
  <span id="sidebar-ctrl" class="glyphicon glyphicon-list-alt circle"></span>
  <div id="wrapper">
    <header>
  <nav class="navbar navbar-default">
    <div class="container-fluid">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#nav-menu" aria-expanded="false">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="/">SixDegree</a>
      </div>
      <div class="collapse navbar-collapse" id="nav-menu">
        <ul class="nav navbar-nav navbar-right">
          
              <li  >
                <a href="/">Blogs</a>
              </li>
          
              <li  >
                <a href="/tags.html">Tags</a>
              </li>
          
              <li  >
                <a href="/about.html">About</a>
              </li>
          
          
              <li>
                <a href="/atom.xml" target="_blank">
                  <span class="icon-rss"></span>
                </a>
              </li>
          
              <li>
                <a href="http://github.com/sixdegree" target="_blank">
                  <span class="icon-github"></span>
                </a>
              </li>
          
        </ul>
      </div>
    </div>
  </nav>
</header>



    <div class="container">
      <article class="detail" role="main">
  <section class="post-header">
    <h1 class="post-title">Hibernate进阶</h1>
    <ul class="post-meta">
      <li>
        <span class="glyphicon glyphicon-calendar"></span>
        <time datetime="2013-06-01T16:00:00.000Z">2013-06-02</time>
      </li>
      
        <li>
         <span class="glyphicon glyphicon-tags"></span>
          
            <a href="/tags.html#tag-Java">Java</a>
          
            <a href="/tags.html#tag-Hibernate">Hibernate</a>
          
        </li>
      
    </ul>
  </section>
  <section class="post-content">
    <h2 id="header-1">Native SQL</h2>
<h3 id="header-2">简单查询</h3>
<ol>
<li>返回<code>List&lt;Object[]&gt;</code><pre><code class="lang-java"> String sql = &quot;select s.rollNo, s.name, s.address from Student s&quot;;
 SQLQuery query = session.createSQLQuery(sql);
 List list = query.list();
 Iterator iterator = list.iterator();
 for (Iterator it = query.iterate(); it.hasNext();) {
         Object[] object = (Object[]) it.next();
         System.out.println(object[0]);
         System.out.println(object[1]);
         System.out.println(object[2]);
 }
</code></pre>
</li>
<li><p>返回<code>List&lt;Map&gt;</code>,使用<code>setResultTransformer</code></p>
<pre><code class="lang-java"> String sql = &quot;select s.roll_no, s.name, s.address from student s&quot;;
 SQLQuery query = session.createSQLQuery(sql)
     .setResultTransformer(Criteria.ALIAS_TO_ENTITY_MAP);

 List list = query.list();
 Iterator iterator = list.iterator();
 while (iterator.hasNext()) {
     Map map = (Map) iterator.next();
     System.out.println(map.get(&quot;roll_no&quot;));
     System.out.println(map.get(&quot;name&quot;));
     System.out.println(map.get(&quot;address&quot;));
 }
</code></pre>
</li>
<li><p>返回持久化对象<code>List&lt;Clazz&gt;</code>，使用<code>addEntity</code></p>
<pre><code class="lang-java"> String sql = &quot;select s.roll_no, s.name, s.address from student s&quot;;
 SQLQuery query = session.createSQLQuery(sql)
     .addEntity(Student.class);
 List&lt;Student&gt; query=(List&lt;Student&gt;)query.list();
</code></pre>
</li>
</ol>
<h3 id="header-3">多表复杂查询，返回未关联对象</h3>
<ol>
<li><p>返回多个持久化对象<code>List&lt;Object[]&gt;</code>，使用<code>addEntity</code></p>
<pre><code class="lang-java"> String sql=&quot;select {p.*}, {b.*} from person p, book b where &lt;complicated join&gt;&quot;;
 SQLQuery q= session.createSQLQuery(sql)
         .addEntity(&quot;p&quot;, Person.class)
         .addEntity(&quot;b&quot;, Book.class);
 List&lt;Object[]&gt; peopleWithBooks=(List&lt;Object[]&gt;)q.list();
</code></pre>
<p> =&gt;Oject[0]:<code>Person</code>
 =&gt;Oject[1]:<code>Book</code>
 <strong>PS</strong>: <code>{p.*}</code>向别名为p的这个对象注入所有属性值，<code>{}</code>占位符里是对象的属性,而非列名</p>
</li>
<li><p>返回托管对象<code>List&lt;XxxVo&gt;</code>，使用<code>addEntity</code> &amp; <code>setResultTransformer</code></p>
<pre><code class="lang-java"> String sql=&quot;select {p.*}, {b.*} from person p, book b where &lt;complicated join&gt;&quot;;
 SQLQuery q= session.createSQLQuery(sql)
         .addEntity(&quot;p&quot;, Person.class)
         .addEntity(&quot;b&quot;, Book.class);
 q.setResultTransformer(Transformers.aliasToBean(PeopleWithBooksVo.class));
 List&lt;PeopleWithBooksVo&gt; peopleWithBooks=(List&lt;PeopleWithBooksVo&gt;)q.list();
</code></pre>
<p> =&gt;<code>PeopleWithBooksVo</code>(Person，Book)</p>
</li>
</ol>
<h3 id="header-4">多表查询，返回关联对象</h3>
<ul>
<li>对象Person：PersonId,Name,Books</li>
<li>对象Book：Code,Description</li>
<li><p>关联记录：</p>
<table class="table">
<thead>
<tr>
<th>PERSONID</th>
<th>NAME</th>
<th>CODE</th>
<th>DESCRIPTION</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>BEN</td>
<td>1234</td>
<td>BOOK 1</td>
</tr>
<tr>
<td>1</td>
<td>BEN</td>
<td>5678</td>
<td>BOOK 2</td>
</tr>
<tr>
<td>2</td>
<td>JOHN</td>
<td>9012</td>
<td>BOOK 3</td>
</tr>
</tbody>
</table>
</li>
<li><p>返回<code>List&lt;Object[]&gt;</code>，使用<code>addEntity</code> &amp; <code>addJoin</code></p>
<pre><code class="lang-java"> String sql=&quot;select {p.*}, {b.*} from person p, book b where &lt;complicated join&gt;&quot;;
 SQLQuery q=session.createSQLQuery(sql)
     .addEntity(&quot;p&quot;, Person.class)
     .addJoin(&quot;b&quot;, &quot;person.books&quot;);
 List&lt;Oject[]&gt; list = (List&lt;Oject[]&gt;) q.list();
</code></pre>
<p> =&gt;<code>List&lt;Object[]&gt;</code> (Object：Person，Book)，结果如下：</p>
<pre><code> List
  |- Object[]
  |   |- Person(Ben)
  |   |   |- Book(1)
  |   |   &#39;- Book(2)
  |   &#39;- Book(1)
  |- Object[]
  |   |- Person(Ben)
  |   |   |- Book(1)
  |   |   &#39;- Book(2)
  |   &#39;- Book(2)
  &#39;- Object[]
      |- Person(John)
      |   &#39;- Book(3)
      &#39;- Book(3)
</code></pre></li>
<li><p>返回<code>List&lt;Clazz&gt;</code>，使用<code>addEntity</code>&amp;<code>addJoin</code> &amp; <code>setResultTransformer</code></p>
<pre><code class="lang-java"> String sql=&quot;select {p.*}, {b.*} from person p, book b where &lt;complicated join&gt;&quot;;
 SQLQuery q=session.createSQLQuery(sql)
     .addEntity(&quot;p&quot;, Person.class)
     .addJoin(&quot;b&quot;, &quot;person.books&quot;);
 q.addEntity(&quot;p&quot;, Person.class);
 q.setResultTransformer(Criteria.DISTINCT_ROOT_ENTITY);
 List&lt; Person&gt;list = (List&lt;Person&gt;) q.list();
</code></pre>
<p> =&gt; <code>List&lt;Person&gt;</code></p>
<p> <strong>PS</strong>：The duplicate<code>.addEntity(&quot;p&quot;, Person.class)</code> is necessary because <code>.setResultTransformer(Criteria.DISTINCT_ROOT_ENTITY)</code> operates on the last entity added.</p>
<pre><code> List
  |- Person(Ben)
  |   |- Book(1)
  |   &#39;- Book(2)
  &#39;- Person(John)
      &#39;- Book(3)
</code></pre></li>
</ul>
<h3 id="header-5">使用<code>addScalar</code> 查询托管对象</h3>
<p>如果不设置addScalar方法可能会报转型错误的异常</p>
<ol>
<li>Hibernate 3:<pre><code class="lang-java"> SQLQuery q = session.createSQLQuery(queryString)
         .addScalar(&quot;UNAME&quot;,Hibernate.STRING)
         .addScalar(&quot;COM&quot;,Hibernate.STRING)
         .addScalar(&quot;COM_DATE&quot;,Hibernate.DATE) 
         .setString(&quot;id&quot;, Id).list();
</code></pre>
</li>
<li>Hibernate4:<pre><code class="lang-java">    q.addScalar(&quot;UNAME&quot;, StringType.INSTANCE)
     .addScalar(&quot;COM&quot;, StringType.INSTANCE)
     .addScalar(&quot;COM_DATE&quot;, DateType.INSTANCE)
</code></pre>
</li>
</ol>
<h3 id="header-6">使用<code>ResultTransformer</code> 返回托管对象</h3>
<ol>
<li><p>使用已有的<code>ResultTransformer</code>
 DTO：</p>
<pre><code class="lang-java"> public class AdvancedClauseSearchResultDTO{ 
     private Date effectiveDate;
     private String status;
     …
     public void getEffectiveDate() {
         return effectiveDate;
     }
     public void setEffectiveDate(Date aDate) {
         Date now = new Date(System.currentTimeMillis());
         if (now.before(effectiveDate)) {
             this.status = &quot;Pending&quot;;
         } else if (now.after(terminationDate)) {
             this.status = &quot;Terminated&quot;;
         } else {
             this.status = &quot;Active&quot;;
         }
         this.effectiveDate = aDate;
     }
 }
</code></pre>
<p> 使用：</p>
<pre><code class="lang-java"> SQLQuery q  = session.createSQLQuery(sb.toString());    
 query.setResultTransformer(Transformers.aliasToBean(AdvancedClauseSearchResultDTO.class));
 return (List&lt;AdvancedClauseSearchResultDTO&gt;)query.list();
</code></pre>
</li>
<li><p>自定义<code>ResultTransformer</code></p>
<pre><code class="lang-java"> public class AdvancedClauseSearchResultTransformer implements ResultTransformer {
     //Use the aliasTransformer to do most of the work
     ResultTransformer aliasTransformer = Transformers.aliasToBean(AdvancedClauseSearchResultDTO.class);

     @Override
     public List transformList(List list) {
     List&lt;AdvancedClauseSearchResultDTO&gt; result = aliasTransformer.transformList(list);
         //for each row, set the status field
        for (AdvancedClauseSearchResultDTO dto : result) {
             String status = null;
             Date effectiveDate = dto.getEffectiveDate();
             Date terminationDate = dto.getTerminationDate();
             Date now = new Date(System.currentTimeMillis());
             if (now.before(effectiveDate)) {
                 status = &quot;Pending&quot;;
             } else if (now.after(terminationDate)) {
                 status = &quot;Terminated&quot;;
             } else {
                 status = &quot;Active&quot;;
             }
             dto.setStatus(status);

             if (StringUtils.isNotEmpty(dto.getReasonForAmendment())){
                 dto.setAmended(Boolean.TRUE);
             }else{
                 dto.setAmended(Boolean.FALSE);
             }
         }
         return result;
     }

     @Override
     public Object transformTuple(Object[] os, String[] strings) {
         Object result = aliasTransformer.transformTuple(os, strings);
         return result;
     }
 }
</code></pre>
<p> 使用：</p>
<pre><code class="lang-java"> SQLQuery q  = session.createSQLQuery(sb.toString());
 q.setResultTransformer(new AdvancedClauseSearchResultTransformer());
 return (List&lt;AdvancedClauseSearchResultDTO&gt;)query.list();
</code></pre>
</li>
</ol>
<h3 id="header-7"><code>addEntity</code> VS <code>ResultTransformer</code></h3>
<ol>
<li><p><code>addEntity(Class clazz)</code> 的参数必须是被Hibernate管理的持久化bean,否则会报<code>MappingException:Unknown entity</code></p>
</li>
<li><p><code>ResultTransformer</code>可以接受一个任意的bean,只要这个bean的属性（严格说是<code>setXxx()</code>中的xxx）与select结果集列名存在对应关系</p>
</li>
</ol>
<h2 id="header-8">QBC</h2>
<p>参考文章：</p>
<ul>
<li><a href="http://what-when-how.com/hibernate/advanced-query-options-hibernate/">Advanced query options (Hibernate)</a></li>
<li><a href="https://docs.jboss.org/hibernate/orm/3.3/reference/en/html/querycriteria.html">Chapter 15. Criteria Queries</a></li>
</ul>
<h3 id="header-9">setFetchMode</h3>
<pre><code class="lang-java">List cats = sess.createCriteria(Cat.class)
    .add( Restrictions.like(&quot;name&quot;, &quot;Fritz%&quot;) )
    .setFetchMode(&quot;mate&quot;, FetchMode.JOIN)
    .setFetchMode(&quot;kittens&quot;, FetchMode.JOIN)
    .list();
</code></pre>
<p>=&gt; <code>List&lt;Cat&gt;</code> (each Cat: mate,kittens)
=&gt; This query will fetch both mate and kittens by outer join.</p>
<p><code>FetchType</code>与<code>FetchMode</code>：</p>
<pre><code class="lang-java">@OneToMany(mappedBy=&quot;item&quot;,cascade=CascadeType.ALL,fetch=FetchType.EAGER) 

@Fetch(value=FetchMode.SUBSELECT)
</code></pre>
<p>两者比较：</p>
<ul>
<li>两者都是设定关联对象的加载策略</li>
<li>FetchType与FetchMode是JPA标准的通用加载策略注解属性</li>
<li>Fetch是Hibernate自有加载策略属性</li>
</ul>
<p>FetchType：</p>
<ul>
<li>FetchType.LAZY: 懒加载，在访问关联对象的时候加载(即从数据库读入内存)</li>
<li>FetchType.EAGER:立刻加载，在查询主对象的时候同时加载关联对象。</li>
</ul>
<p>FetchMode：</p>
<ul>
<li>FetchMode.JOIN： 始终立刻加载，使用外连(outer join)查询的同时加载关联对象，忽略FetchType.LAZY设定。</li>
<li>FetchMode.SELECT：默认懒加载(除非设定关联属性lazy=false)，当访问每一个关联对象时加载该对象，会累计产生N+1条sql语句</li>
<li>FetchMode.SUBSELECT  默认懒加载(除非设定关联属性lazy=false),在访问第一个关联对象时加载所有的关联对象。会累计产生两条sql语句。且FetchType设定有效。</li>
</ul>
<h3 id="header-10">createCriteria</h3>
<p>createCriteria定义：return sub Criteria ,so all the operation is on sub Criteria </p>
<pre><code>public Criteria createCriteria(String associationPath, int joinType) {
    return new Subcriteria( this, associationPath, joinType );
}
</code></pre><p>使用示例：</p>
<pre><code class="lang-java">List cats = sess.createCriteria(Cat.class)
    .add(Restrictions.like(&quot;name&quot;, &quot;F%&quot;) )
    .createCriteria(&quot;kittens&quot;)
    .add(Restrictions.like(&quot;name&quot;, &quot;F%&quot;) )
    .list();
</code></pre>
<p>=&gt; <code>List&lt;Cat&gt;</code> (<strong>Cat:  no kittens</strong>)
=&gt; The second createCriteria() returns a new instance of Criteria that refers to the elements of the kittens collection.</p>
<pre><code class="lang-java">List cats = sess.createCriteria(Cat.class)
    .add(Restrictions.like(&quot;name&quot;, &quot;F%&quot;) )
    .createCriteria(&quot;kittens&quot;,JoinType.LEFT_OUTER_JOIN)
    .add(Restrictions.like(&quot;name&quot;, &quot;F%&quot;) )
    .list();
</code></pre>
<p>=&gt; <code>List&lt;Cat&gt;</code> (<strong>Cat:  kittens</strong>)</p>
<h3 id="header-11">createAlias</h3>
<p>createAlias定义：return the criteria who create sub Criteria (默认使用INNER_JOIN)</p>
<pre><code class="lang-java">public Criteria createAlias(String associationPath, String alias, int joinType) {
    new Subcriteria( this, associationPath, alias, joinType );
    return this;
}
</code></pre>
<pre><code class="lang-java">List cats = sess.createCriteria(Cat.class)
    .createAlias(&quot;kittens&quot;, &quot;kt&quot;)
    .createAlias(&quot;mate&quot;, &quot;mt&quot;)
    .add(Restrictions.eqProperty(&quot;kt.name&quot;, &quot;mt.name&quot;) )
    .list();
</code></pre>
<p>=&gt; <code>List&lt;Cat&gt;</code> (<strong>Cat: no kittens and mate</strong>)
=&gt; createAlias() does not create a new instance of Criteria</p>
<pre><code class="lang-java">List cats = sess.createCriteria(Cat.class)
    .createAlias(&quot;kittens&quot;, &quot;kt&quot;,JoinType.LEFT_OUTER_JOIN)
    .createAlias(&quot;mate&quot;, &quot;mt&quot;,JoinType.LEFT_OUTER_JOIN)
    .add(Restrictions.eqProperty(&quot;kt.name&quot;, &quot;mt.name&quot;) )
    .list();
</code></pre>
<p>=&gt; <code>List&lt;Cat&gt;</code> (<strong>Cat:  kittens and mate</strong>)</p>
<h3 id="header-12">Join Restriction</h3>
<p>类似查询：<code>select * from A left join B on A.xx=B.xx and B.yy=zz where ...</code></p>
<pre><code class="lang-java">DetachedCriteria detachedCriteria=DetachedCriteria.forClass(SysMenu.class)
                      .addOrder(Order.asc(&quot;parent&quot; ))
                      .addOrder(Order.asc(&quot;menuOrder&quot; ))
                      //使用createCriteria或createAlias都可
                      .createAlias(&quot;sysRoleMenus&quot;, &quot;rm&quot;, JoinType.LEFT_OUTER_JOIN,Restrictions.eq(&quot;sysRole.id&quot;, roleId));
</code></pre>
<p>=&gt; <code>List&lt;SysMenu&gt;</code> (<strong>SysMenu : no sysRoleMenus</strong>)</p>
<p>（HQL可使用<code>with</code>关键字实现）</p>
<h3 id="header-13">exist - subquery</h3>
<p>Sample1:</p>
<pre><code class="lang-sql">select A.*
FROM AETABLE A
where not exists
(
    select entryid
    FROM AETABLE B
    where B.classpk = A.classpk
    and B.userid = A.userid
    and B.modifiedDate &gt; A.modifiedDate
)and userid = 10146
</code></pre>
<p>Assuming property / class names match column / table names above:</p>
<pre><code class="lang-java">DetachedCriteria subquery = DetachedCriteria.forClass(AETable.class, &quot;b&quot;)
 .add(Property.forName(&quot;b.classpk&quot;).eqProperty(&quot;a.classpk&quot;))
 .add(Property.forName(&quot;b.userid&quot;).eqProperty(&quot;a.userid&quot;))
 .add(Property.forName(&quot;b.modifiedDate&quot;).gtProperty(&quot;a.modifiedDate&quot;));

Criteria criteria = session.createCriteria(AETable.class, &quot;a&quot;)
 .add(Property.forName(&quot;userid&quot;).eq(new Integer(10146)))
 .add(Subqueries.notExists(subquery);
</code></pre>
<p>If the entryid is not the primary key, need to add projection.</p>
<pre><code class="lang-java">DetachedCriteria subquery = DetachedCriteria.forClass(AETable.class, &quot;b&quot;)
 .add(Property.forName(&quot;b.classpk&quot;).eqProperty(&quot;a.classpk&quot;))
 .add(Property.forName(&quot;b.userid&quot;).eqProperty(&quot;a.userid&quot;))
 .add(Property.forName(&quot;b.modifiedDate&quot;).gtProperty(&quot;a.modifiedDate&quot;))
 .setProjection(Projections.property(&quot;entryId&quot;));  // Additional projection property

Criteria criteria = session.createCriteria(AETable.class, &quot;a&quot;)
 .add(Property.forName(&quot;userid&quot;).eq(new Integer(10146)))
 .add(Subqueries.notExists(subquery);
</code></pre>
<p>Sample2:</p>
<pre><code class="lang-sql">SELECT *
 FROM PIZZA_ORDER
 WHERE EXISTS (SELECT 1
                 FROM PIZZA
                 WHERE PIZZA.pizza_size_id = 1 
                 AND PIZZA.pizza_order_id = PIZZA_ORDER.pizza_order_id)
</code></pre>
<pre><code class="lang-java">DetachedCriteria sizeCriteria = DetachedCriteria.forClass(Pizza.class,&quot;pizza&quot;)
 .add(&quot;pizza_size_id&quot;,1)
 .add(Property.forName(&quot;pizza.pizza_order_id&quot;).eqProperty(&quot;pizzaOrder.pizza_order_id&quot;));

Criteria criteria = Criteria.forClass(PizzaOrder.class,&quot;pizzaOrder&quot;)
 .add(Subqueries.exists(
    sizeCriteria.setProjection(Projections.property(&quot;pizza.id&quot;))
));

List&lt;pizzaOrder&gt; ordersWithOneSmallPizza = criteria.list();
</code></pre>
<p>Sample3:</p>
<pre><code class="lang-sql">select *
 from shuttle_station
 where id in (
    select station_id 
    from shuttle_route_schedule rs left join shuttle_route 
    where active=1 and expireTime is null
)
</code></pre>
<pre><code class="lang-java">DetachedCriteria subCriteria=DetachedCriteria.forClass(ShuttleRouteSchedule.class,&quot;rs&quot;)
    .add(Restrictions.eq(&quot;active&quot;, true))
    .add(Restrictions.isNull(&quot;expireTime&quot;))
    .setProjection(Projections.distinct(Projections.property(&quot;station.id&quot;)));

DetachedCriteria detachedCriteria=DetachedCriteria.forClass(ShuttleStation.class)
    .createAlias(&quot;stationShifts&quot;,&quot;ea&quot;, JoinType.LEFT_OUTER_JOIN)
    .add(Subqueries.propertyIn(&quot;id&quot;, subCriteria));
</code></pre>
<h3 id="header-14">通用查询封装示例</h3>
<p><strong>PS:</strong>  使用过setProjection获取信息后，重置为null，返回的不再是RootEntity~！
参考文章: <a href="http://blog.xebia.com/2008/12/11/sorting-and-pagination-with-hibernate-criteria-how-it-can-go-wrong-with-joins/">Sorting And Pagination With Hibernate Criteria - How It Can Go Wrong With Joins</a></p>
<pre><code class="lang-java">@Override
@SuppressWarnings(&quot;unchecked&quot;)
public List&lt;T&gt; list(DetachedCriteria detachedCriteria,boolean byPage)
{
    Criteria criteria=null;
    if(detachedCriteria!=null)
        criteria=detachedCriteria.getExecutableCriteria(getSession());
    else
        criteria=this.getSession().createCriteria(this.getEntityClass());

    if (byPage &amp;&amp; PaginationUtils.exist()){
        ResultTransformer resultTransformer=((CriteriaImpl)criteria).getResultTransformer();

        Object total = criteria.setProjection(Projections.rowCount()).uniqueResult(); 
        //System.out.println(total.toString());
        Pagination p=PaginationUtils.getPagination();
        p.setTotal(Integer.valueOf(total.toString()));

        criteria.setProjection(null); 
        criteria.setResultTransformer(resultTransformer);

        criteria.setFirstResult(p.getStart());  
        criteria.setMaxResults(p.getLimit()); 
        if (p.getSorter() != null &amp;&amp; p.getSorter().length()!=0) {
            if(&quot;DESC&quot;.equalsIgnoreCase(PaginationUtils.getOrder()))
                criteria.addOrder(Order.desc(PaginationUtils.getSorter()));
            else
                criteria.addOrder(Order.asc(PaginationUtils.getSorter()));
        }
    }
    return criteria.list(); 
}
</code></pre>
<pre><code class="lang-java">@Override
public List&lt;?&gt; listByHql(String hql, Object... params) {
    //this.getEntityClass();
    if (PaginationUtils.exist() &amp;&amp; PaginationUtils.getSorter() != null &amp;&amp; PaginationUtils.getSorter().length()!=0) {
        hql += &quot; order by &quot; + PaginationUtils.getSorter() + &quot; &quot;
                + PaginationUtils.getOrder();
    }
    Query query = createHQLQuery(hql, params);

    if (PaginationUtils.exist()) {
        Query countQuery = createHQLQuery(&quot;select count(*) &quot;
                + removeSelect(hql), params);
        int total = Integer.valueOf(countQuery.uniqueResult().toString());
        PaginationUtils.setTotal(total);

        query.setFirstResult(PaginationUtils.getStart()).setMaxResults(
                PaginationUtils.getLimit());
    }
    return query.list();
}
</code></pre>
<h2 id="header-15">TableGenerator</h2>
<p>参考文章：<a href="http://www.ibm.com/developerworks/cn/java/j-lo-tablegenerator/">探索 Hibernate 新 TableGenerator 机制</a></p>
<h3 id="header-16">TableGenerator 注解和类</h3>
<p><code>@TableGenerator</code> 注解是 JPA 规范中的注解，用于确定 TABLE 主键生成器的各个参数，具体的功能要由 JPA 提供者来实现</p>
<p>Hibernate 中实现该注解的<code>TableGenerator 类</code>有两个：</p>
<ol>
<li>原有的 TableGenerator，类名为 org.hibernate.id.TableGenerator，这是默认的 TableGenerator</li>
<li>新 TableGenerator，指的是 org.hibernate.id.enhanced.TableGenerator</li>
</ol>
<h3 id="header-17">使用JPA注解：@TableGenerator</h3>
<pre><code class="lang-java">@Id
@GeneratedValue(strategy=GenerationType.TABLE,generator=&quot;teacherID&quot;)
@TableGenerator(name=&quot;teacherID&quot;,
        table=&quot;teacherID_DB&quot;,
        pkColumnName=&quot;key_value&quot;,
        pkColumnValue=&quot;pk_value&quot;,
        valueColumnName=&quot;teacher&quot;,
        allocationSize=1)     //注意 initialValue 参数无效
public int getId() {
    return id;
}
</code></pre>
<p><strong>PS</strong>： 默认使用旧的TableGenerator类，若要使用新的，需配置：</p>
<pre><code class="lang-xml">&lt;property name=&quot;hibernate.id.new_generator_mappings&quot; value=&quot;true&quot;/&gt;
</code></pre>
<h3 id="header-18">使用Hibernate注解：@GenericGenerator</h3>
<p>新 TableGenerator 的一些功能不在 JPA 中，因此不能使用 JPA 的 <code>@TableGenerator</code> 注解，而是要使用 Hibernate 自身的 <code>@GenericGenerator</code> 注解</p>
<p>新 TableGenerator 配置参数表：</p>
<table class="table">
<thead>
<tr>
<th>序号</th>
<th>参数名</th>
<th>默认值</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>table_name</td>
<td>hibernate_sequence</td>
<td>辅助表的表名</td>
</tr>
<tr>
<td>2</td>
<td>value_column_name</td>
<td>next_val</td>
<td>存放序列值的列名</td>
</tr>
<tr>
<td>3</td>
<td>segment_column_name</td>
<td>sequence_name</td>
<td>存放序列名的列名</td>
</tr>
<tr>
<td>4</td>
<td>segment_value</td>
<td>default</td>
<td>序列名</td>
</tr>
<tr>
<td>5</td>
<td>segment_value_length</td>
<td>255</td>
<td>序列名所在列数据类型长度</td>
</tr>
<tr>
<td>6</td>
<td>initial_value</td>
<td>1</td>
<td>指定序列的初始值</td>
</tr>
<tr>
<td>7</td>
<td>increment_size</td>
<td>1</td>
<td>指定序列默认的递增量</td>
</tr>
<tr>
<td>8</td>
<td>optimizer</td>
<td>依 increment_size 的取值而定</td>
<td>指定序列的优化器</td>
</tr>
</tbody>
</table>
<p><img src="/2013/06/02/tableGenerator-params.png" alt="TableGenerator Parameters"></p>
<pre><code class="lang-java">@GenericGenerator( name=&quot;id_gen&quot;, strategy=&quot;enhanced-table&quot;,
parameters = {
       @Parameter( name = &quot;table_name&quot;, value = &quot;enhanced_gen&quot;),
       @Parameter( name =&quot;value_column_name&quot;, value = &quot;next&quot;),
       @Parameter( name = &quot;segment_column_name&quot;,value = &quot;segment_name&quot;),
       @Parameter( name = &quot;segment_value&quot;, value = &quot;emp_seq&quot;),
       @Parameter( name = &quot;increment_size&quot;, value = &quot;10&quot;),
       @Parameter( name = &quot;optimizer&quot;,value = &quot;pooled-lo&quot;)
})
@Id
@GeneratedValue(generator=&quot;id_gen&quot;)
public int getId() {
    return id;
}
</code></pre>
<p><strong>PS</strong>： 注意配置使用新的TableGenerator</p>
<pre><code class="lang-xml">&lt;property name=&quot;hibernate.id.new_generator_mappings&quot; value=&quot;true&quot;/&gt;
</code></pre>
<h3 id="header-19">Hibernate的Optimizer优化器</h3>
<p>Optimizer 名字及实现类：</p>
<table class="table">
<thead>
<tr>
<th>Optimizer 名字</th>
<th>类名</th>
<th>特点</th>
</tr>
</thead>
<tbody>
<tr>
<td>none</td>
<td>NoopOptimizer.class</td>
<td>没有任何优化，每次主键生成都需要访问数据库</td>
</tr>
<tr>
<td>hilo</td>
<td>HiLoOptimizer.class</td>
<td>hilo算法实现的主键生成机制，数据库中的值是 bucket 的序号</td>
</tr>
<tr>
<td>legacy-hilo</td>
<td>LegacyHiLoAlgorithmOptimizer.class</td>
<td>旧 hilo 算法</td>
</tr>
<tr>
<td>pooled</td>
<td>PooledOptimizer.class</td>
<td>也使用 hilo 算法，不同之处在于 bucket 内部数值保存在数据库中</td>
</tr>
<tr>
<td>pooled-lo</td>
<td>PooledLoOptimizer.class</td>
<td>算法与 pooled 完全相同，但保存在数据库中的值不同于 pooled</td>
</tr>
</tbody>
</table>
<p>选定优化器的过程：
<img src="/2013/06/02/tableGenerator-optimizer.png" alt="Optimizer"></p>
<h3 id="header-20">自定义TableGenerator</h3>
<ol>
<li>自定义TableGenerator：<code>MyFormatTableGenerator</code> （implements org.hibernate.id.enhanced.TableGenerator）</li>
<li>自定义Optimizer：<code>MyPooledOptimizer</code> （extends OptimizerSupport implements InitialValueAwareOptimizer）</li>
<li>使用：<pre><code class="lang-java"> @Id
 @Column(name = &quot;req_id&quot;, unique = true, nullable = false, length = 10)
 @GeneratedValue(strategy = GenerationType. TABLE, generator = &quot;myFormatTableGenerator&quot; )
 @GenericGenerator(name = &quot;myFormatTableGenerator&quot;, strategy = &quot;com.cj.support.hibernate.MyFormatTableGenerator&quot; , parameters = {
  @Parameter(name = &quot;format&quot;, value = &quot;R%2$ty-%1$05d&quot;),
  @Parameter(name = TableGenerator.TABLE_PARAM, value = &quot;tb_generator&quot;),
  @Parameter(name = TableGenerator.SEGMENT_COLUMN_PARAM, value = &quot;gen_name&quot;),
  @Parameter(name = TableGenerator.SEGMENT_VALUE_PARAM, value = &quot;Request_PK&quot;),
  @Parameter(name = TableGenerator.VALUE_COLUMN_PARAM, value = &quot;gen_value&quot;),
  @Parameter(name = TableGenerator.INITIAL_PARAM, value = &quot;1&quot;),
  @Parameter(name = TableGenerator.INCREMENT_PARAM, value = &quot;20&quot;)
 })
 public String getReqId(){
     return this. reqId;
 }
</code></pre>
</li>
</ol>
<h2 id="header-21">Spring中配置Hibernate</h2>
<pre><code class="lang-xml">&lt;context:property-placeholder location=&quot;classpath:jdbc-prod.properties&quot;/&gt;
&lt;bean id=&quot;dataSource&quot; destroy-method=&quot;close&quot; class=&quot;org.apache.commons.dbcp.BasicDataSource&quot;&gt;
    &lt;property name=&quot;driverClassName&quot; value=&quot;${jdbc.driverClassName}&quot;/&gt;
    &lt;property name=&quot;url&quot; value=&quot;${jdbc.url}&quot;/&gt;
    &lt;property name=&quot;username&quot; value=&quot;${jdbc.username}&quot;/&gt;
    &lt;property name=&quot;password&quot; value=&quot;${jdbc.password}&quot;/&gt;

    &lt;property name=&quot;initialSize&quot; value=&quot;1&quot;/&gt;
    &lt;property name=&quot;minIdle&quot; value=&quot;2&quot;/&gt;
    &lt;property name=&quot;maxActive&quot; value=&quot;200&quot;/&gt;
    &lt;property name=&quot;maxIdle&quot; value=&quot;30&quot;/&gt;
    &lt;property name=&quot;maxWait&quot; value=&quot;1000&quot;/&gt;
    &lt;property name=&quot;removeAbandoned&quot; value=&quot;true&quot;/&gt;
    &lt;!-- &lt;property name=&quot;logAbandoned&quot; value=&quot;true&quot;/&gt;   --&gt;
    &lt;property name=&quot;validationQuery&quot; value=&quot;select 1 from dual&quot;/&gt;
    &lt;property name=&quot;testOnBorrow&quot; value=&quot;true&quot;/&gt;
&lt;/bean&gt;

&lt;bean id=&quot;sessionFactory&quot; class=&quot;org.springframework.orm.hibernate4.LocalSessionFactoryBean&quot;&gt;
    &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot; /&gt;
    &lt;property name=&quot;hibernateProperties&quot;&gt;
        &lt;props&gt;
            &lt;prop key=&quot;hibernate.dialect&quot;&gt;${hibernate.dialect}&lt;/prop&gt;
            &lt;prop key=&quot;hibernate.id.new_generator_mappings&quot;&gt;true&lt;/prop&gt;
            &lt;prop key=&quot;hibernate.show_sql&quot;&gt;${hibernate.show.sql}&lt;/prop&gt;
            &lt;prop key=&quot;hibernate.format_sql&quot;&gt;${hibernate.format.sql}&lt;/prop&gt;
            &lt;!-- &lt;prop key=&quot;javax.persistence.validation.mode&quot;&gt;none&lt;/prop&gt; --&gt;
        &lt;/props&gt;
    &lt;/property&gt;

    &lt;property name=&quot;packagesToScan&quot;&gt;
        &lt;list&gt;
            &lt;value&gt;com.golf.entity&lt;/value&gt;
        &lt;/list&gt;
    &lt;/property&gt;
&lt;/bean&gt;

&lt;!-- 声明式事务 --&gt;
&lt;bean id=&quot;txManager&quot; class=&quot;org.springframework.orm.hibernate4.HibernateTransactionManager&quot;&gt;
    &lt;property name=&quot;sessionFactory&quot; ref=&quot;sessionFactory&quot;/&gt;
&lt;/bean&gt;
&lt;tx:advice id=&quot;txAdvice&quot; transaction-manager=&quot;txManager&quot; &gt;
    &lt;tx:attributes&gt;
        &lt;tx:method name=&quot;list*&quot; propagation=&quot;REQUIRED&quot; read-only=&quot;true&quot;/&gt;
        &lt;tx:method name=&quot;get*&quot; propagation=&quot;REQUIRED&quot; read-only=&quot;true&quot;/&gt;
        &lt;tx:method name=&quot;test*&quot; propagation=&quot;REQUIRED&quot; read-only=&quot;true&quot;  /&gt;
        &lt;tx:method name=&quot;sendMail&quot; propagation=&quot;REQUIRED&quot; read-only=&quot;true&quot; no-rollback-for=&quot;Exception&quot;/&gt;
        &lt;tx:method name=&quot;*&quot;/&gt;
    &lt;/tx:attributes&gt;
&lt;/tx:advice&gt;
 &lt;aop:config&gt;
    &lt;aop:pointcut expression=&quot;execution(* com.cj.service.*.*(..))&quot; id=&quot;mySearchService&quot;/&gt;
    &lt;aop:advisor advice-ref=&quot;txAdvice&quot; pointcut-ref=&quot;mySearchService&quot;/&gt;
&lt;/aop:config&gt;
</code></pre>
  </section>
</article>

      <hr/>
      
<section class="post-comment">
	
		<div id="gitment_container"></div>

<link rel="stylesheet" href="/gitment/default.css">
<script src="/gitment/gitment.browser.js"></script>


<script type="text/javascript">
	var gitment = new Gitment({
	  id: document.location.pathname,
	  owner: 'chenjin-zero',
	  repo: 'blogComment',
	  oauth: {
	    client_id: '36a09bb7399efe69c6ce',
	    client_secret: 'ad9ad546b23b708c71d92e513dc36e0486179dea',
	  }
	})
      
	gitment.render('gitment_container')
</script>
	
</section>

    </div>
  </div>
</body>

<script src="/jquery/dist/jquery.min.js"></script>
<script src="/bootstrap/dist/js/bootstrap.min.js"></script>


	<script src="/highlight/highlight.pack.js"></script>
	<script type="text/javascript">
		hljs.initHighlightingOnLoad();
	</script>






<script type="text/javascript">

  $(document).ready(function(){
    var sidebarCtrl=$("#sidebar-ctrl");
    var sidebar=$("#sidebar");
    var wrapper=$("#wrapper");
    sidebarCtrl.on("click",function(event){
        //alert("click");
        sidebar.toggleClass("sidebar-toggle");
        wrapper.toggleClass("sidebar-toggle");
        sidebarCtrl.toggleClass("sidebar-toggle");
        sidebarCtrl.toggleClass("active");
    })
  });
</script>


</html>
