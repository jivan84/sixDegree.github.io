<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Activiti5</title>
  
  <!-- Meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="jbpm,activiti,process,bpmn,spring">
  
  
    <meta name="description" content="Activiti Introduce">
  

  <!-- Feed -->
  
    <link rel="alternative" href="/atom.xml" title="SixDegree" type="application/atom+xml">
  

  <!-- CSS -->
  <link rel="stylesheet" href="/bootstrap/dist/css/bootstrap.css">
  
    <link rel="stylesheet" href="/highlight/demo/styles/tomorrow-night-bright.css">
  
  <link rel="stylesheet" href="/css/fontello.css">
  <link rel="stylesheet" href="/css/style.css">

  <!-- Site Analyse -->
  
	<script>
	var userID='2bbb83cc0f781dd7502e9d5e19661866';
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?"+userID;
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>


</head>

<body data-spy="scroll" data-target="#nav-catalog">
  <div id="top-push"></div>
<a href="#top-push" id="go-top">
	<span class="glyphicon glyphicon-chevron-up"></span>
</a>
  <aside id="sidebar">
    <section class="sidebar-header">Catalog</section>
     <nav id="nav-catalog">
        <ol class="sidebar-nav nav"><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#Starter"><span class="sidebar-nav nav-text">Starter</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#依赖包"><span class="sidebar-nav nav-text">依赖包</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#流程设计工具"><span class="sidebar-nav nav-text">流程设计工具</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#ProcessEngine-流程引擎"><span class="sidebar-nav nav-text">ProcessEngine(流程引擎)</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#ProcessDefinition-流程定义"><span class="sidebar-nav nav-text">ProcessDefinition(流程定义)</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#发布流程定义"><span class="sidebar-nav nav-text">发布流程定义</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#查看流程定义信息"><span class="sidebar-nav nav-text">查看流程定义信息</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#查看流程附件"><span class="sidebar-nav nav-text">查看流程附件</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#删除流程定义"><span class="sidebar-nav nav-text">删除流程定义</span></a></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#ProcessInstance-流程实例"><span class="sidebar-nav nav-text">ProcessInstance(流程实例)</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#启动流程"><span class="sidebar-nav nav-text">启动流程</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#查看流程状态"><span class="sidebar-nav nav-text">查看流程状态</span></a></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#Task-任务"><span class="sidebar-nav nav-text">Task(任务)</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#查看任务"><span class="sidebar-nav nav-text">查看任务</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#办理任务"><span class="sidebar-nav nav-text">办理任务</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#监听器"><span class="sidebar-nav nav-text">监听器</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#系统任务"><span class="sidebar-nav nav-text">系统任务</span></a></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#Gateway-网关"><span class="sidebar-nav nav-text">Gateway 网关</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#排他网关"><span class="sidebar-nav nav-text">排他网关</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#并行网关"><span class="sidebar-nav nav-text">并行网关</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#包含网关"><span class="sidebar-nav nav-text">包含网关</span></a></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#与Spring整合"><span class="sidebar-nav nav-text">与Spring整合</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#测试"><span class="sidebar-nav nav-text">测试</span></a></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#功能组件介绍"><span class="sidebar-nav nav-text">功能组件介绍</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#Service"><span class="sidebar-nav nav-text">Service</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#Tables"><span class="sidebar-nav nav-text">Tables</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#Var"><span class="sidebar-nav nav-text">Var</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#User"><span class="sidebar-nav nav-text">User</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#Form"><span class="sidebar-nav nav-text">Form</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#Activiti管理表单"><span class="sidebar-nav nav-text">Activiti管理表单</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#非Activiti管理表单"><span class="sidebar-nav nav-text">非Activiti管理表单</span></a></li></ol></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#常见应用"><span class="sidebar-nav nav-text">常见应用</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#Attachment-amp-Comment"><span class="sidebar-nav nav-text">Attachment & Comment</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#多实例"><span class="sidebar-nav nav-text">多实例</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#CallActivity-amp-SubProcess"><span class="sidebar-nav nav-text">CallActivity & SubProcess</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#Transaction-事务"><span class="sidebar-nav nav-text">Transaction 事务</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#流程跟踪"><span class="sidebar-nav nav-text">流程跟踪</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#使用流程定义文件-xml"><span class="sidebar-nav nav-text">使用流程定义文件(.xml)</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#使用部署上传的流程图"><span class="sidebar-nav nav-text">使用部署上传的流程图</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#使用Diagram-Viewer组件"><span class="sidebar-nav nav-text">使用Diagram Viewer组件</span></a></li></ol></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#Reference"><span class="sidebar-nav nav-text">Reference</span></a></li></ol>
    </nav>
  </aside>
  <span id="sidebar-ctrl" class="glyphicon glyphicon-list-alt circle"></span>
  <div id="wrapper">
    <header>
  <nav class="navbar navbar-default">
    <div class="container-fluid">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#nav-menu" aria-expanded="false">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="/">SixDegree</a>
      </div>
      <div class="collapse navbar-collapse" id="nav-menu">
        <ul class="nav navbar-nav navbar-right">
          
              <li  >
                <a href="/">Blogs</a>
              </li>
          
              <li  >
                <a href="/tags.html">Tags</a>
              </li>
          
              <li  >
                <a href="/about.html">About</a>
              </li>
          
          
              <li>
                <a href="/atom.xml" target="_blank">
                  <span class="icon-rss"></span>
                </a>
              </li>
          
              <li>
                <a href="http://github.com/sixdegree" target="_blank">
                  <span class="icon-github"></span>
                </a>
              </li>
          
        </ul>
      </div>
    </div>
  </nav>
</header>



    <div class="container">
      <article class="detail" role="main">
  <section class="post-header">
    <h1 class="post-title">Activiti5</h1>
    <ul class="post-meta">
      <li>
        <span class="glyphicon glyphicon-calendar"></span>
        <time datetime="2013-09-30T16:00:00.000Z">2013-10-01</time>
      </li>
      
        <li>
         <span class="glyphicon glyphicon-tags"></span>
          
            <a href="/tags.html#tag-Java">Java</a>
          
            <a href="/tags.html#tag-Activiti">Activiti</a>
          
        </li>
      
    </ul>
  </section>
  <section class="post-content">
    <h2 id="Starter"><a href="#Starter" class="headerlink" title="Starter"></a>Starter</h2><h3 id="依赖包"><a href="#依赖包" class="headerlink" title="依赖包"></a>依赖包</h3><pre><code class="nullxml">&lt;dependency&gt;
    &lt;groupId&gt;org.activiti&lt;/groupId&gt;
    &lt;artifactId&gt;activiti-engine&lt;/artifactId&gt;
    &lt;version&gt;${activiti-version}&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.activiti&lt;/groupId&gt;
    &lt;artifactId&gt;activiti-spring&lt;/artifactId&gt;
    &lt;version&gt;${activiti-version}&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p>根据需要，加入DB，例如：</p>
<pre><code class="nullxml">&lt;dependency&gt;
    &lt;groupId&gt;mysql&lt;/groupId&gt;
    &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
    &lt;version&gt;5.1.21&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;oracle&lt;/groupId&gt;
    &lt;artifactId&gt;oracle&lt;/artifactId&gt;
    &lt;version&gt;11.2&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.h2database&lt;/groupId&gt;
    &lt;artifactId&gt;h2&lt;/artifactId&gt;
    &lt;version&gt;1.3.168&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.postgresql&lt;/groupId&gt;
    &lt;artifactId&gt;postgresql&lt;/artifactId&gt;
    &lt;version&gt;9.4-1201-jdbc41&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<h3 id="流程设计工具"><a href="#流程设计工具" class="headerlink" title="流程设计工具"></a>流程设计工具</h3><ol>
<li>使用Activiti Modeler（网页流程设计器）<ul>
<li>一般适用于业务设计人员</li>
<li>Signavio 授权的基于Web的开源BPMN设计器</li>
<li>BPMN 2.0规范</li>
<li>获取后置于tomcat中启用，获取方式：<ul>
<li>方式一：<code>svn checkout http://signavio-core-components.googlecode.com/svn/trunk</code></li>
<li>方式二：activiti包下的<code>activiti-explorer.war</code>（内置了Activiti Modeler组件）</li>
</ul>
</li>
<li>还可将此组件加入到自己项目中，为项目提供在线流程设计功能：<pre><code class="nullxml">&lt;dependency&gt; 
  &lt;groupId&gt;org.activiti&lt;/groupId&gt;
  &lt;artifactId&gt;activiti-modeler&lt;/artifactId&gt;
  &lt;version&gt;${activiti-version}&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
</li>
</ul>
</li>
<li>使用Activiti Designer（Eclipse插件）<ul>
<li>一般适用于开发人员</li>
</ul>
</li>
</ol>
<h3 id="ProcessEngine-流程引擎"><a href="#ProcessEngine-流程引擎" class="headerlink" title="ProcessEngine(流程引擎)"></a>ProcessEngine(流程引擎)</h3><p>ProcessEngineConfiguration:</p>
<ul>
<li><code>org.activiti.engine.impl.cfg.StandaloneProcessEngineConfiguration</code>: 单独运行的流程引擎。<ul>
<li>Activiti会自己处理事务</li>
<li>默认</li>
<li>数据库只在引擎启动时检测 （如果没有Activiti的表或者表结构不正确就会抛出异常）</li>
</ul>
</li>
<li><code>org.activiti.engine.impl.cfg.StandaloneInMemProcessEngineConfiguration</code>: 单元测试时的辅助类。<ul>
<li>Activiti会自己控制事务。 </li>
<li>默认使用H2内存数据库。</li>
<li>数据库表会在引擎启动时创建，关闭时删除。</li>
<li>使用它时，不需要其他配置（除非使用job执行器或邮件功能）</li>
</ul>
</li>
<li><code>org.activiti.spring.SpringProcessEngineConfiguration</code>: 在Spring环境下使用流程引擎</li>
<li><code>org.activiti.engine.impl.cfg.JtaProcessEngineConfiguration</code>: 单独运行流程引擎，并使用JTA事务。</li>
</ul>
<p>创建ProcessEngine:</p>
<p>方式一：</p>
<pre><code class="nulljava">/*
 * 不使用配置文件，创建ProcessEngine对象
 */
@Test
public void envTest1(){
    //1.创建流程引擎配置对象ProcessEngineConfiguration
    ProcessEngineConfiguration configuration=ProcessEngineConfiguration.createStandaloneProcessEngineConfiguration();
    //2.配置
    //2.1）完善数据库相关配置--这里使用MySQL（默认为H2）
    configuration.setJdbcDriver(&quot;com.mysql.jdbc.Driver&quot;);
    configuration.setJdbcUrl(&quot;jdbc:mysql://localhost:3306/activitiTest?createDatabaseIfNotExist=true&quot;);
    configuration.setJdbcUsername(&quot;xxxx&quot;);
    configuration.setJdbcPassword(&quot;xxxxxx&quot;);
    //2.2）配置数据库建表策略，默认为false
    configuration.setDatabaseSchemaUpdate(ProcessEngineConfiguration.DB_SCHEMA_UPDATE_TRUE);
    //3.创建ProcessEngine
    ProcessEngine processEngine=configuration.buildProcessEngine();
    System.out.println(processEngine.getName());
}
</code></pre>
<p>方式二：</p>
<pre><code class="nulljava">/*
 * 使用配置文件，加载创建ProcessEngine对象
 * 默认加载classpath下的activiti.cfg.xml文件
 */
@Test
public void envTest2(){
    //最简单获取ProcessEngine对象的方式
    ProcessEngine processEngine=ProcessEngines.getDefaultProcessEngine();
    System.out.println(processEngine.getName());
}
</code></pre>
<p>activiti.cfg.xml:</p>
<pre><code class="nullxml">&lt;bean id=&quot;processEngineConfiguration&quot; class=&quot;org.activiti.engine.impl.cfg.StandaloneProcessEngineConfiguration&quot;&gt;
    &lt;property name=&quot;jdbcDriver&quot; value=&quot;com.mysql.jdbc.Driver&quot;/&gt;
    &lt;property name=&quot;jdbcUrl&quot; value=&quot;jdbc:mysql://localhost:3306/activitiTest?createDatabaseIfNotExist=true&quot;/&gt;
    &lt;property name=&quot;jdbcUsername&quot; value=&quot;xxxx&quot;/&gt;
    &lt;property name=&quot;jdbcPassword&quot; value=&quot;xxxxxx&quot;/&gt;
    &lt;property name=&quot;databaseSchemaUpdate&quot; value=&quot;true&quot;/&gt;
&lt;/bean&gt;
</code></pre>
<h3 id="ProcessDefinition-流程定义"><a href="#ProcessDefinition-流程定义" class="headerlink" title="ProcessDefinition(流程定义)"></a>ProcessDefinition(流程定义)</h3><p>使用设计工具生成流程定义文件：</p>
<ul>
<li>bpmn流程规则文件（xml格式）</li>
<li>png流程图片（自动生成）</li>
<li>例如：HelloWorld.bpmn,HelloWorld.png</li>
</ul>
<p>通过<code>RepositoryService</code>对<code>ProcessDefinition</code>进行操作</p>
<pre><code class="nulljava">ProcessEngine processEngine=ProcessEngines.getDefaultProcessEngine();
RepositoryService repositoryService=this.processEngine.getRepositoryService();
</code></pre>
<h4 id="发布流程定义"><a href="#发布流程定义" class="headerlink" title="发布流程定义"></a>发布流程定义</h4><ul>
<li>方式一：逐个添加资源文件</li>
<li>方式二：添加zip包 （Activiti框架会自动解压解析，依次添加到<code>act_ge_bytearray</code>表中）</li>
</ul>
<pre><code class="nulljava">@Test
public void deployProcess()
{
    DeploymentBuilder builder=repositoryService.createDeployment();

    //方式一：
    /*InputStream bpmnInput=this.getClass().getClassLoader().getResourceAsStream(&quot;bpmn/HelloWorld.bpmn&quot;);
    InputStream pngInput=this.getClass().getClassLoader().getResourceAsStream(&quot;bpmn/HelloWorld.png&quot;);
    builder.name(&quot;Hello World!&quot;)
            .addInputStream(&quot;HelloWorld.bpmn&quot;, bpmnInput)
            .addInputStream(&quot;HelloWorld.png&quot;, pngInput)
            .deploy();*/
    //方式二：
    InputStream in=this.getClass().getClassLoader().getResourceAsStream(&quot;bpmn/HelloWorld.zip&quot;);
    ZipInputStream zipInputStream =new ZipInputStream(in);
    builder.name(&quot;Hello World!&quot;)
            .addZipInputStream(zipInputStream)
            .deploy();
}
</code></pre>
<p>发布成功后，会在3张表中添加数据：</p>
<ul>
<li><code>act_re_deployment</code>: 1条记录：<ul>
<li><code>name</code>：Process的显示别名</li>
<li><code>deploy_time</code>：发布时间</li>
</ul>
</li>
<li><code>act_ge_bytearray</code>: 一般为2条记录（通过<code>deployment_id</code>关联<code>act_re_deployment</code>表）：<ul>
<li>1条bpmn文件内容</li>
<li>1条png文件内容</li>
</ul>
</li>
<li><code>act_re_procdef</code>： 1条记录（Process定义的相关信息，通过<code>deployment_id</code>关联<code>act_re_deployment</code>表）<ul>
<li><code>id</code>：{key}:{version}:{random}</li>
<li><code>version</code>：发布时计算（同key的maxVersion+1,默认取1）</li>
<li><code>name</code>：bpmn文件中定义的process节点的name属性</li>
<li><code>key</code>：bpmn文件中定义的process节点的id属性</li>
<li><code>deployment_id</code>：关联act_re_deployment表</li>
</ul>
</li>
</ul>
<p><strong>PS：</strong>一定要有bpmn流程规则文件，png流程图片可选，也可加入其它文件，比如video，txt等</p>
<h4 id="查看流程定义信息"><a href="#查看流程定义信息" class="headerlink" title="查看流程定义信息"></a>查看流程定义信息</h4><ol>
<li><p>Process概括信息：ProcessDefinition</p>
<ul>
<li>流程定义对象：流程规则的整体信息</li>
<li>记录在<code>act_re_procdef</code>表中</li>
</ul>
</li>
<li><p>Process内部子节点(即活动)等详细信息：<code>ActivityImpl</code></p>
<ul>
<li>活动对象：流程规则的活动信息</li>
<li>记录在bmpn文件中（运行时加载解析bmpn文件到内存中）</li>
</ul>
</li>
<li><p>注意：</p>
<ul>
<li>通过<code>ProcessDefinitionQuery</code>对象获取的是最简单的<code>ProcessDefinition对象</code>（从<code>act_re_procdef</code>表中查询）</li>
<li>要获取Process内部的活动定义信息，需通过<code>RepositoryService</code>的<code>getProcessDefinition(id)</code>方法（从内存中获取存放的活动Activity定义信息）</li>
</ul>
</li>
</ol>
<pre><code class="nulljava">@Test
public void queryProcessDefinition()
{
    String key=&quot;helloWorld&quot;;
    List&lt;ProcessDefinition&gt; pds=repositoryService.createProcessDefinitionQuery().processDefinitionKey(key).list();
    for(ProcessDefinition pd:pds)
    {
        System.out.println(&quot;id:&quot;+pd.getId()+&quot;,name:&quot;+pd.getName()+&quot;,key:&quot;+pd.getKey()+&quot;,version:&quot;+pd.getVersion());
        //System.out.println(((ProcessDefinitionImpl)pd).getActivities());    //这样无法获得Activity信息 (这个ProcessDefinition是从DB中查询得到的)
        ProcessDefinitionImpl pdImpl=(ProcessDefinitionImpl)repositoryService.getProcessDefinition(pd.getId()); 
        //这个ProcessDefinition是对应的bpmn文件解析构建的，即内存中（实际是ProcessDefinitionEntity对象）
        System.out.println(pdImpl.getActivities());        //activity中包含Transitions等信息 （Actitity即节点）
    }
}
</code></pre>
<h4 id="查看流程附件"><a href="#查看流程附件" class="headerlink" title="查看流程附件"></a>查看流程附件</h4><p>查看流程附件（例如:流程图片）</p>
<ul>
<li>存放在表act_ge_bytearray的Bytes字段中（type为BLOB）</li>
<li>通过 deployment_id &amp; 文件名name 查找</li>
</ul>
<pre><code class="nulljava">@Test
public void queryProcessImage() throws IOException
{
    //eg1.获取附件，例如png图片，也可获取其他resource文件：
    String deploymentId=&quot;201&quot;;
    List&lt;String&gt; resources=repositoryService.getDeploymentResourceNames(deploymentId);    //通过发布ID，获取此发布的所有资源文件名
    String imgName=null;
    for(String res:resources)    //文件名过滤
    {
        System.out.println(res);
        if(res.endsWith(&quot;.png&quot;)){
            imgName=res;
            break;
        }
    }
    if(imgName!=null &amp;&amp; imgName.length()!=0){
        //查找指定资源，以流的形式读出
        InputStream in=repositoryService.getResourceAsStream(deploymentId, imgName);
        FileUtils.copyInputStreamToFile(in, new File(&quot;D:/hello.png&quot;));
    }

    //eg2.直接获取流程图：
    String processDefinitionId=&quot;helloWorld:2:304&quot;;
    InputStream in=repositoryService.getProcessDiagram(processDefinitionId);
    FileUtils.copyInputStreamToFile(in, new File(&quot;D:/hello2.png&quot;));
}
</code></pre>
<h4 id="删除流程定义"><a href="#删除流程定义" class="headerlink" title="删除流程定义"></a>删除流程定义</h4><p>删除发布的流程 （<code>act_re_deployment</code>）:</p>
<ul>
<li><p>方式一：普通删除  <code>repositoryService.deleteDeployment(deploymentId);</code></p>
<ul>
<li>等价于:<code>repositoryService.deleteDeployment(deploymentId, false);</code></li>
<li>只删除发布流程相关的信息</li>
<li>若当前<code>ProcessDefinition</code>有正在执行的<code>ProcessInstance</code>，则删除失败（保护），因为<code>act_ru_*</code>中有对ProcessDefinition id的引用</li>
<li>删除下表记录：<ul>
<li><code>act_re_deployment</code></li>
<li><code>act_ge_bytearray</code></li>
<li><code>act_re_procdef</code></li>
</ul>
</li>
<li>不会删除history（<code>act_hi_*</code>)</li>
</ul>
</li>
<li><p>方式二：级联删除  <code>repositoryService.deleteDeployment(deploymentId, true);</code></p>
<ul>
<li>会删除<code>ProcessDefinition</code>和<code>ProcessInstance</code>，包括<code>history</code> （暴力）</li>
<li>删除下表记录：<ul>
<li><code>act_re_deployment</code></li>
<li><code>act_ge_bytearray</code></li>
<li><code>act_re_procdef</code></li>
<li><code>act_ru_*</code></li>
<li><code>act_hi_*</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<pre><code class="nulljava">@Test
public void deleteDeployment()
{
    String key=&quot;myProcess&quot;;
    List&lt;Deployment&gt; deployments=repositoryService.createDeploymentQuery().processDefinitionKey(key).list();
    for(Deployment deployment:deployments)
    {
        //方式一：
        repositoryService.deleteDeployment(deployment.getId());    
        //方式二：
        //repositoryService.deleteDeployment(deployment.getId(), true);
    }
}
</code></pre>
<h3 id="ProcessInstance-流程实例"><a href="#ProcessInstance-流程实例" class="headerlink" title="ProcessInstance(流程实例)"></a>ProcessInstance(流程实例)</h3><p>ProcessInstance特点：</p>
<ol>
<li>一个Process只有一个ProcessInstance<ul>
<li>ID不变</li>
<li>可自定义ID规则，eg:{对象名称}-{对象ID}</li>
</ul>
</li>
<li>流程实例ProcessInstance是一个特殊的Execution对象（<code>ProcessInstance extends Execution</code>）<ul>
<li>代表一次执行，永远指向当前所在的活动节点（类似遍历链式结构的指针，指向当前节点）</li>
<li>对于单线流程，描述每个节点的Execution对象就是ProcessInstance；</li>
<li>对于分支流程，会在分支的最顶部创建一个Execution对象作为ProcessInstance来描述这个分支（ 每个分支下产生的Execution对象都会挂在此ProcessInstance下）</li>
</ul>
</li>
</ol>
<h4 id="启动流程"><a href="#启动流程" class="headerlink" title="启动流程"></a>启动流程</h4><p>启动流程（生成ProcessInstance）:<code>runtimeService.startProcessInstanceByXxx</code></p>
<ul>
<li>方式一：通过processDefinition的Id启动流程</li>
<li>方式二：通过ProcessDefinition的key启动流程（系统会使用此key下版本最高的ProcessDefinition）</li>
</ul>
<pre><code class="nulljava">@Test
public void startProcess(){

    //RuntimeService 负责流程的启动，流转等操作
    RuntimeService runtimeService=this.processEngine.getRuntimeService();

    //方式一：
    /*String id=&quot;helloWorld:1:204&quot;;
    ProcessInstance processInstance=runtimeService.startProcessInstanceById(id);*/

    //方式二：
    String key=&quot;helloWorld&quot;;
    ProcessInstance processInstance=runtimeService.startProcessInstanceByKey(key);

    System.out.println(&quot;id:&quot;+processInstance.getId()+&quot;,activityId:&quot;+processInstance.getActivityId());
}
</code></pre>
<p>启动成功后：</p>
<ul>
<li><code>act_ru_execution</code>表: 记录当前活动（只要流程到达某一个节点，即具体活动，都会在这张表中添加数据）</li>
<li><code>act_ru_task</code>表: 记录人工参与的任务信息 （主要记录：任务办理者assignee，任务分配时间create_Time）</li>
</ul>
<h4 id="查看流程状态"><a href="#查看流程状态" class="headerlink" title="查看流程状态"></a>查看流程状态</h4><p>查看流程状态，使用<code>ProcessInstanceQuery</code><br>（通过<code>runtimeService.createProcessInstanceQuery()</code>获取）</p>
<pre><code class="nulljava">@Test
public void queryProcessState()
{
    String pid=&quot;1001&quot;;
    ProcessInstance processInstance=this.runtimeService.createProcessInstanceQuery()
        .processInstanceId(pid)
        .singleResult();
    if(processInstance!=null)
        System.out.println(&quot;id:&quot;+processInstance.getId()+&quot;,activityId:&quot;+processInstance.getActivityId());
}
</code></pre>
<h3 id="Task-任务"><a href="#Task-任务" class="headerlink" title="Task(任务)"></a>Task(任务)</h3><h4 id="查看任务"><a href="#查看任务" class="headerlink" title="查看任务"></a>查看任务</h4><p>查看任务，使用<code>TaskQuery</code>(通过<code>taskService.createTaskQuery()</code>获取)，主要查询表<code>act_ru_task</code></p>
<pre><code class="nulljava">/**
 * 查看任务——公有任务candidate （candicateUser,candicateGroup -- act_ru_identitylink）
 * taskService.createTaskQuery().taskCandidateXxx
 * */
@Test
public void queryCandidateTask()
{
    String candidateGroup=&quot;ROLE_User&quot;;
    List&lt;Task&gt; tasks=this.taskService.createTaskQuery().taskCandidateGroup(candidateGroup).list();
    System.out.println(&quot;-----------[&quot;+candidateGroup+&quot;]可认领任务列表&quot;);

    for(Task task:tasks)
        System.out.println(&quot;id:&quot;+task.getId()+&quot;,name:&quot;+task.getName()+&quot;,assignee:&quot;+task.getAssignee()+&quot;,createTime:&quot;+task.getCreateTime());

    String candidateUser=&quot;Lucy&quot;;
    tasks=this.taskService.createTaskQuery().taskCandidateUser(candidateUser).list();
    System.out.println(&quot;-----------[&quot;+candidateUser+&quot;]可认领任务列表&quot;);

    for(Task task:tasks)
        System.out.println(&quot;id:&quot;+task.getId()+&quot;,name:&quot;+task.getName()+&quot;,assignee:&quot;+task.getAssignee()+&quot;,createTime:&quot;+task.getCreateTime());
}

/**
 * 查看任务——私有任务assignee
 * taskService.createTaskQuery().taskAssignee
 * */
@Test
public void queryAssigneeTask()
{
    String assignee=&quot;CEO Tom&quot;;
    List&lt;Task&gt; tasks=this.taskService.createTaskQuery()
                                    .taskAssignee(assignee)
                                    .orderByTaskCreateTime().desc()
                                    .list();
    System.out.println(&quot;-----------[&quot;+assignee+&quot;]私有任务列表&quot;);
    for(Task task:tasks)
        System.out.println(&quot;id:&quot;+task.getId()+&quot;,name:&quot;+task.getName()+&quot;,assignee:&quot;+task.getAssignee()+&quot;,createTime:&quot;+task.getCreateTime());
}
</code></pre>
<h4 id="办理任务"><a href="#办理任务" class="headerlink" title="办理任务"></a>办理任务</h4><p>公有任务需被认领（使用<code>taskService.claim</code>）后才可执行</p>
<pre><code class="nulljava">@Test
public void claimTask(){
    String taskId=&quot;1202&quot;;
    String userId=&quot;Lucy&quot;;
    this.taskService.claim(taskId, userId);
}
</code></pre>
<p>办理任务（使用<code>taskService.complete(taskId)</code>）</p>
<pre><code class="nulljava">@Test
public void doTask()
{
    String taskId=&quot;1302&quot;;
    this.taskService.complete(taskId);
}
</code></pre>
<p>完成task后会：</p>
<ul>
<li>会在<code>act_hi_*</code>表中添加记录：<code>act_hi_actinst</code>,<code>act_hi_taskinst</code>,<code>act_hi_proinst</code></li>
<li>删除<code>act_ru_*</code>表中的相关记录:：<code>act_ru_execution</code>,<code>act_ru_task</code></li>
</ul>
<h4 id="监听器"><a href="#监听器" class="headerlink" title="监听器"></a>监听器</h4><ul>
<li><code>TaskListener</code>：任务监听器，监听事件：<ol>
<li><code>assignment</code> – 给指定人分配task时触发<ul>
<li>在bpmn文件中指定;</li>
<li>认领任务后;</li>
<li>create时setAssignee后;</li>
<li>注意：直接<code>task.setAssignee(...)</code>并不会触发</li>
</ul>
</li>
<li><code>create</code> – 启动task时触发</li>
<li><code>complete</code> – 完成task时触发</li>
<li><code>delete</code> – 结束后删除task时触发</li>
</ol>
</li>
<li><code>ExecutionListener</code>：执行节点监听器，一般监听事件：<ol>
<li><code>start</code></li>
<li><code>end</code></li>
</ol>
</li>
<li>使用：<ul>
<li>使用expression设置</li>
<li>使用delegateExpression设置</li>
<li>使用class</li>
<li>。。。</li>
</ul>
</li>
</ul>
<p>使用举例1（TaskListener,delegateExpression）：<br>1) xxx.bpmn.xml:</p>
<pre><code class="nullxml">&lt;userTask id=&quot;usertask1&quot; name=&quot;User Task1&quot;&gt;
  &lt;extensionElements&gt;
    &lt;activiti:taskListener event=&quot;create&quot; delegateExpression=&quot;${springTaskListenerBean}&quot;&gt;&lt;/activiti:taskListener&gt;
  &lt;/extensionElements&gt;
&lt;/userTask&gt;
</code></pre>
<p>2) SpringTaskListenerBean.java:</p>
<pre><code class="nulljava">@Component
public class SpringTaskListenerBean implements TaskListener {
    @Override
    public void notify(DelegateTask delegateTask) {
        delegateTask.setVariable(&quot;status&quot;, delegateTask.getEventName());
        System.out.println(delegateTask.getEventName()+&quot; : &quot;+delegateTask.getName()
                +&quot; ( status: &quot;+delegateTask.getVariable(&quot;status&quot;)+&quot;)&quot;);
    }
}
</code></pre>
<p>使用举例2（TaskListener,expression）：<br>1) xxx.bpmn.xml</p>
<pre><code class="nullxml"> &lt;userTask id=&quot;reqApprove&quot; name=&quot;TPM Manager 审批&quot; activiti:assignee=&quot;${approver}&quot;&gt;
      &lt;extensionElements&gt;
        &lt;activiti:taskListener event=&quot;assignment&quot; expression=&quot;${processService.doProcApproverAssignment(task)}&quot;&gt;&lt;/activiti:taskListener&gt;
      &lt;/extensionElements&gt;
    &lt;/userTask&gt;
</code></pre>
<p>2) ProcessService.java</p>
<pre><code class="nulljava">@Service(&quot;processService&quot;)
public class ProcessService{

    public void doProcApproverAssignment(DelegateTask delegateTask){
        System.out.println(&quot;Do Proc Approver Assignement...&quot;);
        String reqId=(String)delegateTask.getVariable(&quot;reqId&quot;);
        System.out.println(delegateTask.getAssignee());
        ...
    }
}
</code></pre>
<p>使用举例3（executionListener,delegateExpression）：</p>
<pre><code class="nullxml"> &lt;startEvent id=&quot;basicSingleStart&quot; name=&quot;Start&quot; activiti:initiator=&quot;requesterUser&quot;&gt;
  &lt;extensionElements&gt;
    &lt;activiti:executionListener event=&quot;end&quot; delegateExpression=&quot;${procStartListener}&quot;&gt;&lt;/activiti:executionListener&gt;
  &lt;/extensionElements&gt;
&lt;/startEvent&gt;
</code></pre>
<pre><code class="nulljava">public class ProcStartListener implements TaskListener
{
    @Override
    public void notify(DelegateTask delegateTask)
    {
        System.out.println(&quot;Process Start:&quot;+delegateTask.getName());
        String reqId=(String)delegateTask.getVariable(ProcessVariable.reqId);
        if(reqId!=null)
        ...
    }
}
</code></pre>
<p>使用举例3（executionListener,expression）：<br>1) xxx.bpmn.xml</p>
<pre><code class="nullxml">&lt;startEvent id=&quot;basicSingleStart&quot; name=&quot;Start&quot;&gt;
  &lt;extensionElements&gt;
    &lt;activiti:executionListener event=&quot;end&quot; expression=&quot;${processService.setProcBusinessKey(execution)}&quot;&gt;&lt;/activiti:executionListener&gt;
  &lt;/extensionElements&gt;
&lt;/startEvent&gt;
</code></pre>
<p>2) ProcessService.java</p>
<pre><code class="nulljava">@Service(&quot;processService&quot;)
public class ProcessService{
    public void setProcBusinessKey(DelegateExecution execution){
        System.out.println(&quot;Set Proc BusinessKey...&quot;);
        String key=execution.getProcessBusinessKey();
        if(key==null){
            key=(String)execution.getVariable(ProcessVariable.reqId);
            System.out.println(&quot;Set Basic Process BusinessKey:&quot;+key);
            if(execution instanceof ExecutionEntity)
                ((ExecutionEntity)execution).setBusinessKey(key);
            else if(execution instanceof ExecutionImpl)
                ((ExecutionImpl)execution).updateProcessBusinessKey(key);
        }
    }
}
</code></pre>
<p><strong>PS</strong>：</p>
<ul>
<li>execution：<code>DelegateExecution</code>提供外出执行的额外信息。</li>
<li>task：<code>DelegateTask</code>提供当前任务的额外信息。注意，只对任务监听器的表达式有效。</li>
</ul>
<h4 id="系统任务"><a href="#系统任务" class="headerlink" title="系统任务"></a>系统任务</h4><p>ServcieTask 系统任务，自动执行</p>
<p>1) xxx.bpmn.xml:</p>
<pre><code class="nullxml">&lt;serviceTask id=&quot;servicetask&quot; name=&quot;service Task&quot; activiti:delegateExpression=&quot;myJavaDelegate&quot;&gt;&lt;/serviceTask&gt;
</code></pre>
<p>2) MyJavaDelegate.java</p>
<pre><code class="nulljava">public class MyJavaDelegate implements JavaDelegate
{
    @Override
    public void execute(DelegateExecution execution) throws Exception
    {
        System.out.println(&quot;Execution Service Task...&quot;);
        execution.setVariable(&quot;serviceVar&quot;, &quot;Hello&quot;);
    }
}
</code></pre>
<h3 id="Gateway-网关"><a href="#Gateway-网关" class="headerlink" title="Gateway 网关"></a>Gateway 网关</h3><h4 id="排他网关"><a href="#排他网关" class="headerlink" title="排他网关"></a>排他网关</h4><p>排他网关（ExclusiveGateway）:</p>
<ul>
<li>在flow上(线上)设置条件condition，跟jbpm不同</li>
<li>根据condition结果，执行其中一条分支</li>
</ul>
<p><img src="2013-10-01-Activiti5/ExclusiveGateway.png" alt="ExclusiveGateway"></p>
<pre><code class="nullxml">&lt;sequenceFlow id=&quot;flow2&quot; name=&quot;input == 1&quot; sourceRef=&quot;exclusivegateway&quot; targetRef=&quot;usertask1&quot;&gt;
        &lt;conditionExpression xsi:type=&quot;tFormalExpression&quot;&gt;&lt;![CDATA[${input == 1}]]&gt;&lt;/conditionExpression&gt;
&lt;/sequenceFlow&gt;
</code></pre>
<pre><code class="nulljava">public void testExclusiveGateway(){
    Map&lt;String,Object&gt; variables=new HashMap&lt;String,Object&gt;();
    variables.put(&quot;input&quot;, 2);
    runtimeService.startProcessInstanceByKey(&quot;exclusiveGatewayTest&quot;,variables);

    Task task=taskService.createTaskQuery().singleResult();
    assertTrue(&quot;User Task2&quot;.equals(task.getName()));
}
</code></pre>
<h4 id="并行网关"><a href="#并行网关" class="headerlink" title="并行网关"></a>并行网关</h4><p>并行网关(ParallelGateway):</p>
<ul>
<li>无需设置condition</li>
<li>等分支都执行完毕再继续向下执行</li>
</ul>
<p>例如：<br><img src="2013-10-01-Activiti5/ParallelGateway.png" alt="ParallelGateway"><br>需<code>UserTask1</code>和<code>UserTask2</code>都完成后<code>UserTask3</code>才可被执行</p>
<h4 id="包含网关"><a href="#包含网关" class="headerlink" title="包含网关"></a>包含网关</h4><p>包含网关（InclusiveGateway）</p>
<ul>
<li>排他网关ExclusiveGateway和并行网关PallelGateway的结合</li>
<li>符合Condition的分支会并行执行</li>
</ul>
<p>例如：<br><img src="2013-10-01-Activiti5/InclusiveGateway.png" alt="InclusiveGateway"><br>若<code>input=2</code>,则UserTask1不会被执行，且只有<code>UserTask2</code>和<code>UserTask3</code>都被执行完成后，流程才会再往下</p>
<h3 id="与Spring整合"><a href="#与Spring整合" class="headerlink" title="与Spring整合"></a>与Spring整合</h3><pre><code class="nullxml">&lt;aop:aspectj-autoproxy proxy-target-class=&quot;true&quot;/&gt;
&lt;context:annotation-config/&gt;
&lt;context:component-scan base-package=&quot;xxxx&quot; &gt;&lt;/context:component-scan&gt;
&lt;context:property-placeholder location=&quot;classpath:jdbc-mine.properties&quot;/&gt;

&lt;!-- DataSource --&gt;
&lt;bean id=&quot;dataSource&quot; destroy-method=&quot;close&quot; class=&quot;org.apache.commons.dbcp.BasicDataSource&quot;&gt;
    &lt;property name=&quot;driverClassName&quot; value=&quot;${jdbc.driverClassName}&quot;/&gt;
    &lt;property name=&quot;url&quot; value=&quot;${jdbc.url}&quot;/&gt;
    &lt;property name=&quot;username&quot; value=&quot;${jdbc.username}&quot;/&gt;
    &lt;property name=&quot;password&quot; value=&quot;${jdbc.password}&quot;/&gt;

    &lt;property name=&quot;initialSize&quot; value=&quot;1&quot;/&gt;
    &lt;property name=&quot;minIdle&quot; value=&quot;2&quot;/&gt;
    &lt;property name=&quot;maxActive&quot; value=&quot;200&quot;/&gt;   
    &lt;property name=&quot;maxIdle&quot; value=&quot;30&quot;/&gt;       
    &lt;property name=&quot;maxWait&quot; value=&quot;10000&quot;/&gt;  
    &lt;property name=&quot;removeAbandoned&quot; value=&quot;true&quot;/&gt;  
    &lt;!-- &lt;property name=&quot;logAbandoned&quot; value=&quot;true&quot;/&gt;   --&gt;
    &lt;property name=&quot;validationQuery&quot; value=&quot;select 1 from dual&quot;/&gt; 
    &lt;property name=&quot;testOnBorrow&quot; value=&quot;true&quot;/&gt;
&lt;/bean&gt;

&lt;!-- 声明式事务 --&gt;
&lt;bean id=&quot;txManager&quot; class=&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;&gt;
    &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot; /&gt;
&lt;/bean&gt;
&lt;tx:advice id=&quot;txAdvice&quot; transaction-manager=&quot;txManager&quot; &gt;
    &lt;tx:attributes&gt;
        &lt;tx:method name=&quot;list*&quot; propagation=&quot;REQUIRED&quot; read-only=&quot;true&quot;/&gt;
        &lt;tx:method name=&quot;get*&quot; propagation=&quot;REQUIRED&quot; read-only=&quot;true&quot;/&gt;
        &lt;tx:method name=&quot;detail*&quot; propagation=&quot;REQUIRED&quot; read-only=&quot;true&quot; /&gt;
        &lt;tx:method name=&quot;test*&quot; propagation=&quot;REQUIRED&quot; read-only=&quot;true&quot;  /&gt;
        &lt;tx:method name=&quot;*&quot;/&gt;
    &lt;/tx:attributes&gt;
&lt;/tx:advice&gt;
 &lt;aop:config&gt;
    &lt;aop:pointcut expression=&quot;execution(* com.cj..service.*.*(..))&quot; id=&quot;myShuttleService&quot;/&gt;
    &lt;aop:advisor advice-ref=&quot;txAdvice&quot; pointcut-ref=&quot;myShuttleService&quot; order=&quot;2&quot;/&gt;
&lt;/aop:config&gt; 

&lt;!-- Activiti: processEngineConfiguration --&gt;
&lt;bean id=&quot;processEngineConfiguration&quot; class=&quot;org.activiti.spring.SpringProcessEngineConfiguration&quot;&gt;
    &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot; /&gt;
    &lt;property name=&quot;transactionManager&quot; ref=&quot;txManager&quot; /&gt;
    &lt;property name=&quot;databaseSchemaUpdate&quot; value=&quot;true&quot; /&gt;
    &lt;property name=&quot;jobExecutorActivate&quot; value=&quot;true&quot; /&gt;

    &lt;property name=&quot;history&quot; value=&quot;full&quot; /&gt;
    &lt;property name=&quot;activityFontName&quot; value=&quot;宋体&quot; /&gt;
    &lt;property name=&quot;labelFontName&quot; value=&quot;宋体&quot; /&gt;
&lt;/bean&gt;

&lt;!-- Activiti: processEngine --&gt;
&lt;bean id=&quot;processEngine&quot; class=&quot;org.activiti.spring.ProcessEngineFactoryBean&quot; destroy-method=&quot;destroy&quot;&gt;
    &lt;property name=&quot;processEngineConfiguration&quot; ref=&quot;processEngineConfiguration&quot; /&gt;
&lt;/bean&gt;

&lt;!-- Activiti: Service --&gt;
&lt;bean id=&quot;repositoryService&quot; factory-bean=&quot;processEngine&quot; factory-method=&quot;getRepositoryService&quot; /&gt;
&lt;bean id=&quot;runtimeService&quot; factory-bean=&quot;processEngine&quot; factory-method=&quot;getRuntimeService&quot; /&gt;
&lt;bean id=&quot;taskService&quot; factory-bean=&quot;processEngine&quot; factory-method=&quot;getTaskService&quot; /&gt;
&lt;bean id=&quot;historyService&quot; factory-bean=&quot;processEngine&quot; factory-method=&quot;getHistoryService&quot; /&gt;
&lt;bean id=&quot;managementService&quot; factory-bean=&quot;processEngine&quot; factory-method=&quot;getManagementService&quot; /&gt;
&lt;bean id=&quot;identityService&quot; factory-bean=&quot;processEngine&quot; factory-method=&quot;getIdentityService&quot; /&gt;

&lt;!-- 根据需要注入：--&gt;
&lt;!-- Activiti: javaDelegate --&gt;
&lt;bean id=&quot;myJavaDelegate&quot; class=&quot;com.cj.test.javaDelegate.MyJavaDelegate&quot;&gt;&lt;/bean&gt;
&lt;!-- Activiti: taskListener --&gt;
&lt;bean id=&quot;myTaskListener&quot; class=&quot;com.cj.test.taskListener.MyTaskListener&quot;&gt;&lt;/bean&gt;
</code></pre>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p><code>PluggableActivitiTestCase</code>，<code>ResourceActivitiTestCase</code>，<code>SpringActivitiTestCase</code></p>
<ul>
<li><code>extends AbstractActivitiTestCase</code></li>
<li>定义了processEngine和所有的API的Servcie</li>
<li>使用test开头的方法作为单元测试方法：    <code>testXxx(...)</code></li>
<li>可使用<code>@Deployment</code>注解deploy测试流程</li>
</ul>
<p>使用：</p>
<ul>
<li>方式一：<code>extends PluggableActivitiTestCase</code><ul>
<li>使用默认配置文件：<code>activiti.cfg.xml</code></li>
</ul>
</li>
<li>方式二：<code>extends ResourceActivitiTestCase</code><ul>
<li>可指定配置文件,在构造函数中配置调用：<code>super(&quot;xxx&quot;)</code>;<pre><code class="nulljava">public class GatewayTest extends ResourceActivitiTestCase{
  public GatewayTest(){
      super(&quot;activiti-test.cfg.xml&quot;);
  }
  @Deployment(resources = &quot;bpmn/gateway/ExclusiveGateway.bpmn&quot;)
  public void testExclusiveGateway(){
      Map&lt;String,Object&gt; variables=new HashMap&lt;String,Object&gt;();
      variables.put(&quot;input&quot;, 2);
      runtimeService.startProcessInstanceByKey(&quot;exclusiveGatewayTest&quot;,variables);
      Task task=taskService.createTaskQuery().singleResult();
      assertTrue(&quot;User Task2&quot;.equals(task.getName()));
  }
}
</code></pre>
</li>
</ul>
</li>
<li><p>方式三：<code>extends SpringActivitiTestCase</code></p>
<ul>
<li>整合Spring测试（ProcessEngine,Service由Spring管理）</li>
<li><p><code>beans-test.xml</code>:</p>
<pre><code class="nullxml">&lt;bean id=&quot;dataSource&quot; class=&quot;org.springframework.jdbc.datasource.SimpleDriverDataSource&quot;&gt;
  &lt;property name=&quot;driverClass&quot; value=&quot;${jdbc.driverClassName}&quot;/&gt;
  &lt;property name=&quot;url&quot; value=&quot;${jdbc.url}&quot;/&gt;
  &lt;property name=&quot;username&quot; value=&quot;${jdbc.username}&quot;/&gt;
  &lt;property name=&quot;password&quot; value=&quot;${jdbc.password}&quot;/&gt;
&lt;/bean&gt;

&lt;bean id=&quot;txManager&quot; class=&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;&gt;
  &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot; /&gt;
&lt;/bean&gt;
&lt;tx:advice id=&quot;txAdvice&quot; transaction-manager=&quot;txManager&quot; &gt;
  &lt;tx:attributes&gt;
      &lt;tx:method name=&quot;list*&quot; propagation=&quot;REQUIRED&quot; read-only=&quot;true&quot;/&gt;
      &lt;tx:method name=&quot;get*&quot; propagation=&quot;REQUIRED&quot; read-only=&quot;true&quot;/&gt;
      &lt;tx:method name=&quot;detail*&quot; propagation=&quot;REQUIRED&quot; read-only=&quot;true&quot; /&gt;
      &lt;tx:method name=&quot;test*&quot; propagation=&quot;REQUIRED&quot; read-only=&quot;true&quot;  /&gt;
      &lt;tx:method name=&quot;*&quot;/&gt;
  &lt;/tx:attributes&gt;
&lt;/tx:advice&gt;

&lt;bean id=&quot;processEngineConfiguration&quot; class=&quot;org.activiti.spring.SpringProcessEngineConfiguration&quot;&gt;
  &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot; /&gt;
  &lt;property name=&quot;transactionManager&quot; ref=&quot;txManager&quot; /&gt;
  &lt;property name=&quot;databaseSchemaUpdate&quot; value=&quot;true&quot; /&gt;
  &lt;property name=&quot;jobExecutorActivate&quot; value=&quot;true&quot; /&gt;
  &lt;!-- &lt;property name=&quot;history&quot; value=&quot;full&quot; /&gt; --&gt;
  &lt;property name=&quot;activityFontName&quot; value=&quot;微软雅黑&quot; /&gt;
  &lt;property name=&quot;labelFontName&quot; value=&quot;微软雅黑&quot; /&gt;
&lt;/bean&gt;
&lt;bean id=&quot;processEngine&quot; class=&quot;org.activiti.spring.ProcessEngineFactoryBean&quot; destroy-method=&quot;destroy&quot;&gt;
  &lt;property name=&quot;processEngineConfiguration&quot; ref=&quot;processEngineConfiguration&quot; /&gt;
&lt;/bean&gt;

&lt;bean id=&quot;repositoryService&quot; factory-bean=&quot;processEngine&quot; factory-method=&quot;getRepositoryService&quot; /&gt;
&lt;bean id=&quot;runtimeService&quot; factory-bean=&quot;processEngine&quot; factory-method=&quot;getRuntimeService&quot; /&gt;
&lt;bean id=&quot;taskService&quot; factory-bean=&quot;processEngine&quot; factory-method=&quot;getTaskService&quot; /&gt;
&lt;bean id=&quot;historyService&quot; factory-bean=&quot;processEngine&quot; factory-method=&quot;getHistoryService&quot; /&gt;
&lt;bean id=&quot;managementService&quot; factory-bean=&quot;processEngine&quot; factory-method=&quot;getManagementService&quot; /&gt;
&lt;bean id=&quot;identityService&quot; factory-bean=&quot;processEngine&quot; factory-method=&quot;getIdentityService&quot; /&gt;
</code></pre>
</li>
<li><p>Test Class: </p>
<pre><code class="nulljava">@ContextConfiguration(&quot;classpath:beans-test.xml&quot;)
public class TaskSpringTest extends SpringActivitiTestCase
{
  @Deployment(resources=&quot;bpmn/task/ServiceTask-spring.bpmn&quot;)
  public void testServiceTask(){
      ProcessInstance procInst=runtimeService.startProcessInstanceByKey(&quot;serviceTaskSpringTest&quot;);

      //User Task1
      Task task=taskService.createTaskQuery().singleResult();
      assertTrue(&quot;User Task1&quot;.equals(task.getName()));
      taskService.complete(task.getId());

      //Service Task -- auto execute!

      //User Task2
      task=taskService.createTaskQuery().singleResult();
      assertTrue(&quot;User Task2&quot;.equals(task.getName()));

      String var=(String)taskService.getVariable(task.getId(), &quot;serviceVar&quot;);
      assertTrue(&quot;Hello&quot;.equals(var));

      taskService.complete(task.getId());
      assertProcessEnded(procInst.getId());
  }
}
</code></pre>
</li>
</ul>
</li>
</ul>
<h2 id="功能组件介绍"><a href="#功能组件介绍" class="headerlink" title="功能组件介绍"></a>功能组件介绍</h2><h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><p>引擎API：</p>
<ul>
<li><p>RepositoryService：流程资源服务的接口，主要用于对流程定义的部署、查询和删除操作</p>
<ul>
<li><code>repositoryService.createProcessDefinitionQuery()</code></li>
<li><code>repositoryService.getBpmnModel(procDefId)</code></li>
<li><code>repositoryService.createDeployment()</code></li>
<li><code>repositoryService.getDeploymentResourceNames(deploymentId)</code></li>
<li><code>repositoryService.getResourceAsStream(...)</code></li>
<li><code>repositoryService.getProcessDiagram(processDefinitionId)</code></li>
<li>…</li>
</ul>
</li>
<li><p>RuntimeService：运行时服务接口，主要对流程实例，变量，活动等的操作</p>
<ul>
<li><code>runtimeService.startProcessInstanceByXxx(...)</code></li>
<li><code>runtimeService.createExecutionQuery()</code></li>
<li><code>runtimeService.getActiveActivityIds(procInstId);</code></li>
<li>…</li>
</ul>
</li>
<li><p>TaskService：任务服务接口</p>
<ul>
<li><code>taskService.createTaskQuery()</code></li>
<li><code>taskService.claim(taskId, userId);</code></li>
<li><code>taskService.complete(taskId);</code></li>
<li><code>taskService.createAttachment(...)</code></li>
<li><code>taskService.addComment(...)</code></li>
<li>…</li>
</ul>
</li>
<li><p>HistoryService：流程历史的服务接口</p>
<ul>
<li><code>historyService.createHistoricVariableInstanceQuery()</code></li>
<li><code>historyService.createHistoricProcessInstanceQuery()</code></li>
<li><code>historyService.createHistoricTaskInstanceQuery()</code></li>
<li>…</li>
</ul>
</li>
<li><p>IdentityService：用户、组管理服务接口，用于管理Group、User、Membership</p>
<ul>
<li><code>identityService.setAuthenticatedUserId(userId);</code></li>
<li><code>identityService.createUserQuery()</code></li>
<li><code>identityService.createGroupQuery()</code></li>
<li>newUser,saveUser,deleteUser,…</li>
<li>newGroup,saveGroup,deleteGroup,…</li>
<li>newMembership,saveMembership,deleteMemberShip,…</li>
<li>…</li>
</ul>
</li>
<li><p>FormService：表单服务接口，用于访问表单数据，渲染表单等操作</p>
<ul>
<li><code>formService.getXxxFormData(...)</code></li>
<li><code>formService.getRenderedXxxFormData(...)</code></li>
<li><code>formService.submitXxxFormData(...)</code></li>
<li>…</li>
</ul>
</li>
<li><p>ManagementService：提供流程管理和控制操作的接口服务</p>
<pre><code class="nulljava">  String jobId=managementService.createJobQuery()
      .processInstanceId(&quot;2401&quot;)
      .singleResult()
      .getId();
  managementService.executeJob(jobId);
</code></pre>
</li>
</ul>
<h3 id="Tables"><a href="#Tables" class="headerlink" title="Tables"></a>Tables</h3><p>Activiti 数据库中表的命名都是以 <code>ACT_</code>开头</p>
<ul>
<li><code>ACT_RE_*</code>： Repository。存储静态信息，如：流程定义、流程的资源（图片、规则）。</li>
<li><code>ACT_RU_*</code>： Runtime。运行时的表<ul>
<li>Activiti 只存储流程实例执行期间的运行时数据</li>
<li>如：流程变量、用户任务、变量、作业等</li>
<li>当流程实例结束时，将删除这些记录</li>
</ul>
</li>
<li><code>ACT_ID_*</code>：Identity。记录标识信息，如：用户、用户组等</li>
<li><code>ACT_HI_*</code>：History。记录历史的相关数据，如：结束的流程实例、变量、任务等</li>
<li><code>ACT_GE_*</code>：General。记录通用数据</li>
</ul>
<h3 id="Var"><a href="#Var" class="headerlink" title="Var"></a>Var</h3><ol>
<li>运行时变量，存放在<code>act_ru_variable</code>表中<ul>
<li>全局变量</li>
<li>本地变量</li>
</ul>
</li>
<li>历史变量，涉及表<code>act_hi_detail</code>,<code>act_hi_varinst</code><ul>
<li>有4个历史级别：<ul>
<li>none: 不保存任何历史记录，可以提高系统性能；</li>
<li>activity：保存所有的流程实例、任务、活动信息；</li>
<li>audit：也是Activiti的默认级别，保存所有的流程实例、任务、活动、表单属性；</li>
<li>full： 最完整的历史记录，除了包含audit级别的信息之外还能保存详细，例如：流程变量</li>
</ul>
</li>
<li>可配置：<pre><code class="nullxml">&lt;bean id=&quot;processEngineConfiguration&quot; class=&quot;org.activiti.spring.SpringProcessEngineConfiguration&quot;&gt;
  &lt;property name=&quot;history&quot; value=&quot;full&quot;&gt;
&lt;/property&gt;&lt;/bean&gt;
</code></pre>
</li>
<li>查询变量：<pre><code class="nulljava">List&lt;historicvariableinstance&gt; list = historyService.createHistoricVariableInstanceQuery()
          .processInstanceId(processInstanceId)
          .list();
for (HistoricVariableInstance variable : list) {
System.out.println(&quot;variable: &quot; + variable.getVariableName() + &quot; = &quot; + variable.getValue());
}
</code></pre>
</li>
<li>只查询表单字段：<pre><code class="nulljava">List&lt;historicdetail&gt; formProperties = historyService.createHistoricDetailQuery()
          .processInstanceId(processInstance.getId())
          .formProperties()
          .list();
for (HistoricDetail historicDetail : formProperties) {
  HistoricFormProperty field = (HistoricFormProperty) historicDetail;
  System.out.println(&quot;field id: &quot; + field.getPropertyId() + &quot;, value: &quot; + field.getPropertyValue());
}
</code></pre>
</li>
</ul>
</li>
</ol>
<h3 id="User"><a href="#User" class="headerlink" title="User"></a>User</h3><p>统一身份管理：</p>
<ul>
<li>Activiti用户管理系统<ul>
<li>使用<code>identityService</code> 管理User，Group，Membership</li>
<li>关联的表：<code>act_id_user</code>,<code>act_id_info</code>,<code>act_id_group</code>,<code>act_id_membership</code></li>
<li>在流程定义中可直接使用定义的User，Group，例如<ul>
<li><code>activiti:candidateGroups=&quot;admin,manager&quot;</code></li>
<li><code>activiti:candidateUsers=&quot;Tom,Jerry&quot;</code></li>
</ul>
</li>
</ul>
</li>
<li>业务系统的用户管理系统，比如<ul>
<li>使用LDAP</li>
<li>使用部门，角色，权限等更为复杂的组织系统</li>
</ul>
</li>
<li>结合方式：<ul>
<li>业务系统操作时同步管理Activiti用户数据（调用identityService）</li>
<li>自定义SessionFactory，非侵入式替换接口实现</li>
<li>用视图覆盖同名的<code>ACT_ID_*</code>系列表（需在引擎配置中设置属性<code>dbIdentityUsed</code>为false）</li>
</ul>
</li>
</ul>
<h3 id="Form"><a href="#Form" class="headerlink" title="Form"></a>Form</h3><h4 id="Activiti管理表单"><a href="#Activiti管理表单" class="headerlink" title="Activiti管理表单"></a>Activiti管理表单</h4><ul>
<li>配置在流程定义中（可加在StartEvent，Task节点上）</li>
<li>表单支持变量自动替换（UEL语法）</li>
<li>表单内容以key-value形式保存在表<code>act_hi_detail</code>中</li>
<li><p>使用方式一：在流程定义文件中用<code>activiti:formProperty</code>属性定义</p>
<ul>
<li>表单没有布局，所有的表单元素会顺序逐行输出在页面<pre><code class="nullxml">  &lt;startevent id=&quot;startevent1&quot; name=&quot;Start&quot;&gt;
    &lt;extensionelements&gt;
      &lt;activiti:formproperty id=&quot;name&quot; name=&quot;Name&quot; type=&quot;string&quot;&gt;&lt;/activiti:formproperty&gt;
    &lt;/extensionelements&gt;
  &lt;/startevent&gt;
  &lt;usertask id=&quot;usertask1&quot; name=&quot;First Step&quot;&gt;
    &lt;extensionelements&gt;
      &lt;activiti:formproperty id=&quot;setInFirstStep&quot; name=&quot;SetInFirstStep&quot; type=&quot;date&quot;&gt;&lt;/activiti:formproperty&gt;
          &lt;activiti:formproperty id=&quot;remark&quot; name=&quot;Remark&quot; type=&quot;string&quot;&gt;&lt;/activiti:formproperty&gt;
    &lt;/extensionelements&gt;
  &lt;/usertask&gt;
</code></pre>
</li>
<li>通过<code>formService.getXxxForm</code>获取表单：<ul>
<li><code>formService.getStartFormData(processDefinitionId)</code>，返回<code>StartFormData</code></li>
<li><code>formService.getTaskFormData(taskId)</code>，返回<code>TaskFormData</code></li>
</ul>
</li>
<li>提交表单：<code>formService.submitXxxFormData(...)</code></li>
</ul>
</li>
<li><p>使用方式二：在流程定义文件中用<code>activiti:formkey</code>属性引用</p>
<ul>
<li>流程运行时从部署的表单文件中读取，原样输出显示</li>
<li>注意：表单内容写好保存到<code>.form</code>文件，需同流程定义文件一同部署<pre><code class="nullxml">&lt;process id=&quot;FormKey&quot; name=&quot;FormKey&quot;&gt;
  &lt;startevent id=&quot;startevent1&quot; name=&quot;Start&quot; activiti:formkey=&quot;form/start.form&quot;&gt;&lt;/startevent&gt;
  …
&lt;/process&gt;
</code></pre>
</li>
<li>通过<code>formService.getRenderedXxxForm</code>获取表单：<ul>
<li><code>formService.getRenderedStartForm(processDefinitionId)</code></li>
<li><code>formService.getRenderedTaskForm(taskId)</code></li>
<li>注意： return Object （返回内容是经FormEngine处理过的）</li>
<li>默认使用的表单引擎为JuelFormEngine，可自定义进行扩展</li>
</ul>
</li>
<li>提交表单：<code>formService.submitXxxFormData(...)</code></li>
</ul>
</li>
</ul>
<h4 id="非Activiti管理表单"><a href="#非Activiti管理表单" class="headerlink" title="非Activiti管理表单"></a>非Activiti管理表单</h4><ul>
<li>表单呈现自定义</li>
<li>表单内容置于自定义的Table中，通过<code>businessKey</code>传入与流程关联</li>
</ul>
<h2 id="常见应用"><a href="#常见应用" class="headerlink" title="常见应用"></a>常见应用</h2><h3 id="Attachment-amp-Comment"><a href="#Attachment-amp-Comment" class="headerlink" title="Attachment &amp; Comment"></a>Attachment &amp; Comment</h3><p>都是存放在历史记录中的，即<code>act_hi_attachment</code>,<code>act_hi_comment</code></p>
<p>Attachment：</p>
<ol>
<li>涉及到的table：<code>act_hi_attachment</code>,<code>act_ge_bytearray</code>, <code>act_hi_comment</code></li>
<li>添加attachment，两种方式：<ul>
<li>方式一：使用 inputStream<ul>
<li>inputStream 的实际内容存放在 <code>act_ge_bytearray</code>中,通过contentId关联</li>
<li><code>taskService.createAttachment(attachmentType, taskId, processInstanceId, attachmentName, attachmentDescription, content)</code></li>
</ul>
</li>
<li>方式二：使用 url<ul>
<li><code>taskService.createAttachment(attachmentType, taskId, processInstanceId, attachmentName, attachmentDescription, url)</code></li>
</ul>
</li>
</ul>
</li>
<li>会在act_hi_comment表中插入数据 （type:event,action:AddAttachment,message:attachmentName,full_msg:null）</li>
<li>获取Attachment(search <code>act_hi_attachment</code>):<ul>
<li>方式一：<code>List&lt;Attachment&gt; taskService.getTaskAttachments(taskId);</code></li>
<li>方式二：<code>List&lt;Attachment&gt; taskService.getProcessInstanceAttachments(procInstId);</code></li>
</ul>
</li>
</ol>
<p>Comment：</p>
<ol>
<li>涉及到的table：act_hi_comment</li>
<li>添加comment:<ul>
<li><code>taskService.addComment(taskId, processInstanceId, message)</code></li>
<li><code>taskService.addComment(taskId, processInstanceId, type, message)</code></li>
</ul>
</li>
<li>会在act_hi_comment表中插入数据 （type:comment,action:AddComment,full_msg:msg）</li>
<li>获取Comment(search act_hi_comment)：<ul>
<li>方式一：<code>List&lt;Comment&gt; taskService.getTaskComments(taskId);</code></li>
<li>方式二：<code>List&lt;Comment&gt; taskService.getProcessInstanceComments(procInstId);</code> （会查出因为createAttachment而添加的comment记录）</li>
</ul>
</li>
</ol>
<h3 id="多实例"><a href="#多实例" class="headerlink" title="多实例"></a>多实例</h3><pre><code class="nullxml">&lt;userTask id=&quot;miTasks&quot; name=&quot;My Task&quot; activiti:assignee=&quot;${user}&quot;&gt;
    &lt;multiInstanceLoopCharacteristics isSequential=&quot;false&quot;
    activiti:collection=&quot;${myService.resolveUsersForTask()}&quot; activiti:elementVariable=&quot;user&quot; &gt;
    &lt;completionCondition&gt;${nrOfCompletedInstances/nrOfInstances &gt;= 0.6 }&lt;/completionCondition&gt;
    &lt;/multiInstanceLoopCharacteristics&gt;
&lt;/userTask&gt;
</code></pre>
<ul>
<li><code>isSequential=&quot;true&quot;</code> 顺序执行（多级串行）</li>
<li><code>isSequential=&quot;false&quot;</code> 并行执行（并行会签）</li>
<li>每个上级流程为每个实例创建分支时都要提供如下变量：<ul>
<li><code>nrOfInstances</code>：实例总数</li>
<li><code>nrOfActiveInstances</code>：当前活动的实例数量 （对于顺序执行的多实例，值一直为1）</li>
<li><code>nrOfCompletedInstances</code>：已经完成实例的数目</li>
<li>可以通过<code>execution.getVariable(x)</code>方法获得这些变量</li>
</ul>
</li>
<li>每个创建的分支都会有分支级别的本地变量（临时）<ul>
<li>其他实例不可见， 不会保存到流程实例级别</li>
<li>比如：<code>loopCounter</code>（表示特定实例的在循环的索引值）</li>
</ul>
</li>
</ul>
<h3 id="CallActivity-amp-SubProcess"><a href="#CallActivity-amp-SubProcess" class="headerlink" title="CallActivity &amp; SubProcess"></a>CallActivity &amp; SubProcess</h3><p><code>CallActivity</code> 调用外部定义的流程</p>
<ul>
<li>New ProcessInstance</li>
<li>Business Key is null</li>
<li>for transfer: set inputParamater &amp; outParamater</li>
<li>search by some unique var</li>
</ul>
<p><code>SubProcess</code> 子流程 （内嵌在当前流程定义中）</p>
<ul>
<li>has Main Process information</li>
</ul>
<p><img src="2013-10-01-Activiti5/reqStation.png" alt="CallActiviti &amp; SubProcess"><br>（包含SubProcess和CallActivity）<br><img src="2013-10-01-Activiti5/basicSingle.png" alt="BasicSingle"><br>（被Call的外部流程定义）</p>
<h3 id="Transaction-事务"><a href="#Transaction-事务" class="headerlink" title="Transaction 事务"></a>Transaction 事务</h3><ul>
<li><p>Case1: serviceTask[处理成功申请] 同步，即设置<code>activiti:async=&quot;false&quot;</code> （默认）</p>
<pre><code class="nullxml">&lt;serviceTask id=&quot;service1&quot; name=&quot;处理成功申请&quot; activiti:class=&quot;my.custom.Delegate&quot; activiti:async=&quot;false&quot;
</code></pre>
<p><img src="2013-10-01-Activiti5/asyncFalse.png" alt="Async False"></p>
</li>
<li><p>Case2: serviceTask[处理成功申请] 异步，即设置<code>activiti:async=&quot;true&quot;</code>，打开<code>jobExecutorActivate</code>（processEngineConfiguration中）</p>
<pre><code class="nullxml">&lt;serviceTask id=&quot;service1&quot; name=&quot;处理成功申请&quot; activiti:class=&quot;my.custom.Delegate&quot; activiti:async=&quot;true&quot;
</code></pre>
<p><img src="2013-10-01-Activiti5/asyncTrue.png" alt="Async True"><br>（后续执行失败后回滚到此异步task）</p>
</li>
</ul>
<p><strong>异步执行说明：</strong></p>
<ul>
<li>异步只是指：执行方式异步</li>
<li>即启动新的线程（相对于主线程），但在流程控制上，若流程未完结，不会提前执行下一个节点</li>
<li>异步执行是一个新的执行单元（Transaction原子）</li>
<li>所以设置异步执行，流程不会提前结束，会继续执行下一个节点直到流程结束</li>
</ul>
<p><strong>异步节点：TimerCatchEvent</strong></p>
<ol>
<li>Timer无异步设置,本身就是异步执行的，执行失败（Timer或后面同步节点异常）会停留在TimerCatchEvent节点</li>
<li>在流程中设置Timer，会等到Timer执行完成后流程才能结束</li>
<li>Timer Event: start (流程执行到此Timer节点时触发)，end(此异步Timer完成到达设置的执行时间时触发)<ul>
<li>trigger startEvent</li>
<li>create async thread (Sleep)</li>
<li>at setup time(Weakup)</li>
<li>trigger endEvent</li>
<li>next Activity</li>
</ul>
</li>
</ol>
<p><strong>PS：</strong><br>一般情况下，执行一个task为一个原子，执行<code>taskService.complete(taskId)</code> 时，若其中发生异常，将回滚 （这个task中发生的所有操作都会回滚，不用担心业务数据和流程数据不同步的问题）</p>
<h3 id="流程跟踪"><a href="#流程跟踪" class="headerlink" title="流程跟踪"></a>流程跟踪</h3><ul>
<li>方式一：Activiti流程引擎根据流程定义文件(.xml)生成图片<ul>
<li>方便，不灵活，易错位</li>
<li>可直接生成Highlight Activity的图片</li>
<li>弊端：坐标错位不一致，中文乱码，Flow上文字不显示</li>
</ul>
</li>
<li>方式二：直接获取部署时上传的对应流程图<ul>
<li>灵活，复杂</li>
<li>读取图片后通过前端Javascript和Css配合跟踪（Highlight Activity）</li>
<li>可利用静态服务提升读取Activiti流程图的性能</li>
<li>弊端：同方法一</li>
</ul>
</li>
<li>方式三：使用Diagram Viewer流程图跟踪组件<ul>
<li>灵活，方便</li>
<li>根据读取的数据，在前端绘制流程图</li>
</ul>
</li>
</ul>
<h4 id="使用流程定义文件-xml"><a href="#使用流程定义文件-xml" class="headerlink" title="使用流程定义文件(.xml)"></a>使用流程定义文件(.xml)</h4><ul>
<li>生成流程图<pre><code class="nulljava">BpmnModel bpmnModel=repositoryService.getBpmnModel(procInst.getProcessDefinitionId());
InputStream in=ProcessDiagramGenerator.generatePngDiagram(bpmnModel);
</code></pre>
</li>
<li>生成活动节点标记的流程图(activeActivity)<pre><code class="nulljava">List&lt;String&gt; activityIds=runtimeService.getActiveActivityIds(procInst.getId());
InputStream in=ProcessDiagramGenerator.generateDiagram(bpmnModel, &quot;png&quot;, activityIds);
</code></pre>
</li>
<li>生成带活动踪迹的流程图(activeActivity+historyFlow)<pre><code class="nulljava">List&lt;String&gt; highLightedFlows = getHighLightedFlows(processDefinition , processInstanceId);     //具体实现参考ProcessInstanceHighlightsResource.java
InputStream in=ProcessDiagramGenerator.generateDiagram(bpmnModel, &quot;png&quot;, activityIds,highLightedFlows);
</code></pre>
</li>
</ul>
<h4 id="使用部署上传的流程图"><a href="#使用部署上传的流程图" class="headerlink" title="使用部署上传的流程图"></a>使用部署上传的流程图</h4><p>这种方式在优势灵活性很大，可以显示你要展示的所有信息；<br>因为完全就是一堆信息点汇合起来的跟踪功能，需要后端提供数据给前端分析；<br>例如：有哪些Activity及其坐标、高度、宽度、是否当前节点等信息</p>
<p><img src="2013-10-01-Activiti5/diagram1.png" alt="Diagram"></p>
<p>后端： </p>
<ul>
<li>获取流程图<ul>
<li>方法一：<pre><code class="nulljava">InputStream in=repositoryService.getProcessDiagram(processDefinitionId);
</code></pre>
</li>
<li>方法二：<pre><code class="nulljava">String resourceName = procDef.getDiagramResourceName();
InputStream in = repositoryService.getResourceAsStream(processDefinitionId, resourceName);
</code></pre>
</li>
</ul>
</li>
<li>获取流程定义的所有节点信息(All Activities Info)<ul>
<li>Process内部节点(即活动)等详细信息：ActivityImpl</li>
<li>记录在bmpn文件中（运行时加载解析bmpn文件到内存中）</li>
<li>通过RepositoryService的<code>getProcessDefinition(id)</code>方法从内存中获取Activity定义信息<pre><code class="nulljava">ProcessDefinitionEntity processDefinition = (ProcessDefinitionEntity) ((RepositoryServiceImpl) repositoryService)
                        .getDeployedProcessDefinition(procInst.getProcessDefinitionId());
List&lt;ActivityImpl&gt; activitiList = processDefinition.getActivities();//获得当前流程定义的所有节点
</code></pre>
</li>
</ul>
</li>
<li><p>获取当前活动节点信息(Active Activity Info)</p>
<ul>
<li><p>注意：示例中是返回所有节点信息（包括标注是否为当前活动节点）</p>
<pre><code class="nulljava">ProcessDefinitionEntity processDefinition = (ProcessDefinitionEntity) ((RepositoryServiceImpl) repositoryService )
                    .getDeployedProcessDefinition(procInst.getProcessDefinitionId());

List&lt;String&gt; activityIds=runtimeService.getActiveActivityIds(procInst.getId());
List&lt;Map&lt;String, Object&gt;&gt; activityInfos= new ArrayList&lt;Map&lt;String, Object&gt;&gt;();

for(String id:activityIds){
   ActivityImpl activity=processDefinition.findActivity(id);
   Map&lt;String,Object&gt; activityImageInfo=new HaspMap&lt;String,Object&gt;();
   activityImageInfo.put( &quot;x&quot;, activity.getX());
   activityImageInfo.put( &quot;y&quot;, activity.getY());
   activityImageInfo.put( &quot;width&quot;, activity.getWidth());
   activityImageInfo.put( &quot;height&quot;, activity.getHeight());
   activityInfos.add(activityImageInfo);
}
</code></pre>
</li>
</ul>
</li>
</ul>
<p>前端：</p>
<ul>
<li>用js和css配合动态标记当前节点（可参考kft-activiti-demo项目的workflow.js代码）</li>
</ul>
<h4 id="使用Diagram-Viewer组件"><a href="#使用Diagram-Viewer组件" class="headerlink" title="使用Diagram Viewer组件"></a>使用Diagram Viewer组件</h4><ul>
<li>这是官方在5.12版本中提供的一个 Javascript跟踪工具，使用方便，</li>
<li>简单配置就可以使用，兼容各种浏览器，并且可以自己扩展</li>
<li>以Raphaël为基础库，用REST方式获取JSON数据，生成流程图并把流程的处理过程用不同的颜色加以标注</li>
</ul>
<p><img src="2013-10-01-Activiti5/diagram2.png" alt="Diagram"></p>
<p>后端：</p>
<ol>
<li>添加依赖包<pre><code class="nullxml"> &lt;dependency&gt;
    &lt;groupId&gt;org.activiti&lt;/groupId&gt;
    &lt;artifactId&gt;activiti-diagram-rest&lt;/artifactId&gt;
    &lt;version&gt;${activiti.version}&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
</li>
<li><p>配置一个REST拦截器</p>
<ul>
<li>可使用自定义也可使用activiti自带的DiagramRestApplication</li>
<li><code>web.xml</code><pre><code class="nullxml">&lt;!-- Activiti: Restlet adapter - used to expose modeler functionality through REST --&gt;
&lt;servlet&gt;
  &lt;servlet-name&gt;MyActivitiRestletServlet&lt;/servlet-name&gt;
  &lt;servlet-class&gt;org.restlet.ext.servlet.ServerServlet&lt;/servlet-class&gt;
  &lt;init-param&gt;
      &lt;!-- Application class name --&gt;
      &lt;param-name&gt;org.restlet.application&lt;/param-name&gt;
      &lt;!-- &lt;param-value&gt;org.activiti.rest.diagram.application.DiagramRestApplication&lt;/param-value&gt; --&gt;
      &lt;param-value&gt;com.cj.xxx.MyActivitiRestApplication&lt;/param-value&gt;
  &lt;/init-param&gt;
&lt;/servlet&gt;
&lt;!-- Catch all service requests --&gt;
&lt;servlet-mapping&gt;
  &lt;servlet-name&gt;MyActivitiRestletServlet&lt;/servlet-name&gt;
  &lt;url-pattern&gt;/service/*&lt;/url-pattern&gt;
&lt;/servlet-mapping&gt;
</code></pre>
</li>
<li><p><code>MyActivitiRestApplication.java</code></p>
<pre><code class="nulljava">public class MyActivitiRestApplication extends ActivitiRestApplication{
  public MyActivitiRestApplication(){
      super();
  }

  /**
   * Creates a root Restlet that will receive all incoming calls.
   */
  @Override
  public synchronized Restlet createInboundRoot(){
      Router router = new Router(getContext());
      router.attachDefault(DefaultResource.class);
      //DiagramServicesInit.attachResources(router);

      router.attach(&quot;/process-instance/{processInstanceId}/highlights&quot;, ProcessInstanceHighlightsResource.class);
      router.attach(&quot;/process-instance/{processInstanceId}/diagram-layout&quot;, ProcessDefinitionDiagramLayoutResource.class);
      router.attach(&quot;/process-definition/{processDefinitionId}/diagram-layout&quot;, MyProcessDefinitionDiagramLayoutResource.class);

      JsonpFilter jsonpFilter = new JsonpFilter(getContext());
      jsonpFilter.setNext(router);
      return jsonpFilter;
  }
}
</code></pre>
</li>
</ul>
</li>
</ol>
<p>前端使用：</p>
<p>复制Diagram Viewer组件到项目</p>
<ul>
<li>从官网包<code>activiti-explorer.war</code>中找到<code>diagram-viewer</code>拷贝到项目</li>
<li>根据需要编写修改js文件，在页面中应用</li>
</ul>
<p>测试：</p>
<ol>
<li><p>获取完整效果，eg：</p>
<ul>
<li>trigger: <code>baseUrl+/resources/diagram-viewer/index.html?processDefinitionId=leave:1:4&amp;processInstanceId=5</code></li>
<li>响应的HTML上面绘制了对应的流程追踪图</li>
</ul>
</li>
<li><p>获取流程定义所有元素信息，eg：</p>
<ul>
<li>trigger: <code>baseUrl + &quot;/service/process-definition/{processDefinitionId}/diagram-layout?callback=?&quot;</code></li>
<li>or trigger: <code>baseUrl + &quot;/service/process-definition/{processDefinitionKey}/diagram-layout?callback=?&quot;</code></li>
<li>result:<pre><code class="nulljson">{&quot;processDefinition&quot;:{&quot;id&quot;:&quot;leave:1:20&quot;,&quot;name&quot;:&quot;请假流程&quot;,&quot;key&quot;:&quot;leave&quot;,&quot;version&quot;:1,&quot;deploymentId&quot;:&quot;1&quot;,&quot;isGraphicNotationDefined&quot;:true},
&quot;activities&quot;:[
    {&quot;activityId&quot;:&quot;deptLeaderAudit&quot;,&quot;properties&quot;:{&quot;name&quot;:&quot;部门领导审批&quot;,&quot;type&quot;:&quot;userTask&quot;},&quot;x&quot;:90,&quot;y&quot;:80,&quot;width&quot;:105,&quot;height&quot;:55},
    {&quot;activityId&quot;:&quot;exclusivegateway5&quot;,&quot;properties&quot;:{&quot;name&quot;:&quot;Exclusive Gateway&quot;,&quot;type&quot;:&quot;exclusiveGateway&quot;},&quot;x&quot;:250,&quot;y&quot;:87,&quot;width&quot;:40,&quot;height&quot;:40},
    {&quot;activityId&quot;:&quot;modifyApply&quot;,&quot;properties&quot;:{&quot;name&quot;:&quot;调整申请&quot;,&quot;type&quot;:&quot;userTask&quot;},&quot;x&quot;:218,&quot;y&quot;:190,&quot;width&quot;:105,&quot;height&quot;:55},
    {&quot;activityId&quot;:&quot;hrAudit&quot;,&quot;properties&quot;:{&quot;name&quot;:&quot;人事审批&quot;,&quot;type&quot;:&quot;userTask&quot;},&quot;x&quot;:358,&quot;y&quot;:80,&quot;width&quot;:105,&quot;height&quot;:55},
    {&quot;activityId&quot;:&quot;exclusivegateway6&quot;,&quot;properties&quot;:{&quot;name&quot;:&quot;Exclusive Gateway&quot;,&quot;type&quot;:&quot;exclusiveGateway&quot;},&quot;x&quot;:495,&quot;y&quot;:87,&quot;width&quot;:40,&quot;height&quot;:40},
    {&quot;activityId&quot;:&quot;reportBack&quot;,&quot;properties&quot;:{&quot;name&quot;:&quot;销假&quot;,&quot;type&quot;:&quot;userTask&quot;},&quot;x&quot;:590,&quot;y&quot;:80,&quot;width&quot;:105,&quot;height&quot;:55},
    {&quot;activityId&quot;:&quot;exclusivegateway7&quot;,&quot;properties&quot;:{&quot;name&quot;:&quot;Exclusive Gateway&quot;,&quot;type&quot;:&quot;exclusiveGateway&quot;},&quot;x&quot;:250,&quot;y&quot;:280,&quot;width&quot;:40,&quot;height&quot;:40},
    {&quot;activityId&quot;:&quot;startevent1&quot;,&quot;properties&quot;:{&quot;name&quot;:&quot;Start&quot;,&quot;type&quot;:&quot;startEvent&quot;},&quot;x&quot;:10,&quot;y&quot;:90,&quot;width&quot;:35,&quot;height&quot;:35},
    {&quot;activityId&quot;:&quot;endevent1&quot;,&quot;properties&quot;:{&quot;name&quot;:&quot;End&quot;,&quot;type&quot;:&quot;endEvent&quot;},&quot;x&quot;:625,&quot;y&quot;:283,&quot;width&quot;:35,&quot;height&quot;:35}
    ],
&quot;sequenceFlows&quot;:[
    {&quot;id&quot;:&quot;flow3&quot;,&quot;name&quot;:&quot;&quot;,&quot;flow&quot;:&quot;(deptLeaderAudit)--flow3--&gt;(exclusivegateway5)&quot;,&quot;xPointArray&quot;:[195,250],&quot;yPointArray&quot;:[107,107]},
    {&quot;id&quot;:&quot;flow4&quot;,&quot;name&quot;:&quot;不同意&quot;,&quot;flow&quot;:&quot;(exclusivegateway5)--flow4--&gt;(modifyApply)&quot;,&quot;xPointArray&quot;:[270,270],&quot;yPointArray&quot;:[127,190]},
    {&quot;id&quot;:&quot;flow5&quot;,&quot;name&quot;:&quot;同意&quot;,&quot;flow&quot;:&quot;(exclusivegateway5)--flow5--&gt;(hrAudit)&quot;,&quot;xPointArray&quot;:[290,358],&quot;yPointArray&quot;:[107,107]},
    {&quot;id&quot;:&quot;flow11&quot;,&quot;name&quot;:&quot;&quot;,&quot;flow&quot;:&quot;(modifyApply)--flow11--&gt;(exclusivegateway7)&quot;,&quot;xPointArray&quot;:[270,270],&quot;yPointArray&quot;:[245,280]},
    {&quot;id&quot;:&quot;flow6&quot;,&quot;name&quot;:&quot;&quot;,&quot;flow&quot;:&quot;(hrAudit)--flow6--&gt;(exclusivegateway6)&quot;,&quot;xPointArray&quot;:[463,495],&quot;yPointArray&quot;:[107,107]},
    {&quot;id&quot;:&quot;flow7&quot;,&quot;name&quot;:&quot;同意&quot;,&quot;flow&quot;:&quot;(exclusivegateway6)--flow7--&gt;(reportBack)&quot;,&quot;xPointArray&quot;:[535,590],&quot;yPointArray&quot;:[107,107]},
    {&quot;id&quot;:&quot;flow9&quot;,&quot;name&quot;:&quot;不同意&quot;,&quot;flow&quot;:&quot;(exclusivegateway6)--flow9--&gt;(modifyApply)&quot;,&quot;xPointArray&quot;:[515,514,323],&quot;yPointArray&quot;:[127,217,217]},
    {&quot;id&quot;:&quot;flow8&quot;,&quot;name&quot;:&quot;&quot;,&quot;flow&quot;:&quot;(reportBack)--flow8--&gt;(endevent1)&quot;,&quot;xPointArray&quot;:[642,642],&quot;yPointArray&quot;:[135,283]},
    {&quot;id&quot;:&quot;flow10&quot;,&quot;name&quot;:&quot;重新申请&quot;,&quot;flow&quot;:&quot;(exclusivegateway7)--flow10--&gt;(deptLeaderAudit)&quot;,&quot;xPointArray&quot;:[250,142,142],&quot;yPointArray&quot;:[300,299,135]},
    {&quot;id&quot;:&quot;flow12&quot;,&quot;name&quot;:&quot;结束流程&quot;,&quot;flow&quot;:&quot;(exclusivegateway7)--flow12--&gt;(endevent1)&quot;,&quot;xPointArray&quot;:[290,625],&quot;yPointArray&quot;:[300,300]},
    {&quot;id&quot;:&quot;flow2&quot;,&quot;name&quot;:&quot;&quot;,&quot;flow&quot;:&quot;(startevent1)--flow2--&gt;(deptLeaderAudit)&quot;,&quot;xPointArray&quot;:[45,90],&quot;yPointArray&quot;:[107,107]}
    ]
};
</code></pre>
</li>
</ul>
</li>
<li><p>获取当前活动节点和线信息进行高亮处理，eg：</p>
<ul>
<li>trigger: <code>baseUrl + &quot;/service/process-instance/{processInstanceId}/highlights?callback=?&quot;</code></li>
<li>result: <pre><code class="nulljson">{&quot;processInstanceId&quot;:&quot;108&quot;,&quot;processDefinitionId&quot;:&quot;leave:1:20&quot;,&quot;activities&quot;:[&quot;hrAudit&quot;],&quot;flows&quot;:[&quot;flow2&quot;,&quot;flow3&quot;,&quot;flow5&quot;]});
</code></pre>
</li>
</ul>
</li>
</ol>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="http://activiti.org/">Activiti官网</a></li>
<li><a href="http://forums.activiti-cn.org/">Activiti 中文论坛</a></li>
<li><a href="http://www.mossle.com/docs/activiti/">Activiti 用户手册</a></li>
<li>推荐博文:<a href="http://www.kafeitu.me/activiti.html">咖啡兔</a> | <a href="http://www.infoq.com/cn/articles/bpmn2-activiti5?utm_source=bshare&amp;utm_campaign=bshare&amp;utm_medium=sinaminiblog&amp;bsh_bid=91185688">BPMN2新规范与Activiti5</a></li>
<li>Activiti Online Projects: <a href="http://mossle.com/">lemon</a>| <a href="http://www.jee-soft.cn/htsite/index.html">宏天</a></li>
</ul>
  </section>
</article>

      <hr/>
      <section class="post-comment">
	<!-- disqus默认将数据加载到id为'disqus_thread'的容器中，可配置disqus_container_id改变-->
<div id="disqus_thread"> 
	<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

	<script type="text/javascript">
		var disqus_shortname = 'sixdegreespace'; 
		var disqus_identifier = '2013/10/01/Activiti5.html';	
		var disqus_title = 'Activiti5';
		var disqus_url = 'http://sixdegree.github.io/2013/10/01/Activiti5.html' ;
		//var disqus_category_id = '4262241'; 

		(function() {
		    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
		})();
	</script>


 
</section>
    </div>
  </div>
</body>

<script src="/jquery/dist/jquery.min.js"></script>
<script src="/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/highlight/highlight.pack.js"></script>
<script type="text/javascript">
  hljs.initHighlightingOnLoad();
  
  $(document).ready(function(){
    var sidebarCtrl=$("#sidebar-ctrl");
    var sidebar=$("#sidebar");
    var wrapper=$("#wrapper");
    sidebarCtrl.on("click",function(event){
        //alert("click");
        sidebar.toggleClass("sidebar-toggle");
        wrapper.toggleClass("sidebar-toggle");
        sidebarCtrl.toggleClass("sidebar-toggle");
        sidebarCtrl.toggleClass("active");
    })
  });
</script>


</html>
