<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Activiti5</title>
  
  <!-- Meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="jbpm,activiti,process,bpmn,spring">
  
  
    <meta name="description" content="Activiti Introduce">
  

  <!-- Feed -->
  
    <link rel="alternative" href="/atom.xml" title="SixDegree" type="application/atom+xml">
  

  <!-- CSS -->
  <link rel="stylesheet" href="/bootstrap/dist/css/bootstrap.css">
  
    <link rel="stylesheet" href="/highlight/demo/styles/tomorrow-night-bright.css">
  
  <link rel="stylesheet" href="/css/fontello.css">
  <link rel="stylesheet" href="/css/style.css">

  <!-- Site Analyse -->
  
	<script>
	var userID='2bbb83cc0f781dd7502e9d5e19661866';
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?"+userID;
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>


</head>

<body data-spy="scroll" data-target="#nav-catalog">
  <div id="top-push"></div>
<a href="#top-push" id="go-top">
	<span class="glyphicon glyphicon-chevron-up"></span>
</a>
  <aside id="sidebar">
    <section class="sidebar-header">Catalog</section>
     <nav id="nav-catalog">
        <ol class="sidebar-nav nav"><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#header-1"><span class="sidebar-nav nav-text">Starter</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-2"><span class="sidebar-nav nav-text">依赖包</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-3"><span class="sidebar-nav nav-text">流程设计工具</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-4"><span class="sidebar-nav nav-text">ProcessEngine(流程引擎)</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-5"><span class="sidebar-nav nav-text">ProcessDefinition(流程定义)</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-6"><span class="sidebar-nav nav-text">发布流程定义</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-7"><span class="sidebar-nav nav-text">查看流程定义信息</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-8"><span class="sidebar-nav nav-text">查看流程附件</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-9"><span class="sidebar-nav nav-text">删除流程定义</span></a></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-10"><span class="sidebar-nav nav-text">ProcessInstance(流程实例)</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-11"><span class="sidebar-nav nav-text">启动流程</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-12"><span class="sidebar-nav nav-text">查看流程状态</span></a></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-13"><span class="sidebar-nav nav-text">Task(任务)</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-14"><span class="sidebar-nav nav-text">查看任务</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-15"><span class="sidebar-nav nav-text">办理任务</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-16"><span class="sidebar-nav nav-text">监听器</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-17"><span class="sidebar-nav nav-text">系统任务</span></a></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-18"><span class="sidebar-nav nav-text">Gateway 网关</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-19"><span class="sidebar-nav nav-text">排他网关</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-20"><span class="sidebar-nav nav-text">并行网关</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-21"><span class="sidebar-nav nav-text">包含网关</span></a></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-22"><span class="sidebar-nav nav-text">与Spring整合</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-23"><span class="sidebar-nav nav-text">测试</span></a></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#header-24"><span class="sidebar-nav nav-text">功能组件介绍</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-25"><span class="sidebar-nav nav-text">Service</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-26"><span class="sidebar-nav nav-text">Tables</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-27"><span class="sidebar-nav nav-text">Var</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-28"><span class="sidebar-nav nav-text">User</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-29"><span class="sidebar-nav nav-text">Form</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-30"><span class="sidebar-nav nav-text">Activiti管理表单</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-31"><span class="sidebar-nav nav-text">非Activiti管理表单</span></a></li></ol></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#header-32"><span class="sidebar-nav nav-text">常见应用</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-33"><span class="sidebar-nav nav-text">Attachment &amp; Comment</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-34"><span class="sidebar-nav nav-text">多实例</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-35"><span class="sidebar-nav nav-text">CallActivity &amp; SubProcess</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-36"><span class="sidebar-nav nav-text">Transaction 事务</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-37"><span class="sidebar-nav nav-text">流程跟踪</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-38"><span class="sidebar-nav nav-text">使用流程定义文件(.xml)</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-39"><span class="sidebar-nav nav-text">使用部署上传的流程图</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-4"><a class="sidebar-nav nav-link" href="#header-40"><span class="sidebar-nav nav-text">使用Diagram Viewer组件</span></a></li></ol></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#header-41"><span class="sidebar-nav nav-text">Reference</span></a></li></ol>
    </nav>
  </aside>
  <span id="sidebar-ctrl" class="glyphicon glyphicon-list-alt circle"></span>
  <div id="wrapper">
    <header>
  <nav class="navbar navbar-default">
    <div class="container-fluid">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#nav-menu" aria-expanded="false">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="/">SixDegree</a>
      </div>
      <div class="collapse navbar-collapse" id="nav-menu">
        <ul class="nav navbar-nav navbar-right">
          
              <li  >
                <a href="/">Blogs</a>
              </li>
          
              <li  >
                <a href="/tags.html">Tags</a>
              </li>
          
              <li  >
                <a href="/about.html">About</a>
              </li>
          
          
              <li>
                <a href="/atom.xml" target="_blank">
                  <span class="icon-rss"></span>
                </a>
              </li>
          
              <li>
                <a href="http://github.com/sixdegree" target="_blank">
                  <span class="icon-github"></span>
                </a>
              </li>
          
        </ul>
      </div>
    </div>
  </nav>
</header>



    <div class="container">
      <article class="detail" role="main">
  <section class="post-header">
    <h1 class="post-title">Activiti5</h1>
    <ul class="post-meta">
      <li>
        <span class="glyphicon glyphicon-calendar"></span>
        <time datetime="2013-09-30T16:00:00.000Z">2013-10-01</time>
      </li>
      
        <li>
         <span class="glyphicon glyphicon-tags"></span>
          
            <a href="/tags.html#tag-Java">Java</a>
          
            <a href="/tags.html#tag-Activiti">Activiti</a>
          
        </li>
      
    </ul>
  </section>
  <section class="post-content">
    <h2 id="header-1">Starter</h2>
<h3 id="header-2">依赖包</h3>
<pre><code class="nullxml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.activiti<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>activiti-engine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${activiti-version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.activiti<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>activiti-spring<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${activiti-version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>根据需要，加入DB，例如：</p>
<pre><code class="nullxml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.1.21<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>oracle<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>oracle<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>11.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.h2database<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>h2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.3.168<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.postgresql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>postgresql<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>9.4-1201-jdbc41<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h3 id="header-3">流程设计工具</h3>
<ol>
<li>使用Activiti Modeler（网页流程设计器）<ul>
<li>一般适用于业务设计人员</li>
<li>Signavio 授权的基于Web的开源BPMN设计器</li>
<li>BPMN 2.0规范</li>
<li>获取后置于tomcat中启用，获取方式：<ul>
<li>方式一：<code>svn checkout http://signavio-core-components.googlecode.com/svn/trunk</code></li>
<li>方式二：activiti包下的<code>activiti-explorer.war</code>（内置了Activiti Modeler组件）</li>
</ul>
</li>
<li>还可将此组件加入到自己项目中，为项目提供在线流程设计功能：<pre><code class="nullxml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span> 
  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.activiti<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>activiti-modeler<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${activiti-version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
</li>
</ul>
</li>
<li>使用Activiti Designer（Eclipse插件）<ul>
<li>一般适用于开发人员</li>
</ul>
</li>
</ol>
<h3 id="header-4">ProcessEngine(流程引擎)</h3>
<p>ProcessEngineConfiguration:</p>
<ul>
<li><code>org.activiti.engine.impl.cfg.StandaloneProcessEngineConfiguration</code>: 单独运行的流程引擎。<ul>
<li>Activiti会自己处理事务</li>
<li>默认</li>
<li>数据库只在引擎启动时检测 （如果没有Activiti的表或者表结构不正确就会抛出异常）</li>
</ul>
</li>
<li><code>org.activiti.engine.impl.cfg.StandaloneInMemProcessEngineConfiguration</code>: 单元测试时的辅助类。<ul>
<li>Activiti会自己控制事务。 </li>
<li>默认使用H2内存数据库。</li>
<li>数据库表会在引擎启动时创建，关闭时删除。</li>
<li>使用它时，不需要其他配置（除非使用job执行器或邮件功能）</li>
</ul>
</li>
<li><code>org.activiti.spring.SpringProcessEngineConfiguration</code>: 在Spring环境下使用流程引擎</li>
<li><code>org.activiti.engine.impl.cfg.JtaProcessEngineConfiguration</code>: 单独运行流程引擎，并使用JTA事务。</li>
</ul>
<p>创建ProcessEngine:</p>
<p>方式一：</p>
<pre><code class="nulljava"><span class="hljs-comment">/*
 * 不使用配置文件，创建ProcessEngine对象
 */</span>
<span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">envTest1</span><span class="hljs-params">()</span></span>{
    <span class="hljs-comment">//1.创建流程引擎配置对象ProcessEngineConfiguration</span>
    ProcessEngineConfiguration configuration=ProcessEngineConfiguration.createStandaloneProcessEngineConfiguration();
    <span class="hljs-comment">//2.配置</span>
    <span class="hljs-comment">//2.1）完善数据库相关配置--这里使用MySQL（默认为H2）</span>
    configuration.setJdbcDriver(<span class="hljs-string">"com.mysql.jdbc.Driver"</span>);
    configuration.setJdbcUrl(<span class="hljs-string">"jdbc:mysql://localhost:3306/activitiTest?createDatabaseIfNotExist=true"</span>);
    configuration.setJdbcUsername(<span class="hljs-string">"xxxx"</span>);
    configuration.setJdbcPassword(<span class="hljs-string">"xxxxxx"</span>);
    <span class="hljs-comment">//2.2）配置数据库建表策略，默认为false</span>
    configuration.setDatabaseSchemaUpdate(ProcessEngineConfiguration.DB_SCHEMA_UPDATE_TRUE);
    <span class="hljs-comment">//3.创建ProcessEngine</span>
    ProcessEngine processEngine=configuration.buildProcessEngine();
    System.out.println(processEngine.getName());
}
</code></pre>
<p>方式二：</p>
<pre><code class="nulljava"><span class="hljs-comment">/*
 * 使用配置文件，加载创建ProcessEngine对象
 * 默认加载classpath下的activiti.cfg.xml文件
 */</span>
<span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">envTest2</span><span class="hljs-params">()</span></span>{
    <span class="hljs-comment">//最简单获取ProcessEngine对象的方式</span>
    ProcessEngine processEngine=ProcessEngines.getDefaultProcessEngine();
    System.out.println(processEngine.getName());
}
</code></pre>
<p>activiti.cfg.xml:</p>
<pre><code class="nullxml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"processEngineConfiguration"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.activiti.engine.impl.cfg.StandaloneProcessEngineConfiguration"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"jdbcDriver"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"com.mysql.jdbc.Driver"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"jdbcUrl"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"jdbc:mysql://localhost:3306/activitiTest?createDatabaseIfNotExist=true"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"jdbcUsername"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"xxxx"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"jdbcPassword"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"xxxxxx"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"databaseSchemaUpdate"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"true"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>
</code></pre>
<h3 id="header-5">ProcessDefinition(流程定义)</h3>
<p>使用设计工具生成流程定义文件：</p>
<ul>
<li>bpmn流程规则文件（xml格式）</li>
<li>png流程图片（自动生成）</li>
<li>例如：HelloWorld.bpmn,HelloWorld.png</li>
</ul>
<p>通过<code>RepositoryService</code>对<code>ProcessDefinition</code>进行操作</p>
<pre><code class="nulljava">ProcessEngine processEngine=ProcessEngines.getDefaultProcessEngine();
RepositoryService repositoryService=<span class="hljs-keyword">this</span>.processEngine.getRepositoryService();
</code></pre>
<h4 id="header-6">发布流程定义</h4>
<ul>
<li>方式一：逐个添加资源文件</li>
<li>方式二：添加zip包 （Activiti框架会自动解压解析，依次添加到<code>act_ge_bytearray</code>表中）</li>
</ul>
<pre><code class="nulljava"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">deployProcess</span><span class="hljs-params">()</span>
</span>{
    DeploymentBuilder builder=repositoryService.createDeployment();

    <span class="hljs-comment">//方式一：</span>
    <span class="hljs-comment">/*InputStream bpmnInput=this.getClass().getClassLoader().getResourceAsStream("bpmn/HelloWorld.bpmn");
    InputStream pngInput=this.getClass().getClassLoader().getResourceAsStream("bpmn/HelloWorld.png");
    builder.name("Hello World!")
            .addInputStream("HelloWorld.bpmn", bpmnInput)
            .addInputStream("HelloWorld.png", pngInput)
            .deploy();*/</span>
    <span class="hljs-comment">//方式二：</span>
    InputStream in=<span class="hljs-keyword">this</span>.getClass().getClassLoader().getResourceAsStream(<span class="hljs-string">"bpmn/HelloWorld.zip"</span>);
    ZipInputStream zipInputStream =<span class="hljs-keyword">new</span> ZipInputStream(in);
    builder.name(<span class="hljs-string">"Hello World!"</span>)
            .addZipInputStream(zipInputStream)
            .deploy();
}
</code></pre>
<p>发布成功后，会在3张表中添加数据：</p>
<ul>
<li><code>act_re_deployment</code>: 1条记录：<ul>
<li><code>name</code>：Process的显示别名</li>
<li><code>deploy_time</code>：发布时间</li>
</ul>
</li>
<li><code>act_ge_bytearray</code>: 一般为2条记录（通过<code>deployment_id</code>关联<code>act_re_deployment</code>表）：<ul>
<li>1条bpmn文件内容</li>
<li>1条png文件内容</li>
</ul>
</li>
<li><code>act_re_procdef</code>： 1条记录（Process定义的相关信息，通过<code>deployment_id</code>关联<code>act_re_deployment</code>表）<ul>
<li><code>id</code>：{key}:{version}:{random}</li>
<li><code>version</code>：发布时计算（同key的maxVersion+1,默认取1）</li>
<li><code>name</code>：bpmn文件中定义的process节点的name属性</li>
<li><code>key</code>：bpmn文件中定义的process节点的id属性</li>
<li><code>deployment_id</code>：关联act_re_deployment表</li>
</ul>
</li>
</ul>
<p><strong>PS：</strong>一定要有bpmn流程规则文件，png流程图片可选，也可加入其它文件，比如video，txt等</p>
<h4 id="header-7">查看流程定义信息</h4>
<ol>
<li><p>Process概括信息：ProcessDefinition</p>
<ul>
<li>流程定义对象：流程规则的整体信息</li>
<li>记录在<code>act_re_procdef</code>表中</li>
</ul>
</li>
<li><p>Process内部子节点(即活动)等详细信息：<code>ActivityImpl</code></p>
<ul>
<li>活动对象：流程规则的活动信息</li>
<li>记录在bmpn文件中（运行时加载解析bmpn文件到内存中）</li>
</ul>
</li>
<li><p>注意：</p>
<ul>
<li>通过<code>ProcessDefinitionQuery</code>对象获取的是最简单的<code>ProcessDefinition对象</code>（从<code>act_re_procdef</code>表中查询）</li>
<li>要获取Process内部的活动定义信息，需通过<code>RepositoryService</code>的<code>getProcessDefinition(id)</code>方法（从内存中获取存放的活动Activity定义信息）</li>
</ul>
</li>
</ol>
<pre><code class="nulljava"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">queryProcessDefinition</span><span class="hljs-params">()</span>
</span>{
    String key=<span class="hljs-string">"helloWorld"</span>;
    List&lt;ProcessDefinition&gt; pds=repositoryService.createProcessDefinitionQuery().processDefinitionKey(key).list();
    <span class="hljs-keyword">for</span>(ProcessDefinition pd:pds)
    {
        System.out.println(<span class="hljs-string">"id:"</span>+pd.getId()+<span class="hljs-string">",name:"</span>+pd.getName()+<span class="hljs-string">",key:"</span>+pd.getKey()+<span class="hljs-string">",version:"</span>+pd.getVersion());
        <span class="hljs-comment">//System.out.println(((ProcessDefinitionImpl)pd).getActivities());    //这样无法获得Activity信息 (这个ProcessDefinition是从DB中查询得到的)</span>
        ProcessDefinitionImpl pdImpl=(ProcessDefinitionImpl)repositoryService.getProcessDefinition(pd.getId()); 
        <span class="hljs-comment">//这个ProcessDefinition是对应的bpmn文件解析构建的，即内存中（实际是ProcessDefinitionEntity对象）</span>
        System.out.println(pdImpl.getActivities());        <span class="hljs-comment">//activity中包含Transitions等信息 （Actitity即节点）</span>
    }
}
</code></pre>
<h4 id="header-8">查看流程附件</h4>
<p>查看流程附件（例如:流程图片）</p>
<ul>
<li>存放在表act_ge_bytearray的Bytes字段中（type为BLOB）</li>
<li>通过 deployment_id &amp; 文件名name 查找</li>
</ul>
<pre><code class="nulljava"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">queryProcessImage</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException
</span>{
    <span class="hljs-comment">//eg1.获取附件，例如png图片，也可获取其他resource文件：</span>
    String deploymentId=<span class="hljs-string">"201"</span>;
    List&lt;String&gt; resources=repositoryService.getDeploymentResourceNames(deploymentId);    <span class="hljs-comment">//通过发布ID，获取此发布的所有资源文件名</span>
    String imgName=<span class="hljs-keyword">null</span>;
    <span class="hljs-keyword">for</span>(String res:resources)    <span class="hljs-comment">//文件名过滤</span>
    {
        System.out.println(res);
        <span class="hljs-keyword">if</span>(res.endsWith(<span class="hljs-string">".png"</span>)){
            imgName=res;
            <span class="hljs-keyword">break</span>;
        }
    }
    <span class="hljs-keyword">if</span>(imgName!=<span class="hljs-keyword">null</span> &amp;&amp; imgName.length()!=<span class="hljs-number">0</span>){
        <span class="hljs-comment">//查找指定资源，以流的形式读出</span>
        InputStream in=repositoryService.getResourceAsStream(deploymentId, imgName);
        FileUtils.copyInputStreamToFile(in, <span class="hljs-keyword">new</span> File(<span class="hljs-string">"D:/hello.png"</span>));
    }

    <span class="hljs-comment">//eg2.直接获取流程图：</span>
    String processDefinitionId=<span class="hljs-string">"helloWorld:2:304"</span>;
    InputStream in=repositoryService.getProcessDiagram(processDefinitionId);
    FileUtils.copyInputStreamToFile(in, <span class="hljs-keyword">new</span> File(<span class="hljs-string">"D:/hello2.png"</span>));
}
</code></pre>
<h4 id="header-9">删除流程定义</h4>
<p>删除发布的流程 （<code>act_re_deployment</code>）:</p>
<ul>
<li><p>方式一：普通删除  <code>repositoryService.deleteDeployment(deploymentId);</code></p>
<ul>
<li>等价于:<code>repositoryService.deleteDeployment(deploymentId, false);</code></li>
<li>只删除发布流程相关的信息</li>
<li>若当前<code>ProcessDefinition</code>有正在执行的<code>ProcessInstance</code>，则删除失败（保护），因为<code>act_ru_*</code>中有对ProcessDefinition id的引用</li>
<li>删除下表记录：<ul>
<li><code>act_re_deployment</code></li>
<li><code>act_ge_bytearray</code></li>
<li><code>act_re_procdef</code></li>
</ul>
</li>
<li>不会删除history（<code>act_hi_*</code>)</li>
</ul>
</li>
<li><p>方式二：级联删除  <code>repositoryService.deleteDeployment(deploymentId, true);</code></p>
<ul>
<li>会删除<code>ProcessDefinition</code>和<code>ProcessInstance</code>，包括<code>history</code> （暴力）</li>
<li>删除下表记录：<ul>
<li><code>act_re_deployment</code></li>
<li><code>act_ge_bytearray</code></li>
<li><code>act_re_procdef</code></li>
<li><code>act_ru_*</code></li>
<li><code>act_hi_*</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<pre><code class="nulljava"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">deleteDeployment</span><span class="hljs-params">()</span>
</span>{
    String key=<span class="hljs-string">"myProcess"</span>;
    List&lt;Deployment&gt; deployments=repositoryService.createDeploymentQuery().processDefinitionKey(key).list();
    <span class="hljs-keyword">for</span>(Deployment deployment:deployments)
    {
        <span class="hljs-comment">//方式一：</span>
        repositoryService.deleteDeployment(deployment.getId());    
        <span class="hljs-comment">//方式二：</span>
        <span class="hljs-comment">//repositoryService.deleteDeployment(deployment.getId(), true);</span>
    }
}
</code></pre>
<h3 id="header-10">ProcessInstance(流程实例)</h3>
<p>ProcessInstance特点：</p>
<ol>
<li>一个Process只有一个ProcessInstance<ul>
<li>ID不变</li>
<li>可自定义ID规则，eg:{对象名称}-{对象ID}</li>
</ul>
</li>
<li>流程实例ProcessInstance是一个特殊的Execution对象（<code>ProcessInstance extends Execution</code>）<ul>
<li>代表一次执行，永远指向当前所在的活动节点（类似遍历链式结构的指针，指向当前节点）</li>
<li>对于单线流程，描述每个节点的Execution对象就是ProcessInstance；</li>
<li>对于分支流程，会在分支的最顶部创建一个Execution对象作为ProcessInstance来描述这个分支（ 每个分支下产生的Execution对象都会挂在此ProcessInstance下）</li>
</ul>
</li>
</ol>
<h4 id="header-11">启动流程</h4>
<p>启动流程（生成ProcessInstance）:<code>runtimeService.startProcessInstanceByXxx</code></p>
<ul>
<li>方式一：通过processDefinition的Id启动流程</li>
<li>方式二：通过ProcessDefinition的key启动流程（系统会使用此key下版本最高的ProcessDefinition）</li>
</ul>
<pre><code class="nulljava"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">startProcess</span><span class="hljs-params">()</span></span>{

    <span class="hljs-comment">//RuntimeService 负责流程的启动，流转等操作</span>
    RuntimeService runtimeService=<span class="hljs-keyword">this</span>.processEngine.getRuntimeService();

    <span class="hljs-comment">//方式一：</span>
    <span class="hljs-comment">/*String id="helloWorld:1:204";
    ProcessInstance processInstance=runtimeService.startProcessInstanceById(id);*/</span>

    <span class="hljs-comment">//方式二：</span>
    String key=<span class="hljs-string">"helloWorld"</span>;
    ProcessInstance processInstance=runtimeService.startProcessInstanceByKey(key);

    System.out.println(<span class="hljs-string">"id:"</span>+processInstance.getId()+<span class="hljs-string">",activityId:"</span>+processInstance.getActivityId());
}
</code></pre>
<p>启动成功后：</p>
<ul>
<li><code>act_ru_execution</code>表: 记录当前活动（只要流程到达某一个节点，即具体活动，都会在这张表中添加数据）</li>
<li><code>act_ru_task</code>表: 记录人工参与的任务信息 （主要记录：任务办理者assignee，任务分配时间create_Time）</li>
</ul>
<h4 id="header-12">查看流程状态</h4>
<p>查看流程状态，使用<code>ProcessInstanceQuery</code><br>（通过<code>runtimeService.createProcessInstanceQuery()</code>获取）</p>
<pre><code class="nulljava"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">queryProcessState</span><span class="hljs-params">()</span>
</span>{
    String pid=<span class="hljs-string">"1001"</span>;
    ProcessInstance processInstance=<span class="hljs-keyword">this</span>.runtimeService.createProcessInstanceQuery()
        .processInstanceId(pid)
        .singleResult();
    <span class="hljs-keyword">if</span>(processInstance!=<span class="hljs-keyword">null</span>)
        System.out.println(<span class="hljs-string">"id:"</span>+processInstance.getId()+<span class="hljs-string">",activityId:"</span>+processInstance.getActivityId());
}
</code></pre>
<h3 id="header-13">Task(任务)</h3>
<h4 id="header-14">查看任务</h4>
<p>查看任务，使用<code>TaskQuery</code>(通过<code>taskService.createTaskQuery()</code>获取)，主要查询表<code>act_ru_task</code></p>
<pre><code class="nulljava"><span class="hljs-comment">/**
 * 查看任务——公有任务candidate （candicateUser,candicateGroup -- act_ru_identitylink）
 * taskService.createTaskQuery().taskCandidateXxx
 * */</span>
<span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">queryCandidateTask</span><span class="hljs-params">()</span>
</span>{
    String candidateGroup=<span class="hljs-string">"ROLE_User"</span>;
    List&lt;Task&gt; tasks=<span class="hljs-keyword">this</span>.taskService.createTaskQuery().taskCandidateGroup(candidateGroup).list();
    System.out.println(<span class="hljs-string">"-----------["</span>+candidateGroup+<span class="hljs-string">"]可认领任务列表"</span>);

    <span class="hljs-keyword">for</span>(Task task:tasks)
        System.out.println(<span class="hljs-string">"id:"</span>+task.getId()+<span class="hljs-string">",name:"</span>+task.getName()+<span class="hljs-string">",assignee:"</span>+task.getAssignee()+<span class="hljs-string">",createTime:"</span>+task.getCreateTime());

    String candidateUser=<span class="hljs-string">"Lucy"</span>;
    tasks=<span class="hljs-keyword">this</span>.taskService.createTaskQuery().taskCandidateUser(candidateUser).list();
    System.out.println(<span class="hljs-string">"-----------["</span>+candidateUser+<span class="hljs-string">"]可认领任务列表"</span>);

    <span class="hljs-keyword">for</span>(Task task:tasks)
        System.out.println(<span class="hljs-string">"id:"</span>+task.getId()+<span class="hljs-string">",name:"</span>+task.getName()+<span class="hljs-string">",assignee:"</span>+task.getAssignee()+<span class="hljs-string">",createTime:"</span>+task.getCreateTime());
}

<span class="hljs-comment">/**
 * 查看任务——私有任务assignee
 * taskService.createTaskQuery().taskAssignee
 * */</span>
<span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">queryAssigneeTask</span><span class="hljs-params">()</span>
</span>{
    String assignee=<span class="hljs-string">"CEO Tom"</span>;
    List&lt;Task&gt; tasks=<span class="hljs-keyword">this</span>.taskService.createTaskQuery()
                                    .taskAssignee(assignee)
                                    .orderByTaskCreateTime().desc()
                                    .list();
    System.out.println(<span class="hljs-string">"-----------["</span>+assignee+<span class="hljs-string">"]私有任务列表"</span>);
    <span class="hljs-keyword">for</span>(Task task:tasks)
        System.out.println(<span class="hljs-string">"id:"</span>+task.getId()+<span class="hljs-string">",name:"</span>+task.getName()+<span class="hljs-string">",assignee:"</span>+task.getAssignee()+<span class="hljs-string">",createTime:"</span>+task.getCreateTime());
}
</code></pre>
<h4 id="header-15">办理任务</h4>
<p>公有任务需被认领（使用<code>taskService.claim</code>）后才可执行</p>
<pre><code class="nulljava"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">claimTask</span><span class="hljs-params">()</span></span>{
    String taskId=<span class="hljs-string">"1202"</span>;
    String userId=<span class="hljs-string">"Lucy"</span>;
    <span class="hljs-keyword">this</span>.taskService.claim(taskId, userId);
}
</code></pre>
<p>办理任务（使用<code>taskService.complete(taskId)</code>）</p>
<pre><code class="nulljava"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doTask</span><span class="hljs-params">()</span>
</span>{
    String taskId=<span class="hljs-string">"1302"</span>;
    <span class="hljs-keyword">this</span>.taskService.complete(taskId);
}
</code></pre>
<p>完成task后会：</p>
<ul>
<li>会在<code>act_hi_*</code>表中添加记录：<code>act_hi_actinst</code>,<code>act_hi_taskinst</code>,<code>act_hi_proinst</code></li>
<li>删除<code>act_ru_*</code>表中的相关记录:：<code>act_ru_execution</code>,<code>act_ru_task</code></li>
</ul>
<h4 id="header-16">监听器</h4>
<ul>
<li><code>TaskListener</code>：任务监听器，监听事件：<ol>
<li><code>assignment</code> – 给指定人分配task时触发<ul>
<li>在bpmn文件中指定;</li>
<li>认领任务后;</li>
<li>create时setAssignee后;</li>
<li>注意：直接<code>task.setAssignee(...)</code>并不会触发</li>
</ul>
</li>
<li><code>create</code> – 启动task时触发</li>
<li><code>complete</code> – 完成task时触发</li>
<li><code>delete</code> – 结束后删除task时触发</li>
</ol>
</li>
<li><code>ExecutionListener</code>：执行节点监听器，一般监听事件：<ol>
<li><code>start</code></li>
<li><code>end</code></li>
</ol>
</li>
<li>使用：<ul>
<li>使用expression设置</li>
<li>使用delegateExpression设置</li>
<li>使用class</li>
<li>。。。</li>
</ul>
</li>
</ul>
<p>使用举例1（TaskListener,delegateExpression）：<br>1) xxx.bpmn.xml:</p>
<pre><code class="nullxml"><span class="hljs-tag">&lt;<span class="hljs-name">userTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"usertask1"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"User Task1"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">extensionElements</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">activiti:taskListener</span> <span class="hljs-attr">event</span>=<span class="hljs-string">"create"</span> <span class="hljs-attr">delegateExpression</span>=<span class="hljs-string">"${springTaskListenerBean}"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">activiti:taskListener</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">extensionElements</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">userTask</span>&gt;</span>
</code></pre>
<p>2) SpringTaskListenerBean.java:</p>
<pre><code class="nulljava"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SpringTaskListenerBean</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">TaskListener</span> </span>{
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">notify</span><span class="hljs-params">(DelegateTask delegateTask)</span> </span>{
        delegateTask.setVariable(<span class="hljs-string">"status"</span>, delegateTask.getEventName());
        System.out.println(delegateTask.getEventName()+<span class="hljs-string">" : "</span>+delegateTask.getName()
                +<span class="hljs-string">" ( status: "</span>+delegateTask.getVariable(<span class="hljs-string">"status"</span>)+<span class="hljs-string">")"</span>);
    }
}
</code></pre>
<p>使用举例2（TaskListener,expression）：<br>1) xxx.bpmn.xml</p>
<pre><code class="nullxml"> <span class="hljs-tag">&lt;<span class="hljs-name">userTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"reqApprove"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"TPM Manager 审批"</span> <span class="hljs-attr">activiti:assignee</span>=<span class="hljs-string">"${approver}"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">extensionElements</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">activiti:taskListener</span> <span class="hljs-attr">event</span>=<span class="hljs-string">"assignment"</span> <span class="hljs-attr">expression</span>=<span class="hljs-string">"${processService.doProcApproverAssignment(task)}"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">activiti:taskListener</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">extensionElements</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">userTask</span>&gt;</span>
</code></pre>
<p>2) ProcessService.java</p>
<pre><code class="nulljava"><span class="hljs-meta">@Service</span>(<span class="hljs-string">"processService"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProcessService</span></span>{

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doProcApproverAssignment</span><span class="hljs-params">(DelegateTask delegateTask)</span></span>{
        System.out.println(<span class="hljs-string">"Do Proc Approver Assignement..."</span>);
        String reqId=(String)delegateTask.getVariable(<span class="hljs-string">"reqId"</span>);
        System.out.println(delegateTask.getAssignee());
        ...
    }
}
</code></pre>
<p>使用举例3（executionListener,delegateExpression）：</p>
<pre><code class="nullxml"> <span class="hljs-tag">&lt;<span class="hljs-name">startEvent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"basicSingleStart"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"Start"</span> <span class="hljs-attr">activiti:initiator</span>=<span class="hljs-string">"requesterUser"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">extensionElements</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">activiti:executionListener</span> <span class="hljs-attr">event</span>=<span class="hljs-string">"end"</span> <span class="hljs-attr">delegateExpression</span>=<span class="hljs-string">"${procStartListener}"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">activiti:executionListener</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">extensionElements</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">startEvent</span>&gt;</span>
</code></pre>
<pre><code class="nulljava"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProcStartListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">TaskListener</span>
</span>{
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">notify</span><span class="hljs-params">(DelegateTask delegateTask)</span>
    </span>{
        System.out.println(<span class="hljs-string">"Process Start:"</span>+delegateTask.getName());
        String reqId=(String)delegateTask.getVariable(ProcessVariable.reqId);
        <span class="hljs-keyword">if</span>(reqId!=<span class="hljs-keyword">null</span>)
        ...
    }
}
</code></pre>
<p>使用举例3（executionListener,expression）：<br>1) xxx.bpmn.xml</p>
<pre><code class="nullxml"><span class="hljs-tag">&lt;<span class="hljs-name">startEvent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"basicSingleStart"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"Start"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">extensionElements</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">activiti:executionListener</span> <span class="hljs-attr">event</span>=<span class="hljs-string">"end"</span> <span class="hljs-attr">expression</span>=<span class="hljs-string">"${processService.setProcBusinessKey(execution)}"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">activiti:executionListener</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">extensionElements</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">startEvent</span>&gt;</span>
</code></pre>
<p>2) ProcessService.java</p>
<pre><code class="nulljava"><span class="hljs-meta">@Service</span>(<span class="hljs-string">"processService"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProcessService</span></span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setProcBusinessKey</span><span class="hljs-params">(DelegateExecution execution)</span></span>{
        System.out.println(<span class="hljs-string">"Set Proc BusinessKey..."</span>);
        String key=execution.getProcessBusinessKey();
        <span class="hljs-keyword">if</span>(key==<span class="hljs-keyword">null</span>){
            key=(String)execution.getVariable(ProcessVariable.reqId);
            System.out.println(<span class="hljs-string">"Set Basic Process BusinessKey:"</span>+key);
            <span class="hljs-keyword">if</span>(execution <span class="hljs-keyword">instanceof</span> ExecutionEntity)
                ((ExecutionEntity)execution).setBusinessKey(key);
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(execution <span class="hljs-keyword">instanceof</span> ExecutionImpl)
                ((ExecutionImpl)execution).updateProcessBusinessKey(key);
        }
    }
}
</code></pre>
<p><strong>PS</strong>：</p>
<ul>
<li>execution：<code>DelegateExecution</code>提供外出执行的额外信息。</li>
<li>task：<code>DelegateTask</code>提供当前任务的额外信息。注意，只对任务监听器的表达式有效。</li>
</ul>
<h4 id="header-17">系统任务</h4>
<p>ServcieTask 系统任务，自动执行</p>
<p>1) xxx.bpmn.xml:</p>
<pre><code class="nullxml"><span class="hljs-tag">&lt;<span class="hljs-name">serviceTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"servicetask"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"service Task"</span> <span class="hljs-attr">activiti:delegateExpression</span>=<span class="hljs-string">"myJavaDelegate"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">serviceTask</span>&gt;</span>
</code></pre>
<p>2) MyJavaDelegate.java</p>
<pre><code class="nulljava"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyJavaDelegate</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">JavaDelegate</span>
</span>{
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">execute</span><span class="hljs-params">(DelegateExecution execution)</span> <span class="hljs-keyword">throws</span> Exception
    </span>{
        System.out.println(<span class="hljs-string">"Execution Service Task..."</span>);
        execution.setVariable(<span class="hljs-string">"serviceVar"</span>, <span class="hljs-string">"Hello"</span>);
    }
}
</code></pre>
<h3 id="header-18">Gateway 网关</h3>
<h4 id="header-19">排他网关</h4>
<p>排他网关（ExclusiveGateway）:</p>
<ul>
<li>在flow上(线上)设置条件condition，跟jbpm不同</li>
<li>根据condition结果，执行其中一条分支</li>
</ul>
<p><img src="/2013/10/01/ExclusiveGateway.png" alt="ExclusiveGateway"></p>
<pre><code class="nullxml"><span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"flow2"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"input == 1"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"exclusivegateway"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"usertask1"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">conditionExpression</span> <span class="hljs-attr">xsi:type</span>=<span class="hljs-string">"tFormalExpression"</span>&gt;</span>&lt;![CDATA[${input == 1}]]&gt;<span class="hljs-tag">&lt;/<span class="hljs-name">conditionExpression</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">sequenceFlow</span>&gt;</span>
</code></pre>
<pre><code class="nulljava"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testExclusiveGateway</span><span class="hljs-params">()</span></span>{
    Map&lt;String,Object&gt; variables=<span class="hljs-keyword">new</span> HashMap&lt;String,Object&gt;();
    variables.put(<span class="hljs-string">"input"</span>, <span class="hljs-number">2</span>);
    runtimeService.startProcessInstanceByKey(<span class="hljs-string">"exclusiveGatewayTest"</span>,variables);

    Task task=taskService.createTaskQuery().singleResult();
    assertTrue(<span class="hljs-string">"User Task2"</span>.equals(task.getName()));
}
</code></pre>
<h4 id="header-20">并行网关</h4>
<p>并行网关(ParallelGateway):</p>
<ul>
<li>无需设置condition</li>
<li>等分支都执行完毕再继续向下执行</li>
</ul>
<p>例如：<br><img src="/2013/10/01/ParallelGateway.png" alt="ParallelGateway"><br>需<code>UserTask1</code>和<code>UserTask2</code>都完成后<code>UserTask3</code>才可被执行</p>
<h4 id="header-21">包含网关</h4>
<p>包含网关（InclusiveGateway）</p>
<ul>
<li>排他网关ExclusiveGateway和并行网关PallelGateway的结合</li>
<li>符合Condition的分支会并行执行</li>
</ul>
<p>例如：<br><img src="/2013/10/01/InclusiveGateway.png" alt="InclusiveGateway"><br>若<code>input=2</code>,则UserTask1不会被执行，且只有<code>UserTask2</code>和<code>UserTask3</code>都被执行完成后，流程才会再往下</p>
<h3 id="header-22">与Spring整合</h3>
<pre><code class="nullxml"><span class="hljs-tag">&lt;<span class="hljs-name">aop:aspectj-autoproxy</span> <span class="hljs-attr">proxy-target-class</span>=<span class="hljs-string">"true"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">context:annotation-config</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">context:component-scan</span> <span class="hljs-attr">base-package</span>=<span class="hljs-string">"xxxx"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">context:component-scan</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">context:property-placeholder</span> <span class="hljs-attr">location</span>=<span class="hljs-string">"classpath:jdbc-mine.properties"</span>/&gt;</span>

<span class="hljs-comment">&lt;!-- DataSource --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"dataSource"</span> <span class="hljs-attr">destroy-method</span>=<span class="hljs-string">"close"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.apache.commons.dbcp.BasicDataSource"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"driverClassName"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${jdbc.driverClassName}"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"url"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${jdbc.url}"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"username"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${jdbc.username}"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${jdbc.password}"</span>/&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"initialSize"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"1"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"minIdle"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"2"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"maxActive"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"200"</span>/&gt;</span>   
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"maxIdle"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"30"</span>/&gt;</span>       
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"maxWait"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"10000"</span>/&gt;</span>  
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"removeAbandoned"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"true"</span>/&gt;</span>  
    <span class="hljs-comment">&lt;!-- &lt;property name="logAbandoned" value="true"/&gt;   --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"validationQuery"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"select 1 from dual"</span>/&gt;</span> 
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"testOnBorrow"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"true"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 声明式事务 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"txManager"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"dataSource"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"dataSource"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">tx:advice</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"txAdvice"</span> <span class="hljs-attr">transaction-manager</span>=<span class="hljs-string">"txManager"</span> &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">tx:attributes</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">tx:method</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"list*"</span> <span class="hljs-attr">propagation</span>=<span class="hljs-string">"REQUIRED"</span> <span class="hljs-attr">read-only</span>=<span class="hljs-string">"true"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">tx:method</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"get*"</span> <span class="hljs-attr">propagation</span>=<span class="hljs-string">"REQUIRED"</span> <span class="hljs-attr">read-only</span>=<span class="hljs-string">"true"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">tx:method</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"detail*"</span> <span class="hljs-attr">propagation</span>=<span class="hljs-string">"REQUIRED"</span> <span class="hljs-attr">read-only</span>=<span class="hljs-string">"true"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">tx:method</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"test*"</span> <span class="hljs-attr">propagation</span>=<span class="hljs-string">"REQUIRED"</span> <span class="hljs-attr">read-only</span>=<span class="hljs-string">"true"</span>  /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">tx:method</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"*"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">tx:attributes</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">tx:advice</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">aop:config</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">aop:pointcut</span> <span class="hljs-attr">expression</span>=<span class="hljs-string">"execution(* com.cj..service.*.*(..))"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"myShuttleService"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">aop:advisor</span> <span class="hljs-attr">advice-ref</span>=<span class="hljs-string">"txAdvice"</span> <span class="hljs-attr">pointcut-ref</span>=<span class="hljs-string">"myShuttleService"</span> <span class="hljs-attr">order</span>=<span class="hljs-string">"2"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">aop:config</span>&gt;</span> 

<span class="hljs-comment">&lt;!-- Activiti: processEngineConfiguration --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"processEngineConfiguration"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.activiti.spring.SpringProcessEngineConfiguration"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"dataSource"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"dataSource"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"transactionManager"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"txManager"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"databaseSchemaUpdate"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"true"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"jobExecutorActivate"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"true"</span> /&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"history"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"full"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"activityFontName"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"宋体"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"labelFontName"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"宋体"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

<span class="hljs-comment">&lt;!-- Activiti: processEngine --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"processEngine"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.activiti.spring.ProcessEngineFactoryBean"</span> <span class="hljs-attr">destroy-method</span>=<span class="hljs-string">"destroy"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"processEngineConfiguration"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"processEngineConfiguration"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

<span class="hljs-comment">&lt;!-- Activiti: Service --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"repositoryService"</span> <span class="hljs-attr">factory-bean</span>=<span class="hljs-string">"processEngine"</span> <span class="hljs-attr">factory-method</span>=<span class="hljs-string">"getRepositoryService"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"runtimeService"</span> <span class="hljs-attr">factory-bean</span>=<span class="hljs-string">"processEngine"</span> <span class="hljs-attr">factory-method</span>=<span class="hljs-string">"getRuntimeService"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"taskService"</span> <span class="hljs-attr">factory-bean</span>=<span class="hljs-string">"processEngine"</span> <span class="hljs-attr">factory-method</span>=<span class="hljs-string">"getTaskService"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"historyService"</span> <span class="hljs-attr">factory-bean</span>=<span class="hljs-string">"processEngine"</span> <span class="hljs-attr">factory-method</span>=<span class="hljs-string">"getHistoryService"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"managementService"</span> <span class="hljs-attr">factory-bean</span>=<span class="hljs-string">"processEngine"</span> <span class="hljs-attr">factory-method</span>=<span class="hljs-string">"getManagementService"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"identityService"</span> <span class="hljs-attr">factory-bean</span>=<span class="hljs-string">"processEngine"</span> <span class="hljs-attr">factory-method</span>=<span class="hljs-string">"getIdentityService"</span> /&gt;</span>

<span class="hljs-comment">&lt;!-- 根据需要注入：--&gt;</span>
<span class="hljs-comment">&lt;!-- Activiti: javaDelegate --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"myJavaDelegate"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.cj.test.javaDelegate.MyJavaDelegate"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>
<span class="hljs-comment">&lt;!-- Activiti: taskListener --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"myTaskListener"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.cj.test.taskListener.MyTaskListener"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>
</code></pre>
<h3 id="header-23">测试</h3>
<p><code>PluggableActivitiTestCase</code>，<code>ResourceActivitiTestCase</code>，<code>SpringActivitiTestCase</code></p>
<ul>
<li><code>extends AbstractActivitiTestCase</code></li>
<li>定义了processEngine和所有的API的Servcie</li>
<li>使用test开头的方法作为单元测试方法：    <code>testXxx(...)</code></li>
<li>可使用<code>@Deployment</code>注解deploy测试流程</li>
</ul>
<p>使用：</p>
<ul>
<li>方式一：<code>extends PluggableActivitiTestCase</code><ul>
<li>使用默认配置文件：<code>activiti.cfg.xml</code></li>
</ul>
</li>
<li>方式二：<code>extends ResourceActivitiTestCase</code><ul>
<li>可指定配置文件,在构造函数中配置调用：<code>super(&quot;xxx&quot;)</code>;<pre><code class="nulljava"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GatewayTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ResourceActivitiTestCase</span></span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">GatewayTest</span><span class="hljs-params">()</span></span>{
      <span class="hljs-keyword">super</span>(<span class="hljs-string">"activiti-test.cfg.xml"</span>);
  }
  <span class="hljs-meta">@Deployment</span>(resources = <span class="hljs-string">"bpmn/gateway/ExclusiveGateway.bpmn"</span>)
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testExclusiveGateway</span><span class="hljs-params">()</span></span>{
      Map&lt;String,Object&gt; variables=<span class="hljs-keyword">new</span> HashMap&lt;String,Object&gt;();
      variables.put(<span class="hljs-string">"input"</span>, <span class="hljs-number">2</span>);
      runtimeService.startProcessInstanceByKey(<span class="hljs-string">"exclusiveGatewayTest"</span>,variables);
      Task task=taskService.createTaskQuery().singleResult();
      assertTrue(<span class="hljs-string">"User Task2"</span>.equals(task.getName()));
  }
}
</code></pre>
</li>
</ul>
</li>
<li><p>方式三：<code>extends SpringActivitiTestCase</code></p>
<ul>
<li>整合Spring测试（ProcessEngine,Service由Spring管理）</li>
<li><p><code>beans-test.xml</code>:</p>
<pre><code class="nullxml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"dataSource"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.springframework.jdbc.datasource.SimpleDriverDataSource"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"driverClass"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${jdbc.driverClassName}"</span>/&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"url"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${jdbc.url}"</span>/&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"username"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${jdbc.username}"</span>/&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${jdbc.password}"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"txManager"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"dataSource"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"dataSource"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">tx:advice</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"txAdvice"</span> <span class="hljs-attr">transaction-manager</span>=<span class="hljs-string">"txManager"</span> &gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">tx:attributes</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">tx:method</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"list*"</span> <span class="hljs-attr">propagation</span>=<span class="hljs-string">"REQUIRED"</span> <span class="hljs-attr">read-only</span>=<span class="hljs-string">"true"</span>/&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">tx:method</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"get*"</span> <span class="hljs-attr">propagation</span>=<span class="hljs-string">"REQUIRED"</span> <span class="hljs-attr">read-only</span>=<span class="hljs-string">"true"</span>/&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">tx:method</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"detail*"</span> <span class="hljs-attr">propagation</span>=<span class="hljs-string">"REQUIRED"</span> <span class="hljs-attr">read-only</span>=<span class="hljs-string">"true"</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">tx:method</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"test*"</span> <span class="hljs-attr">propagation</span>=<span class="hljs-string">"REQUIRED"</span> <span class="hljs-attr">read-only</span>=<span class="hljs-string">"true"</span>  /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">tx:method</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"*"</span>/&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">tx:attributes</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">tx:advice</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"processEngineConfiguration"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.activiti.spring.SpringProcessEngineConfiguration"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"dataSource"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"dataSource"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"transactionManager"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"txManager"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"databaseSchemaUpdate"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"true"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"jobExecutorActivate"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"true"</span> /&gt;</span>
  <span class="hljs-comment">&lt;!-- &lt;property name="history" value="full" /&gt; --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"activityFontName"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"微软雅黑"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"labelFontName"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"微软雅黑"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"processEngine"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.activiti.spring.ProcessEngineFactoryBean"</span> <span class="hljs-attr">destroy-method</span>=<span class="hljs-string">"destroy"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"processEngineConfiguration"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"processEngineConfiguration"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"repositoryService"</span> <span class="hljs-attr">factory-bean</span>=<span class="hljs-string">"processEngine"</span> <span class="hljs-attr">factory-method</span>=<span class="hljs-string">"getRepositoryService"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"runtimeService"</span> <span class="hljs-attr">factory-bean</span>=<span class="hljs-string">"processEngine"</span> <span class="hljs-attr">factory-method</span>=<span class="hljs-string">"getRuntimeService"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"taskService"</span> <span class="hljs-attr">factory-bean</span>=<span class="hljs-string">"processEngine"</span> <span class="hljs-attr">factory-method</span>=<span class="hljs-string">"getTaskService"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"historyService"</span> <span class="hljs-attr">factory-bean</span>=<span class="hljs-string">"processEngine"</span> <span class="hljs-attr">factory-method</span>=<span class="hljs-string">"getHistoryService"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"managementService"</span> <span class="hljs-attr">factory-bean</span>=<span class="hljs-string">"processEngine"</span> <span class="hljs-attr">factory-method</span>=<span class="hljs-string">"getManagementService"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"identityService"</span> <span class="hljs-attr">factory-bean</span>=<span class="hljs-string">"processEngine"</span> <span class="hljs-attr">factory-method</span>=<span class="hljs-string">"getIdentityService"</span> /&gt;</span>
</code></pre>
</li>
<li><p>Test Class: </p>
<pre><code class="nulljava"><span class="hljs-meta">@ContextConfiguration</span>(<span class="hljs-string">"classpath:beans-test.xml"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TaskSpringTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SpringActivitiTestCase</span>
</span>{
  <span class="hljs-meta">@Deployment</span>(resources=<span class="hljs-string">"bpmn/task/ServiceTask-spring.bpmn"</span>)
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testServiceTask</span><span class="hljs-params">()</span></span>{
      ProcessInstance procInst=runtimeService.startProcessInstanceByKey(<span class="hljs-string">"serviceTaskSpringTest"</span>);

      <span class="hljs-comment">//User Task1</span>
      Task task=taskService.createTaskQuery().singleResult();
      assertTrue(<span class="hljs-string">"User Task1"</span>.equals(task.getName()));
      taskService.complete(task.getId());

      <span class="hljs-comment">//Service Task -- auto execute!</span>

      <span class="hljs-comment">//User Task2</span>
      task=taskService.createTaskQuery().singleResult();
      assertTrue(<span class="hljs-string">"User Task2"</span>.equals(task.getName()));

      String var=(String)taskService.getVariable(task.getId(), <span class="hljs-string">"serviceVar"</span>);
      assertTrue(<span class="hljs-string">"Hello"</span>.equals(var));

      taskService.complete(task.getId());
      assertProcessEnded(procInst.getId());
  }
}
</code></pre>
</li>
</ul>
</li>
</ul>
<h2 id="header-24">功能组件介绍</h2>
<h3 id="header-25">Service</h3>
<p>引擎API：</p>
<ul>
<li><p>RepositoryService：流程资源服务的接口，主要用于对流程定义的部署、查询和删除操作</p>
<ul>
<li><code>repositoryService.createProcessDefinitionQuery()</code></li>
<li><code>repositoryService.getBpmnModel(procDefId)</code></li>
<li><code>repositoryService.createDeployment()</code></li>
<li><code>repositoryService.getDeploymentResourceNames(deploymentId)</code></li>
<li><code>repositoryService.getResourceAsStream(...)</code></li>
<li><code>repositoryService.getProcessDiagram(processDefinitionId)</code></li>
<li>…</li>
</ul>
</li>
<li><p>RuntimeService：运行时服务接口，主要对流程实例，变量，活动等的操作</p>
<ul>
<li><code>runtimeService.startProcessInstanceByXxx(...)</code></li>
<li><code>runtimeService.createExecutionQuery()</code></li>
<li><code>runtimeService.getActiveActivityIds(procInstId);</code></li>
<li>…</li>
</ul>
</li>
<li><p>TaskService：任务服务接口</p>
<ul>
<li><code>taskService.createTaskQuery()</code></li>
<li><code>taskService.claim(taskId, userId);</code></li>
<li><code>taskService.complete(taskId);</code></li>
<li><code>taskService.createAttachment(...)</code></li>
<li><code>taskService.addComment(...)</code></li>
<li>…</li>
</ul>
</li>
<li><p>HistoryService：流程历史的服务接口</p>
<ul>
<li><code>historyService.createHistoricVariableInstanceQuery()</code></li>
<li><code>historyService.createHistoricProcessInstanceQuery()</code></li>
<li><code>historyService.createHistoricTaskInstanceQuery()</code></li>
<li>…</li>
</ul>
</li>
<li><p>IdentityService：用户、组管理服务接口，用于管理Group、User、Membership</p>
<ul>
<li><code>identityService.setAuthenticatedUserId(userId);</code></li>
<li><code>identityService.createUserQuery()</code></li>
<li><code>identityService.createGroupQuery()</code></li>
<li>newUser,saveUser,deleteUser,…</li>
<li>newGroup,saveGroup,deleteGroup,…</li>
<li>newMembership,saveMembership,deleteMemberShip,…</li>
<li>…</li>
</ul>
</li>
<li><p>FormService：表单服务接口，用于访问表单数据，渲染表单等操作</p>
<ul>
<li><code>formService.getXxxFormData(...)</code></li>
<li><code>formService.getRenderedXxxFormData(...)</code></li>
<li><code>formService.submitXxxFormData(...)</code></li>
<li>…</li>
</ul>
</li>
<li><p>ManagementService：提供流程管理和控制操作的接口服务</p>
<pre><code class="nulljava">  String jobId=managementService.createJobQuery()
      .processInstanceId(<span class="hljs-string">"2401"</span>)
      .singleResult()
      .getId();
  managementService.executeJob(jobId);
</code></pre>
</li>
</ul>
<h3 id="header-26">Tables</h3>
<p>Activiti 数据库中表的命名都是以 <code>ACT_</code>开头</p>
<ul>
<li><code>ACT_RE_*</code>： Repository。存储静态信息，如：流程定义、流程的资源（图片、规则）。</li>
<li><code>ACT_RU_*</code>： Runtime。运行时的表<ul>
<li>Activiti 只存储流程实例执行期间的运行时数据</li>
<li>如：流程变量、用户任务、变量、作业等</li>
<li>当流程实例结束时，将删除这些记录</li>
</ul>
</li>
<li><code>ACT_ID_*</code>：Identity。记录标识信息，如：用户、用户组等</li>
<li><code>ACT_HI_*</code>：History。记录历史的相关数据，如：结束的流程实例、变量、任务等</li>
<li><code>ACT_GE_*</code>：General。记录通用数据</li>
</ul>
<h3 id="header-27">Var</h3>
<ol>
<li>运行时变量，存放在<code>act_ru_variable</code>表中<ul>
<li>全局变量</li>
<li>本地变量</li>
</ul>
</li>
<li>历史变量，涉及表<code>act_hi_detail</code>,<code>act_hi_varinst</code><ul>
<li>有4个历史级别：<ul>
<li>none: 不保存任何历史记录，可以提高系统性能；</li>
<li>activity：保存所有的流程实例、任务、活动信息；</li>
<li>audit：也是Activiti的默认级别，保存所有的流程实例、任务、活动、表单属性；</li>
<li>full： 最完整的历史记录，除了包含audit级别的信息之外还能保存详细，例如：流程变量</li>
</ul>
</li>
<li>可配置：<pre><code class="nullxml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"processEngineConfiguration"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.activiti.spring.SpringProcessEngineConfiguration"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"history"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"full"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>
</code></pre>
</li>
<li>查询变量：<pre><code class="nulljava">List&lt;historicvariableinstance&gt; list = historyService.createHistoricVariableInstanceQuery()
          .processInstanceId(processInstanceId)
          .list();
<span class="hljs-keyword">for</span> (HistoricVariableInstance variable : list) {
System.out.println(<span class="hljs-string">"variable: "</span> + variable.getVariableName() + <span class="hljs-string">" = "</span> + variable.getValue());
}
</code></pre>
</li>
<li>只查询表单字段：<pre><code class="nulljava">List&lt;historicdetail&gt; formProperties = historyService.createHistoricDetailQuery()
          .processInstanceId(processInstance.getId())
          .formProperties()
          .list();
<span class="hljs-keyword">for</span> (HistoricDetail historicDetail : formProperties) {
  HistoricFormProperty field = (HistoricFormProperty) historicDetail;
  System.out.println(<span class="hljs-string">"field id: "</span> + field.getPropertyId() + <span class="hljs-string">", value: "</span> + field.getPropertyValue());
}
</code></pre>
</li>
</ul>
</li>
</ol>
<h3 id="header-28">User</h3>
<p>统一身份管理：</p>
<ul>
<li>Activiti用户管理系统<ul>
<li>使用<code>identityService</code> 管理User，Group，Membership</li>
<li>关联的表：<code>act_id_user</code>,<code>act_id_info</code>,<code>act_id_group</code>,<code>act_id_membership</code></li>
<li>在流程定义中可直接使用定义的User，Group，例如<ul>
<li><code>activiti:candidateGroups=&quot;admin,manager&quot;</code></li>
<li><code>activiti:candidateUsers=&quot;Tom,Jerry&quot;</code></li>
</ul>
</li>
</ul>
</li>
<li>业务系统的用户管理系统，比如<ul>
<li>使用LDAP</li>
<li>使用部门，角色，权限等更为复杂的组织系统</li>
</ul>
</li>
<li>结合方式：<ul>
<li>业务系统操作时同步管理Activiti用户数据（调用identityService）</li>
<li>自定义SessionFactory，非侵入式替换接口实现</li>
<li>用视图覆盖同名的<code>ACT_ID_*</code>系列表（需在引擎配置中设置属性<code>dbIdentityUsed</code>为false）</li>
</ul>
</li>
</ul>
<h3 id="header-29">Form</h3>
<h4 id="header-30">Activiti管理表单</h4>
<ul>
<li>配置在流程定义中（可加在StartEvent，Task节点上）</li>
<li>表单支持变量自动替换（UEL语法）</li>
<li>表单内容以key-value形式保存在表<code>act_hi_detail</code>中</li>
<li><p>使用方式一：在流程定义文件中用<code>activiti:formProperty</code>属性定义</p>
<ul>
<li>表单没有布局，所有的表单元素会顺序逐行输出在页面<pre><code class="nullxml">  <span class="hljs-tag">&lt;<span class="hljs-name">startevent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"startevent1"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"Start"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">extensionelements</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">activiti:formproperty</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"Name"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"string"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">activiti:formproperty</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">extensionelements</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">startevent</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">usertask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"usertask1"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"First Step"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">extensionelements</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">activiti:formproperty</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"setInFirstStep"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"SetInFirstStep"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"date"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">activiti:formproperty</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">activiti:formproperty</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"remark"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"Remark"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"string"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">activiti:formproperty</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">extensionelements</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">usertask</span>&gt;</span>
</code></pre>
</li>
<li>通过<code>formService.getXxxForm</code>获取表单：<ul>
<li><code>formService.getStartFormData(processDefinitionId)</code>，返回<code>StartFormData</code></li>
<li><code>formService.getTaskFormData(taskId)</code>，返回<code>TaskFormData</code></li>
</ul>
</li>
<li>提交表单：<code>formService.submitXxxFormData(...)</code></li>
</ul>
</li>
<li><p>使用方式二：在流程定义文件中用<code>activiti:formkey</code>属性引用</p>
<ul>
<li>流程运行时从部署的表单文件中读取，原样输出显示</li>
<li>注意：表单内容写好保存到<code>.form</code>文件，需同流程定义文件一同部署<pre><code class="nullxml"><span class="hljs-tag">&lt;<span class="hljs-name">process</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"FormKey"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"FormKey"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">startevent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"startevent1"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"Start"</span> <span class="hljs-attr">activiti:formkey</span>=<span class="hljs-string">"form/start.form"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">startevent</span>&gt;</span>
  …
<span class="hljs-tag">&lt;/<span class="hljs-name">process</span>&gt;</span>
</code></pre>
</li>
<li>通过<code>formService.getRenderedXxxForm</code>获取表单：<ul>
<li><code>formService.getRenderedStartForm(processDefinitionId)</code></li>
<li><code>formService.getRenderedTaskForm(taskId)</code></li>
<li>注意： return Object （返回内容是经FormEngine处理过的）</li>
<li>默认使用的表单引擎为JuelFormEngine，可自定义进行扩展</li>
</ul>
</li>
<li>提交表单：<code>formService.submitXxxFormData(...)</code></li>
</ul>
</li>
</ul>
<h4 id="header-31">非Activiti管理表单</h4>
<ul>
<li>表单呈现自定义</li>
<li>表单内容置于自定义的Table中，通过<code>businessKey</code>传入与流程关联</li>
</ul>
<h2 id="header-32">常见应用</h2>
<h3 id="header-33">Attachment &amp; Comment</h3>
<p>都是存放在历史记录中的，即<code>act_hi_attachment</code>,<code>act_hi_comment</code></p>
<p>Attachment：</p>
<ol>
<li>涉及到的table：<code>act_hi_attachment</code>,<code>act_ge_bytearray</code>, <code>act_hi_comment</code></li>
<li>添加attachment，两种方式：<ul>
<li>方式一：使用 inputStream<ul>
<li>inputStream 的实际内容存放在 <code>act_ge_bytearray</code>中,通过contentId关联</li>
<li><code>taskService.createAttachment(attachmentType, taskId, processInstanceId, attachmentName, attachmentDescription, content)</code></li>
</ul>
</li>
<li>方式二：使用 url<ul>
<li><code>taskService.createAttachment(attachmentType, taskId, processInstanceId, attachmentName, attachmentDescription, url)</code></li>
</ul>
</li>
</ul>
</li>
<li>会在act_hi_comment表中插入数据 （type:event,action:AddAttachment,message:attachmentName,full_msg:null）</li>
<li>获取Attachment(search <code>act_hi_attachment</code>):<ul>
<li>方式一：<code>List&lt;Attachment&gt; taskService.getTaskAttachments(taskId);</code></li>
<li>方式二：<code>List&lt;Attachment&gt; taskService.getProcessInstanceAttachments(procInstId);</code></li>
</ul>
</li>
</ol>
<p>Comment：</p>
<ol>
<li>涉及到的table：act_hi_comment</li>
<li>添加comment:<ul>
<li><code>taskService.addComment(taskId, processInstanceId, message)</code></li>
<li><code>taskService.addComment(taskId, processInstanceId, type, message)</code></li>
</ul>
</li>
<li>会在act_hi_comment表中插入数据 （type:comment,action:AddComment,full_msg:msg）</li>
<li>获取Comment(search act_hi_comment)：<ul>
<li>方式一：<code>List&lt;Comment&gt; taskService.getTaskComments(taskId);</code></li>
<li>方式二：<code>List&lt;Comment&gt; taskService.getProcessInstanceComments(procInstId);</code> （会查出因为createAttachment而添加的comment记录）</li>
</ul>
</li>
</ol>
<h3 id="header-34">多实例</h3>
<pre><code class="nullxml"><span class="hljs-tag">&lt;<span class="hljs-name">userTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"miTasks"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"My Task"</span> <span class="hljs-attr">activiti:assignee</span>=<span class="hljs-string">"${user}"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">multiInstanceLoopCharacteristics</span> <span class="hljs-attr">isSequential</span>=<span class="hljs-string">"false"</span>
    <span class="hljs-attr">activiti:collection</span>=<span class="hljs-string">"${myService.resolveUsersForTask()}"</span> <span class="hljs-attr">activiti:elementVariable</span>=<span class="hljs-string">"user"</span> &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">completionCondition</span>&gt;</span>${nrOfCompletedInstances/nrOfInstances &gt;= 0.6 }<span class="hljs-tag">&lt;/<span class="hljs-name">completionCondition</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">multiInstanceLoopCharacteristics</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">userTask</span>&gt;</span>
</code></pre>
<ul>
<li><code>isSequential=&quot;true&quot;</code> 顺序执行（多级串行）</li>
<li><code>isSequential=&quot;false&quot;</code> 并行执行（并行会签）</li>
<li>每个上级流程为每个实例创建分支时都要提供如下变量：<ul>
<li><code>nrOfInstances</code>：实例总数</li>
<li><code>nrOfActiveInstances</code>：当前活动的实例数量 （对于顺序执行的多实例，值一直为1）</li>
<li><code>nrOfCompletedInstances</code>：已经完成实例的数目</li>
<li>可以通过<code>execution.getVariable(x)</code>方法获得这些变量</li>
</ul>
</li>
<li>每个创建的分支都会有分支级别的本地变量（临时）<ul>
<li>其他实例不可见， 不会保存到流程实例级别</li>
<li>比如：<code>loopCounter</code>（表示特定实例的在循环的索引值）</li>
</ul>
</li>
</ul>
<h3 id="header-35">CallActivity &amp; SubProcess</h3>
<p><code>CallActivity</code> 调用外部定义的流程</p>
<ul>
<li>New ProcessInstance</li>
<li>Business Key is null</li>
<li>for transfer: set inputParamater &amp; outParamater</li>
<li>search by some unique var</li>
</ul>
<p><code>SubProcess</code> 子流程 （内嵌在当前流程定义中）</p>
<ul>
<li>has Main Process information</li>
</ul>
<p><img src="/2013/10/01/reqStation.png" alt="CallActiviti &amp; SubProcess"><br>（包含SubProcess和CallActivity）<br><img src="/2013/10/01/basicSingle.png" alt="BasicSingle"><br>（被Call的外部流程定义）</p>
<h3 id="header-36">Transaction 事务</h3>
<ul>
<li><p>Case1: serviceTask[处理成功申请] 同步，即设置<code>activiti:async=&quot;false&quot;</code> （默认）</p>
<pre><code class="nullxml"><span class="hljs-tag">&lt;<span class="hljs-name">serviceTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"service1"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"处理成功申请"</span> <span class="hljs-attr">activiti:class</span>=<span class="hljs-string">"my.custom.Delegate"</span> <span class="hljs-attr">activiti:async</span>=<span class="hljs-string">"false"</span></span>
</code></pre>
<p><img src="/2013/10/01/asyncFalse.png" alt="Async False"></p>
</li>
<li><p>Case2: serviceTask[处理成功申请] 异步，即设置<code>activiti:async=&quot;true&quot;</code>，打开<code>jobExecutorActivate</code>（processEngineConfiguration中）</p>
<pre><code class="nullxml"><span class="hljs-tag">&lt;<span class="hljs-name">serviceTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"service1"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"处理成功申请"</span> <span class="hljs-attr">activiti:class</span>=<span class="hljs-string">"my.custom.Delegate"</span> <span class="hljs-attr">activiti:async</span>=<span class="hljs-string">"true"</span></span>
</code></pre>
<p><img src="/2013/10/01/asyncTrue.png" alt="Async True"><br>（后续执行失败后回滚到此异步task）</p>
</li>
</ul>
<p><strong>异步执行说明：</strong></p>
<ul>
<li>异步只是指：执行方式异步</li>
<li>即启动新的线程（相对于主线程），但在流程控制上，若流程未完结，不会提前执行下一个节点</li>
<li>异步执行是一个新的执行单元（Transaction原子）</li>
<li>所以设置异步执行，流程不会提前结束，会继续执行下一个节点直到流程结束</li>
</ul>
<p><strong>异步节点：TimerCatchEvent</strong></p>
<ol>
<li>Timer无异步设置,本身就是异步执行的，执行失败（Timer或后面同步节点异常）会停留在TimerCatchEvent节点</li>
<li>在流程中设置Timer，会等到Timer执行完成后流程才能结束</li>
<li>Timer Event: start (流程执行到此Timer节点时触发)，end(此异步Timer完成到达设置的执行时间时触发)<ul>
<li>trigger startEvent</li>
<li>create async thread (Sleep)</li>
<li>at setup time(Weakup)</li>
<li>trigger endEvent</li>
<li>next Activity</li>
</ul>
</li>
</ol>
<p><strong>PS：</strong><br>一般情况下，执行一个task为一个原子，执行<code>taskService.complete(taskId)</code> 时，若其中发生异常，将回滚 （这个task中发生的所有操作都会回滚，不用担心业务数据和流程数据不同步的问题）</p>
<h3 id="header-37">流程跟踪</h3>
<ul>
<li>方式一：Activiti流程引擎根据流程定义文件(.xml)生成图片<ul>
<li>方便，不灵活，易错位</li>
<li>可直接生成Highlight Activity的图片</li>
<li>弊端：坐标错位不一致，中文乱码，Flow上文字不显示</li>
</ul>
</li>
<li>方式二：直接获取部署时上传的对应流程图<ul>
<li>灵活，复杂</li>
<li>读取图片后通过前端Javascript和Css配合跟踪（Highlight Activity）</li>
<li>可利用静态服务提升读取Activiti流程图的性能</li>
<li>弊端：同方法一</li>
</ul>
</li>
<li>方式三：使用Diagram Viewer流程图跟踪组件<ul>
<li>灵活，方便</li>
<li>根据读取的数据，在前端绘制流程图</li>
</ul>
</li>
</ul>
<h4 id="header-38">使用流程定义文件(.xml)</h4>
<ul>
<li>生成流程图<pre><code class="nulljava">BpmnModel bpmnModel=repositoryService.getBpmnModel(procInst.getProcessDefinitionId());
InputStream in=ProcessDiagramGenerator.generatePngDiagram(bpmnModel);
</code></pre>
</li>
<li>生成活动节点标记的流程图(activeActivity)<pre><code class="nulljava">List&lt;String&gt; activityIds=runtimeService.getActiveActivityIds(procInst.getId());
InputStream in=ProcessDiagramGenerator.generateDiagram(bpmnModel, <span class="hljs-string">"png"</span>, activityIds);
</code></pre>
</li>
<li>生成带活动踪迹的流程图(activeActivity+historyFlow)<pre><code class="nulljava">List&lt;String&gt; highLightedFlows = getHighLightedFlows(processDefinition , processInstanceId);     <span class="hljs-comment">//具体实现参考ProcessInstanceHighlightsResource.java</span>
InputStream in=ProcessDiagramGenerator.generateDiagram(bpmnModel, <span class="hljs-string">"png"</span>, activityIds,highLightedFlows);
</code></pre>
</li>
</ul>
<h4 id="header-39">使用部署上传的流程图</h4>
<p>这种方式在优势灵活性很大，可以显示你要展示的所有信息；<br>因为完全就是一堆信息点汇合起来的跟踪功能，需要后端提供数据给前端分析；<br>例如：有哪些Activity及其坐标、高度、宽度、是否当前节点等信息</p>
<p><img src="/2013/10/01/diagram1.png" alt="Diagram"></p>
<p>后端： </p>
<ul>
<li>获取流程图<ul>
<li>方法一：<pre><code class="nulljava">InputStream in=repositoryService.getProcessDiagram(processDefinitionId);
</code></pre>
</li>
<li>方法二：<pre><code class="nulljava">String resourceName = procDef.getDiagramResourceName();
InputStream in = repositoryService.getResourceAsStream(processDefinitionId, resourceName);
</code></pre>
</li>
</ul>
</li>
<li>获取流程定义的所有节点信息(All Activities Info)<ul>
<li>Process内部节点(即活动)等详细信息：ActivityImpl</li>
<li>记录在bmpn文件中（运行时加载解析bmpn文件到内存中）</li>
<li>通过RepositoryService的<code>getProcessDefinition(id)</code>方法从内存中获取Activity定义信息<pre><code class="nulljava">ProcessDefinitionEntity processDefinition = (ProcessDefinitionEntity) ((RepositoryServiceImpl) repositoryService)
                        .getDeployedProcessDefinition(procInst.getProcessDefinitionId());
List&lt;ActivityImpl&gt; activitiList = processDefinition.getActivities();<span class="hljs-comment">//获得当前流程定义的所有节点</span>
</code></pre>
</li>
</ul>
</li>
<li><p>获取当前活动节点信息(Active Activity Info)</p>
<ul>
<li><p>注意：示例中是返回所有节点信息（包括标注是否为当前活动节点）</p>
<pre><code class="nulljava">ProcessDefinitionEntity processDefinition = (ProcessDefinitionEntity) ((RepositoryServiceImpl) repositoryService )
                    .getDeployedProcessDefinition(procInst.getProcessDefinitionId());

List&lt;String&gt; activityIds=runtimeService.getActiveActivityIds(procInst.getId());
List&lt;Map&lt;String, Object&gt;&gt; activityInfos= <span class="hljs-keyword">new</span> ArrayList&lt;Map&lt;String, Object&gt;&gt;();

<span class="hljs-keyword">for</span>(String id:activityIds){
   ActivityImpl activity=processDefinition.findActivity(id);
   Map&lt;String,Object&gt; activityImageInfo=<span class="hljs-keyword">new</span> HaspMap&lt;String,Object&gt;();
   activityImageInfo.put( <span class="hljs-string">"x"</span>, activity.getX());
   activityImageInfo.put( <span class="hljs-string">"y"</span>, activity.getY());
   activityImageInfo.put( <span class="hljs-string">"width"</span>, activity.getWidth());
   activityImageInfo.put( <span class="hljs-string">"height"</span>, activity.getHeight());
   activityInfos.add(activityImageInfo);
}
</code></pre>
</li>
</ul>
</li>
</ul>
<p>前端：</p>
<ul>
<li>用js和css配合动态标记当前节点（可参考kft-activiti-demo项目的workflow.js代码）</li>
</ul>
<h4 id="header-40">使用Diagram Viewer组件</h4>
<ul>
<li>这是官方在5.12版本中提供的一个 Javascript跟踪工具，使用方便，</li>
<li>简单配置就可以使用，兼容各种浏览器，并且可以自己扩展</li>
<li>以Raphaël为基础库，用REST方式获取JSON数据，生成流程图并把流程的处理过程用不同的颜色加以标注</li>
</ul>
<p><img src="/2013/10/01/diagram2.png" alt="Diagram"></p>
<p>后端：</p>
<ol>
<li>添加依赖包<pre><code class="nullxml"> <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.activiti<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>activiti-diagram-rest<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${activiti.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
</li>
<li><p>配置一个REST拦截器</p>
<ul>
<li>可使用自定义也可使用activiti自带的DiagramRestApplication</li>
<li><code>web.xml</code><pre><code class="nullxml"><span class="hljs-comment">&lt;!-- Activiti: Restlet adapter - used to expose modeler functionality through REST --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">servlet</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>MyActivitiRestletServlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">servlet-class</span>&gt;</span>org.restlet.ext.servlet.ServerServlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-class</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">init-param</span>&gt;</span>
      <span class="hljs-comment">&lt;!-- Application class name --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>org.restlet.application<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span>
      <span class="hljs-comment">&lt;!-- &lt;param-value&gt;org.activiti.rest.diagram.application.DiagramRestApplication&lt;/param-value&gt; --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>com.cj.xxx.MyActivitiRestApplication<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">init-param</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">servlet</span>&gt;</span>
<span class="hljs-comment">&lt;!-- Catch all service requests --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">servlet-mapping</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>MyActivitiRestletServlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/service/*<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-mapping</span>&gt;</span>
</code></pre>
</li>
<li><p><code>MyActivitiRestApplication.java</code></p>
<pre><code class="nulljava"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyActivitiRestApplication</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ActivitiRestApplication</span></span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyActivitiRestApplication</span><span class="hljs-params">()</span></span>{
      <span class="hljs-keyword">super</span>();
  }

  <span class="hljs-comment">/**
   * Creates a root Restlet that will receive all incoming calls.
   */</span>
  <span class="hljs-meta">@Override</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> Restlet <span class="hljs-title">createInboundRoot</span><span class="hljs-params">()</span></span>{
      Router router = <span class="hljs-keyword">new</span> Router(getContext());
      router.attachDefault(DefaultResource.class);
      <span class="hljs-comment">//DiagramServicesInit.attachResources(router);</span>

      router.attach(<span class="hljs-string">"/process-instance/{processInstanceId}/highlights"</span>, ProcessInstanceHighlightsResource.class);
      router.attach(<span class="hljs-string">"/process-instance/{processInstanceId}/diagram-layout"</span>, ProcessDefinitionDiagramLayoutResource.class);
      router.attach(<span class="hljs-string">"/process-definition/{processDefinitionId}/diagram-layout"</span>, MyProcessDefinitionDiagramLayoutResource.class);

      JsonpFilter jsonpFilter = <span class="hljs-keyword">new</span> JsonpFilter(getContext());
      jsonpFilter.setNext(router);
      <span class="hljs-keyword">return</span> jsonpFilter;
  }
}
</code></pre>
</li>
</ul>
</li>
</ol>
<p>前端使用：</p>
<p>复制Diagram Viewer组件到项目</p>
<ul>
<li>从官网包<code>activiti-explorer.war</code>中找到<code>diagram-viewer</code>拷贝到项目</li>
<li>根据需要编写修改js文件，在页面中应用</li>
</ul>
<p>测试：</p>
<ol>
<li><p>获取完整效果，eg：</p>
<ul>
<li>trigger: <code>baseUrl+/resources/diagram-viewer/index.html?processDefinitionId=leave:1:4&amp;processInstanceId=5</code></li>
<li>响应的HTML上面绘制了对应的流程追踪图</li>
</ul>
</li>
<li><p>获取流程定义所有元素信息，eg：</p>
<ul>
<li>trigger: <code>baseUrl + &quot;/service/process-definition/{processDefinitionId}/diagram-layout?callback=?&quot;</code></li>
<li>or trigger: <code>baseUrl + &quot;/service/process-definition/{processDefinitionKey}/diagram-layout?callback=?&quot;</code></li>
<li>result:<pre><code class="nulljson">{"processDefinition":{"id":"leave:1:20","name":"请假流程","key":"leave","version":1,"deploymentId":"1","isGraphicNotationDefined":true},
"activities":[
    {"activityId":"deptLeaderAudit","properties":{"name":"部门领导审批","type":"userTask"},"x":90,"y":80,"width":105,"height":55},
    {"activityId":"exclusivegateway5","properties":{"name":"Exclusive Gateway","type":"exclusiveGateway"},"x":250,"y":87,"width":40,"height":40},
    {"activityId":"modifyApply","properties":{"name":"调整申请","type":"userTask"},"x":218,"y":190,"width":105,"height":55},
    {"activityId":"hrAudit","properties":{"name":"人事审批","type":"userTask"},"x":358,"y":80,"width":105,"height":55},
    {"activityId":"exclusivegateway6","properties":{"name":"Exclusive Gateway","type":"exclusiveGateway"},"x":495,"y":87,"width":40,"height":40},
    {"activityId":"reportBack","properties":{"name":"销假","type":"userTask"},"x":590,"y":80,"width":105,"height":55},
    {"activityId":"exclusivegateway7","properties":{"name":"Exclusive Gateway","type":"exclusiveGateway"},"x":250,"y":280,"width":40,"height":40},
    {"activityId":"startevent1","properties":{"name":"Start","type":"startEvent"},"x":10,"y":90,"width":35,"height":35},
    {"activityId":"endevent1","properties":{"name":"End","type":"endEvent"},"x":625,"y":283,"width":35,"height":35}
    ],
"sequenceFlows":[
    {"id":"flow3","name":"","flow":"(deptLeaderAudit)--flow3--&gt;(exclusivegateway5)","xPointArray":[195,250],"yPointArray":[107,107]},
    {"id":"flow4","name":"不同意","flow":"(exclusivegateway5)--flow4--&gt;(modifyApply)","xPointArray":[270,270],"yPointArray":[127,190]},
    {"id":"flow5","name":"同意","flow":"(exclusivegateway5)--flow5--&gt;(hrAudit)","xPointArray":[290,358],"yPointArray":[107,107]},
    {"id":"flow11","name":"","flow":"(modifyApply)--flow11--&gt;(exclusivegateway7)","xPointArray":[270,270],"yPointArray":[245,280]},
    {"id":"flow6","name":"","flow":"(hrAudit)--flow6--&gt;(exclusivegateway6)","xPointArray":[463,495],"yPointArray":[107,107]},
    {"id":"flow7","name":"同意","flow":"(exclusivegateway6)--flow7--&gt;(reportBack)","xPointArray":[535,590],"yPointArray":[107,107]},
    {"id":"flow9","name":"不同意","flow":"(exclusivegateway6)--flow9--&gt;(modifyApply)","xPointArray":[515,514,323],"yPointArray":[127,217,217]},
    {"id":"flow8","name":"","flow":"(reportBack)--flow8--&gt;(endevent1)","xPointArray":[642,642],"yPointArray":[135,283]},
    {"id":"flow10","name":"重新申请","flow":"(exclusivegateway7)--flow10--&gt;(deptLeaderAudit)","xPointArray":[250,142,142],"yPointArray":[300,299,135]},
    {"id":"flow12","name":"结束流程","flow":"(exclusivegateway7)--flow12--&gt;(endevent1)","xPointArray":[290,625],"yPointArray":[300,300]},
    {"id":"flow2","name":"","flow":"(startevent1)--flow2--&gt;(deptLeaderAudit)","xPointArray":[45,90],"yPointArray":[107,107]}
    ]
};
</code></pre>
</li>
</ul>
</li>
<li><p>获取当前活动节点和线信息进行高亮处理，eg：</p>
<ul>
<li>trigger: <code>baseUrl + &quot;/service/process-instance/{processInstanceId}/highlights?callback=?&quot;</code></li>
<li>result: <pre><code class="nulljson">{&quot;processInstanceId&quot;:&quot;108&quot;,&quot;processDefinitionId&quot;:&quot;leave:1:20&quot;,&quot;activities&quot;:[&quot;hrAudit&quot;],&quot;flows&quot;:[&quot;flow2&quot;,&quot;flow3&quot;,&quot;flow5&quot;]});
</code></pre>
</li>
</ul>
</li>
</ol>
<h2 id="header-41">Reference</h2>
<ul>
<li><a href="http://activiti.org/" target="_blank" rel="noopener">Activiti官网</a></li>
<li><a href="http://forums.activiti-cn.org/" target="_blank" rel="noopener">Activiti 中文论坛</a></li>
<li><a href="http://www.mossle.com/docs/activiti/" target="_blank" rel="noopener">Activiti 用户手册</a></li>
<li>推荐博文:<a href="http://www.kafeitu.me/activiti.html" target="_blank" rel="noopener">咖啡兔</a> | <a href="http://www.infoq.com/cn/articles/bpmn2-activiti5?utm_source=bshare&amp;utm_campaign=bshare&amp;utm_medium=sinaminiblog&amp;bsh_bid=91185688" target="_blank" rel="noopener">BPMN2新规范与Activiti5</a></li>
<li>Activiti Online Projects: <a href="http://mossle.com/" target="_blank" rel="noopener">lemon</a>| <a href="http://www.jee-soft.cn/htsite/index.html" target="_blank" rel="noopener">宏天</a></li>
</ul>
  </section>
</article>

      <hr/>
      
<section class="post-comment">
	
		<div id="gitment_container"></div>

<link rel="stylesheet" href="/gitment/default.css">
<script src="/gitment/gitment.browser.js"></script>


<script type="text/javascript">
	var gitment = new Gitment({
	  owner: 'sixdegree',
	  repo: 'sixDegree.github.io',
	  oauth: {
	    client_id: '36a09bb7399efe69c6ce',
	    client_secret: 'f28f2c5fff964d8e5d1a6ebdee77e6a890a8ac94',
	  },
	})
	gitment.render('gitment_container')
</script>
	
</section>

    </div>
  </div>
</body>

<script src="/jquery/dist/jquery.min.js"></script>
<script src="/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/highlight/highlight.pack.js"></script>
<script type="text/javascript">
  hljs.initHighlightingOnLoad();
  
  $(document).ready(function(){
    var sidebarCtrl=$("#sidebar-ctrl");
    var sidebar=$("#sidebar");
    var wrapper=$("#wrapper");
    sidebarCtrl.on("click",function(event){
        //alert("click");
        sidebar.toggleClass("sidebar-toggle");
        wrapper.toggleClass("sidebar-toggle");
        sidebarCtrl.toggleClass("sidebar-toggle");
        sidebarCtrl.toggleClass("active");
    })
  });
</script>


</html>
