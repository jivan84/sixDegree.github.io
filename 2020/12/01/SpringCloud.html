<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Spring Cloud</title>
  
  <!-- Meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="micro service,spring cloud,spring cloud alibaba">
  
  

  <!-- Feed -->
  
    <link rel="alternative" href="/atom.xml" title="SixDegree" type="application/atom+xml">
  

  <!-- CSS -->
  <link rel="stylesheet" href="/bootstrap/dist/css/bootstrap.css">
  
	
		<link rel="stylesheet" href="/highlight/demo/styles/tomorrow-night-bright.css">
	
    
  
  <link rel="stylesheet" href="/css/fontello.css">
  <link rel="stylesheet" href="/css/style.css">

  <!-- Site Analyse -->
  
	<script>
	var userID='2bbb83cc0f781dd7502e9d5e19661866';
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?"+userID;
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>


</head>

<body data-spy="scroll" data-target="#nav-catalog">
  <div id="top-push"></div>
<a href="#top-push" id="go-top">
	<span class="glyphicon glyphicon-chevron-up"></span>
</a>
  <aside id="sidebar">
    <section class="sidebar-header">Catalog</section>
     <nav id="nav-catalog">
        <ol class="sidebar-nav nav"><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#header-1"><span class="sidebar-nav nav-text">Starter</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#header-2"><span class="sidebar-nav nav-text">服务注册&配置中心：Nacos (Spring Cloud Alibaba)</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-3"><span class="sidebar-nav nav-text">Nacos Server</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-4"><span class="sidebar-nav nav-text">Nacos 服务注册</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-5"><span class="sidebar-nav nav-text">Nacos 服务配置</span></a></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#header-6"><span class="sidebar-nav nav-text">链路追踪：Sleuth & Zipkin</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-7"><span class="sidebar-nav nav-text">Sleuth</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-8"><span class="sidebar-nav nav-text">Zipkin</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-9"><span class="sidebar-nav nav-text">Sample</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-10"><span class="sidebar-nav nav-text">优化：链路数据持久化（默认存储在内存）</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-11"><span class="sidebar-nav nav-text">优化：链路数据传输方式（默认Http方式发送给Zipkin Server）</span></a></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#header-12"><span class="sidebar-nav nav-text">服务调用：OpenFeign (Spring Cloud)</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#header-13"><span class="sidebar-nav nav-text">服务降级：Sentinel（Spring Cloud Alibaba）</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-14"><span class="sidebar-nav nav-text">Sentinel 控制台</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-15"><span class="sidebar-nav nav-text">Sample</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-16"><span class="sidebar-nav nav-text">限流规则持久化</span></a></li></ol></li><li class="sidebar-nav nav-item sidebar-nav nav-level-2"><a class="sidebar-nav nav-link" href="#header-17"><span class="sidebar-nav nav-text">服务网关：Gateway（Spring Cloud)</span></a><ol class="sidebar-nav nav-child"><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-18"><span class="sidebar-nav nav-text">Sample</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-19"><span class="sidebar-nav nav-text">predicates 断言</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-20"><span class="sidebar-nav nav-text">开启微服务名称转发</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-21"><span class="sidebar-nav nav-text">过滤器</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-22"><span class="sidebar-nav nav-text">网关限流</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-23"><span class="sidebar-nav nav-text">网关限流：基于Filter</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-24"><span class="sidebar-nav nav-text">网关限流：基于Sentinel</span></a></li><li class="sidebar-nav nav-item sidebar-nav nav-level-3"><a class="sidebar-nav nav-link" href="#header-25"><span class="sidebar-nav nav-text">网关高可用</span></a></li></ol></li></ol>
    </nav>
  </aside>
  <span id="sidebar-ctrl" class="glyphicon glyphicon-list-alt circle"></span>
  <div id="wrapper">
    <header>
  <nav class="navbar navbar-default">
    <div class="container-fluid">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#nav-menu" aria-expanded="false">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="/">SixDegree</a>
      </div>
      <div class="collapse navbar-collapse" id="nav-menu">
        <ul class="nav navbar-nav navbar-right">
          
              <li  >
                <a href="/">Blogs</a>
              </li>
          
              <li  >
                <a href="/tags.html">Tags</a>
              </li>
          
              <li  >
                <a href="/about.html">About</a>
              </li>
          
          
              <li>
                <a href="/atom.xml" target="_blank">
                  <span class="icon-rss"></span>
                </a>
              </li>
          
              <li>
                <a href="http://github.com/sixdegree" target="_blank">
                  <span class="icon-github"></span>
                </a>
              </li>
          
        </ul>
      </div>
    </div>
  </nav>
</header>



    <div class="container">
      <article class="detail" role="main">
  <section class="post-header">
    <h1 class="post-title">Spring Cloud</h1>
    <ul class="post-meta">
      <li>
        <span class="glyphicon glyphicon-calendar"></span>
        <time datetime="2020-11-30T16:00:00.000Z">2020-12-01</time>
      </li>
      
        <li>
         <span class="glyphicon glyphicon-tags"></span>
          
            <a href="/tags.html#tag-MicroService">MicroService</a>
          
        </li>
      
    </ul>
  </section>
  <section class="post-content">
    <h2 id="header-1">Starter</h2>
<ol>
<li><p>服务注册中心</p>
<ul>
<li>Eureka (Netflix)</li>
<li>Zookeeper</li>
<li>Consul</li>
<li>Nacos (Alibaba)</li>
</ul>
</li>
<li><p>服务配置</p>
<ul>
<li>Config</li>
<li>Nacos (Alibaba)</li>
</ul>
</li>
<li><p>服务总线</p>
<ul>
<li>Bus</li>
<li>Nacos (Alibaba)</li>
</ul>
</li>
<li><p>服务调用</p>
<ul>
<li>Ribbon (Netflix)</li>
<li>LoadBalancer (SpringCloud)</li>
<li>Feign</li>
<li>OpenFeign (SpringCloud)</li>
</ul>
</li>
<li><p>服务降级</p>
<ul>
<li>Hystrix (Netflix)</li>
<li>Resilience4j</li>
<li>Sentinel (Alibaba)</li>
</ul>
</li>
<li><p>服务网关</p>
<ul>
<li>Zuul (Netflix)</li>
<li>Zuul2 (Netflix)</li>
<li>Gateway (SpringCloud)</li>
</ul>
</li>
</ol>
<h2 id="header-2">服务注册&amp;配置中心：Nacos (Spring Cloud Alibaba)</h2>
<ul>
<li>服务中心 （同类实现： Eureka,Zookeeper,Consual)</li>
<li>服务配置和总线 （同类实现：Config &amp; Bus)</li>
</ul>
<p><a href="https://github.com/alibaba/nacos/releases">https://github.com/alibaba/nacos/releases</a>
<a href="https://nacos.io/zh-cn/docs/quick-start.html">https://nacos.io/zh-cn/docs/quick-start.html</a>
<a href="https://spring-cloud-alibaba-group.github.io/github-pages/hoxton/en-us/index.html">https://spring-cloud-alibaba-group.github.io/github-pages/hoxton/en-us/index.html</a></p>
<pre><code class="lang-shell"># 安装
unzip nacos-server-$version.zip 或者 tar -xvf nacos-server-$version.tar.gz
cd nacos/bin

# 打开
sh startup.sh -m standalone

# 关闭
sh shutdown.sh
</code></pre>
<h3 id="header-3">Nacos Server</h3>
<p>link：<a href="http://127.0.0.1:8848/nacos/">http://127.0.0.1:8848/nacos/</a>
默认账号和密码为：nacos/nacos</p>
<p>注意：Nacos Server 的数据源是用 Derby 还是 MySQL 完全是由其运行模式决定的</p>
<ul>
<li>standalone 的话仅会使用 Derby，即使在 application.properties 里边配置 MySQL 也照样无视</li>
<li>cluster 模式会自动使用 MySQL，这时候如果没有 MySQL 的配置，是会报错的</li>
<li>不支持 MySQL 8.0 版本</li>
</ul>
<h3 id="header-4">Nacos 服务注册</h3>
<ol>
<li><p>parent pom</p>
<pre><code class="lang-xml"> &lt;properties&gt;
     &lt;spring.cloud.alibaba&gt;2.2.1.RELEASE&lt;/spring.cloud.alibaba&gt;
 &lt;/properties&gt;

  &lt;dependencyManagement&gt;
     &lt;dependencies&gt;
          &lt;!-- Spring Cloud Alibaba --&gt;
         &lt;dependency&gt;
             &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
             &lt;artifactId&gt;spring-cloud-alibaba-dependencies&lt;/artifactId&gt;
             &lt;version&gt;${spring.cloud.alibaba}&lt;/version&gt;
             &lt;type&gt;pom&lt;/type&gt;
             &lt;scope&gt;import&lt;/scope&gt;
         &lt;/dependency&gt;
     &lt;/dependencies&gt;
 &lt;/dependencyManagement&gt;
</code></pre>
</li>
<li><p>provider/consumer client pom</p>
<pre><code class="lang-xml"> &lt;!-- 服务发现 --&gt;
 &lt;dependency&gt;
     &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
     &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;
 &lt;/dependency&gt;
</code></pre>
</li>
<li><p>provider</p>
<ul>
<li>application.yml<pre><code class="lang-yaml">  server:
      port: 7010
  spring:
    application:
      name: nacos-provider
    cloud:
      nacos:
        discovery:
          server-addr: localhost:8848 # ${NACOS_SERVER:8848}
</code></pre>
</li>
<li><p>main</p>
<pre><code class="lang-java">  @SpringBootApplication
  @EnableDiscoveryClient
  public class NacosProviderApp {

      public static void main(String[] args){
          SpringApplication.run(NacosProviderApp.class,args);
      }

      @RestController
      public class HelloController {
          @GetMapping(&quot;/hi&quot;)
          public Object hello(){ return &quot;Hello&quot;;}
      }
  }
</code></pre>
</li>
</ul>
</li>
<li><p>consumer</p>
<ul>
<li>application.yml<pre><code class="lang-yaml">  server:
      port: 7020
  spring:
    application:
      name: nacos-consumer
    cloud:
      nacos:
        discovery:
          server-addr: localhost:8848 # ${NACOS_SERVER:8848}
</code></pre>
</li>
<li><p>main</p>
<pre><code class="lang-java">  @SpringBootApplication
  @EnableDiscoveryClient
  public class NacosConsumerApp {
      public static void main(String[] args){
          SpringApplication.run(NacosConsumerApp.class,args);
      }

      @Bean
      @LoadBalanced // 使用serviceId访问则一定要加上，否则找不到服务；不加此注解，则可通过普通的ip:host的URL来访问服务
      public RestTemplate restTemplate(){
          return new RestTemplate();
      }

      @RestController
      public class HelloController {
          private String remoteServiceId=&quot;nacos-provider&quot;;
          @Autowired
          private RestTemplate restTemplate;

          @GetMapping(&quot;/&quot;)
          public Object index(){
              return &quot;Index&quot;;
          }

          @GetMapping(&quot;/hi&quot;)
          public Object hello(){
              String url = String.format(&quot;http://%s/hi&quot;,remoteServiceId);
              String result = restTemplate.getForObject(url,String.class);
              return &quot;Say: &quot;+result;
          }
      }
  }
</code></pre>
</li>
</ul>
</li>
<li><p>Test</p>
<ul>
<li>provider: Get <a href="http://localhost:7010/hi">http://localhost:7010/hi</a></li>
<li>consumer: Get <a href="http://localhost:7020/">http://localhost:7020/</a></li>
<li>consumer: Get <a href="http://localhost:7020/hi">http://localhost:7020/hi</a></li>
</ul>
</li>
</ol>
<h3 id="header-5">Nacos 服务配置</h3>
<ol>
<li><p>provider/consumer client pom</p>
<pre><code class="lang-xml"> &lt;!-- 服务配置 --&gt;
 &lt;dependency&gt;
     &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
     &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-config&lt;/artifactId&gt;
 &lt;/dependency&gt;
  &lt;!-- spring cloud 2020,需加上这个才能读取bootstrap.yml,Nacos Config才能正常使用--&gt;
 &lt;dependency&gt;
     &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
     &lt;artifactId&gt;spring-cloud-starter-bootstrap&lt;/artifactId&gt;
 &lt;/dependency&gt;
</code></pre>
</li>
<li><p>bootstrap.yml (或者 bootstrap.properties) 优先级高于application.yml，nacos相关配置需配在此处</p>
<pre><code class="lang-yaml"> server:
   port: 7010

 spring:
   application:
     name: nacos-provider
   cloud:
     nacos:
       discovery:
         server-addr: localhost:8848 # ${NACOS_SERVER:8848} | 注意：必须有端口号
       config:
         server-addr: localhost:8848
         file-extension: yaml # 支持properties(默认),yaml | 注意：nacos识别yaml，yml会报错
         namespace: dear-v1 # 命名空间ID，不是命名空间名称 | 注意：只能配置一个命名空间
         group: NACOS_GROUP # 默认DEFAULT_GROUP | 注意：只能配置一个GROUP
         # =&gt; 加载的dataId为: ${prefix}-${spring.profiles.active}.${file-extension}
         # prefix 默认为 spring.application.name
         # spring.profiles.active为空时 =&gt; 对应的连接符 - 也将不存在,dataId 的拼接格式变成 ${prefix}.${file-extension}
         ext-config: # 列表，优先级都低于上面正常group&amp;namespace下的配置，列表的优先级是下标越大优先级越高
           + data-id: logback-spring.yaml
             group: LOG_GROUP
             refresh: true
           + data-id: external.yaml
             group: EXTERNAL_GROUP
             refresh: true
</code></pre>
</li>
<li><p>application.yml (optional): <code>spring.profiles.active</code> 可在运行时指定</p>
<pre><code class="lang-yaml"> spring:
   profiles:
     active: dev
</code></pre>
</li>
<li><p>Controller</p>
<pre><code class="lang-java"> @RestController
 @RefreshScope // 实现配置自动更新
 public class ConfigController{

     @Value(&quot;${provider.name:UnKnow}&quot;)
     private String providerName;

     @Value(&quot;${welcome:UnKnow}&quot;)
     private String welcome;

     @GetMapping(&quot;/config&quot;)
     public Object config(){
         return &quot;ProviderName: &quot;+providerName +&quot;; Welcome: &quot;+welcome;
     }
 }
</code></pre>
</li>
<li><p>Nocos 配置界面：<code>http://127.0.0.1:8848/nacos</code>，添加配置文件</p>
<ul>
<li>namesapce: dear-v1</li>
<li>group: <ul>
<li>EXTERNAL_GROUP<ul>
<li>external.yaml<pre><code class="lang-yaml">  welcome: External Welcome V1
</code></pre>
</li>
</ul>
</li>
<li>LOG_GROUP<ul>
<li>logback-spring.yaml<pre><code class="lang-yaml">  logging:
      config: classpath:logback-spring-${spring.profiles.active}.xml
      path: logs
      package: com.cj.dear
</code></pre>
</li>
</ul>
</li>
<li>NACOS_GROUP<ul>
<li>nacos-provider.yaml<pre><code class="lang-yaml">  provider:
      name: Default Nacos Provider
</code></pre>
</li>
<li>nacos-provider-dev.yaml<pre><code class="lang-yaml">  provider:
      name: Dev Nacos Provider
</code></pre>
</li>
<li>nacos-provider-prod.yaml<pre><code class="lang-yaml">  provider:
      name: Prod Nacos Provider
</code></pre>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>启动运行，访问 <code>http://localhost:7010/config</code></p>
<ul>
<li>Run Configuration =&gt; program arguments <code>--spring.profiles.active=prod</code></li>
<li>使用命令行：<code>java -jar nacos-provider.jar --spring.profiles.active=dev</code></li>
</ul>
</li>
</ol>
<h2 id="header-6">链路追踪：Sleuth &amp; Zipkin</h2>
<h3 id="header-7">Sleuth</h3>
<ul>
<li>trace: 整个调用链路，一系列span组成一个树状结构 -- tranceID</li>
<li>span: 每个最小的工作单元（一次微服务调用）-- spanID</li>
</ul>
<p>Sleuth 帮助记录这些traceID,spanID
Zipkin Twitter的一个开源项目，收集链路的跟踪数据，提供可插拔的数据存储方式，UI直观查看分析</p>
<h3 id="header-8">Zipkin</h3>
<p><a href="https://zipkin.io/">https://zipkin.io/</a>
<a href="https://github.com/openzipkin/openzipkin.github.io">https://github.com/openzipkin/openzipkin.github.io</a>
<a href="https://github.com/openzipkin/zipkin">https://github.com/openzipkin/zipkin</a></p>
<p>核心组件：</p>
<ul>
<li>Collector 收集链路信息</li>
<li>Storage 存储</li>
<li>Restful API</li>
<li>Web UI</li>
</ul>
<p>分两端：</p>
<ul>
<li>服务端<ul>
<li>Zipkin Server 下载 <a href="https://zipkin.io/pages/quickstart">https://zipkin.io/pages/quickstart</a> </li>
<li>启动 <code>java -jar zipkin.jar</code> 或使用docker <code>docker run -d -p 9411:9411 openzipkin/zipkin</code></li>
<li>visit <code>http://localhost:9411</code></li>
</ul>
</li>
<li>客户端 发送链路信息给服务端<ul>
<li>HTTP报文方式发送</li>
<li>消息总线方式（如RabbitMQ)</li>
</ul>
</li>
</ul>
<h3 id="header-9">Sample</h3>
<ol>
<li><p>pom.xml (所有微服务)</p>
<pre><code class="lang-xml"> &lt;!-- 链路追踪 Sleuth--&gt;
 &lt;!--&lt;dependency&gt;--&gt;
     &lt;!--&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;--&gt;
     &lt;!--&lt;artifactId&gt;spring-cloud-starter-sleuth&lt;/artifactId&gt;--&gt;
 &lt;!--&lt;/dependency&gt;--&gt;
 &lt;!-- Zipkin Client(dependence 已包含了sleuth相关依赖) 收集链路信息，发送给Zipkin Server --&gt;
 &lt;dependency&gt;
     &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
     &lt;artifactId&gt;spring-cloud-starter-zipkin&lt;/artifactId&gt;
 &lt;/dependency&gt;
</code></pre>
</li>
<li><p>application.xml （所有微服务）</p>
<pre><code class="lang-yaml"> spring:
   zipkin:
     base-url: http://localhost:9411 # Zipkin Server端地址
     sender:
       type: web                     # 数据用HTTP方式传送给Zipkin Server端的方式
   sleuth:
     sampler:
       probability: 0.5              # 数据采样比（0～1，默认0.1）
</code></pre>
</li>
<li><p>Test (多请求一些链接，然后去 <a href="http://localhost:9411">http://localhost:9411</a> 查看可视化界面)</p>
<ul>
<li><a href="http://localhost:81/nacos-consumer/hi?token=a">http://localhost:81/nacos-consumer/hi?token=a</a></li>
<li><a href="http://localhost:81/provider/hi?token=b">http://localhost:81/provider/hi?token=b</a></li>
<li><a href="http://localhost:7010/provider/hi">http://localhost:7010/provider/hi</a></li>
<li>...</li>
</ul>
</li>
</ol>
<h3 id="header-10">优化：链路数据持久化（默认存储在内存）</h3>
<p><a href="https://github.com/openzipkin/zipkin/tree/master/zipkin-server">https://github.com/openzipkin/zipkin/tree/master/zipkin-server</a></p>
<p>Sample: 持久化到MySQL</p>
<ol>
<li><p>准备数据库表</p>
<ul>
<li><a href="https://github.com/openzipkin/zipkin/tree/master/zipkin-storage/mysql-v1#applying-the-schema">https://github.com/openzipkin/zipkin/tree/master/zipkin-storage/mysql-v1#applying-the-schema</a></li>
<li><a href="https://github.com/openzipkin/zipkin/blob/master/zipkin-storage/mysql-v1/src/main/resources/mysql.sql">https://github.com/openzipkin/zipkin/blob/master/zipkin-storage/mysql-v1/src/main/resources/mysql.sql</a></li>
</ul>
</li>
<li><p>重启 Zipkin Server, 启动时传递相关配置参数</p>
<ul>
<li><a href="https://github.com/openzipkin/zipkin/tree/master/zipkin-server">https://github.com/openzipkin/zipkin/tree/master/zipkin-server</a></li>
<li><a href="https://blog.csdn.net/qq_42714869/article/details/90052903">https://blog.csdn.net/qq_42714869/article/details/90052903</a></li>
<li><a href="https://blog.csdn.net/qq_42714869/article/details/90052903">https://blog.csdn.net/qq_42714869/article/details/90052903</a><pre><code class="lang-shell">java -jar zipkin.jar --STORAGE_TYPE=mysql --MYSQL_HOST=localhost --MYSQL_TCP_PORT=3306 --MYSQL_USER=cj --MYSQL_PASS=123 --MYSQL_DB=dear_zipkin
</code></pre>
</li>
</ul>
</li>
</ol>
<h3 id="header-11">优化：链路数据传输方式（默认Http方式发送给Zipkin Server）</h3>
<p>Sample: 使用消息中间件 </p>
<ol>
<li><p>准备RabbitMQ服务器 <a href="http://localhost:15672">http://localhost:15672</a></p>
</li>
<li><p>修改Zipkin Server,从RabbitMQ中拉取信息</p>
<ul>
<li><a href="https://github.com/openzipkin/zipkin/tree/master/zipkin-collector/rabbitmq">https://github.com/openzipkin/zipkin/tree/master/zipkin-collector/rabbitmq</a><pre><code class="lang-shell">java -jar zipkin.jar --STORAGE_TYPE=mysql --MYSQL_HOST=localhost --MYSQL_TCP_PORT=3306 --MYSQL_USER=cj --MYSQL_PASS=123 --MYSQL_DB=dear_zipkin --RABBIT_ADDRESSES=localhost:5672 --RABBIT_USER=admin --RABBIT_PASSWORD=admin --RABBIT_VIRTUAL_HOST=my_vhost
</code></pre>
</li>
</ul>
</li>
<li><p>修改微服务Zipkin client 相关配置，将采集信息发送RabbitMQ</p>
</li>
</ol>
<h2 id="header-12">服务调用：OpenFeign (Spring Cloud)</h2>
<p>服务调用（同类实现：Ribbon,LoadBalancer,Feign)</p>
<p><a href="https://docs.spring.io/spring-cloud-openfeign/docs/current/reference/html/">https://docs.spring.io/spring-cloud-openfeign/docs/current/reference/html/</a></p>
<ul>
<li>依赖注册中心</li>
<li>使用本地负载均衡器<ul>
<li>常见算法：轮询，随机，固定IP，权重，Hash一致性，...</li>
</ul>
</li>
</ul>
<ol>
<li><p>pom.xml</p>
<pre><code class="lang-xml"> &lt;!-- 服务发现 Nacos--&gt;
 &lt;dependency&gt;
     &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
     &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;
     &lt;!-- 排除ribbon, 使用Springcloud loadbalancer (f否则启动报错)--&gt;
     &lt;exclusions&gt; 
         &lt;exclusion&gt;
             &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
             &lt;artifactId&gt;spring-cloud-starter-netflix-ribbon&lt;/artifactId&gt;
         &lt;/exclusion&gt;
     &lt;/exclusions&gt;
 &lt;/dependency&gt;

 &lt;!-- Spring Cloud OpenFeign --&gt;
 &lt;dependency&gt;
     &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
     &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;
 &lt;/dependency&gt;

 &lt;dependency&gt;
     &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
     &lt;artifactId&gt;spring-cloud-starter-loadbalancer&lt;/artifactId&gt;
 &lt;/dependency&gt;
</code></pre>
</li>
<li><p>application.yml</p>
<pre><code class="lang-yaml"> server:
   port: 7020

 spring:
   application:
     name: nacos-consumer
   cloud:
     nacos:
       discovery:
         server-addr: localhost:8848 # ${NACOS_SERVER:8848}
         namespace: dear-v1
     loadbalancer:
       ribbon:
         enabled: false

 # config feign -- optional
 feign:
   client:
     config:
       nacos-provider: #  FeignClient名 或使用 default
         connectTimeout: 5000
         readTimeout: 5000
         loggerLevel: FULL

 logging:
   level:
     com.cj.dear.nacos: debug
   config: classpath:logback-spring-dev.xml
   path: logs
</code></pre>
</li>
<li><p>激活Feign <code>@EnableFeignClients</code></p>
<pre><code class="lang-java"> @SpringBootApplication
 @EnableDiscoveryClient
 @EnableFeignClients
 public class NacosConsumerApp {
     public static void main(String[] args){
         SpringApplication.run(NacosConsumerApp.class,args);
     }
 }
</code></pre>
</li>
<li><p>FeignClient （注意：feign要求指明确定返回值类，才能正确解析方法返回值，即方法返回值不能使用Object！）</p>
<pre><code class="lang-java"> @FeignClient(&quot;nacos-provider&quot;)
 public interface ProviderFeignClient{

     @GetMapping(&quot;/hi&quot;)
     String hello();

     @GetMapping(&quot;/config&quot;)
     String config();
 }
</code></pre>
</li>
<li><p>Usage</p>
<pre><code class="lang-java"> @RestController
 public class HelloController{
     @Autowired
     private ProviderFeignClient providerFeignClient;

     @GetMapping(&quot;callProvider&quot;)
     public Object callProvider(@RequestParam(required = false,
             name=&quot;func&quot;,defaultValue = &quot;hi&quot;)String func){
         System.out.println(&quot;func:&quot;+func);
         if(func.equals(&quot;hi&quot;))
             return &quot;Call &quot;+func+&quot; Result: &quot;+providerFeignClient.hello();
         return &quot;Call &quot;+func+&quot; Result: &quot;+providerFeignClient.config();
     }
 }
</code></pre>
</li>
<li><p>Test (启动N个nacos-provider)</p>
<ul>
<li><a href="http://localhost:7020/callProvider">http://localhost:7020/callProvider</a></li>
<li><a href="http://localhost:7020/callProvier?func=xx">http://localhost:7020/callProvier?func=xx</a></li>
</ul>
</li>
</ol>
<h2 id="header-13">服务降级：Sentinel（Spring Cloud Alibaba）</h2>
<p>服务降级（同类实现：Hystrix,Resilience4j)</p>
<p><a href="https://spring-cloud-alibaba-group.github.io/github-pages/hoxton/en-us/index.html#_spring_cloud_alibaba_sentinel">https://spring-cloud-alibaba-group.github.io/github-pages/hoxton/en-us/index.html#_spring_cloud_alibaba_sentinel</a></p>
<p><a href="https://github.com/alibaba/Sentinel/">https://github.com/alibaba/Sentinel/</a></p>
<p><a href="https://github.com/alibaba/Sentinel/wiki/%E4%BB%8B%E7%BB%8D">https://github.com/alibaba/Sentinel/wiki/%E4%BB%8B%E7%BB%8D</a></p>
<p>高并发问题
由于请求积压，造成服务瘫痪，服务与服务之间存在依赖性，故障传播，连锁反应，造成整个系统崩溃 （雪崩）=》 处理方案：</p>
<ul>
<li>服务隔离<ul>
<li>线程池隔离（每个服务接口有自己独立的线程池，互不影响）</li>
<li>信号量隔离（计数器，最大阈值，超过则拒绝）</li>
</ul>
</li>
<li>服务熔断，降级</li>
<li>服务限流</li>
</ul>
<h3 id="header-14">Sentinel 控制台</h3>
<p><a href="https://github.com/alibaba/Sentinel/wiki/%E6%8E%A7%E5%88%B6%E5%8F%B0">https://github.com/alibaba/Sentinel/wiki/%E6%8E%A7%E5%88%B6%E5%8F%B0</a></p>
<ol>
<li><p>启动Sentinel控制台</p>
<pre><code class="lang-bash"> java -Dserver.port=8080 -Dcsp.sentinel.dashboard.server=localhost:8080 -Dproject.name=sentinel-dashboard -jar sentinel-dashboard.jar
</code></pre>
<ul>
<li>启动时加入 JVM 参数 <code>-Dcsp.sentinel.dashboard.server=consoleIp:port</code> 指定控制台地址和端口。</li>
<li>若启动多个应用，则需要通过 <code>-Dcsp.sentinel.api.port=xxxx</code> 指定客户端监控 API 的端口（默认是 8719）</li>
</ul>
</li>
<li><p>visit: <a href="http://localhost:8080/">http://localhost:8080/</a></p>
<ul>
<li>username/password: sentinel/sentinel</li>
</ul>
</li>
</ol>
<h3 id="header-15">Sample</h3>
<ol>
<li><p>pom.xml</p>
<pre><code class="lang-xml"> &lt;!-- Spring Cloud Aalibaba Sentinel --&gt;
 &lt;dependency&gt;
     &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
     &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;/artifactId&gt;
 &lt;/dependency&gt;
</code></pre>
</li>
<li><p>application.yml</p>
<pre><code class="lang-yaml"> spring:
   cloud:
     sentinel:
       transport:
         dashboard: localhost:8080
       eager: true # 默认false，懒加载
</code></pre>
</li>
<li><p>java</p>
<pre><code class="lang-java"> @GetMapping(&quot;callProvider&quot;)
 @SentinelResource(value=&quot;callProvider&quot;,
         blockHandler=&quot;callProviderBlockHandler&quot;,fallback=&quot;callProviderFallbackHandler&quot;)
 public Object callProvider(@RequestParam(required = false,
         name=&quot;func&quot;,defaultValue = &quot;hi&quot;)String func){
     System.out.println(&quot;func:&quot;+func);
     if(func.equals(&quot;hi&quot;))
         return &quot;Call &quot;+func+&quot; Result: &quot;+providerFeignClient.hello();
     return &quot;Call &quot;+func+&quot; Result: &quot;+providerFeignClient.config();
 }

 // sentinel
 // 1. 限流熔断 blockHandler（捕获BlockException) 注意：参数（最后Optional: BlockException），返回值类型需与原方法一致
 // 2. 异常降级 fallback（捕获其他异常） 注意：参数，返回值类型需与原方法一致（Optional: 可加Throwable）

 public Object callProviderBlockHandler(String func,BlockException ex){
     return &quot;CallProvider:&quot;+func+&quot;; BlockHandler&quot;;
 }

 public Object callProviderFallbackHandler(String func){
     return &quot;CallProvider:&quot;+func+&quot;; FallBack&quot;;
 }
</code></pre>
<ul>
<li>注意：blockHandler和fallback都配置了，则被限流降级而抛出BlockException时只会进入blockHandler处理逻辑</li>
</ul>
</li>
<li><p>启动服务</p>
</li>
<li><p>访问Sentinel控制台，配置限流规则，测试</p>
</li>
</ol>
<h3 id="header-16">限流规则持久化</h3>
<p>一条限流规则的组成：</p>
<ul>
<li>resource : 资源名（限流规则的作用对象），唯一，默认为请求路径</li>
<li>limitApp : 流控针对的调用来源（Sentinel可针对调用者进行限流，填写微服务名，默认default，即不区分调用来源）</li>
<li>grade : 阈值类型<ul>
<li>0: 线程数</li>
<li>1: QPS</li>
</ul>
</li>
<li>count : 单机限流阈值</li>
<li>strategy : 流控模式<ul>
<li>0: 直接，API达到限流条件时，直接限流</li>
<li>1: 关联，关联资源达到阈值时，限流自己</li>
<li>2: 链路，只记录指定链路上的流量（指定资源从入口资源进来的流量，达到阈值则进行限流，API级别的针对来源）</li>
</ul>
</li>
<li>controlBehavior : 流控效果<ul>
<li>0: 快速失败，直接拒绝，抛异常</li>
<li>1: Warm up，根据codeFactor（冷加载因子，默认3）的值，从阈值/codeFactor，经过预热时长，才达到设置的QPS值</li>
<li>2: 排队等待，匀速排队，让请求匀速通过（阈值类型必须为QPS才可）</li>
</ul>
</li>
<li>clusterMode : 是否集群</li>
</ul>
<p><strong> Sample: 本地文件加载限流规则 </strong></p>
<ol>
<li><p>resources/flowRule.json</p>
<pre><code class="lang-json"> [
     {
         &quot;resource&quot;: &quot;callProvider&quot;,
         &quot;limitApp&quot;: &quot;default&quot;,
         &quot;grade&quot;: 0,
         &quot;count&quot;: 2,
         &quot;strategy&quot;: 0,
         &quot;controlBehavior&quot;: 0
     }
 ]
</code></pre>
</li>
<li><p>resources/application.yml</p>
<pre><code class="lang-yaml"> spring:
   application:
     name: nacos-consumer
   cloud:
     sentinel:
       transport:
         dashboard: localhost:8080
       eager: true # 默认false，懒加载
       datasource:
         ds1:
           file:  # 配置从本地文件读取限流规则
             dataType: json
             ruleType: flow
             file: classpath:flowRule.json
</code></pre>
</li>
<li><p>启动服务</p>
</li>
<li><p>visit sentinel控制台查看规则 <a href="http://localhost:8080/">http://localhost:8080/</a></p>
</li>
</ol>
<p><strong> Sample: 从nacos加载限流规则 </strong></p>
<ol>
<li><p>visit nacos控制台，配置 <code>nacos-consumer-sentinel.json</code></p>
</li>
<li><p>pom.xml: 增加 <code>sentinel-datasource-nacos</code>包</p>
<pre><code class="lang-xml"> &lt;!-- Spring Cloud Aalibaba Sentinel --&gt;
 &lt;dependency&gt;
     &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
     &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;/artifactId&gt;
 &lt;/dependency&gt;
 &lt;!-- Sentinel从nacos获取限流规则--&gt;
 &lt;dependency&gt;
     &lt;groupId&gt;com.alibaba.csp&lt;/groupId&gt;
     &lt;artifactId&gt;sentinel-datasource-nacos&lt;/artifactId&gt;
 &lt;/dependency&gt;
</code></pre>
</li>
<li><p>application.yml</p>
<pre><code class="lang-yaml"> spring:
   application:
     name: nacos-consumer
   cloud:
     sentinel:
       transport:
         dashboard: localhost:8080
       eager: true # 默认false，懒加载
       datasource:
         ds1:
 #          file: # 配置从本地文件读取限流规则
 #            dataType: json
 #            ruleType: flow
 #            file: classpath:flowRule.json
           nacos: # 配置从nacos中获取
             dataType: json
             ruleType: flow
             serverAddr: localhost:8848
             namespace: dear-v1
             dataId: nacos-consumer-sentinel.json
             groupId: DEFAULT_GROUP
</code></pre>
</li>
<li><p>启动服务</p>
</li>
<li><p>visit sentinel控制台查看规则 <a href="http://localhost:8080/">http://localhost:8080/</a></p>
</li>
</ol>
<h2 id="header-17">服务网关：Gateway（Spring Cloud)</h2>
<p>服务网关（同类实现：Zuul1,Zuul2)</p>
<ul>
<li>Netflix Zuul1: 阻塞Servlet</li>
<li>Netflix Zuul2: 基于Netty，非阻塞，支持长链接</li>
<li>SpringCloud Gateway: 基于Netty,Project Reactor响应式非阻塞，支持长链接，使用WebFlux，Filter链方式</li>
</ul>
<p>可应用解决问题：</p>
<ul>
<li>统一微服务登录认证问题，权限控制，减少代码冗余</li>
<li>跨域问题</li>
<li>保护服务，限流，黑白名单等</li>
<li>统一日志</li>
</ul>
<p>核心概念：</p>
<ul>
<li>路由 routes: 一个route由id,uri,predicates,filters组成</li>
<li>断言 predicates : 定义匹配来自HttpRequest的任何信息（断言函数输入类型是Spring5.0的ServerWebExchange)</li>
<li>过滤器 filters : 两种类型 GatewayFilter / GlobalFilter</li>
</ul>
<h3 id="header-18">Sample</h3>
<ol>
<li><p>pom.xml</p>
<pre><code class="lang-xml"> &lt;!-- Spring Cloud Gateway | 注意：依赖WebFlux，所以不要引入spring-boot-starter-web，，不然会与SpringMVC冲突，启动报错--&gt;
 &lt;dependency&gt;
     &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
     &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;
 &lt;/dependency&gt;
  &lt;!--&lt;dependency&gt;--&gt;
     &lt;!--&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;--&gt;
     &lt;!--&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;--&gt;
 &lt;!--&lt;/dependency&gt;--&gt;

 &lt;!--
 Spring Cloud 2x 有这个问题
 解决报错：Parameter 0 of method loadBalancerWebClientBuilderBeanPostProcessor
 in org.springframework.cloud.client.loadbalancer.reactive.LoadBalancerBeanPostProcessorAutoConfiguration
 required a bean of type &#39;org.springframework.cloud.client.loadbalancer.reactive.DeferringLoadBalancerExchangeFilterFunction&#39;
 that could not be found.
 --&gt;
 &lt;dependency&gt;
     &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
     &lt;artifactId&gt;spring-cloud-starter-loadbalancer&lt;/artifactId&gt;
 &lt;/dependency&gt;
</code></pre>
</li>
<li><p>application.yml</p>
<pre><code class="lang-yaml"> spring:
   profiles:
     active: dev
   cloud:
     gateway:
       discovery:                        # 简化路由配置，自动根据serviceId进行路由转发 eg: http://localhost:81/nacos-consumer/hi 会自动转发到 http://nacos-consumer/hi
         locator:
           enabled: true                 # 开启根据serviceId自动转发｜打开后，可使用serviceId，负载均衡定位访问服务
           lower-case-service-id: true   # 微服务名称以小写形式呈现
       routes:
         + id: baidu
           uri: https://www.baidu.com
           filters:
             + SetPath=/?{args}
           predicates:
             + Path=/baidu/{args}
         + id: nacos-provider          # 路由的ID，没有固定规则但要求唯一
           uri: lb://nacos-provider/   # 匹配后提供服务的路由地址（lb:// 根据serviceId，负载均衡策略确定具体服务地址）
           filters:
             + StripPrefix=1           # 过滤器，不加时定位服务为：lb://nacos-provider/provider/**；设置去掉第一段，则变成lb://nacos-provider/**
           predicates:
             + Path=/provider/**       # 断言,路径相匹配的进行路由
</code></pre>
</li>
<li><p>自定义GlobalFilter</p>
<pre><code class="lang-java"> @Component
 public class GatewayTokenFilter implements GlobalFilter {

     @Override
     public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) {

         String token = exchange.getRequest().getQueryParams().getFirst(&quot;token&quot;);
         if(StringUtils.isEmpty(token)){
             ServerHttpResponse response = exchange.getResponse();
             response.setStatusCode(HttpStatus.FORBIDDEN);
             String msg = &quot;Gateway:Forbidden to visit&quot;;
             DataBuffer df = response.bufferFactory().wrap(msg.getBytes());
             return response.writeWith(Mono.just(df));
         }

         return chain.filter(exchange);
     }
 }
</code></pre>
</li>
<li><p>Test</p>
<ul>
<li><a href="http://localhost:81/baidu/dd">http://localhost:81/baidu/dd</a> =》 Gateway:Forbidden to visit</li>
<li><a href="http://localhost:81/baidu/dd?token=ee">http://localhost:81/baidu/dd?token=ee</a> =&gt; 看到百度页面</li>
</ul>
</li>
<li><p>结合Nacos</p>
<pre><code class="lang-yaml"> server:
   port: 81

 spring:
   application:
     name: cloud-gateway
   cloud:
     nacos:
       discovery:
         server-addr: localhost:8848
         namespace: dear-v1
       config:
         server-addr: localhost:8848
         file-extension: yaml
         namespace: dear-v1
         group: CLOUD_GROUP
         ext-config:
           + data-id: logback-spring.yaml
             group: LOG_GROUP
             refresh: true
           + data-id: external.yaml
             group: EXTERNAL_GROUP
             refresh: true
</code></pre>
</li>
<li><p>main</p>
<pre><code class="lang-java"> @SpringBootApplication
 @EnableDiscoveryClient
 public class CloudGatewayApp {
     public static void main(String[] args){
         SpringApplication.run(CloudGatewayApp.class,args);
     }

     @Value(&quot;${provider.name:UnKnow}&quot;)
     private String providerName;

     @RestController
     @RefreshScope
     public class HelloController{

         @Value(&quot;${provider.name:UnKnow}&quot;)
         private String providerName;

         @GetMapping(&quot;/hi&quot;)  // http://localhost:81/hi =&gt; Gateway: Hello | ProviderName: Default Cloud Gateway V5 dev
         public String Hello() {
             return &quot;Gateway: Hello | ProviderName: &quot;+providerName;
         }
     }

 }
</code></pre>
</li>
<li><p>Test (需启动 Nacos Server,nacos-provider工程)</p>
<ul>
<li><a href="http://localhost:81/hi">http://localhost:81/hi</a> =&gt; Gateway: Hello | ProviderName: Default Cloud Gateway V5 dev</li>
<li><a href="http://localhost:81/provider/hi">http://localhost:81/provider/hi</a>  =》 Gateway:Forbidden to visit</li>
<li><a href="http://localhost:81/provider/hi?token=11">http://localhost:81/provider/hi?token=11</a> =》 Hello</li>
<li><a href="http://localhost:81/provider/config?token=22">http://localhost:81/provider/config?token=22</a> =》 ProviderName: Dev Nacos Provider; Welcome: External Welcome V1</li>
<li><a href="http://localhost:81/nacos-consumer/hi?token=11">http://localhost:81/nacos-consumer/hi?token=11</a> =》 Say: Hello</li>
</ul>
</li>
</ol>
<h3 id="header-19">predicates 断言</h3>
<p>RoutePredicateFactory</p>
<ul>
<li>datetime 请求时间校验: After,Before,Between</li>
<li>Cookie 请求Cookie校验 </li>
<li>Header 请求头校验</li>
<li>Host 请求Host校验</li>
<li>Method 请求方法校验</li>
<li>Path 请求路径校验</li>
<li>Queryparam 请求参数校验</li>
<li>RemoteAddr 请求远程地址校验</li>
</ul>
<h3 id="header-20">开启微服务名称转发</h3>
<p><code>spring.cloud.gateway.discovery.locator.enable=true</code></p>
<pre><code class="lang-yaml">spring:
  cloud:
    gateway:
      discovery:                        # 简化路由配置，自动根据serviceId进行路由转发
        locator:
          enabled: true                 # 开启根据serviceId自动转发｜打开后，可使用serviceId，负载均衡定位访问服务
          lower-case-service-id: true   # 微服务名称以小写形式呈现
</code></pre>
<p>开启后，无需配置routes，即可实现
visit <code>http://localhost:81/nacos-consumer/hi</code> 自动转发到 <code>http://nacos-consumer/hi</code></p>
<p>Test: 
<a href="http://localhost:81/nacos-consumer/hi?token=11">http://localhost:81/nacos-consumer/hi?token=11</a> =》 Say: Hello</p>
<h3 id="header-21">过滤器</h3>
<ul>
<li>生命周期：<ul>
<li><code>pre</code></li>
<li><code>post</code></li>
</ul>
</li>
<li>类型：<ul>
<li><code>GatewayFilter</code> 局部过滤器，应用到单一路由，或一个分组路由上<ul>
<li>Gateway中已内置了很多不同类型的局部过滤器，可直接使用 （实现类以<code>GatewawyFilterFactory</code>结尾）</li>
</ul>
</li>
<li><code>GlobalFilter</code> 全局过滤器，应用到所有路由上，eg 内置的一些全局过滤器<ul>
<li>LoadBalancer 负载均衡相关过滤器： LoadBalancerClientFilter</li>
<li>HttpClient http客户短相关：NettyRoutingFilter</li>
<li>Websocket ：WebsocketRoutingFilter</li>
<li>ForwardPath 路径转发：ForwardPathFilter</li>
<li>RouteToRequestUrl 路由Url相关：RouteToRequestUrlFilter</li>
<li>WebClient ：WebClientHttpRoutingFilter,WebClientWriteResponseFilter</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>自定义GlobalFilter: 实现GlobalFilter, Ordered(Optional,越小优先级越高)</p>
<h3 id="header-22">网关限流</h3>
<p>常见限流算法：</p>
<ul>
<li>计数器<ul>
<li>每个单位时间内 =&gt; 累计统计单位时间内请求数量 =&gt; 是否超过单位时间内最大的请求数量（阈值）=&gt; 一个单位时间结束，重置0重新累计</li>
<li>缺点：单位时间内不平滑</li>
</ul>
</li>
<li>漏桶算法<ul>
<li>内部维护一个队列（桶容量）=&gt; 按一定频率输出（rate）=&gt; 超出桶容量的丢弃/拒绝</li>
<li>都按一定频率输出，自己可能积压太多请求，自身压力大，对后面微服务是种浪费</li>
</ul>
</li>
<li>令牌算法（漏桶算法改进版，允许一定程度的突发调用）<ul>
<li>内部维护桶（可负载最大容量）=&gt; 按一定速率往桶里存放令牌(满了则不生成令牌) =&gt; 请求从桶里获取令牌成功则可进行下步操作 =&gt; 请求无法获取令牌则等待或失败</li>
<li>可快速转发为后面的微服务，不用积压太多请求，保护自己</li>
</ul>
</li>
</ul>
<p>Spring Cloud Gateway：</p>
<ul>
<li>基于Filter：官方提供了基于令牌桶的限流支持<ul>
<li>基于内置的局部过滤器工厂<code>RequestRateLimiterGatewayFilterFactory</code>实现（通过Redis和lu脚本结合的方式实现）</li>
</ul>
</li>
<li>基于Sentinel的限流</li>
</ul>
<h3 id="header-23">网关限流：基于Filter</h3>
<ol>
<li><p>pom.xml</p>
<pre><code class="lang-xml"> &lt;!-- 网关限流： 基于Filter 实现 --&gt;
 &lt;!-- 监控依赖 --&gt;
 &lt;dependency&gt;
     &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
     &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
 &lt;/dependency&gt;
 &lt;!-- Reids 相关依赖（基于reactive的redis依赖）） --&gt;
 &lt;dependency&gt;
     &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
     &lt;artifactId&gt;spring-boot-starter-data-redis-reactive&lt;/artifactId&gt;
 &lt;/dependency&gt;
</code></pre>
</li>
<li><p>application.yml 添加redis &amp; 限流配置</p>
<pre><code class="lang-yaml"> spring:
   redis:
     host: localhost
     port: 6379
     database: 1
     password: 123456
   cloud:
     gateway:
       routes:
         + id: nacos-provider
           uri: lb://nacos-provider/
           filters:
             + name: RequestRateLimiter # 使用限流过滤器
               args:
                 key-resolver: &#39;#{@queryParamKeyResolver}&#39;   # 限流Key解析器（即基于什么限流），使用SpEL表达式@xxx从Spring容器中获取name为xxx的Bean对象, 查看自定义的RateLimiteConfig中注入的Bean
                 redis-rate-limiter.replenishRate: 1  # 向令牌桶中填充token的速率
                 redis-rate-limiter.burstCapacity: 3  # 令牌桶容量
                 redis-rate-limiter.requestedTokens: 1 # 一个请求消耗几个令牌
             + StripPrefix=1
           predicates:
             + Path=/provider/**
</code></pre>
</li>
<li><p>编写KeyResolver</p>
<pre><code class="lang-java"> @Configuration
 public class KeyResolverConfig {

     // 基于请求路径限流
     @Bean
     @Primary
     public KeyResolver pathKeyResolver(){
         return new KeyResolver(){
             @Override
             public Mono&lt;String&gt; resolve(ServerWebExchange exchange) {
                 return Mono.just(exchange.getRequest().getPath().toString());
             }
         };
     }

     // 基于请求参数限流
     @Bean
     public KeyResolver queryParamKeyResolver(){
         return exchange -&gt;{
             String token = exchange.getRequest().getQueryParams().getFirst(&quot;token&quot;);
             return Mono.just(token!=null?token:exchange.getRequest().getPath().toString());
         };
     }
 }
</code></pre>
</li>
<li><p>Test</p>
<ul>
<li>Redis Cli: 选择数据库，打开监听<pre><code class="lang-shell">  &gt; select 1
  &gt; monitor
</code></pre>
</li>
<li>vist:<ul>
<li><a href="http://localhost:81/provider/hi">http://localhost:81/provider/hi</a></li>
<li><a href="http://localhost:81/provider/hi?token=11">http://localhost:81/provider/hi?token=11</a></li>
<li><a href="http://localhost:81/provider/hi?token=22">http://localhost:81/provider/hi?token=22</a></li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="header-24">网关限流：基于Sentinel</h3>
<p><a href="https://www.cnblogs.com/yinjihuan/p/10772558.html">https://www.cnblogs.com/yinjihuan/p/10772558.html</a></p>
<p><a href="https://github.com/alibaba/Sentinel/wiki/API-Gateway-Flow-Control">https://github.com/alibaba/Sentinel/wiki/API-Gateway-Flow-Control</a></p>
<ol>
<li><p>pom.xml</p>
<pre><code class="lang-xml"> &lt;!-- 网关限流： 基于Sentinel 实现 --&gt;
 &lt;dependency&gt;
     &lt;groupId&gt;com.alibaba.csp&lt;/groupId&gt;
     &lt;artifactId&gt;sentinel-spring-cloud-gateway-adapter&lt;/artifactId&gt;
 &lt;/dependency&gt;
</code></pre>
</li>
<li><p>application.yml</p>
<pre><code class="lang-yaml"> spring:
   cloud:
     gateway:
       discovery:
         locator:
           enabled: true
           lower-case-service-id: true
       routes:
         + id: baidu
           uri: https://www.baidu.com
           filters:
             + SetPath=/?{args}
           predicates:
             + Path=/baidu/{args}
         + id: nacos-provider
           uri: lb://nacos-provider/
           predicates:
             + Path=/provider/**
           filters:
             + StripPrefix=1
</code></pre>
</li>
<li><p>Configuration</p>
<pre><code class="lang-java"> @Configuration
 public class SentinelGatewayConfig {

     private final List&lt;ViewResolver&gt; viewResolvers;
     private final ServerCodecConfigurer serverCodecConfigurer;

     public SentinelGatewayConfig(ObjectProvider&lt;List&lt;ViewResolver&gt;&gt; viewResolversProvider,
                                 ServerCodecConfigurer serverCodecConfigurer) {
         this.viewResolvers = viewResolversProvider.getIfAvailable(Collections::emptyList);
         this.serverCodecConfigurer = serverCodecConfigurer;
     }

     // 配置限流异常处理器
     @Bean
     @Order(-1)
     public SentinelGatewayBlockExceptionHandler sentinelGatewayBlockExceptionHandler() {
         // Register the block exception handler for Spring Cloud Gateway.
         return new SentinelGatewayBlockExceptionHandler(viewResolvers, serverCodecConfigurer);
     }

     // 配置限流过滤器
     @Bean
     @Order(Ordered.HIGHEST_PRECEDENCE)
     public GlobalFilter sentinelGatewayFilter() {
         // By default the order is HIGHEST_PRECEDENCE
         return new SentinelGatewayFilter();
     }

     // Optinal: 配置一些初始化的限流规则
     // Test: http://localhost:81/provider/hi?token=22
     @PostConstruct
     public void initGatewayRules(){
         Set&lt;GatewayFlowRule&gt; rules = new HashSet&lt;&gt;();

         // 路由ID，单位时间限流阈值，单位时间
         // rules.add(new GatewayFlowRule(&quot;nacos-provider&quot;).setCount(2).setIntervalSec(1));

         // 限流分组名，单位时间限流阈值，单位时间
         rules.add(new GatewayFlowRule(&quot;providerApis&quot;).setCount(2).setIntervalSec(1));

         GatewayRuleManager.loadRules(rules);
     }

     // Optinal: 自定义限流分组
     @PostConstruct
     public void initCustomizedApis(){
         Set&lt;ApiDefinition&gt; definitions = new HashSet&lt;&gt;();

         Set&lt;ApiPredicateItem&gt; predicateItems = new HashSet&lt;&gt;();
         predicateItems.add(new ApiPathPredicateItem()
                 .setPattern(&quot;/provider/**&quot;)
                 .setMatchStrategy(SentinelGatewayConstants.URL_MATCH_STRATEGY_PREFIX)
         );
         ApiDefinition def = new ApiDefinition(&quot;providerApis&quot;)
                 .setPredicateItems(predicateItems);

         definitions.add(def);
         GatewayApiDefinitionManager.loadApiDefinitions(definitions);
     }

     // Optinal: 自定义限流处理器
     @PostConstruct
     public void initBlockHandlers(){
         BlockRequestHandler handler = new BlockRequestHandler() {
             @Override
             public Mono&lt;ServerResponse&gt; handleRequest(ServerWebExchange serverWebExchange, Throwable throwable) {
                 Map map = new HashMap();
                 map.put(&quot;code&quot;,&quot;001&quot;);
                 map.put(&quot;message&quot;,&quot;不好意思，限流了哦&quot;);
                 return ServerResponse.status(HttpStatus.OK)
                         .contentType(MediaType.APPLICATION_JSON)
                         .body(BodyInserters.fromValue(map));
             }
         };
         GatewayCallbackManager.setBlockHandler(handler);
     }
 }
</code></pre>
</li>
<li><p>Test: <a href="http://localhost:81/provider/hi?token=22">http://localhost:81/provider/hi?token=22</a></p>
</li>
</ol>
<h3 id="header-25">网关高可用</h3>
<p>Ngnix + 网关集群</p>
<ol>
<li><p>Ngnix 配置</p>
<pre><code> // gateway集群
 upstream gateway{
     server 127.0.0.1:81;
     server 127.0.0.1:82;
 }

 Server{
     listen 80;
     server_name localhost;
     # 路由
     location / {
         proxy_pass http://gateway;
     }
 }
</code></pre></li>
<li><p>启动两个网关实例，端口分别为81，82</p>
</li>
<li><p>Test: <a href="http://localhost/provider/hi?token=aa">http://localhost/provider/hi?token=aa</a></p>
</li>
</ol>
  </section>
</article>

      <hr/>
      
<section class="post-comment">
	
		<div id="gitment_container"></div>

<link rel="stylesheet" href="/gitment/default.css">
<script src="/gitment/gitment.browser.js"></script>


<script type="text/javascript">
	var gitment = new Gitment({
	  id: document.location.pathname,
	  owner: 'chenjin-zero',
	  repo: 'blogComment',
	  oauth: {
	    client_id: '36a09bb7399efe69c6ce',
	    client_secret: 'ad9ad546b23b708c71d92e513dc36e0486179dea',
	  }
	})
      
	gitment.render('gitment_container')
</script>
	
</section>

    </div>
  </div>
</body>

<script src="/jquery/dist/jquery.min.js"></script>
<script src="/bootstrap/dist/js/bootstrap.min.js"></script>


	<script src="/highlight/highlight.pack.js"></script>
	<script type="text/javascript">
		hljs.initHighlightingOnLoad();
	</script>






<script type="text/javascript">

  $(document).ready(function(){
    var sidebarCtrl=$("#sidebar-ctrl");
    var sidebar=$("#sidebar");
    var wrapper=$("#wrapper");
    sidebarCtrl.on("click",function(event){
        //alert("click");
        sidebar.toggleClass("sidebar-toggle");
        wrapper.toggleClass("sidebar-toggle");
        sidebarCtrl.toggleClass("sidebar-toggle");
        sidebarCtrl.toggleClass("active");
    })
  });
</script>


</html>
